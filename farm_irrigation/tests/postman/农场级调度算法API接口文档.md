# å†œåœºçº§çŒæº‰è°ƒåº¦ç®—æ³•APIæ¥å£æ–‡æ¡£-First

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ä¸šåŠ¡æœ¯è¯­è¡¨](#ä¸šåŠ¡æœ¯è¯­è¡¨)
3. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
4. [è®¤è¯æ–¹å¼](#è®¤è¯æ–¹å¼)
5. [æ¥å£åˆ—è¡¨](#æ¥å£åˆ—è¡¨)
   - [ç³»ç»Ÿç®¡ç†](#1-ç³»ç»Ÿç®¡ç†)
   - [çŒæº‰è®¡åˆ’ç”Ÿæˆ](#2-çŒæº‰è®¡åˆ’ç”Ÿæˆ)
   - [å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”](#3-å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”)
   - [è®¡åˆ’ä¼˜åŒ–](#4-è®¡åˆ’ä¼˜åŒ–)
   - [åŠ¨æ€æ‰§è¡Œç®¡ç†](#5-åŠ¨æ€æ‰§è¡Œç®¡ç†)
   - [æ‰¹æ¬¡ç®¡ç†](#6-æ‰¹æ¬¡ç®¡ç†)
   - [æ°´ä½ç®¡ç†](#7-æ°´ä½ç®¡ç†)
   - [è®¡åˆ’é‡æ–°ç”Ÿæˆ](#8-è®¡åˆ’é‡æ–°ç”Ÿæˆ)
   - [æ‰¹æ¬¡è°ƒæ•´](#9-æ‰¹æ¬¡è°ƒæ•´)
     - [æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´](#91-æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´)
     - [æ‰¹æ¬¡é¡ºåºè°ƒæ•´](#92-æ‰¹æ¬¡é¡ºåºè°ƒæ•´)
   - [ç¡¬ä»¶è®¾å¤‡ç®¡ç†](#10-ç¡¬ä»¶è®¾å¤‡ç®¡ç†)
     - [æŸ¥è¯¢æ‰€æœ‰ç”°å—è®¾å¤‡çŠ¶æ€](#101-æŸ¥è¯¢æ‰€æœ‰ç”°å—è®¾å¤‡çŠ¶æ€)
     - [æ ¹æ®è®¡åˆ’è·å–è®¾å¤‡åˆ—è¡¨](#102-æ ¹æ®è®¡åˆ’è·å–è®¾å¤‡åˆ—è¡¨)
     - [è®¾å¤‡è‡ªæ£€å®Œæ•´å·¥ä½œæµ](#103-è®¾å¤‡è‡ªæ£€å®Œæ•´å·¥ä½œæµ)
     - [è·å–æ‰¹æ¬¡è®¾å¤‡æŒ‡ä»¤](#104-è·å–æ‰¹æ¬¡è®¾å¤‡æŒ‡ä»¤)
     - [æäº¤æŒ‡ä»¤åé¦ˆ](#105-æäº¤æŒ‡ä»¤åé¦ˆ)
   - [Rice æ™ºèƒ½å†³ç­–é›†æˆ](#11-rice-æ™ºèƒ½å†³ç­–é›†æˆ)
6. [å…¸å‹ä¸šåŠ¡æµç¨‹](#å…¸å‹ä¸šåŠ¡æµç¨‹)
7. [é”™è¯¯ç è¯´æ˜](#é”™è¯¯ç è¯´æ˜)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---
## æ¦‚è¿°
### ç³»ç»Ÿä»‹ç»
å†œåœºçº§çŒæº‰è°ƒåº¦ç®—æ³•æä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
- **åŠ¨æ€æ‰¹æ¬¡æ‰§è¡Œç®¡ç†** - å®æ—¶è°ƒæ•´çŒæº‰è®¡åˆ’
- **å®æ—¶æ°´ä½æ•°æ®è·å–å’Œç®¡ç†** - æ”¯æŒå¤šæ•°æ®æº
- **æ™ºèƒ½è®¡åˆ’é‡æ–°ç”Ÿæˆ** - åŸºäºæœ€æ–°æ•°æ®è‡ªåŠ¨ä¼˜åŒ–
- **æ‰§è¡ŒçŠ¶æ€ç›‘æ§å’Œå†å²è®°å½•** - å®Œæ•´çš„è¿½è¸ªä½“ç³»
- **ç”°å—æ°´ä½è¶‹åŠ¿åˆ†æ** - æ•°æ®å¯è§†åŒ–æ”¯æŒ
- **å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”åˆ†æ** - è¾…åŠ©å†³ç­–
- **çŒæº‰è®¡åˆ’æ™ºèƒ½ä¼˜åŒ–** - å¤šç›®æ ‡ä¼˜åŒ–ç®—æ³•

### æŠ€æœ¯æ¶æ„
- **æ¡†æ¶**: FastAPI + Uvicorn
- **éƒ¨ç½²**: Docker + Docker Compose + Nginx
- **ç«¯å£**: 80 (Nginx) / 8000 (APIç›´è¿)
---

## ä¸šåŠ¡æœ¯è¯­è¡¨

### æ ¸å¿ƒæ¦‚å¿µ
| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|------|--------|
| **farm_id** | Farm ID | å†œåœºå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„å†œåœº | `"13944136728576"` |
| **plan_id** | Plan ID | çŒæº‰è®¡åˆ’æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œç”±ç”Ÿæˆè®¡åˆ’æ¥å£è¿”å› | ç”Ÿäº§ç¯å¢ƒ: `"/app/output/irrigation_plan_*.json"`<br>æœ¬åœ°ç¯å¢ƒ: `"e:/irrigation_schedule/farm_irrigation/output/irrigation_plan_*.json"` |
| **execution_id** | Execution ID | æ‰§è¡Œä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œç”±å¯åŠ¨æ‰§è¡Œæ¥å£è¿”å› | `"exec_20250109_123456"` |
| **batch_index** | Batch Index | æ‰¹æ¬¡ç´¢å¼•å·ï¼Œ**ä»1å¼€å§‹è®¡æ•°**ï¼ˆä¸æ˜¯0ï¼‰ | `1, 2, 3, 4` |
| **field_id** | Field ID | ç”°å—å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ ¼å¼ï¼š`ç‰‡åŒº-é—¸é—¨-ç”°å—` | `"S3-G2-F1"` |
| **segment_id** | Segment ID | ç‰‡åŒºæ ‡è¯†ç¬¦ï¼Œè¡¨ç¤ºä¸€ä¸ªçŒæº‰åŒºåŸŸ | `"S3", "S4", "S5"` |

### çŒæº‰ç›¸å…³
| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ | å•ä½ |
|------|------|------|------|
| **wl_mm** | Current Water Level | ç”°å—å½“å‰å®é™…æ°´ä½æ·±åº¦ | æ¯«ç±³ (mm) |
| **wl_low** | Low Water Level | ä½æ°´ä½é˜ˆå€¼ï¼Œ**è§¦å‘çŒæº‰çš„åˆ¤æ–­æ ‡å‡†** | æ¯«ç±³ (mm) |
| **wl_opt** | Optimal Water Level | æœ€ä¼˜æ°´ä½ï¼Œ**çŒæº‰çš„ç›®æ ‡æ°´ä½** | æ¯«ç±³ (mm) |
| **wl_high** | High Water Level | é«˜æ°´ä½é˜ˆå€¼ï¼Œè¶…è¿‡åˆ™ä¸éœ€è¦çŒæº‰ | æ¯«ç±³ (mm) |
| **d_target_mm** | Target Irrigation Depth | ç›®æ ‡çŒæº‰æ°´æ·±ï¼ˆå‚è€ƒå€¼ï¼Œå®é™…ä½¿ç”¨åŠ¨æ€è®¡ç®—ï¼‰ | æ¯«ç±³ (mm) |
| **area_mu** | Area | ç”°å—é¢ç§¯ | äº© (mu) |
| **deficit_vol_m3** | Deficit Volume | **åŠ¨æ€è®¡ç®—çš„ç¼ºæ°´é‡**ï¼ˆ= ç”°å—æ•°é‡ Ã— ç¼ºæ°´æ·±åº¦ Ã— 0.666667ï¼‰ | ç«‹æ–¹ç±³ (mÂ³) |
| **eta_hours** | ETA Hours | é¢„è®¡å®Œæˆæ—¶é—´ï¼ˆåŸºäºå®é™…ç¼ºæ°´é‡åŠ¨æ€è®¡ç®—ï¼‰ | å°æ—¶ (h) |

**ğŸ’¡ çŒæº‰é‡åŠ¨æ€è®¡ç®—é€»è¾‘ï¼š**
```
åˆ¤æ–­æ¡ä»¶ï¼šif wl_mm < wl_low â†’ éœ€è¦çŒæº‰
ç¼ºæ°´æ·±åº¦ï¼šdeficit_mm = wl_opt - wl_mm
ç¼ºæ°´é‡ï¼šdeficit_m3 = area_mu Ã— deficit_mm Ã— 0.666667
çŒæº‰ç›®æ ‡ï¼šä»å½“å‰æ°´ä½ (wl_mm) çŒæº‰åˆ°æœ€ä¼˜æ°´ä½ (wl_opt)
```

**ç¤ºä¾‹ï¼š**
- ç”°å—é¢ç§¯ = 10äº©
- wl_low = 80mm, wl_opt = 100mm
- å½“å‰æ°´ä½ = 75mm

```
åˆ¤æ–­ï¼š75 < 80 âœ… éœ€è¦çŒæº‰
ç¼ºæ°´æ·±åº¦ï¼š100 - 75 = 25mm
ç¼ºæ°´é‡ï¼š10 Ã— 25 Ã— 0.666667 = 167 mÂ³
çŒæº‰åï¼š75 + 25 = 100mm (è¾¾åˆ°æœ€ä¼˜æ°´ä½)
```

### è®¾å¤‡ç›¸å…³
| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|------|--------|
| **pump_id** | Pump ID | æ°´æ³µæ ‡è¯†ç¬¦ | `"P1", "P2"` |
| **active_pumps** | Active Pumps | å½“å‰å¯ç”¨çš„æ°´æ³µåˆ—è¡¨ | `["P1", "P2"]` |
| **q_avail_m3ph** | Available Flow | å¯ç”¨æµé‡ï¼ˆæ¯å°æ—¶ç«‹æ–¹ç±³ï¼‰ | `240.0` |
| **power_kw** | Power | æ°´æ³µåŠŸç‡ | åƒç“¦ (kW) |

### æ—¶é—´ç›¸å…³
| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ | æ ¼å¼/å•ä½ |
|------|------|------|----------|
| **t_start_h** | Start Time | å¼€å§‹æ—¶é—´ï¼ˆç›¸å¯¹æ—¶é—´ï¼‰ | å°æ—¶ (h)ï¼Œå¦‚ `22.0` è¡¨ç¤ºæ™šä¸Š10ç‚¹ |
| **t_end_h** | End Time | ç»“æŸæ—¶é—´ï¼ˆç›¸å¯¹æ—¶é—´ï¼‰ | å°æ—¶ (h)ï¼Œå¦‚ `40.28` è¡¨ç¤ºä»èµ·å§‹ç‚¹å40.28å°æ—¶ |
| **duration_h** | Duration | æŒç»­æ—¶é•¿ | å°æ—¶ (h) |
| **timestamp** | Timestamp | ç»å¯¹æ—¶é—´æˆ³ | ISO 8601æ ¼å¼ï¼Œå¦‚ `"2025-01-09T12:34:56.789Z"` |

### ä¼˜åŒ–ç›¸å…³
| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| **cost_minimization** | Cost Minimization | æˆæœ¬æœ€å°åŒ–ï¼Œä¼˜å…ˆé™ä½ç”µè´¹æˆæœ¬ |
| **time_minimization** | Time Minimization | æ—¶é—´æœ€å°åŒ–ï¼Œæœ€å¿«å®ŒæˆçŒæº‰ä»»åŠ¡ |
| **balanced** | Balanced | å‡è¡¡ä¼˜åŒ–ï¼Œåœ¨æˆæœ¬å’Œæ—¶é—´ä¹‹é—´å¹³è¡¡ |
| **off_peak** | Off-Peak | é¿å³°ç”¨ç”µï¼Œé¿å¼€å³°æ®µç”µä»·æ—¶æ®µ |
| **water_saving** | Water Saving | èŠ‚æ°´ä¼˜åŒ–ï¼Œå‡å°‘æ°´èµ„æºæ¶ˆè€— |

### æ‰§è¡Œæ¨¡å¼
| æ¨¡å¼ | è¯´æ˜ |
|------|------|
| **simulation** | æ¨¡æ‹Ÿæ¨¡å¼ï¼Œä¸å®é™…æ§åˆ¶è®¾å¤‡ï¼Œä»…ç”¨äºæµ‹è¯•å’Œé¢„è§ˆ |
| **production** | ç”Ÿäº§æ¨¡å¼ï¼Œå®é™…æ§åˆ¶çŒæº‰è®¾å¤‡æ‰§è¡Œ |

### æ•°æ®è´¨é‡
| ç­‰çº§ | è¯´æ˜ |
|------|------|
| **good** | è‰¯å¥½ï¼Œæ•°æ®æ¥è‡ªå¯é ä¼ æ„Ÿå™¨æˆ–ç»è¿‡éªŒè¯ |
| **fair** | ä¸€èˆ¬ï¼Œæ•°æ®å¯ç”¨ä½†å¯èƒ½å­˜åœ¨åå·® |
| **poor** | è¾ƒå·®ï¼Œæ•°æ®è´¨é‡ä¸ä½³ï¼Œå»ºè®®è°¨æ…ä½¿ç”¨ |

### æ•°æ®æ¥æº
| æ¥æº | è¯´æ˜ |
|------|------|
| **sensor** | ä¼ æ„Ÿå™¨è‡ªåŠ¨é‡‡é›† |
| **manual** | äººå·¥æ‰‹åŠ¨è¾“å…¥ |
| **estimated** | ç³»ç»Ÿä¼°ç®—å€¼ |

---

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€é…ç½®

```javascript
// ç¯å¢ƒé…ç½®
const BASE_URL = 'http://120.55.127.125';
const API_BASE_URL = `${BASE_URL}/api`;

// é€šç”¨è¯·æ±‚å¤´
const headers = {
  'Content-Type': 'application/json',
  'Accept': 'application/json'
};
```

### æœ€ç®€å•çš„è°ƒç”¨ç¤ºä¾‹
```javascript
// 1. å¥åº·æ£€æŸ¥
fetch(`${BASE_URL}/api/system/health-check`, {
  method: 'POST',
  headers: headers
})
.then(res => res.json())
.then(data => console.log(data));

// 2. è·å–APIä¿¡æ¯
fetch(`${BASE_URL}/api/info`)
.then(res => res.json())
.then(data => console.log(data));
```

---
## è®¤è¯æ–¹å¼

**å½“å‰ç‰ˆæœ¬**: æ— éœ€è®¤è¯  
**æœªæ¥ç‰ˆæœ¬**: å°†æ”¯æŒ JWT Token è®¤è¯

```javascript
// é¢„ç•™çš„è®¤è¯å¤´ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰
headers: {
  'Authorization': 'Bearer YOUR_JWT_TOKEN'
}
```

---

## æ¥å£åˆ—è¡¨

### 1. ç³»ç»Ÿç®¡ç†

#### 1.1 å¥åº·æ£€æŸ¥

**æ¥å£è¯´æ˜**: æ£€æŸ¥ç³»ç»Ÿå„ç»„ä»¶çš„å¥åº·çŠ¶æ€

**è¯·æ±‚**
```
POST /api/system/health-check
```

**å“åº”ç¤ºä¾‹**
```json
{
  "status": "healthy",
  "timestamp": "2025-01-09T12:34:56.789Z",
  "components": {
    "scheduler": "ok",
    "waterlevel_manager": "ok",
    "plan_regenerator": "ok",
    "status_manager": "ok"
  }
}
```

**å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| status | string | ç³»ç»Ÿæ€»ä½“çŠ¶æ€: `healthy`/`degraded`/`unhealthy` |
| timestamp | string | ISO 8601 æ ¼å¼æ—¶é—´æˆ³ |
| components | object | å„ç»„ä»¶çŠ¶æ€ï¼Œå€¼ä¸º `ok`/`not_initialized` |

---

#### 1.2 è·å–ç³»ç»ŸçŠ¶æ€

**æ¥å£è¯´æ˜**: è·å–ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œç»„ä»¶åˆå§‹åŒ–æƒ…å†µ

**è¯·æ±‚**
```
GET /api/system/status
```

**å“åº”ç¤ºä¾‹**
```json
{
  "system_status": "running",
  "scheduler_initialized": true,
  "waterlevel_manager_initialized": true,
  "plan_regenerator_initialized": true,
  "status_manager_initialized": true,
  "current_time": "2025-01-09T12:34:56.789Z",
  "uptime_seconds": 3600.5
}
```

---

#### 1.3 è·å–APIä¿¡æ¯

**æ¥å£è¯´æ˜**: è·å–APIç‰ˆæœ¬å’ŒåŠŸèƒ½åˆ—è¡¨

**è¯·æ±‚**
```
GET /api/info
```

**å“åº”ç¤ºä¾‹**
```json
{
  "title": "æ™ºèƒ½çŒæº‰åŠ¨æ€æ‰§è¡Œç³»ç»ŸAPI",
  "description": "åŸºäºå®æ—¶æ°´ä½æ•°æ®çš„æ™ºèƒ½çŒæº‰æ‰¹æ¬¡åŠ¨æ€æ‰§è¡Œç³»ç»Ÿ",
  "version": "1.0.0",
  "features": [
    "åŠ¨æ€æ‰¹æ¬¡æ‰§è¡Œç®¡ç†",
    "å®æ—¶æ°´ä½æ•°æ®è·å–å’Œç®¡ç†",
    "æ™ºèƒ½è®¡åˆ’é‡æ–°ç”Ÿæˆ",
    "æ‰§è¡ŒçŠ¶æ€ç›‘æ§å’Œå†å²è®°å½•",
    "ç”°å—æ°´ä½è¶‹åŠ¿åˆ†æ",
    "å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”åˆ†æ",
    "çŒæº‰è®¡åˆ’æ™ºèƒ½ä¼˜åŒ–"
  ],
  "endpoints": {
    "system": "/api/system/*",
    "execution": "/api/execution/*",
    "water_levels": "/api/water-levels/*",
    "regeneration": "/api/regeneration/*",
    "batches": "/api/batches/*",
    "irrigation": "/api/irrigation/*",
    "data": "/api/data/*"
  }
}
```

---

### 2. çŒæº‰è®¡åˆ’ç”Ÿæˆ

#### 2.1 ç”ŸæˆçŒæº‰è®¡åˆ’

**æ¥å£è¯´æ˜**: æ ¹æ®é…ç½®ç”Ÿæˆå®Œæ•´çš„çŒæº‰è®¡åˆ’ï¼Œæ”¯æŒå¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”

**è¯·æ±‚**
```
POST /api/irrigation/plan-generation
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "farm_id": "13944136728576",
  "config_path": "",
  "output_dir": "",
  "scenario_name": "test_scenario",
  "multi_pump_scenarios": true
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| farm_id | string | âœ… æ˜¯ | - | å†œåœºå”¯ä¸€æ ‡è¯†ç¬¦ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æ ‡è¯†å½“å‰æ“ä½œçš„å†œåœºï¼Œç³»ç»Ÿæ ¹æ®æ­¤IDåŠ è½½å¯¹åº”çš„å†œåœºé…ç½®å’Œç”°å—æ•°æ®ã€‚<br>**ç¤ºä¾‹**: `"13944136728576"` |
| config_path | string | âŒ å¦ | `"config.json"` | é…ç½®æ–‡ä»¶è·¯å¾„ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æŒ‡å®šè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œç•™ç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤é…ç½®æ–‡ä»¶ã€‚é…ç½®æ–‡ä»¶åŒ…å«æ°´æ³µå‚æ•°ã€ç”µä»·ã€çŒæº‰æ·±åº¦ç­‰è®¾ç½®ã€‚<br>**ç¤ºä¾‹**: `""` (ä½¿ç”¨é»˜è®¤) æˆ– `"custom_config.json"` |
| output_dir | string | âŒ å¦ | `"/app/output"` | è¾“å‡ºç›®å½•è·¯å¾„ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: çŒæº‰è®¡åˆ’æ–‡ä»¶çš„ä¿å­˜ç›®å½•ï¼Œç•™ç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤è¾“å‡ºç›®å½•ã€‚<br>**ç¤ºä¾‹**: `""` (ä½¿ç”¨é»˜è®¤) æˆ– `"/custom/path"` |
| scenario_name | string | âŒ å¦ | `"default"` | åœºæ™¯åç§°æ ‡è¯†ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ä¸ºæœ¬æ¬¡ç”Ÿæˆçš„è®¡åˆ’å‘½åï¼Œä¾¿äºåç»­è¯†åˆ«å’Œç®¡ç†ä¸åŒåœºæ™¯çš„æ–¹æ¡ˆï¼ˆå¦‚"å¤å­£çŒæº‰"ã€"åº”æ€¥æ–¹æ¡ˆ"ç­‰ï¼‰ã€‚<br>**ç¤ºä¾‹**: `"test_scenario"`, `"summer_plan"` |
| multi_pump_scenarios | boolean | âŒ å¦ | `false` | æ˜¯å¦ç”Ÿæˆå¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: å¯ç”¨åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¸åŒæ°´æ³µç»„åˆçš„æ–¹æ¡ˆï¼ˆå¦‚P1å•ç‹¬ã€P2å•ç‹¬ã€P1+P2ç»„åˆï¼‰ï¼Œå¹¶è¿›è¡Œæˆæœ¬å’Œæ—¶é•¿å¯¹æ¯”ï¼Œå¸®åŠ©å†³ç­–é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆã€‚<br>**å»ºè®®**: é¦–æ¬¡è§„åˆ’æˆ–éœ€è¦å¯¹æ¯”æ—¶è®¾ä¸º`true`ã€‚<br>**ç¤ºä¾‹**: `true` |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "çŒæº‰è®¡åˆ’ç”ŸæˆæˆåŠŸ",
  "plan_id": "/app/output/irrigation_plan_20250109_123456.json",
  "data": {
    "calc": {
      "A_cover_mu": 79.99996,
      "q_avail_m3ph": 240.0,
      "t_win_h": 20.0,
      "d_target_mm": 90.0
    },
    "batches": [
      {
        "index": 1,
        "area_mu": 73.107,
        "fields": [
          {
            "id": "S3-G2-F1",
            "area_mu": 5.225,
            "segment_id": "S3",
            "wl_mm": 0.0
          }
        ],
        "stats": {
          "deficit_vol_m3": 4386.42,
          "cap_vol_m3": 4800.0,
          "eta_hours": 18.28
        }
      }
    ],
    "steps": [
      {
        "t_start_h": 22.0,
        "t_end_h": 40.28,
        "label": "æ‰¹æ¬¡ 1",
        "commands": [
          {
            "action": "start",
            "target": "P2",
            "value": null,
            "t_start_h": 22.0,
            "t_end_h": 40.28
          }
        ]
      }
    ]
  },
  "multi_pump_scenarios": {
    "scenarios": [
      {
        "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
        "pumps_used": ["P2"],
        "total_electricity_cost": 1774.17,
        "total_eta_h": 73.92,
        "coverage_info": {
          "covered_segments": ["S3", "S4", "S5", "S6", "S7", "S8"],
          "total_covered_segments": 6
        }
      }
    ],
    "analysis": {
      "total_fields_below_threshold": 36,
      "min_fields_trigger": 1,
      "trigger_status": "å·²è¾¾åˆ°è§¦å‘æ¡ä»¶"
    },
    "total_scenarios": 4
  }
}
```

**å…³é”®å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| plan_id | string | **é‡è¦ï¼** ç”Ÿæˆçš„è®¡åˆ’æ–‡ä»¶å®Œæ•´è·¯å¾„ï¼Œç”¨äºåç»­æ¥å£ |
| data.batches | array | çŒæº‰æ‰¹æ¬¡åˆ—è¡¨ |
| data.steps | array | æ‰§è¡Œæ­¥éª¤åˆ—è¡¨ |
| multi_pump_scenarios | object | å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”æ•°æ®ï¼ˆå¦‚æœå¯ç”¨ï¼‰ |

---

#### 2.2 ä¸Šä¼ é…ç½®å¹¶ç”Ÿæˆè®¡åˆ’

**æ¥å£è¯´æ˜**: ä¸Šä¼ è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å¹¶ç”ŸæˆçŒæº‰è®¡åˆ’

**è¯·æ±‚**
```
POST /api/irrigation/plan-with-upload
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•° (FormData)**
```javascript
const formData = new FormData();
formData.append('farm_id', '13944136728576');
formData.append('scenario_name', 'upload_test');
formData.append('multi_pump_scenarios', 'true');
formData.append('config_file', fileBlob, 'config.json');
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| farm_id | string | æ˜¯ | å†œåœºID |
| scenario_name | string | å¦ | åœºæ™¯åç§° |
| multi_pump_scenarios | string | å¦ | "true"/"false" |
| config_file | file | å¦ | é…ç½®JSONæ–‡ä»¶ |

**å“åº”æ ¼å¼**: ä¸æ¥å£2.1ç›¸åŒ

---

### 3. å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”

#### 3.1 ç”Ÿæˆå¤šæ°´æ³µæ–¹æ¡ˆ

**æ¥å£è¯´æ˜**: ç‹¬ç«‹ç”Ÿæˆå¤šä¸ªæ°´æ³µç»„åˆçš„çŒæº‰æ–¹æ¡ˆï¼Œç”¨äºæ–¹æ¡ˆå¯¹æ¯”å’Œå†³ç­–

**è¯·æ±‚**
```
POST /api/irrigation/multi-pump-scenarios
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "config_file": "config.json",
  "active_pumps": null,
  "zone_ids": null,
  "use_realtime_wl": true,
  "min_fields_trigger": 1
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| config_file | string | âœ… æ˜¯ | - | é…ç½®æ–‡ä»¶åç§°ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼ŒåŒ…å«å†œåœºå¸ƒå±€ã€æ°´æ³µå‚æ•°ã€ç”µä»·ç­‰åŸºç¡€æ•°æ®ã€‚<br>**ç¤ºä¾‹**: `"config.json"` |
| active_pumps | array\|null | âŒ å¦ | `null` | æŒ‡å®šå‚ä¸å¯¹æ¯”çš„æ°´æ³µåˆ—è¡¨ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: é™åˆ¶å¯¹æ¯”æ–¹æ¡ˆä¸­ä½¿ç”¨çš„æ°´æ³µï¼Œ`null`è¡¨ç¤ºä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­æ‰€æœ‰å¯ç”¨æ°´æ³µã€‚å¯ç”¨äºæ¨¡æ‹ŸæŸå°æ°´æ³µæ•…éšœæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆã€‚<br>**ç¤ºä¾‹**: `["P1", "P2"]` æˆ– `null` (å…¨éƒ¨æ°´æ³µ) |
| zone_ids | array\|null | âŒ å¦ | `null` | æŒ‡å®šçŒæº‰çš„ç‰‡åŒºåˆ—è¡¨ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: é™åˆ¶åªå¯¹æŒ‡å®šç‰‡åŒºç”Ÿæˆæ–¹æ¡ˆï¼Œ`null`è¡¨ç¤ºè¦†ç›–æ‰€æœ‰éœ€è¦çŒæº‰çš„ç‰‡åŒºã€‚å¯ç”¨äºåˆ†åŒºåŸŸçŒæº‰è§„åˆ’ã€‚<br>**ç¤ºä¾‹**: `["S3", "S4"]` æˆ– `null` (å…¨éƒ¨ç‰‡åŒº) |
| use_realtime_wl | boolean | âŒ å¦ | `true` | æ˜¯å¦ä½¿ç”¨å®æ—¶æ°´ä½æ•°æ®ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: `true`ä»æ°´ä½ç®¡ç†ç³»ç»Ÿè·å–æœ€æ–°æ•°æ®ï¼Œ`false`ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤æ°´ä½ã€‚å»ºè®®å¼€å¯ä»¥è·å¾—å‡†ç¡®çš„çŒæº‰æ–¹æ¡ˆã€‚<br>**ç¤ºä¾‹**: `true` |
| min_fields_trigger | integer\|null | âŒ å¦ | `null` | è§¦å‘çŒæº‰çš„æœ€å°ç”°å—æ•°é˜ˆå€¼ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: åªæœ‰å½“ä½äºç›®æ ‡æ°´ä½çš„ç”°å—æ•°é‡ â‰¥ æ­¤å€¼æ—¶ï¼Œæ‰ç”ŸæˆçŒæº‰æ–¹æ¡ˆã€‚`null`ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å€¼ã€‚å¯ç”¨äºé¿å…ä¸ºå°‘é‡ç”°å—å¯åŠ¨å¤§å‹æ°´æ³µã€‚<br>**ç¤ºä¾‹**: `1` (æœ‰1å—ç”°éœ€è¦å°±çŒæº‰) æˆ– `5` (è‡³å°‘5å—ç”°éœ€è¦æ‰çŒæº‰) |

**å“åº”ç¤ºä¾‹**
```json
{
  "scenarios": [
    {
      "scenario_name": "P1å•ç‹¬ä½¿ç”¨",
      "pumps_used": ["P1"],
      "total_electricity_cost": 2150.5,
      "total_eta_h": 85.3,
      "total_pump_runtime_hours": {
        "P1": 70.2
      },
      "coverage_info": {
        "covered_segments": ["S1", "S2"],
        "total_covered_segments": 2
      },
      "plan": {
        "batches": [],
        "steps": []
      }
    },
    {
      "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
      "pumps_used": ["P2"],
      "total_electricity_cost": 1774.17,
      "total_eta_h": 73.92,
      "coverage_info": {
        "covered_segments": ["S3", "S4", "S5", "S6", "S7", "S8"],
        "total_covered_segments": 6
      }
    },
    {
      "scenario_name": "P1+P2ç»„åˆ",
      "pumps_used": ["P1", "P2"],
      "total_electricity_cost": 1950.8,
      "total_eta_h": 65.5,
      "coverage_info": {
        "covered_segments": ["S1", "S2", "S3", "S4", "S5", "S6", "S7", "S8"],
        "total_covered_segments": 8
      }
    }
  ],
  "analysis": {
    "total_fields_below_threshold": 36,
    "min_fields_trigger": 1,
    "trigger_status": "å·²è¾¾åˆ°è§¦å‘æ¡ä»¶",
    "total_fields_to_irrigate": 36,
    "required_segments": ["S3", "S4", "S5", "S6", "S7", "S8"],
    "valid_pump_combinations": [["P2"], ["P1", "P2"]]
  },
  "total_scenarios": 3
}
```

**å…³é”®å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| scenarios | array | æ‰€æœ‰å¯è¡Œæ–¹æ¡ˆåˆ—è¡¨ |
| scenarios[].total_electricity_cost | number | æ€»ç”µè´¹ï¼ˆå…ƒï¼‰ |
| scenarios[].total_eta_h | number | æ€»æ—¶é•¿ï¼ˆå°æ—¶ï¼‰ |
| scenarios[].pumps_used | array | ä½¿ç”¨çš„æ°´æ³µåˆ—è¡¨ |
| analysis.trigger_status | string | è§¦å‘æ¡ä»¶çŠ¶æ€ |
| analysis.valid_pump_combinations | array | æœ‰æ•ˆçš„æ°´æ³µç»„åˆ |

---

### 4. è®¡åˆ’ä¼˜åŒ–

#### 4.1 æ™ºèƒ½ä¼˜åŒ–çŒæº‰è®¡åˆ’

**æ¥å£è¯´æ˜**: åŸºäºä¸åŒä¼˜åŒ–ç›®æ ‡ç”Ÿæˆå¤šä¸ªä¼˜åŒ–æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æˆæœ¬æœ€å°åŒ–ã€æ—¶é—´æœ€å°åŒ–ã€å‡è¡¡ä¼˜åŒ–ã€é¿å³°ç”¨ç”µç­‰

**è¯·æ±‚**
```
POST /api/irrigation/plan-optimization
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "original_plan_id": "/app/output/irrigation_plan_20250109_123456.json",
  "optimization_goals": [
    "cost_minimization",
    "time_minimization",
    "balanced",
    "off_peak"
  ],
  "constraints": {
    "max_duration_hours": 24,
    "electricity_price_schedule": {
      "peak": {
        "hours": [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21],
        "price": 1.0
      },
      "valley": {
        "hours": [22, 23, 0, 1, 2, 3, 4, 5, 6, 7],
        "price": 0.4
      }
    },
    "available_pumps": ["P1", "P2"]
  }
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| original_plan_id | string | âœ… æ˜¯ | - | åŸå§‹çŒæº‰è®¡åˆ’IDã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç”±"ç”ŸæˆçŒæº‰è®¡åˆ’"æ¥å£è¿”å›çš„`plan_id`ï¼Œä½œä¸ºä¼˜åŒ–çš„åŸºç¡€æ–¹æ¡ˆã€‚ç³»ç»Ÿä¼šåŸºäºæ­¤æ–¹æ¡ˆç”Ÿæˆå¤šä¸ªä¼˜åŒ–ç‰ˆæœ¬ã€‚<br>**æ¥æº**: `/api/irrigation/plan-generation` çš„å“åº”ä¸­çš„ `plan_id` å­—æ®µ<br>**ç¤ºä¾‹**: `"/app/output/irrigation_plan_20250109_123456.json"` |
| optimization_goals | array | âœ… æ˜¯ | - | ä¼˜åŒ–ç›®æ ‡åˆ—è¡¨ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æŒ‡å®šè¦ç”Ÿæˆçš„ä¼˜åŒ–æ–¹æ¡ˆç±»å‹ï¼Œå¯åŒæ—¶æŒ‡å®šå¤šä¸ªç›®æ ‡ï¼Œç³»ç»Ÿä¼šä¸ºæ¯ä¸ªç›®æ ‡ç”Ÿæˆä¸€ä¸ªç‹¬ç«‹æ–¹æ¡ˆã€‚<br>**å»ºè®®**: è‡³å°‘é€‰æ‹©2-3ä¸ªç›®æ ‡è¿›è¡Œå¯¹æ¯”<br>**ç¤ºä¾‹**: `["cost_minimization", "time_minimization", "balanced"]` |
| constraints | object | âŒ å¦ | `{}` | çº¦æŸæ¡ä»¶é…ç½®ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: é™åˆ¶ä¼˜åŒ–æ–¹æ¡ˆçš„è¾¹ç•Œæ¡ä»¶ï¼Œå¦‚æœ€å¤§æ—¶é•¿ã€ç”µä»·æ—¶æ®µã€å¯ç”¨æ°´æ³µç­‰ã€‚<br>**å­å­—æ®µ**:<br>â€¢ `max_duration_hours`: æœ€å¤§å…è®¸æ—¶é•¿ï¼ˆå°æ—¶ï¼‰<br>â€¢ `electricity_price_schedule`: ç”µä»·æ—¶æ®µè¡¨<br>â€¢ `available_pumps`: å¯ç”¨æ°´æ³µåˆ—è¡¨<br>**ç¤ºä¾‹**: è§ä¸‹æ–¹è¯¦ç»†è¯´æ˜ |

**optimization_goals å¯é€‰å€¼**

| å€¼ | åç§° | ä¸šåŠ¡ç›®æ ‡ | é€‚ç”¨åœºæ™¯ |
|---|------|----------|----------|
| `cost_minimization` | æˆæœ¬æœ€å°åŒ– | é™ä½ç”µè´¹æ”¯å‡ºï¼Œä¼˜å…ˆåœ¨ä½è°·ç”µä»·æ—¶æ®µçŒæº‰ | ç”µè´¹é¢„ç®—ç´§å¼ ï¼Œå¯¹æ—¶é—´è¦æ±‚ä¸é«˜ |
| `time_minimization` | æ—¶é—´æœ€å°åŒ– | æœ€å¿«å®Œæˆä»»åŠ¡ï¼Œä½¿ç”¨æœ€å¤§æ°´æ³µç»„åˆ | åº”æ€¥çŒæº‰ï¼Œå¤©æ°”æ¡ä»¶ç´§è¿« |
| `balanced` | å‡è¡¡ä¼˜åŒ– | åœ¨æˆæœ¬å’Œæ—¶é—´ä¹‹é—´å–å¾—å¹³è¡¡ | æ—¥å¸¸çŒæº‰ï¼Œç»¼åˆè€ƒè™‘æ•ˆç‡å’Œæˆæœ¬ |
| `off_peak` | é¿å³°ç”¨ç”µ | å®Œå…¨é¿å¼€å³°æ®µç”µä»·ï¼Œé™ä½ç”µè´¹ | æ‰§è¡Œåˆ†æ—¶ç”µä»·æ”¿ç­–çš„å†œåœº |
| `water_saving` | èŠ‚æ°´ä¼˜åŒ– | å‡å°‘æ°´èµ„æºæ¶ˆè€—ï¼Œæé«˜åˆ©ç”¨ç‡ | æ°´èµ„æºç´§å¼ åœ°åŒº |

**constraints è¯¦ç»†è¯´æ˜**

| å­å‚æ•° | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `max_duration_hours` | number | æœ€å¤§å…è®¸æ‰§è¡Œæ—¶é•¿ï¼ˆå°æ—¶ï¼‰ã€‚è¶…è¿‡æ­¤æ—¶é•¿çš„æ–¹æ¡ˆä¼šè¢«è¿‡æ»¤ã€‚<br>**ç¤ºä¾‹**: `24` (å¿…é¡»åœ¨24å°æ—¶å†…å®Œæˆ) |
| `electricity_price_schedule` | object | ç”µä»·æ—¶æ®µé…ç½®ã€‚<br>**åŒ…å«**: `peak`(å³°æ®µ) å’Œ `valley`(è°·æ®µ)<br>**æ¯ä¸ªæ—¶æ®µåŒ…å«**: `hours`(å°æ—¶æ•°ç»„) å’Œ `price`(ç”µä»·)<br>**ç¤ºä¾‹**: `{"peak": {"hours": [8-21], "price": 1.0}, "valley": {"hours": [22-7], "price": 0.4}}` |
| `available_pumps` | array | å¯ç”¨æ°´æ³µåˆ—è¡¨ï¼Œé™åˆ¶åªä½¿ç”¨æŒ‡å®šæ°´æ³µã€‚<br>**ç¤ºä¾‹**: `["P1", "P2"]` |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æˆåŠŸç”Ÿæˆ 4 ä¸ªä¼˜åŒ–æ–¹æ¡ˆ",
  "total_scenarios": 4,
  "scenarios": [
    {
      "name": "æˆæœ¬æœ€å°åŒ–æ–¹æ¡ˆ",
      "description": "ä¼˜å…ˆé™ä½ç”µè´¹æˆæœ¬ï¼Œåœ¨ä½è°·ç”µä»·æ—¶æ®µé›†ä¸­çŒæº‰",
      "total_eta_h": 78.5,
      "total_electricity_cost": 1580.3,
      "optimization_type": "cost_minimization",
      "plan": {
        "batches": [],
        "steps": []
      }
    },
    {
      "name": "æ—¶é—´æœ€å°åŒ–æ–¹æ¡ˆ",
      "description": "æœ€å¿«å®ŒæˆçŒæº‰ä»»åŠ¡ï¼Œä½¿ç”¨æœ€å¤§æ³µç»„åˆ",
      "total_eta_h": 55.2,
      "total_electricity_cost": 2150.8,
      "optimization_type": "time_minimization"
    },
    {
      "name": "å‡è¡¡ä¼˜åŒ–æ–¹æ¡ˆ",
      "description": "åœ¨æˆæœ¬å’Œæ—¶é—´ä¹‹é—´å¯»æ±‚æœ€ä½³å¹³è¡¡",
      "total_eta_h": 65.8,
      "total_electricity_cost": 1820.5,
      "optimization_type": "balanced"
    },
    {
      "name": "é¿å³°ç”¨ç”µæ–¹æ¡ˆ",
      "description": "å®Œå…¨é¿å¼€å³°æ®µç”µä»·æ—¶æ®µ",
      "total_eta_h": 82.3,
      "total_electricity_cost": 1620.7,
      "optimization_type": "off_peak"
    }
  ],
  "comparison": {
    "recommended": "æˆæœ¬æœ€å°åŒ–æ–¹æ¡ˆ",
    "cost_range": {
      "min": 1580.3,
      "max": 2150.8,
      "savings_percent": 26.5
    },
    "time_range": {
      "min": 55.2,
      "max": 82.3
    }
  },
  "base_plan_summary": {
    "total_eta_h": 73.92,
    "total_electricity_cost": 1774.17,
    "total_batches": 4
  }
}
```

**å…³é”®å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| scenarios | array | ä¼˜åŒ–æ–¹æ¡ˆåˆ—è¡¨ |
| scenarios[].name | string | æ–¹æ¡ˆåç§° |
| scenarios[].description | string | æ–¹æ¡ˆæè¿° |
| scenarios[].total_eta_h | number | æ€»æ—¶é•¿ï¼ˆå°æ—¶ï¼‰ |
| scenarios[].total_electricity_cost | number | æ€»ç”µè´¹ï¼ˆå…ƒï¼‰ |
| comparison.recommended | string | æ¨èæ–¹æ¡ˆ |
| comparison.cost_range.savings_percent | number | æœ€å¤§èŠ‚çœç™¾åˆ†æ¯” |

---

### 5. åŠ¨æ€æ‰§è¡Œç®¡ç†

#### 5.1 å¯åŠ¨åŠ¨æ€æ‰§è¡Œ

**æ¥å£è¯´æ˜**: å¯åŠ¨çŒæº‰è®¡åˆ’çš„åŠ¨æ€æ‰§è¡Œï¼Œæ”¯æŒå®æ—¶æ°´ä½æ›´æ–°å’Œè®¡åˆ’é‡æ–°ç”Ÿæˆ

**è¯·æ±‚**
```
POST /api/execution/start
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "plan_file_path": "/app/output/irrigation_plan_20250109_123456.json",
  "farm_id": "13944136728576",
  "config_file_path": "",
  "auto_start": true,
  "water_level_update_interval_minutes": 30,
  "enable_plan_regeneration": true,
  "execution_mode": "simulation"
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| plan_file_path | string | âœ… æ˜¯ | - | çŒæº‰è®¡åˆ’æ–‡ä»¶è·¯å¾„ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: è¦æ‰§è¡Œçš„çŒæº‰è®¡åˆ’ï¼Œä½¿ç”¨"ç”ŸæˆçŒæº‰è®¡åˆ’"æ¥å£è¿”å›çš„`plan_id`ã€‚<br>**é‡è¦**: å¿…é¡»ä½¿ç”¨å®Œæ•´è·¯å¾„ï¼Œç³»ç»Ÿä¼šæ ¹æ®æ­¤æ–‡ä»¶çš„æ‰¹æ¬¡ã€æ—¶é—´ã€è®¾å¤‡ä¿¡æ¯è¿›è¡Œæ‰§è¡Œè°ƒåº¦ã€‚<br>**æ¥æº**: `/api/irrigation/plan-generation` æˆ– `/api/irrigation/plan-optimization` çš„ `plan_id`<br>**ç¤ºä¾‹**: `"/app/output/irrigation_plan_20250109_123456.json"` |
| farm_id | string | âœ… æ˜¯ | - | å†œåœºå”¯ä¸€æ ‡è¯†ç¬¦ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: å¿…é¡»ä¸ç”Ÿæˆè®¡åˆ’æ—¶ä½¿ç”¨çš„`farm_id`ä¸€è‡´ï¼Œç”¨äºåŠ è½½å†œåœºé…ç½®å’ŒéªŒè¯è®¡åˆ’æœ‰æ•ˆæ€§ã€‚<br>**ç¤ºä¾‹**: `"13944136728576"` |
| config_file_path | string | âŒ å¦ | `"config.json"` | é…ç½®æ–‡ä»¶è·¯å¾„ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼ŒåŒ…å«è®¾å¤‡é€šä¿¡å‚æ•°ã€å®‰å…¨é˜ˆå€¼ç­‰ã€‚ç•™ç©ºä½¿ç”¨é»˜è®¤é…ç½®ã€‚<br>**ç¤ºä¾‹**: `""` (ä½¿ç”¨é»˜è®¤) |
| auto_start | boolean | âŒ å¦ | `true` | æ˜¯å¦ç«‹å³å¼€å§‹æ‰§è¡Œã€‚<br>**ä¸šåŠ¡å«ä¹‰**: <br>â€¢ `true`: å¯åŠ¨åç«‹å³æŒ‰è®¡åˆ’æ‰§è¡Œï¼Œé€‚åˆè‡ªåŠ¨åŒ–åœºæ™¯<br>â€¢ `false`: å¯åŠ¨åè¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œéœ€æ‰‹åŠ¨è§¦å‘ï¼Œé€‚åˆéœ€è¦äººå·¥ç¡®è®¤çš„åœºæ™¯<br>**å»ºè®®**: æµ‹è¯•æ—¶è®¾ä¸º`false`ï¼Œç”Ÿäº§ç¯å¢ƒå¯è®¾ä¸º`true`<br>**ç¤ºä¾‹**: `true` |
| water_level_update_interval_minutes | integer | âŒ å¦ | `30` | æ°´ä½æ•°æ®æ›´æ–°é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç³»ç»Ÿæ¯éš”æ­¤æ—¶é•¿è‡ªåŠ¨è·å–æœ€æ–°æ°´ä½æ•°æ®ã€‚è®¾ç½®è¶Šå°æ•°æ®è¶ŠåŠæ—¶ï¼Œä½†ä¼šå¢åŠ ä¼ æ„Ÿå™¨è¯»å–é¢‘ç‡ã€‚<br>**å»ºè®®èŒƒå›´**: 15-60åˆ†é’Ÿ<br>**ç¤ºä¾‹**: `30` (æ¯30åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡) |
| enable_plan_regeneration | boolean | âŒ å¦ | `true` | æ˜¯å¦å¯ç”¨æ™ºèƒ½é‡æ–°ç”Ÿæˆã€‚<br>**ä¸šåŠ¡å«ä¹‰**: <br>â€¢ `true`: å½“æ°´ä½å˜åŒ–è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè‡ªåŠ¨é‡æ–°ç”Ÿæˆåç»­æ‰¹æ¬¡è®¡åˆ’ï¼Œå®ç°åŠ¨æ€è°ƒæ•´<br>â€¢ `false`: ä¸¥æ ¼æŒ‰åŸè®¡åˆ’æ‰§è¡Œï¼Œä¸åšè°ƒæ•´<br>**é€‚ç”¨åœºæ™¯**: <br>â€¢ å¤©æ°”å¤šå˜ã€æ°´ä½æ³¢åŠ¨å¤§ â†’ è®¾ä¸º`true`<br>â€¢ è®¡åˆ’å·²ç»è¿‡å……åˆ†éªŒè¯ã€éœ€ä¸¥æ ¼æ‰§è¡Œ â†’ è®¾ä¸º`false`<br>**ç¤ºä¾‹**: `true` |
| execution_mode | string | âŒ å¦ | `"simulation"` | æ‰§è¡Œæ¨¡å¼ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: <br>â€¢ `simulation`: **æ¨¡æ‹Ÿæ¨¡å¼**ï¼Œä¸å®é™…æ§åˆ¶è®¾å¤‡ï¼Œä»…è®°å½•æ‰§è¡Œæ—¥å¿—ï¼Œç”¨äºæµ‹è¯•å’Œé¢„æ¼”<br>â€¢ `production`: **ç”Ÿäº§æ¨¡å¼**ï¼Œå®é™…å‘é€æŒ‡ä»¤æ§åˆ¶æ°´æ³µã€é—¸é—¨ç­‰è®¾å¤‡<br>**âš ï¸ é‡è¦**: é¦–æ¬¡éƒ¨ç½²æˆ–ä¿®æ”¹é…ç½®åï¼Œå¿…é¡»å…ˆåœ¨`simulation`æ¨¡å¼ä¸‹éªŒè¯ï¼<br>**ç¤ºä¾‹**: `"simulation"` (æµ‹è¯•) æˆ– `"production"` (æ­£å¼æ‰§è¡Œ) |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "åŠ¨æ€æ‰§è¡Œå¯åŠ¨æˆåŠŸ",
  "data": {
    "execution_id": "exec_20250109_123456",
    "status": "running",
    "start_time": "2025-01-09T12:34:56.789Z",
    "plan_file": "/app/output/irrigation_plan_20250109_123456.json",
    "total_batches": 4,
    "current_batch": 1,
    "execution_mode": "simulation"
  }
}
```

**å…³é”®å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| execution_id | string | **é‡è¦ï¼** æ‰§è¡ŒIDï¼Œç”¨äºæŸ¥è¯¢çŠ¶æ€å’Œåœæ­¢æ‰§è¡Œ |
| status | string | æ‰§è¡ŒçŠ¶æ€: `running`/`paused`/`completed`/`failed` |
| current_batch | integer | å½“å‰æ‰§è¡Œæ‰¹æ¬¡ |
| total_batches | integer | æ€»æ‰¹æ¬¡æ•° |

---

#### 5.2 æŸ¥è¯¢æ‰§è¡ŒçŠ¶æ€

**æ¥å£è¯´æ˜**: æŸ¥è¯¢å½“å‰æ‰§è¡Œçš„è¯¦ç»†çŠ¶æ€

**è¯·æ±‚**
```
GET /api/execution/status?execution_id=exec_20250109_123456
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| execution_id | string | å¦ | æ‰§è¡ŒIDï¼Œä¸ä¼ è¿”å›å½“å‰æ‰§è¡Œ |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "data": {
    "execution_id": "exec_20250109_123456",
    "status": "running",
    "start_time": "2025-01-09T12:34:56.789Z",
    "current_batch": 2,
    "total_batches": 4,
    "progress_percent": 50.0,
    "last_water_level_update": "2025-01-09T13:04:56.789Z",
    "total_regenerations": 1,
    "active_fields": [
      {
        "field_id": "S4-G21-F15",
        "status": "irrigating",
        "start_time": "2025-01-09T13:00:00.000Z"
      }
    ],
    "completed_batches": [1],
    "selected_scenario": {
      "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
      "pumps_used": ["P2"],
      "total_batches": 4
    }
  }
}
```

**å…³é”®å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| status | string | æ‰§è¡ŒçŠ¶æ€ |
| progress_percent | number | æ‰§è¡Œè¿›åº¦ç™¾åˆ†æ¯” |
| total_regenerations | integer | è®¡åˆ’é‡æ–°ç”Ÿæˆæ¬¡æ•° |
| active_fields | array | æ­£åœ¨çŒæº‰çš„ç”°å— |
| selected_scenario | object | å½“å‰æ‰§è¡Œçš„æ–¹æ¡ˆä¿¡æ¯ |

---

#### 5.3 åœæ­¢æ‰§è¡Œ

**æ¥å£è¯´æ˜**: åœæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡

**è¯·æ±‚**
```
POST /api/execution/stop
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "execution_id": "exec_20250109_123456",
  "reason": "æ‰‹åŠ¨åœæ­¢"
}
```

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æ‰§è¡Œå·²åœæ­¢",
  "data": {
    "execution_id": "exec_20250109_123456",
    "status": "stopped",
    "stop_time": "2025-01-09T14:00:00.000Z",
    "completed_batches": 2,
    "total_batches": 4
  }
}
```

---

#### 5.4 è·å–æ‰§è¡Œå†å²

**æ¥å£è¯´æ˜**: è·å–æœ€è¿‘çš„æ‰§è¡Œå†å²è®°å½•

**è¯·æ±‚**
```
GET /api/execution/history?limit=10
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| limit | integer | å¦ | è¿”å›è®°å½•æ•°ï¼Œé»˜è®¤10 |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "total": 25,
  "data": [
    {
      "execution_id": "exec_20250109_123456",
      "start_time": "2025-01-09T12:34:56.789Z",
      "end_time": "2025-01-09T14:00:00.000Z",
      "status": "completed",
      "total_batches": 4,
      "completed_batches": 4,
      "total_regenerations": 2
    }
  ]
}
```

---

### 6. æ‰¹æ¬¡ç®¡ç†

#### 6.1 è·å–æ‰¹æ¬¡åˆ—è¡¨

**æ¥å£è¯´æ˜**: è·å–å½“å‰è®¡åˆ’çš„æ‰€æœ‰æ‰¹æ¬¡ä¿¡æ¯

**è¯·æ±‚**
```
GET /api/batches?farm_id=13944136728576&status=active
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| farm_id | string | å¦ | å†œåœºID |
| status | string | å¦ | æ‰¹æ¬¡çŠ¶æ€è¿‡æ»¤ |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "total_batches": 4,
  "batches": [
    {
      "index": 1,
      "area_mu": 73.107,
      "field_count": 14,
      "fields": ["S3-G2-F1", "S3-G3-F2", "S3-G5-F3"],
      "segment_ids": ["S3", "S4"]
    },
    {
      "index": 2,
      "area_mu": 79.083,
      "field_count": 11,
      "fields": ["S4-G21-F15", "S4-G22-F16"],
      "segment_ids": ["S4", "S5", "S6"]
    }
  ],
  "farm_id": "13944136728576",
  "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
  "scenario_count": 1,
  "query_time": "2025-01-09T12:34:56.789Z"
}
```

---

#### 6.2 è·å–æ‰¹æ¬¡è¯¦æƒ…

**æ¥å£è¯´æ˜**: è·å–æŒ‡å®šæ‰¹æ¬¡çš„è¯¦ç»†ä¿¡æ¯

**è¯·æ±‚**
```
GET /api/batches/{batch_index}/details
```

**è·¯å¾„å‚æ•°**
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| batch_index | integer | æ‰¹æ¬¡ç´¢å¼•ï¼ˆä»1å¼€å§‹ï¼‰ |

**å“åº”ç¤ºä¾‹**
```json
{
  "batch_index": 1,
  "area_mu": 73.107,
  "field_count": 14,
  "fields": [
    {
      "id": "S3-G2-F1",
      "area_mu": 5.225,
      "segment_id": "S3",
      "distance_rank": 1,
      "wl_mm": 0.0,
      "inlet_G_id": "S3-G2"
    }
  ],
  "segment_ids": ["S3", "S4"],
  "execution_details": {
    "status": "completed",
    "start_time": "2025-01-09T12:00:00.000Z",
    "end_time": "2025-01-09T13:30:00.000Z"
  },
  "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
  "query_time": "2025-01-09T12:34:56.789Z"
}
```

---

#### 6.3 è·å–å½“å‰è®¡åˆ’

**æ¥å£è¯´æ˜**: è·å–å½“å‰æ‰§è¡Œçš„å®Œæ•´è®¡åˆ’æ•°æ®

**è¯·æ±‚**
```
GET /api/batches/current-plan
```

**å“åº”ç¤ºä¾‹**
```json
{
  "plan": {
    "calc": {},
    "batches": [],
    "steps": []
  },
  "farm_id": "13944136728576",
  "query_time": "2025-01-09T12:34:56.789Z"
}
```

---

### 7. æ°´ä½ç®¡ç†

#### 7.1 æ›´æ–°æ°´ä½æ•°æ®

**æ¥å£è¯´æ˜**: æ›´æ–°æŒ‡å®šç”°å—çš„æ°´ä½æ•°æ®

**è¯·æ±‚**
```
POST /api/water-levels/update
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "farm_id": "13944136728576",
  "field_id": "S3-G2-F1",
  "water_level_mm": 25.5,
  "timestamp": "2025-01-09T12:00:00Z",
  "source": "sensor",
  "quality": "good"
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| farm_id | string | âœ… æ˜¯ | - | å†œåœºå”¯ä¸€æ ‡è¯†ç¬¦ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æ ‡è¯†æ•°æ®æ‰€å±çš„å†œåœºï¼Œç”¨äºæ•°æ®éš”ç¦»å’Œå…³è”ã€‚<br>**ç¤ºä¾‹**: `"13944136728576"` |
| field_id | string | âœ… æ˜¯ | - | ç”°å—å”¯ä¸€æ ‡è¯†ç¬¦ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æŒ‡å®šè¦æ›´æ–°æ°´ä½çš„ç”°å—ï¼Œæ ¼å¼ä¸º"ç‰‡åŒº-é—¸é—¨-ç”°å—"ã€‚<br>**æ ¼å¼**: `S{ç‰‡åŒºç¼–å·}-G{é—¸é—¨ç¼–å·}-F{ç”°å—ç¼–å·}`<br>**ç¤ºä¾‹**: `"S3-G2-F1"` (ç¬¬3ç‰‡åŒºç¬¬2é—¸é—¨ç¬¬1å—ç”°) |
| water_level_mm | number | âœ… æ˜¯ | - | ç”°å—å½“å‰æ°´ä½æ·±åº¦ï¼ˆæ¯«ç±³ï¼‰ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç”°å—å†…çš„å®é™…æ°´æ·±ï¼Œç³»ç»Ÿæ ¹æ®æ­¤å€¼åˆ¤æ–­æ˜¯å¦éœ€è¦çŒæº‰ã€‚<br>**æ•°å€¼èŒƒå›´**: é€šå¸¸ 0-150mm<br>**ç‰¹æ®Šå€¼**: `0`è¡¨ç¤ºå¹²ç”°<br>**ç¤ºä¾‹**: `25.5` (æ°´æ·±25.5æ¯«ç±³) |
| timestamp | string | âŒ å¦ | å½“å‰æ—¶é—´ | é‡‡é›†æ•°æ®çš„æ—¶é—´æˆ³ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æ ‡è®°æ•°æ®çš„é‡‡é›†æ—¶é—´ï¼Œç•™ç©ºåˆ™ä½¿ç”¨æœåŠ¡å™¨æ¥æ”¶æ—¶é—´ã€‚å¯¹äºæ‰¹é‡å†å²æ•°æ®å¯¼å…¥ï¼Œå»ºè®®å¡«å†™å®é™…é‡‡é›†æ—¶é—´ã€‚<br>**æ ¼å¼**: ISO 8601æ ¼å¼ `YYYY-MM-DDTHH:mm:ss.sssZ`<br>**ç¤ºä¾‹**: `"2025-01-09T12:00:00Z"` |
| source | string | âŒ å¦ | `"manual"` | æ•°æ®æ¥æºç±»å‹ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æ ‡è¯†æ•°æ®çš„è·å–æ–¹å¼ï¼Œå½±å“æ•°æ®å¯ä¿¡åº¦æƒé‡ã€‚<br>**å¯é€‰å€¼**:<br>â€¢ `sensor`: ä¼ æ„Ÿå™¨è‡ªåŠ¨é‡‡é›†ï¼Œ**æœ€å¯é **<br>â€¢ `manual`: äººå·¥æ‰‹åŠ¨è¾“å…¥ï¼Œéœ€äºŒæ¬¡ç¡®è®¤<br>â€¢ `estimated`: ç³»ç»Ÿä¼°ç®—ï¼Œä»…å‚è€ƒ<br>**ç¤ºä¾‹**: `"sensor"` |
| quality | string | âŒ å¦ | `"good"` | æ•°æ®è´¨é‡ç­‰çº§ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: è¯„ä¼°æ•°æ®çš„å¯é æ€§ï¼Œå½±å“æ˜¯å¦è§¦å‘è®¡åˆ’é‡æ–°ç”Ÿæˆã€‚<br>**å¯é€‰å€¼**:<br>â€¢ `good`: æ•°æ®å¯é ï¼Œå¯ç›´æ¥ä½¿ç”¨<br>â€¢ `fair`: æ•°æ®å¯ç”¨ï¼Œä½†å¯èƒ½æœ‰åå·®<br>â€¢ `poor`: æ•°æ®è´¨é‡å·®ï¼Œå»ºè®®é‡æ–°é‡‡é›†<br>**è‡ªåŠ¨åˆ¤æ–­**: ä¼ æ„Ÿå™¨æ•°æ®é€šå¸¸ä¸º`good`ï¼Œäººå·¥è¾“å…¥å»ºè®®è®¾ä¸º`fair`<br>**ç¤ºä¾‹**: `"good"` |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æ°´ä½æ•°æ®æ›´æ–°æˆåŠŸ",
  "data": {
    "field_id": "S3-G2-F1",
    "water_level_mm": 25.5,
    "updated_at": "2025-01-09T12:00:00Z"
  }
}
```

---

#### 7.2 è·å–æ°´ä½æ±‡æ€»

**æ¥å£è¯´æ˜**: è·å–å†œåœºæˆ–æŒ‡å®šç”°å—çš„æ°´ä½æ±‡æ€»ä¿¡æ¯

**è¯·æ±‚**
```
GET /api/water-levels/summary?farm_id=13944136728576&field_ids=S3-G2-F1,S3-G3-F2&use_sgf_format=true
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| farm_id | string | æ˜¯ | å†œåœºID |
| field_ids | string | å¦ | ç”°å—IDåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œæ”¯æŒæ•°å­—IDæˆ–SGFæ ¼å¼ |
| use_sgf_format | boolean | å¦ | æ˜¯å¦ä½¿ç”¨SGFæ ¼å¼çš„ç”°å—IDï¼ˆå¦‚S1-G2-F03ï¼‰ï¼Œé»˜è®¤falseä½¿ç”¨æ•°å­—ID |

**å“åº”ç¤ºä¾‹ï¼ˆuse_sgf_format=falseï¼Œé»˜è®¤ï¼‰**
```json
{
  "farm_id": "13944136728576",
  "total_fields": 29,
  "fields_with_data": 29,
  "fields_without_data": [],
  "quality_distribution": {
    "excellent": 29,
    "good": 0,
    "fair": 0,
    "poor": 0,
    "invalid": 0
  },
  "source_distribution": {
    "api": 29,
    "manual": 0,
    "config": 0,
    "interpolated": 0,
    "cached": 0
  },
  "field_details": {
    "1901482103712129024": {
      "water_level_mm": 0.8,
      "quality": "excellent",
      "source": "api",
      "confidence": 0.72,
      "age_hours": 0.5,
      "timestamp": "2025-11-13T09:22:43.284200",
      "readings_count": 1
    }
  },
  "coverage_rate": 1.0,
  "last_updated": "2025-11-13T09:52:53.238923",
  "query_time": "2025-11-13T09:52:53.238923"
}
```

**å“åº”ç¤ºä¾‹ï¼ˆuse_sgf_format=trueï¼‰**
```json
{
  "farm_id": "13944136728576",
  "total_fields": 29,
  "fields_with_data": 29,
  "fields_without_data": [],
  "quality_distribution": {
    "excellent": 29,
    "good": 0,
    "fair": 0,
    "poor": 0,
    "invalid": 0
  },
  "source_distribution": {
    "api": 29,
    "manual": 0,
    "config": 0,
    "interpolated": 0,
    "cached": 0
  },
  "field_details": {
    "S6-G43-F29": {
      "water_level_mm": 0.8,
      "quality": "excellent",
      "source": "api",
      "confidence": 0.72,
      "age_hours": 0.5,
      "timestamp": "2025-11-13T09:22:43.284200",
      "readings_count": 1,
      "numeric_id": "1901482103712129024"
    },
    "S3-G2-F1": {
      "water_level_mm": 1.8,
      "quality": "excellent",
      "source": "api",
      "confidence": 0.72,
      "age_hours": 0.0,
      "timestamp": "2025-11-13T09:52:43.284200",
      "readings_count": 2,
      "numeric_id": "1901477857038049280"
    }
  },
  "coverage_rate": 1.0,
  "last_updated": "2025-11-13T09:52:53.238923",
  "query_time": "2025-11-13T09:52:53.238923"
}
```

**å­—æ®µè¯´æ˜**
- `total_fields`: æ€»ç”°å—æ•°
- `fields_with_data`: æœ‰æ°´ä½æ•°æ®çš„ç”°å—æ•°
- `fields_without_data`: æ²¡æœ‰æ•°æ®çš„ç”°å—åˆ—è¡¨
- `quality_distribution`: æ•°æ®è´¨é‡åˆ†å¸ƒç»Ÿè®¡
- `source_distribution`: æ•°æ®æ¥æºåˆ†å¸ƒç»Ÿè®¡
- `field_details`: å„ç”°å—è¯¦ç»†ä¿¡æ¯
  - `water_level_mm`: å½“å‰æ°´ä½ï¼ˆæ¯«ç±³ï¼‰
  - `quality`: æ•°æ®è´¨é‡ç­‰çº§ï¼ˆexcellent/good/fair/poor/invalidï¼‰
  - `source`: æ•°æ®æ¥æºï¼ˆapi/manual/config/interpolated/cachedï¼‰
  - `confidence`: ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
  - `age_hours`: æ•°æ®å¹´é¾„ï¼ˆå°æ—¶ï¼‰
  - `timestamp`: æ•°æ®æ—¶é—´æˆ³
  - `readings_count`: å†å²è¯»æ•°æ•°é‡
  - `numeric_id`: æ•°å­—IDï¼ˆä»…åœ¨use_sgf_format=trueæ—¶è¿”å›ï¼‰
- `coverage_rate`: æ•°æ®è¦†ç›–ç‡ï¼ˆ0-1ï¼‰

---

#### 7.3 è·å–æ°´ä½å†å²

**æ¥å£è¯´æ˜**: è·å–æŒ‡å®šç”°å—çš„æ°´ä½å†å²æ•°æ®

**è¯·æ±‚**
```
GET /api/water-levels/history?farm_id=13944136728576&field_id=S3-G2-F1&hours=24
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| farm_id | string | æ˜¯ | å†œåœºID |
| field_id | string | æ˜¯ | ç”°å—ID |
| hours | integer | å¦ | æŸ¥è¯¢æ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼‰ï¼Œé»˜è®¤24 |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "field_id": "S3-G2-F1",
  "data": [
    {
      "timestamp": "2025-01-09T12:00:00Z",
      "water_level_mm": 25.5,
      "source": "sensor",
      "quality": "good"
    },
    {
      "timestamp": "2025-01-09T11:00:00Z",
      "water_level_mm": 23.2,
      "source": "sensor",
      "quality": "good"
    }
  ],
  "total_records": 24
}
```

---

#### 7.4 è·å–ç”°å—æ°´ä½è¶‹åŠ¿

**æ¥å£è¯´æ˜**: è·å–ç”°å—æ°´ä½å˜åŒ–è¶‹åŠ¿åˆ†æ

**è¯·æ±‚**
```
GET /api/water-levels/trend/{field_id}?hours=48
```

**è·¯å¾„å‚æ•°**
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| field_id | string | ç”°å—ID |

**æŸ¥è¯¢å‚æ•°**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| hours | integer | å¦ | åˆ†ææ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼‰ï¼Œé»˜è®¤48 |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "field_id": "S3-G2-F1",
  "trend": {
    "direction": "increasing",
    "rate_mm_per_hour": 0.5,
    "prediction_24h": 37.5
  },
  "statistics": {
    "min": 10.0,
    "max": 30.0,
    "average": 22.5,
    "std_dev": 5.2
  },
  "data_points": 48
}
```

---

### 8. è®¡åˆ’é‡æ–°ç”Ÿæˆ

#### 8.1 æ‰¹æ¬¡é‡æ–°ç”Ÿæˆ

**æ¥å£è¯´æ˜**: ä¿®æ”¹æ‰¹æ¬¡å¹¶é‡æ–°ç”Ÿæˆè®¡åˆ’ï¼Œæ”¯æŒç”°å—ä¿®æ”¹ã€æ°´æ³µåˆ†é…ã€æ—¶é—´è°ƒæ•´

**è¯·æ±‚**
```
POST /api/regeneration/batch
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "original_plan_id": "/app/output/irrigation_plan_20250109_123456.json",
  "scenario_name": "çœç”µæ–¹æ¡ˆ",
  "field_modifications": [
    {
      "field_id": "S3-G5-F1",
      "action": "add",
      "custom_water_level": 95.0
    },
    {
      "field_id": "S3-G5-F2",
      "action": "remove"
    }
  ],
  "pump_assignments": [
    {
      "batch_index": 1,
      "pump_ids": ["P1", "P2"]
    }
  ],
  "time_modifications": [
    {
      "batch_index": 1,
      "start_time_h": 2.0,
      "duration_h": 10.0
    }
  ],
  "regeneration_params": {
    "force_regeneration": true,
    "optimize_schedule": true
  }
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| original_plan_id | string | âœ… æ˜¯ | - | åŸå§‹çŒæº‰è®¡åˆ’IDã€‚<br>**ä¸šåŠ¡å«ä¹‰**: è¦ä¿®æ”¹çš„è®¡åˆ’æ–‡ä»¶è·¯å¾„ï¼Œä½¿ç”¨"ç”ŸæˆçŒæº‰è®¡åˆ’"æ¥å£è¿”å›çš„`plan_id`ã€‚<br>**ç¤ºä¾‹**: `"/app/output/irrigation_plan_20250109_123456.json"` |
| scenario_name | string | âŒ å¦ | `null` | æŒ‡å®šè¦ä¿®æ”¹çš„scenarioåç§°ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: åœ¨å¤šæ–¹æ¡ˆè®¡åˆ’ä¸­ï¼Œå¯ä»¥æŒ‡å®šåªä¿®æ”¹æŸä¸ªç‰¹å®šæ–¹æ¡ˆï¼Œæˆ–è€…ä¸æŒ‡å®šåˆ™ä¿®æ”¹æ‰€æœ‰æ–¹æ¡ˆã€‚<br>**å¤šæ³µæ–¹æ¡ˆå¯é€‰å€¼**:<br>â€¢ `"P1å•ç‹¬ä½¿ç”¨"`<br>â€¢ `"P2å•ç‹¬ä½¿ç”¨"`<br>â€¢ `"å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨"`<br>**ä¼˜åŒ–æ–¹æ¡ˆå¯é€‰å€¼**:<br>â€¢ `"çœç”µæ–¹æ¡ˆ"` (cost_minimization)<br>â€¢ `"çœæ—¶æ–¹æ¡ˆ"` (time_minimization)<br>â€¢ `"å‡è¡¡æ–¹æ¡ˆ"` (balanced)<br>â€¢ `"é¿å³°æ–¹æ¡ˆ"` (off_peak)<br>â€¢ `"èŠ‚æ°´æ–¹æ¡ˆ"` (water_saving)<br>**ç‰¹æ®Šå€¼**: `null` æˆ–ä¸ä¼  - ä¿®æ”¹æ‰€æœ‰scenario<br>**ğŸ’¡ æç¤º**: ä½¿ç”¨ `GET /api/regeneration/scenarios?plan_id={plan_id}` æ¥å£å¯æŸ¥è¯¢å¯ç”¨çš„scenarioåˆ—è¡¨ |
| field_modifications | array | âŒ å¦ | `[]` | ç”°å—ä¿®æ”¹åˆ—è¡¨ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æŒ‡å®šè¦æ·»åŠ æˆ–åˆ é™¤çš„ç”°å—ã€‚å¸¸ç”¨äº:<br>â€¢ ä¸´æ—¶å¢åŠ çŒæº‰ç”°å—<br>â€¢ æ’é™¤æ•…éšœç”°å—<br>â€¢ è°ƒæ•´çŒæº‰ä¼˜å…ˆçº§<br>**æ ¼å¼**: è§ä¸‹æ–¹è¯¦ç»†è¯´æ˜ |
| pump_assignments | array | âŒ å¦ | `[]` | æ°´æ³µåˆ†é…åˆ—è¡¨ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ä¸ºç‰¹å®šæ‰¹æ¬¡æŒ‡å®šä½¿ç”¨çš„æ°´æ³µç»„åˆã€‚å¸¸ç”¨äº:<br>â€¢ æŸå°æ°´æ³µæ•…éšœï¼Œåˆ‡æ¢å¤‡ç”¨<br>â€¢ å¤šæ³µååŒä½œä¸š<br>â€¢ è´Ÿè½½å‡è¡¡<br>**æ ¼å¼**: `[{"batch_index": 1, "pump_ids": ["P1", "P2"]}]`<br>**âš ï¸ æ³¨æ„**: å¦‚æœæŒ‡å®šäº†`scenario_name`ï¼Œåªä¼šä¿®æ”¹è¯¥scenarioçš„æ°´æ³µé…ç½® |
| time_modifications | array | âŒ å¦ | `[]` | æ—¶é—´ä¿®æ”¹åˆ—è¡¨ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: è°ƒæ•´æ‰¹æ¬¡çš„å¼€å§‹æ—¶é—´æˆ–æŒç»­æ—¶é•¿ã€‚å¸¸ç”¨äº:<br>â€¢ é¿å¼€ç”¨ç”µé«˜å³°<br>â€¢ é€‚åº”å¤©æ°”å˜åŒ–<br>â€¢ ä¼˜åŒ–äººåŠ›è°ƒåº¦<br>**æ ¼å¼**: `[{"batch_index": 1, "start_time_h": 2.0, "duration_h": 10.0}]`<br>**âš ï¸ æ³¨æ„**: ä¿®æ”¹æ—¶é—´ä¼šè‡ªåŠ¨çº§è”è°ƒæ•´åç»­æ‰¹æ¬¡ï¼›å¦‚æœæŒ‡å®šäº†`scenario_name`ï¼Œåªä¼šä¿®æ”¹è¯¥scenarioçš„æ—¶é—´ |
| regeneration_params | object | âŒ å¦ | `{}` | é‡æ–°ç”Ÿæˆå‚æ•°ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æ§åˆ¶é‡æ–°ç”Ÿæˆçš„è¡Œä¸ºã€‚<br>**å­å­—æ®µ**:<br>â€¢ `force_regeneration`: å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼ˆå³ä½¿å˜åŒ–å¾ˆå°ï¼‰<br>â€¢ `optimize_schedule`: æ˜¯å¦ä¼˜åŒ–è°ƒåº¦é¡ºåº |

**field_modifications è¯¦ç»†è¯´æ˜**

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| field_id | string | âœ… | ç”°å—å”¯ä¸€æ ‡è¯†ç¬¦ã€‚<br>**æ ¼å¼**: `S{ç‰‡åŒº}-G{é—¸é—¨}-F{ç”°å—}`<br>**ç¤ºä¾‹**: `"S3-G5-F1"` |
| action | string | âœ… | æ“ä½œç±»å‹ã€‚<br>**å¯é€‰å€¼**:<br>â€¢ `add`: æ·»åŠ ç”°å—åˆ°çŒæº‰è®¡åˆ’<br>â€¢ `remove`: ä»è®¡åˆ’ä¸­ç§»é™¤ç”°å—<br>**ç¤ºä¾‹**: `"add"` |
| custom_water_level | number | âŒ | è‡ªå®šä¹‰æ°´ä½ï¼ˆä»…`add`æ—¶éœ€è¦ï¼‰ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ä¸ºæ–°å¢ç”°å—æŒ‡å®šå½“å‰æ°´ä½ï¼Œç”¨äºè®¡ç®—çŒæº‰é‡ã€‚<br>**å•ä½**: æ¯«ç±³ (mm)<br>**ç¤ºä¾‹**: `95.0` |

**pump_assignments è¯¦ç»†è¯´æ˜**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| batch_index | integer | æ‰¹æ¬¡ç´¢å¼•å·ï¼ˆ**ä»1å¼€å§‹**ï¼‰<br>**ç¤ºä¾‹**: `1` |
| pump_ids | array | è¯¥æ‰¹æ¬¡ä½¿ç”¨çš„æ°´æ³µåˆ—è¡¨<br>**ç¤ºä¾‹**: `["P1", "P2"]` (åŒæ—¶ä½¿ç”¨P1å’ŒP2) |

**time_modifications è¯¦ç»†è¯´æ˜**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| batch_index | integer | æ‰¹æ¬¡ç´¢å¼•å·ï¼ˆ**ä»1å¼€å§‹**ï¼‰<br>**ç¤ºä¾‹**: `1` |
| start_time_h | number | æ–°çš„å¼€å§‹æ—¶é—´ï¼ˆå°æ—¶ï¼‰<br>**æ ¼å¼**: ç›¸å¯¹æ—¶é—´ï¼Œ`0`ä¸ºè®¡åˆ’èµ·å§‹ç‚¹<br>**ç¤ºä¾‹**: `2.0` (è®¡åˆ’å¼€å§‹å2å°æ—¶) |
| duration_h | number | æ–°çš„æŒç»­æ—¶é•¿ï¼ˆå°æ—¶ï¼‰<br>**âš ï¸ æ³¨æ„**: ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯æ°´æ³µæµé‡æ˜¯å¦è¶³å¤Ÿ<br>**ç¤ºä¾‹**: `10.0` (æ‰§è¡Œ10å°æ—¶) |

**å“åº”æ ¼å¼è¯´æ˜**

ğŸ’¡ **å“åº”å†…å®¹æ ¹æ®æ˜¯å¦æŒ‡å®šscenario_nameè‡ªåŠ¨ä¼˜åŒ–**ï¼š
- **æŒ‡å®šscenario_name**ï¼šåªè¿”å›è¯¥scenarioçš„æ•°æ®ï¼ˆæ¨èï¼Œæ•°æ®é‡å°ï¼‰
- **æœªæŒ‡å®šscenario_name**ï¼šè¿”å›å®Œæ•´è®¡åˆ’çš„æ‰€æœ‰scenarios

**å“åº”ç¤ºä¾‹1ï¼šæŒ‡å®šscenarioï¼ˆæ¨èï¼‰**
```json
{
  "success": true,
  "message": "æ‰¹æ¬¡è®¡åˆ’é‡æ–°ç”ŸæˆæˆåŠŸï¼Œå…±è¿›è¡Œäº† 2 é¡¹ä¿®æ”¹",
  "scenario_name": "çœç”µæ–¹æ¡ˆ",
  "modified_plan_path": "e:/irrigation_schedule/farm_irrigation/output/irrigation_plan_20251110_143025_modified.json",
  "original_scenario": {
    "scenario_name": "çœç”µæ–¹æ¡ˆ",
    "pumps_used": ["P2"],
    "total_batches": 10,
    "total_eta_h": 61.6,
    "total_electricity_cost": 2217.71,
    "plan": {
      "batches": [...],
      "steps": [...]
    }
  },
  "modified_scenario": {
    "scenario_name": "çœç”µæ–¹æ¡ˆ",
    "pumps_used": ["P1"],  // å·²ä¿®æ”¹
    "total_batches": 10,
    "total_eta_h": 61.6,
    "total_electricity_cost": 2217.71,
    "plan": {
      "batches": [...],
      "steps": [...]
    }
  },
  "modifications_summary": {
    "pump_assignments": [
      {
        "batch_index": 1,
        "pump_ids": ["P1"],
        "scenarios_affected": ["çœç”µæ–¹æ¡ˆ"],
        "result": "success"
      }
    ],
    "time_modifications": [
      {
        "batch_index": 1,
        "start_time_h": 2.0,
        "duration_h": 10.0,
        "scenarios_affected": ["çœç”µæ–¹æ¡ˆ"],
        "result": "success"
      }
    ],
    "scenarios_modified": ["çœç”µæ–¹æ¡ˆ"],
    "scenarios_unchanged": ["P1å•ç‹¬ä½¿ç”¨", "P2å•ç‹¬ä½¿ç”¨", "å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨"],
    "total_changes": 2
  }
}
```

**å“åº”ç¤ºä¾‹2ï¼šæœªæŒ‡å®šscenarioï¼ˆä¿®æ”¹æ‰€æœ‰ï¼‰**
```json
{
  "success": true,
  "message": "æ‰¹æ¬¡è®¡åˆ’é‡æ–°ç”ŸæˆæˆåŠŸï¼Œå…±è¿›è¡Œäº† 3 é¡¹ä¿®æ”¹",
  "modified_plan_path": "e:/irrigation_schedule/farm_irrigation/output/irrigation_plan_20251110_143025_modified.json",
  "original_plan": {
    "scenarios": [
      {"scenario_name": "P1å•ç‹¬ä½¿ç”¨", ...},
      {"scenario_name": "P2å•ç‹¬ä½¿ç”¨", ...},
      {"scenario_name": "å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨", ...}
    ]
  },
  "modified_plan": {
    "scenarios": [
      {"scenario_name": "P1å•ç‹¬ä½¿ç”¨", ...},  // å·²ä¿®æ”¹
      {"scenario_name": "P2å•ç‹¬ä½¿ç”¨", ...},  // å·²ä¿®æ”¹
      {"scenario_name": "å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨", ...}  // å·²ä¿®æ”¹
    ]
  },
  "modifications_summary": {
    "scenarios_modified": ["P1å•ç‹¬ä½¿ç”¨", "P2å•ç‹¬ä½¿ç”¨", "å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨"],
    "total_changes": 3
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**

| å­—æ®µ | ç±»å‹ | æ¡ä»¶ | è¯´æ˜ |
|------|------|------|------|
| success | boolean | æ€»æ˜¯è¿”å› | æ˜¯å¦æˆåŠŸ |
| message | string | æ€»æ˜¯è¿”å› | å“åº”æ¶ˆæ¯ |
| **modified_plan_path** | string | æ€»æ˜¯è¿”å› | **ğŸ†• ä¿®æ”¹åçš„è®¡åˆ’æ–‡ä»¶ä¿å­˜è·¯å¾„**ï¼Œå¯ç”¨äºåç»­æ¥å£è°ƒç”¨æˆ–æ‰§è¡Œ |
| **scenario_name** | string | æŒ‡å®šscenarioæ—¶ | è¢«ä¿®æ”¹çš„scenarioåç§° |
| **original_scenario** | object | æŒ‡å®šscenarioæ—¶ | ä¿®æ”¹å‰çš„scenarioæ•°æ® |
| **modified_scenario** | object | æŒ‡å®šscenarioæ—¶ | ä¿®æ”¹åçš„scenarioæ•°æ® |
| **original_plan** | object | æœªæŒ‡å®šscenarioæ—¶ | ä¿®æ”¹å‰çš„å®Œæ•´è®¡åˆ’ï¼ˆåŒ…å«æ‰€æœ‰scenariosï¼‰ |
| **modified_plan** | object | æœªæŒ‡å®šscenarioæ—¶ | ä¿®æ”¹åçš„å®Œæ•´è®¡åˆ’ï¼ˆåŒ…å«æ‰€æœ‰scenariosï¼‰ |
| modifications_summary | object | æ€»æ˜¯è¿”å› | ä¿®æ”¹æ‘˜è¦ |

---

#### 8.2 æŸ¥è¯¢å¯ç”¨Scenarios

**æ¥å£è¯´æ˜**: è·å–è®¡åˆ’ä¸­æ‰€æœ‰å¯ç”¨çš„scenarioåˆ—è¡¨ï¼ŒåŒ…æ‹¬å¤šæ³µæ–¹æ¡ˆå’Œä¼˜åŒ–æ–¹æ¡ˆ

**è¯·æ±‚**
```
GET /api/regeneration/scenarios?plan_id={plan_id}
```

**è¯·æ±‚å‚æ•°**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| plan_id | string | âŒ | **å¯é€‰**ï¼Œè®¡åˆ’IDæˆ–æ–‡ä»¶è·¯å¾„ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ä¸ä¼ æˆ–ä¸ºç©ºæ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨outputç›®å½•ä¸­æœ€æ–°çš„çŒæº‰è®¡åˆ’æ–‡ä»¶ã€‚<br>**ç¤ºä¾‹**: `irrigation_plan_20251105_214020.json` æˆ–ä¸ä¼ ï¼ˆä½¿ç”¨æœ€æ–°æ–‡ä»¶ï¼‰ |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æˆåŠŸè·å– 3 ä¸ªscenarioä¿¡æ¯",
  "data": {
    "plan_id": "irrigation_plan_20251105_214020.json",
    "total_scenarios": 3,
    "available_scenarios": [
      {
        "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
        "pumps_used": ["P2"],
        "total_batches": 10,
        "total_eta_h": 61.6,
        "total_electricity_cost": 2217.71,
        "total_pump_runtime_hours": {
          "P2": 61.6
        },
        "coverage_info": {
          "covered_segments": ["S3", "S4", "S5", "S6", "S7", "S8"],
          "total_covered_segments": 6
        },
        "optimization_goal": null
      },
      {
        "scenario_name": "P1å•ç‹¬ä½¿ç”¨",
        "pumps_used": ["P1"],
        "total_batches": 10,
        "total_eta_h": 61.6,
        "total_electricity_cost": 2217.71,
        "total_pump_runtime_hours": {
          "P1": 61.6
        },
        "coverage_info": {
          "covered_segments": ["S3", "S4", "S5", "S6", "S7", "S8"],
          "total_covered_segments": 6
        },
        "optimization_goal": null
      },
      {
        "scenario_name": "å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨",
        "pumps_used": ["P1", "P2"],
        "total_batches": 5,
        "total_eta_h": 30.8,
        "total_electricity_cost": 2217.71,
        "total_pump_runtime_hours": {
          "P1": 30.8,
          "P2": 30.8
        },
        "coverage_info": {
          "covered_segments": ["S3", "S4", "S5", "S6", "S7", "S8"],
          "total_covered_segments": 6
        },
        "optimization_goal": null
      }
    ]
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| scenario_name | string | Scenarioåç§°ã€‚å¤šæ³µæ–¹æ¡ˆå¦‚"P1å•ç‹¬ä½¿ç”¨"ï¼Œä¼˜åŒ–æ–¹æ¡ˆå¦‚"çœç”µæ–¹æ¡ˆ" |
| pumps_used | array | è¯¥scenarioä½¿ç”¨çš„æ°´æ³µåˆ—è¡¨ |
| total_batches | integer | æ€»æ‰¹æ¬¡æ•° |
| total_eta_h | number | é¢„è®¡æ€»æ‰§è¡Œæ—¶é•¿ï¼ˆå°æ—¶ï¼‰ |
| total_electricity_cost | number | é¢„è®¡æ€»ç”µè´¹ï¼ˆå…ƒï¼‰ |
| total_pump_runtime_hours | object | å„æ°´æ³µè¿è¡Œæ—¶é•¿ç»Ÿè®¡ |
| coverage_info | object | è¦†ç›–èŒƒå›´ä¿¡æ¯ |
| optimization_goal | string/null | ä¼˜åŒ–ç›®æ ‡ï¼ˆä¼˜åŒ–æ–¹æ¡ˆï¼‰ï¼šcost_minimizationã€time_minimizationã€balancedã€off_peakã€water_savingã€‚å¤šæ³µæ–¹æ¡ˆä¸ºnull |

**ä½¿ç”¨åœºæ™¯**
1. **å‰ç«¯ç•Œé¢å±•ç¤º**: åœ¨æ‰¹æ¬¡ä¿®æ”¹ç•Œé¢æ˜¾ç¤ºæ‰€æœ‰å¯é€‰çš„scenario
2. **é€‰æ‹©æ€§ä¿®æ”¹**: ç”¨æˆ·é€‰æ‹©æŸä¸ªscenarioåï¼Œè°ƒç”¨æ‰¹æ¬¡é‡æ–°ç”Ÿæˆæ¥å£æ—¶ä¼ å…¥`scenario_name`
3. **æ–¹æ¡ˆå¯¹æ¯”**: å±•ç¤ºä¸åŒscenarioçš„æˆæœ¬ã€æ—¶é•¿ç­‰æŒ‡æ ‡ï¼Œå¸®åŠ©ç”¨æˆ·å†³ç­–

**ç¤ºä¾‹ä½¿ç”¨æµç¨‹**
```javascript
// 1. è·å–å¯ç”¨scenarios
GET /api/regeneration/scenarios?plan_id=irrigation_plan_20251105_214020.json

// 2. ç”¨æˆ·ä»è¿”å›çš„available_scenariosä¸­é€‰æ‹©è¦ä¿®æ”¹çš„scenario

// 3. è°ƒç”¨æ‰¹æ¬¡é‡æ–°ç”Ÿæˆæ¥å£ï¼Œä¼ å…¥é€‰ä¸­çš„scenario_name
POST /api/regeneration/batch
{
  "original_plan_id": "irrigation_plan_20251105_214020.json",
  "scenario_name": "çœç”µæ–¹æ¡ˆ",  // ç”¨æˆ·é€‰æ‹©çš„scenario
  "pump_assignments": [...]
}
```

---

#### 8.3 æ‰‹åŠ¨é‡æ–°ç”Ÿæˆï¼ˆæ°´ä½ï¼‰

**æ¥å£è¯´æ˜**: åŸºäºæ–°çš„æ°´ä½æ•°æ®é‡æ–°ç”ŸæˆæŒ‡å®šæ‰¹æ¬¡ï¼Œæ”¯æŒä¸ºç‰¹å®šç”°å—è®¾ç½®è‡ªå®šä¹‰çš„æ°´ä½æ ‡å‡†

**è¯·æ±‚**
```
POST /api/regeneration/manual
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "batch_index": 1,
  "custom_water_levels": {
    "S3-G5-F3": 25.0,
    "S3-G6-F4": 28.5
  },
  "custom_water_level_standards": {
    "S3-G5-F3": {
      "wl_low": 20.0,
      "wl_opt": 70.0,
      "wl_high": 130.0
    }
  },
  "force_regeneration": true
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| batch_index | integer | âœ… æ˜¯ | - | æ‰¹æ¬¡ç´¢å¼•å·ï¼ˆ**ä»1å¼€å§‹**ï¼‰ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æŒ‡å®šè¦é‡æ–°ç”Ÿæˆçš„æ‰¹æ¬¡ã€‚<br>**ç¤ºä¾‹**: `1` |
| custom_water_levels | object | âŒ å¦ | `{}` | è‡ªå®šä¹‰ç”°å—å®é™…æ°´ä½ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ä¸ºæŒ‡å®šç”°å—è®¾ç½®å½“å‰å®é™…æ°´ä½å€¼ï¼Œæ ¼å¼ä¸º `{"ç”°å—ID": æ°´ä½å€¼(mm)}`ã€‚<br>**ä½¿ç”¨åœºæ™¯**: ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°åï¼Œæ‰‹åŠ¨è§¦å‘é‡æ–°è®¡ç®—ã€‚<br>**ç¤ºä¾‹**: `{"S3-G5-F3": 25.0}` |
| custom_water_level_standards | object | âŒ å¦ | `null` | **ğŸ†• æ–°åŠŸèƒ½** è‡ªå®šä¹‰ç”°å—çº§æ°´ä½æ ‡å‡†ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ä¸ºç‰¹å®šç”°å—è®¾ç½®ç‹¬ç«‹çš„æ°´ä½æ ‡å‡†ï¼ˆä½æ°´ä½é˜ˆå€¼ã€æœ€ä¼˜æ°´ä½ã€é«˜æ°´ä½é˜ˆå€¼ï¼‰ï¼Œè¦†ç›–å…¨å±€é»˜è®¤å€¼ã€‚ç®—æ³•å°†ä½¿ç”¨è¿™äº›è‡ªå®šä¹‰æ ‡å‡†é‡æ–°è®¡ç®—è¯¥ç”°å—çš„çŒæº‰éœ€æ±‚ã€‚<br>**æ ¼å¼**: `{"ç”°å—ID": {"wl_low": å€¼, "wl_opt": å€¼, "wl_high": å€¼}}`<br>**ä½¿ç”¨åœºæ™¯**: <br>â€¢ ä¸åŒä½œç‰©ç”Ÿé•¿é˜¶æ®µéœ€è¦ä¸åŒæ°´ä½<br>â€¢ ç‰¹æ®Šç”°å—åœŸå£¤æ¡ä»¶å·®å¼‚<br>â€¢ ç²¾å‡†çŒæº‰è¯•éªŒå¯¹æ¯”<br>**å­—æ®µè¯´æ˜**:<br>â€¢ `wl_low`: ä½æ°´ä½é˜ˆå€¼(mm)ï¼Œå¯é€‰<br>â€¢ `wl_opt`: æœ€ä¼˜æ°´ä½(mm)ï¼Œå¯é€‰<br>â€¢ `wl_high`: é«˜æ°´ä½é˜ˆå€¼(mm)ï¼Œå¯é€‰<br>**âš ï¸ æ³¨æ„**: <br>â€¢ æœªæŒ‡å®šçš„å­—æ®µä½¿ç”¨å…¨å±€é»˜è®¤å€¼<br>â€¢ ä»…åœ¨æœ¬æ¬¡è®¡ç®—ç”Ÿæ•ˆï¼Œä¸ä¼šä¿®æ”¹ config.json<br>â€¢ æœªæŒ‡å®šæ ‡å‡†çš„ç”°å—ä½¿ç”¨å…¨å±€é»˜è®¤å€¼<br>**ç¤ºä¾‹**: `{"S3-G5-F3": {"wl_low": 20.0, "wl_opt": 70.0, "wl_high": 130.0}}` |
| force_regeneration | boolean | âŒ å¦ | `false` | æ˜¯å¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆã€‚<br>**ä¸šåŠ¡å«ä¹‰**: `true`æ—¶å³ä½¿å˜åŒ–å¾ˆå°ä¹Ÿé‡æ–°ç”Ÿæˆï¼Œ`false`æ—¶ç³»ç»Ÿåˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆã€‚<br>**ç¤ºä¾‹**: `true` |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æ‰¹æ¬¡ 1 é‡æ–°ç”ŸæˆæˆåŠŸ (åŸºäºscenario 'P1å•æ³µæ–¹æ¡ˆ')",
  "batch_index": 1,
  "scenario_name": "P1å•æ³µæ–¹æ¡ˆ",
  "scenario_count": 3,
  "changes_count": 5,
  "execution_time_adjustment_seconds": 180.0,
  "water_usage_adjustment_m3": 12.5,
  "change_summary": "å…±æœ‰5é¡¹å˜æ›´ï¼šæŒç»­æ—¶é—´è°ƒæ•´3é¡¹ï¼Œæµé‡è°ƒæ•´2é¡¹",
  "output_file": "/app/output/irrigation_plan_manual_regen_1762349810.json",
  "wl_low": 30.0,
  "wl_opt": 80.0,
  "wl_high": 140.0,
  "d_target_mm": 90.0,
  "field_water_level_standards": {
    "S3-G5-F3": {
      "wl_low": 20.0,
      "wl_opt": 70.0,
      "wl_high": 130.0
    }
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | boolean | æ“ä½œæ˜¯å¦æˆåŠŸ |
| message | string | è¯¦ç»†æ¶ˆæ¯ |
| batch_index | integer | æ‰¹æ¬¡ç´¢å¼• |
| scenario_name | string | å½“å‰ä½¿ç”¨çš„scenarioåç§° |
| scenario_count | integer | è®¡åˆ’ä¸­åŒ…å«çš„scenarioæ€»æ•° |
| changes_count | integer | å®é™…å˜æ›´é¡¹ç›®æ•°é‡ |
| execution_time_adjustment_seconds | float | æ‰§è¡Œæ—¶é—´è°ƒæ•´ï¼ˆç§’ï¼‰ |
| water_usage_adjustment_m3 | float | ç”¨æ°´é‡è°ƒæ•´ï¼ˆç«‹æ–¹ç±³ï¼‰ |
| change_summary | string | å˜æ›´æ‘˜è¦æè¿° |
| output_file | string | ä¿å­˜çš„JSONæ–‡ä»¶è·¯å¾„ |
| **wl_low** | **float** | **å…¨å±€ä½æ°´ä½é˜ˆå€¼ï¼ˆmmï¼‰**ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç³»ç»Ÿé»˜è®¤çš„ä½æ°´ä½é˜ˆå€¼ï¼Œå½“ç”°å—æ°´ä½ä½äºæ­¤å€¼æ—¶è§¦å‘çŒæº‰ã€‚<br>**æ•°æ®æ¥æº**: æ¥è‡ª config.json çš„å…¨å±€é…ç½®ã€‚<br>**ç¤ºä¾‹**: `30.0` |
| **wl_opt** | **float** | **å…¨å±€æœ€ä¼˜æ°´ä½ï¼ˆmmï¼‰**ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç³»ç»Ÿé»˜è®¤çš„æœ€ä¼˜æ°´ä½ç›®æ ‡ï¼ŒçŒæº‰çš„ç›®æ ‡æ˜¯å°†ç”°å—æ°´ä½æå‡åˆ°æ­¤å€¼ã€‚<br>**æ•°æ®æ¥æº**: æ¥è‡ª config.json çš„å…¨å±€é…ç½®ã€‚<br>**çŒæº‰é€»è¾‘**: ç¼ºæ°´æ·±åº¦ = wl_opt - wl_mm<br>**ç¤ºä¾‹**: `80.0` |
| **wl_high** | **float** | **å…¨å±€é«˜æ°´ä½é˜ˆå€¼ï¼ˆmmï¼‰**ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç³»ç»Ÿé»˜è®¤çš„é«˜æ°´ä½é˜ˆå€¼ï¼Œå½“ç”°å—æ°´ä½è¶…è¿‡æ­¤å€¼æ—¶ä¸éœ€è¦çŒæº‰ã€‚<br>**æ•°æ®æ¥æº**: æ¥è‡ª config.json çš„å…¨å±€é…ç½®ã€‚<br>**ç¤ºä¾‹**: `140.0` |
| **d_target_mm** | **float** | **ç›®æ ‡çŒæº‰æ°´æ·±ï¼ˆmmï¼‰**ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: å‚è€ƒå€¼ï¼Œå®é™…çŒæº‰æ·±åº¦ç”±åŠ¨æ€è®¡ç®—å†³å®šï¼ˆwl_opt - wl_mmï¼‰ã€‚<br>**ç¤ºä¾‹**: `90.0` |
| **field_water_level_standards** | **object\|null** | **ğŸ†• ç”°å—çº§æ°´ä½æ ‡å‡†ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰ï¼‰**ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: è¿”å›æœ¬æ¬¡è®¡ç®—ä¸­ä½¿ç”¨çš„ç”°å—çº§è‡ªå®šä¹‰æ°´ä½æ ‡å‡†ã€‚å¦‚æœè¯·æ±‚ä¸­ä¼ å…¥äº† `custom_water_level_standards`ï¼Œæ­¤å­—æ®µä¼šè¿”å›å®é™…åº”ç”¨çš„æ ‡å‡†ã€‚<br>**æ ¼å¼**: `{"ç”°å—ID": {"wl_low": å€¼, "wl_opt": å€¼, "wl_high": å€¼}}`<br>**å€¼è¯´æ˜**: <br>â€¢ `null`: æ²¡æœ‰ä½¿ç”¨ç”°å—çº§è‡ªå®šä¹‰æ ‡å‡†<br>â€¢ `{...}`: åŒ…å«ä½¿ç”¨äº†è‡ªå®šä¹‰æ ‡å‡†çš„ç”°å—<br>**ä½¿ç”¨åœºæ™¯**: å‰ç«¯å¯å±•ç¤ºå“ªäº›ç”°å—ä½¿ç”¨äº†ç‰¹æ®Šçš„æ°´ä½æ ‡å‡†ï¼Œä¾¿äºè¿½è¸ªå’ŒéªŒè¯ã€‚<br>**ç¤ºä¾‹**: `{"S3-G5-F3": {"wl_low": 20.0, "wl_opt": 70.0, "wl_high": 130.0}}` |

---

#### 8.4 æ¸…é™¤ç¼“å­˜

**æ¥å£è¯´æ˜**: æ¸…é™¤æ‰¹æ¬¡é‡æ–°ç”Ÿæˆå’Œè®¡åˆ’ç”Ÿæˆæ¥å£çš„ç¼“å­˜æ•°æ®ï¼Œå¼ºåˆ¶ä¸‹æ¬¡è¯·æ±‚é‡æ–°è®¡ç®—

**è¯·æ±‚**
```
POST /api/regeneration/clear-cache
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| æ—  | - | - | è¯¥æ¥å£æ— éœ€å‚æ•° |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "ç¼“å­˜å·²æ¸…é™¤"
}
```

**ä½¿ç”¨åœºæ™¯**
| åœºæ™¯ | è¯´æ˜ |
|------|------|
| **å¼ºåˆ¶é‡æ–°ç”Ÿæˆ** | å½“ä¿®æ”¹äº†é…ç½®æ–‡ä»¶æˆ–ç”°å—æ•°æ®åï¼Œéœ€è¦å¼ºåˆ¶é‡æ–°è®¡ç®—è€Œä¸æ˜¯è¿”å›ç¼“å­˜ç»“æœ |
| **æµ‹è¯•è°ƒè¯•** | å¼€å‘æµ‹è¯•æ—¶ï¼Œéœ€è¦æ¸…é™¤ç¼“å­˜ä»¥éªŒè¯æ–°çš„è®¡ç®—é€»è¾‘ |
| **æ•°æ®æ›´æ–°å** | æ‰‹åŠ¨æ›´æ–°äº†æ°´ä½æ•°æ®æˆ–å…¶ä»–å…³é”®å‚æ•°ï¼Œéœ€è¦ç«‹å³ç”Ÿæ•ˆ |
| **ç¼“å­˜è¿‡æœŸ** | è™½ç„¶ç³»ç»Ÿæœ‰5åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸï¼Œä½†æŸäº›æƒ…å†µä¸‹éœ€è¦ç«‹å³æ¸…é™¤ |

**æ³¨æ„äº‹é¡¹**
- âš ï¸ æ¸…é™¤ç¼“å­˜åï¼Œä¸‹æ¬¡è¯·æ±‚ä¼šé‡æ–°è®¡ç®—ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
- âœ… æ¸…é™¤æ“ä½œæ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šå½±å“å·²ä¿å­˜çš„è®¡åˆ’æ–‡ä»¶
- ğŸ’¡ ç¼“å­˜æœºåˆ¶é»˜è®¤5åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸï¼Œé€šå¸¸æ— éœ€æ‰‹åŠ¨æ¸…é™¤

---

### 9. æ‰¹æ¬¡è°ƒæ•´

#### 9.1 æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´

**æ¥å£è¯´æ˜**: åœ¨ä¸æ”¹å˜æ‰¹æ¬¡æ•°é‡çš„æƒ…å†µä¸‹ï¼Œè°ƒæ•´ç”°å—åœ¨æ‰¹æ¬¡é—´çš„åˆ†é…ã€‚ä¿æŒç°æœ‰æ‰¹æ¬¡ç»“æ„ï¼Œé‡æ–°è®¡ç®—çŒæº‰é¡ºåºå’Œæ—¶é—´ã€‚

**ä¸æ‰¹æ¬¡é‡æ–°ç”Ÿæˆçš„åŒºåˆ«**:
- `/api/regeneration/batch`: å¢å‡ç”°å—ï¼Œ**å¯èƒ½æ”¹å˜æ‰¹æ¬¡æ•°é‡å’Œç»“æ„**ï¼Œé€‚ç”¨äºç”°å—å¢å‡åœºæ™¯
- `/api/batch/adjust`: æ‰¹æ¬¡é—´ç§»åŠ¨ç”°å—ï¼Œ**æ‰¹æ¬¡æ•°é‡ä¸å˜**ï¼Œåªè°ƒæ•´åˆ†é…ï¼Œé€‚ç”¨äºä¼˜åŒ–ç°æœ‰æ‰¹æ¬¡åœºæ™¯

**è¯·æ±‚**
```
POST /api/batch/adjust
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "plan_id": "/app/output/irrigation_plan_20250109_123456.json",
  "field_adjustments": [
    {
      "field_id": "S3-G5-F3",
      "from_batch": 1,
      "to_batch": 2
    },
    {
      "field_id": "S5-G27-F19",
      "from_batch": 2,
      "to_batch": 1
    }
  ],
  "options": {
    "recalculate_sequence": true,
    "recalculate_timing": true,
    "maintain_pump_assignments": true,
    "regenerate_commands": true
  }
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| plan_id | string | âœ… æ˜¯ | - | çŒæº‰è®¡åˆ’IDæˆ–æ–‡ä»¶è·¯å¾„ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: è¦è°ƒæ•´çš„è®¡åˆ’æ–‡ä»¶è·¯å¾„ï¼Œä½¿ç”¨"ç”ŸæˆçŒæº‰è®¡åˆ’"æ¥å£è¿”å›çš„`plan_id`ã€‚<br>**ç¤ºä¾‹**: `"/app/output/irrigation_plan_20250109_123456.json"` æˆ– `"output/irrigation_plan_20250109_123456.json"` (ç›¸å¯¹è·¯å¾„) |
| field_adjustments | array | âœ… æ˜¯ | - | ç”°å—è°ƒæ•´åˆ—è¡¨ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æŒ‡å®šè¦åœ¨æ‰¹æ¬¡é—´ç§»åŠ¨çš„ç”°å—ã€‚æ”¯æŒå¤šä¸ªç”°å—åŒæ—¶ç§»åŠ¨ï¼Œå¯ä»¥å®ç°æ‰¹æ¬¡é—´ç”°å—äº¤æ¢ã€‚<br>**å¸¸ç”¨åœºæ™¯**:<br>â€¢ ä¼˜åŒ–æ‰¹æ¬¡è´Ÿè½½å‡è¡¡<br>â€¢ è°ƒæ•´çŒæº‰ä¼˜å…ˆçº§<br>â€¢ æ ¹æ®å®é™…æƒ…å†µé‡æ–°åˆ†é…ç”°å—<br>**æ ¼å¼**: è§ä¸‹æ–¹è¯¦ç»†è¯´æ˜ |
| options | object | âŒ å¦ | å…¨éƒ¨ä¸º`true` | è°ƒæ•´é€‰é¡¹é…ç½®ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æ§åˆ¶è°ƒæ•´åçš„é‡æ–°è®¡ç®—è¡Œä¸ºã€‚<br>**å­å­—æ®µ**:<br>â€¢ `recalculate_sequence`: æ˜¯å¦é‡æ–°è®¡ç®—çŒæº‰é¡ºåº<br>â€¢ `recalculate_timing`: æ˜¯å¦é‡æ–°è®¡ç®—æ—¶é—´<br>â€¢ `maintain_pump_assignments`: æ˜¯å¦ä¿æŒæ°´æ³µåˆ†é…<br>â€¢ `regenerate_commands`: æ˜¯å¦é‡æ–°ç”Ÿæˆå‘½ä»¤ |

**field_adjustments è¯¦ç»†è¯´æ˜**

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| field_id | string | âœ… | ç”°å—å”¯ä¸€æ ‡è¯†ç¬¦ã€‚<br>**æ ¼å¼**: `S{ç‰‡åŒº}-G{é—¸é—¨}-F{ç”°å—}`<br>**ç¤ºä¾‹**: `"S3-G5-F3"` |
| from_batch | integer | âœ… | æºæ‰¹æ¬¡ç´¢å¼•ï¼ˆ**ä»1å¼€å§‹**ï¼‰ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: ç”°å—å½“å‰æ‰€åœ¨çš„æ‰¹æ¬¡ã€‚<br>**ç¤ºä¾‹**: `1` |
| to_batch | integer | âœ… | ç›®æ ‡æ‰¹æ¬¡ç´¢å¼•ï¼ˆ**ä»1å¼€å§‹**ï¼‰ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: è¦å°†ç”°å—ç§»åŠ¨åˆ°çš„ç›®æ ‡æ‰¹æ¬¡ã€‚<br>**âš ï¸ æ³¨æ„**: å¿…é¡»æ˜¯å·²å­˜åœ¨çš„æ‰¹æ¬¡ç´¢å¼•<br>**ç¤ºä¾‹**: `2` |

**options è¯¦ç»†è¯´æ˜**

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| recalculate_sequence | boolean | `true` | æ˜¯å¦é‡æ–°è®¡ç®—æ‰¹æ¬¡å†…ç”°å—çš„çŒæº‰é¡ºåºã€‚<br>**ä¸šåŠ¡å«ä¹‰**: `true`æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®è·ç¦»ç­‰çº§é‡æ–°æ’åºç”°å—ï¼Œä¼˜åŒ–çŒæº‰è·¯å¾„ã€‚<br>**å»ºè®®**: é€šå¸¸ä¿æŒ`true` |
| recalculate_timing | boolean | `true` | æ˜¯å¦é‡æ–°è®¡ç®—æ‰¹æ¬¡æ—¶é—´ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: `true`æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®æ–°çš„ç”°å—åˆ†é…é‡æ–°è®¡ç®—æ¯ä¸ªæ‰¹æ¬¡çš„çŒæº‰æ—¶é•¿å’Œé¢„è®¡å®Œæˆæ—¶é—´ã€‚<br>**å»ºè®®**: é€šå¸¸ä¿æŒ`true` |
| maintain_pump_assignments | boolean | `true` | æ˜¯å¦ä¿æŒåŸæœ‰æ°´æ³µåˆ†é…ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: `true`æ—¶ä¿æŒåŸè®¡åˆ’çš„æ°´æ³µé…ç½®ï¼Œ`false`æ—¶å¯èƒ½æ ¹æ®æ–°åˆ†é…é‡æ–°é€‰æ‹©æ°´æ³µã€‚<br>**å»ºè®®**: ä¿æŒ`true`ä»¥é¿å…æ°´æ³µé…ç½®å˜åŒ– |
| regenerate_commands | boolean | `true` | æ˜¯å¦é‡æ–°ç”Ÿæˆæ‰§è¡Œå‘½ä»¤ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: `true`æ—¶ï¼Œç³»ç»Ÿä¼šæ›´æ–°`steps`ä¸­çš„è¯¦ç»†æ‰§è¡ŒæŒ‡ä»¤ï¼ˆåŒ…æ‹¬`sequence.fields`å’Œ`full_order`ï¼‰ï¼Œç¡®ä¿å‘½ä»¤ä¸æ‰¹æ¬¡ä¸€è‡´ã€‚<br>**âš ï¸ é‡è¦**: å¿…é¡»è®¾ä¸º`true`ï¼Œå¦åˆ™æ‰§è¡Œæ—¶ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´æˆåŠŸ",
  "original_plan": {
    "batches": [
      {
        "index": 1,
        "fields": [
          {"id": "S3-G5-F3", "area_mu": 5.225}
        ]
      },
      {
        "index": 2,
        "fields": [
          {"id": "S5-G27-F19", "area_mu": 6.358}
        ]
      }
    ]
  },
  "adjusted_plan": {
    "batches": [
      {
        "index": 1,
        "fields": [
          {"id": "S5-G27-F19", "area_mu": 6.358}
        ]
      },
      {
        "index": 2,
        "fields": [
          {"id": "S3-G5-F3", "area_mu": 5.225}
        ]
      }
    ]
  },
  "changes_summary": {
    "total_fields_moved": 2,
    "affected_batches": [1, 2],
    "field_movements": [
      {
        "field_id": "S3-G5-F3",
        "from_batch": 1,
        "to_batch": 2,
        "status": "success"
      },
      {
        "field_id": "S5-G27-F19",
        "from_batch": 2,
        "to_batch": 1,
        "status": "success"
      }
    ],
    "batch_time_changes": [
      {
        "batch_index": 1,
        "old_duration_h": 18.28,
        "new_duration_h": 19.15,
        "time_diff_h": 0.87
      },
      {
        "batch_index": 2,
        "old_duration_h": 19.15,
        "new_duration_h": 18.28,
        "time_diff_h": -0.87
      }
    ]
  },
  "validation": {
    "is_valid": true,
    "total_fields": 36,
    "total_batches": 4,
    "warnings": []
  },
  "output_file": "/app/output/irrigation_plan_20250109_123456_adjusted_20250109_140530.json"
}
```

**å…³é”®å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| original_plan | object | åŸå§‹è®¡åˆ’çš„å…³é”®ä¿¡æ¯ï¼ˆä»…åŒ…å«å—å½±å“æ‰¹æ¬¡ï¼‰ |
| adjusted_plan | object | è°ƒæ•´åçš„å®Œæ•´è®¡åˆ’æ•°æ® |
| changes_summary | object | å˜æ›´æ‘˜è¦ä¿¡æ¯ |
| changes_summary.total_fields_moved | integer | ç§»åŠ¨çš„ç”°å—æ€»æ•° |
| changes_summary.affected_batches | array | å—å½±å“çš„æ‰¹æ¬¡ç´¢å¼•åˆ—è¡¨ |
| changes_summary.field_movements | array | æ¯ä¸ªç”°å—çš„ç§»åŠ¨è¯¦æƒ… |
| changes_summary.batch_time_changes | array | æ‰¹æ¬¡æ—¶é—´å˜åŒ–è¯¦æƒ… |
| validation | object | éªŒè¯ç»“æœ |
| validation.is_valid | boolean | è°ƒæ•´åçš„è®¡åˆ’æ˜¯å¦æœ‰æ•ˆ |
| validation.warnings | array | è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰ |
| output_file | string | è°ƒæ•´åè®¡åˆ’ä¿å­˜çš„æ–‡ä»¶è·¯å¾„ |

**ä½¿ç”¨åœºæ™¯**

| åœºæ™¯ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **è´Ÿè½½å‡è¡¡** | æŸä¸ªæ‰¹æ¬¡ç”°å—è¿‡å¤šï¼ŒçŒæº‰æ—¶é—´è¿‡é•¿ | å°†éƒ¨åˆ†ç”°å—ç§»è‡³å…¶ä»–æ‰¹æ¬¡ï¼Œå¹³è¡¡å„æ‰¹æ¬¡æ—¶é•¿ |
| **ä¼˜å…ˆçº§è°ƒæ•´** | éœ€è¦ä¼˜å…ˆçŒæº‰æŸäº›ç”°å— | å°†æ€¥éœ€çŒæº‰çš„ç”°å—ç§»è‡³ç¬¬1æ‰¹æ¬¡ |
| **æ•…éšœåº”å¯¹** | æŸæ‰¹æ¬¡çš„æ°´æ³µæˆ–é—¸é—¨æ•…éšœ | å°†è¯¥æ‰¹æ¬¡çš„ç”°å—åˆ†æ•£åˆ°å…¶ä»–æ‰¹æ¬¡ |
| **ç”°å—äº¤æ¢** | ä¸¤ä¸ªæ‰¹æ¬¡é—´äº’æ¢ç”°å— | åŒæ—¶ç§»åŠ¨ä¸¤ä¸ªæ–¹å‘çš„ç”°å—ï¼Œå®ç°äº¤æ¢ |

**æ³¨æ„äº‹é¡¹**
1. âš ï¸ è°ƒæ•´ä¸ä¼šæ”¹å˜æ‰¹æ¬¡æ€»æ•°ï¼Œåªä¼šé‡æ–°åˆ†é…ç”°å—
2. âš ï¸ å¿…é¡»ç¡®ä¿`from_batch`ä¸­åŒ…å«æŒ‡å®šçš„`field_id`
3. âš ï¸ å»ºè®®è°ƒæ•´åæ£€æŸ¥`validation.is_valid`ç¡®ä¿è®¡åˆ’æœ‰æ•ˆ
4. âš ï¸ è°ƒæ•´ä¼šç”Ÿæˆæ–°çš„è®¡åˆ’æ–‡ä»¶ï¼ŒåŸè®¡åˆ’æ–‡ä»¶ä¸ä¼šè¢«ä¿®æ”¹
5. âœ… æ”¯æŒå¤šåœºæ™¯è®¡åˆ’ï¼ˆå¦‚P1å•ç‹¬ã€P2å•ç‹¬ã€P1+P2ç»„åˆï¼‰ï¼Œä¼šåŒæ—¶æ›´æ–°æ‰€æœ‰åœºæ™¯
6. âœ… ç³»ç»Ÿä¼šè‡ªåŠ¨æ›´æ–°`batches`ã€`steps`ã€`sequence.fields`å’Œ`full_order`ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´

---

#### 9.2 æ‰¹æ¬¡é¡ºåºè°ƒæ•´

**æ¥å£è¯´æ˜**: è°ƒæ•´æ‰¹æ¬¡çš„æ‰§è¡Œé¡ºåºï¼Œé€šè¿‡ä¿®æ”¹æ‰¹æ¬¡çš„å¼€å§‹æ—¶é—´æ¥å®ç°é¡ºåºå˜åŒ–ã€‚æ‰¹æ¬¡ç´¢å¼•ä¿æŒä¸å˜ï¼Œåªæ”¹å˜æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚

**è¯·æ±‚**
```
POST /api/batch/reorder
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**
```json
{
  "plan_id": "/app/output/irrigation_plan_20250109_123456.json",
  "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
  "new_order": [2, 1, 3]
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| plan_id | string | âœ… æ˜¯ | çŒæº‰è®¡åˆ’IDæˆ–æ–‡ä»¶è·¯å¾„ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: è¦è°ƒæ•´çš„è®¡åˆ’æ–‡ä»¶è·¯å¾„ã€‚<br>**ç¤ºä¾‹**: `"irrigation_plan_20250109_123456.json"` |
| scenario_name | string | âŒ å¦ | æŒ‡å®šè¦è°ƒæ•´çš„scenarioåç§°ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: åœ¨å¤šæ–¹æ¡ˆè®¡åˆ’ä¸­ï¼ŒæŒ‡å®šè¦è°ƒæ•´å“ªä¸ªscenarioçš„æ‰¹æ¬¡é¡ºåºã€‚<br>**âš ï¸ é‡è¦**: ä¸åŒscenarioå¯èƒ½æœ‰ä¸åŒæ•°é‡çš„æ‰¹æ¬¡ï¼š<br>â€¢ P1å•ç‹¬ä½¿ç”¨ï¼š10ä¸ªæ‰¹æ¬¡<br>â€¢ P2å•ç‹¬ä½¿ç”¨ï¼š10ä¸ªæ‰¹æ¬¡<br>â€¢ P1+P2ç»„åˆä½¿ç”¨ï¼š5ä¸ªæ‰¹æ¬¡ï¼ˆåŒæ³µæµé‡å¤§ï¼‰<br>**å»ºè®®**: å»ºè®®æ˜ç¡®æŒ‡å®šscenario_nameï¼Œé¿å…æ‰¹æ¬¡æ•°é‡ä¸åŒ¹é…é”™è¯¯<br>**å¯é€‰å€¼**: `"P1å•ç‹¬ä½¿ç”¨"`, `"P2å•ç‹¬ä½¿ç”¨"`, `"å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨"`, `"çœç”µæ–¹æ¡ˆ"`, `"çœæ—¶æ–¹æ¡ˆ"`, `"å‡è¡¡æ–¹æ¡ˆ"`, `"é¿å³°æ–¹æ¡ˆ"`, `"èŠ‚æ°´æ–¹æ¡ˆ"`<br>**ç‰¹æ®Šå€¼**: ä¸ä¼ æˆ–`null` - è°ƒæ•´æ‰€æœ‰scenarioï¼ˆè¦æ±‚æ‰€æœ‰scenarioæ‰¹æ¬¡æ•°é‡ç›¸åŒï¼‰<br>**ğŸ’¡ æç¤º**: ä½¿ç”¨ `GET /api/regeneration/scenarios` æ¥å£å¯æŸ¥è¯¢å¯ç”¨çš„scenarioåˆ—è¡¨ |
| new_order | array | âœ… æ˜¯ | æ–°çš„æ‰¹æ¬¡æ‰§è¡Œé¡ºåºåˆ—è¡¨ï¼ˆç´¢å¼•ä»1å¼€å§‹ï¼‰ã€‚<br>**ä¸šåŠ¡å«ä¹‰**: æŒ‡å®šæ‰¹æ¬¡çš„æ–°æ‰§è¡Œé¡ºåºï¼Œå¿…é¡»åŒ…å«æ‰€æœ‰æ‰¹æ¬¡ç´¢å¼•ã€‚<br>**æ ¼å¼**: æ•´æ•°æ•°ç»„ï¼Œä¾‹å¦‚ `[2, 1, 3]` è¡¨ç¤ºæ‰¹æ¬¡2å…ˆæ‰§è¡Œï¼Œç„¶åæ‰¹æ¬¡1ï¼Œæœ€åæ‰¹æ¬¡3<br>**âš ï¸ æ³¨æ„**: <br>â€¢ åˆ—è¡¨é•¿åº¦å¿…é¡»ç­‰äºè¯¥scenarioçš„æ€»æ‰¹æ¬¡æ•°<br>â€¢ å¿…é¡»åŒ…å«ä»1åˆ°æ€»æ‰¹æ¬¡æ•°çš„æ‰€æœ‰ç´¢å¼•<br>â€¢ ä¸èƒ½æœ‰é‡å¤æˆ–é—æ¼<br>**ç¤ºä¾‹**: `[2, 1, 3]` ï¼ˆ3ä¸ªæ‰¹æ¬¡ï¼‰ |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æˆåŠŸè°ƒæ•´æ‰¹æ¬¡é¡ºåºï¼Œå…±4ä¸ªæ‰¹æ¬¡",
  "original_plan": {
    "scenarios": [...]
  },
  "reordered_plan": {
    "scenarios": [...]
  },
  "changes_summary": {
    "order_changed": true,
    "original_order": [1, 2, 3, 4],
    "new_order": [2, 1, 3, 4],
    "total_batches": 4,
    "batch_changes": [
      {
        "batch_index": 1,
        "batch_name": "æ‰¹æ¬¡1",
        "original_position": 1,
        "new_position": 2,
        "position_change": 1,
        "time_change": {
          "original_start": 0,
          "new_start": 18.5,
          "original_end": 18.5,
          "new_end": 37.0
        }
      },
      {
        "batch_index": 2,
        "batch_name": "æ‰¹æ¬¡2",
        "original_position": 2,
        "new_position": 1,
        "position_change": -1,
        "time_change": {
          "original_start": 18.5,
          "new_start": 0,
          "original_end": 37.0,
          "new_end": 18.5
        }
      }
    ],
    "timestamp": "2025-01-10T14:30:25.123Z"
  },
  "validation": {
    "is_valid": true
  },
  "output_file": "e:/irrigation_schedule/farm_irrigation/output/irrigation_plan_20250109_123456_reordered_20250110_143025.json"
}
```

**å…³é”®å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| original_plan | object | åŸå§‹è®¡åˆ’æ•°æ® |
| reordered_plan | object | é‡æ–°æ’åºåçš„å®Œæ•´è®¡åˆ’æ•°æ® |
| changes_summary | object | å˜æ›´æ‘˜è¦ä¿¡æ¯ |
| changes_summary.order_changed | boolean | é¡ºåºæ˜¯å¦å‘ç”Ÿå˜åŒ– |
| changes_summary.original_order | array | åŸå§‹æ‰¹æ¬¡é¡ºåº |
| changes_summary.new_order | array | æ–°çš„æ‰¹æ¬¡é¡ºåº |
| changes_summary.batch_changes | array | æ¯ä¸ªæ‰¹æ¬¡çš„è¯¦ç»†å˜åŒ– |
| changes_summary.batch_changes[].batch_index | integer | æ‰¹æ¬¡ç´¢å¼• |
| changes_summary.batch_changes[].original_position | integer | åŸå§‹ä½ç½®ï¼ˆç¬¬å‡ ä¸ªæ‰§è¡Œï¼‰ |
| changes_summary.batch_changes[].new_position | integer | æ–°ä½ç½®ï¼ˆç¬¬å‡ ä¸ªæ‰§è¡Œï¼‰ |
| changes_summary.batch_changes[].position_change | integer | ä½ç½®å˜åŒ–ï¼ˆæ­£æ•°=åç§»ï¼Œè´Ÿæ•°=å‰ç§»ï¼‰ |
| changes_summary.batch_changes[].time_change | object | æ—¶é—´å˜åŒ–è¯¦æƒ… |
| validation | object | éªŒè¯ç»“æœ |
| output_file | string | é‡æ–°æ’åºåè®¡åˆ’ä¿å­˜çš„æ–‡ä»¶è·¯å¾„ |

**ä½¿ç”¨åœºæ™¯**

| åœºæ™¯ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ä¼˜å…ˆçº§è°ƒæ•´** | æŸä¸ªæ‰¹æ¬¡éœ€è¦ä¼˜å…ˆæ‰§è¡Œ | æ‰¹æ¬¡3çš„ç”°å—ç¼ºæ°´ä¸¥é‡ï¼Œè°ƒæ•´ä¸ºç¬¬ä¸€ä¸ªæ‰§è¡Œ |
| **é¿å³°ç”¨ç”µ** | è°ƒæ•´é¡ºåºä»¥é¿å¼€ç”¨ç”µé«˜å³° | å°†é«˜åŠŸè€—æ‰¹æ¬¡è°ƒæ•´åˆ°å¤œé—´è°·ç”µæ—¶æ®µ |
| **åº”æ€¥å“åº”** | æ ¹æ®å¤©æ°”æˆ–ç´§æ€¥æƒ…å†µå¿«é€Ÿè°ƒæ•´ | å¤©æ°”é¢„æŠ¥æ˜å¤©ä¸‹é›¨ï¼ŒæŠŠæ‰¹æ¬¡4æå‰åˆ°ä»Šå¤© |
| **èµ„æºä¼˜åŒ–** | é…åˆäººåŠ›æˆ–è®¾å¤‡è°ƒåº¦ | è°ƒæ•´æ‰¹æ¬¡é¡ºåºé…åˆå·¡æ£€äººå‘˜çš„å·¥ä½œå®‰æ’ |

**å…¸å‹è°ƒç”¨ç¤ºä¾‹**
```javascript
// åœºæ™¯1ï¼šè°ƒæ•´P2å•ç‹¬ä½¿ç”¨æ–¹æ¡ˆçš„æ‰¹æ¬¡é¡ºåºï¼ˆæ¨èï¼‰
POST /api/batch/reorder
{
  "plan_id": "irrigation_plan_20250109_123456.json",
  "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
  "new_order": [2, 1, 3]  // P2æ–¹æ¡ˆï¼šæ‰¹æ¬¡2å…ˆæ‰§è¡Œï¼Œç„¶åæ‰¹æ¬¡1ï¼Œæœ€åæ‰¹æ¬¡3
}

// åœºæ™¯2ï¼šè°ƒæ•´ç»„åˆæ°´æ³µæ–¹æ¡ˆçš„é¡ºåº
POST /api/batch/reorder
{
  "plan_id": "irrigation_plan_20250109_123456.json",
  "scenario_name": "å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨",
  "new_order": [2, 1]  // ç»„åˆæ–¹æ¡ˆå¯èƒ½åªæœ‰2ä¸ªæ‰¹æ¬¡
}

// åœºæ™¯3ï¼šä¸æŒ‡å®šscenarioï¼ˆè¦æ±‚æ‰€æœ‰scenarioæ‰¹æ¬¡æ•°é‡ç›¸åŒï¼‰
POST /api/batch/reorder
{
  "plan_id": "irrigation_plan_20250109_123456.json",
  "new_order": [2, 1, 3]  // æ‰€æœ‰scenarioçš„æ‰¹æ¬¡é¡ºåºéƒ½ä¼šè°ƒæ•´
}

// åœºæ™¯4ï¼šæ‰¹æ¬¡äº¤æ¢
POST /api/batch/reorder
{
  "plan_id": "irrigation_plan_20250109_123456.json",
  "scenario_name": "çœç”µæ–¹æ¡ˆ",
  "new_order": [1, 2, 4, 3]  // æ‰¹æ¬¡1ã€2ä¸å˜ï¼Œæ‰¹æ¬¡3å’Œ4äº¤æ¢
}
```

**æ³¨æ„äº‹é¡¹**
1. âš ï¸ **ä¸åŒscenarioæ‰¹æ¬¡æ•°é‡å¯èƒ½ä¸åŒ**ï¼šP1å•ç‹¬ä½¿ç”¨å¯èƒ½æœ‰10ä¸ªæ‰¹æ¬¡ï¼ŒP1+P2ç»„åˆå¯èƒ½åªæœ‰5ä¸ªæ‰¹æ¬¡
2. âš ï¸ **å»ºè®®æ˜ç¡®æŒ‡å®šscenario_name**ï¼šé¿å…"æ‰¹æ¬¡æ•°é‡ä¸åŒ¹é…"é”™è¯¯
3. âš ï¸ æ‰¹æ¬¡ç´¢å¼•ä¸ä¼šæ”¹å˜ï¼Œåªæ˜¯æ‰§è¡Œé¡ºåºè°ƒæ•´
4. âš ï¸ å¿…é¡»æä¾›å®Œæ•´çš„æ‰¹æ¬¡é¡ºåºï¼Œä¸èƒ½é—æ¼æˆ–é‡å¤
5. âš ï¸ ç³»ç»Ÿä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—æ‰€æœ‰æ‰¹æ¬¡çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
6. âš ï¸ æ¯ä¸ªæ‰¹æ¬¡çš„æŒç»­æ—¶é—´ä¿æŒä¸å˜ï¼Œåªæ˜¯å¼€å§‹æ—¶é—´è°ƒæ•´
7. âœ… æŒ‡å®šscenario_nameæ—¶åªè°ƒæ•´è¯¥scenarioï¼Œä¸æŒ‡å®šåˆ™è°ƒæ•´æ‰€æœ‰scenarioï¼ˆéœ€æ‰¹æ¬¡æ•°é‡ä¸€è‡´ï¼‰
8. âœ… è°ƒæ•´ä¼šç”Ÿæˆæ–°çš„è®¡åˆ’æ–‡ä»¶ï¼ŒåŸè®¡åˆ’æ–‡ä»¶ä¸ä¼šè¢«ä¿®æ”¹
9. ğŸ’¡ å¦‚æœæ–°é¡ºåºä¸åŸé¡ºåºç›¸åŒï¼Œç³»ç»Ÿä¼šè¿”å›æˆåŠŸä½†ä¸ç”Ÿæˆæ–°æ–‡ä»¶
10. ğŸ’¡ ä½¿ç”¨ `GET /api/regeneration/scenarios` æŸ¥è¯¢å„scenarioçš„æ‰¹æ¬¡æ•°é‡

**ä¸æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´çš„åŒºåˆ«**

| ç‰¹æ€§ | æ‰¹æ¬¡é¡ºåºè°ƒæ•´<br>`/api/batch/reorder` | æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´<br>`/api/batch/adjust` |
|------|-------------------------------------|-------------------------------------|
| **ä¸»è¦åŠŸèƒ½** | è°ƒæ•´æ‰¹æ¬¡æ‰§è¡Œé¡ºåº | åœ¨æ‰¹æ¬¡é—´ç§»åŠ¨ç”°å— |
| **æ‰¹æ¬¡ç´¢å¼•** | ä¿æŒä¸å˜ | ä¿æŒä¸å˜ |
| **æ‰¹æ¬¡å†…å®¹** | ä¿æŒä¸å˜ | ä¼šæ”¹å˜ï¼ˆç”°å—é‡æ–°åˆ†é…ï¼‰ |
| **æ‰§è¡Œé¡ºåº** | âœ… ä¼šæ”¹å˜ | ä¿æŒä¸å˜ |
| **æ—¶é—´å®‰æ’** | âœ… ä¼šé‡æ–°è®¡ç®— | âœ… ä¼šé‡æ–°è®¡ç®— |
| **é€‚ç”¨åœºæ™¯** | â€¢ è°ƒæ•´æ‰§è¡Œä¼˜å…ˆçº§<br>â€¢ é¿å³°ç”¨ç”µ<br>â€¢ åº”æ€¥è°ƒåº¦ | â€¢ è´Ÿè½½å‡è¡¡<br>â€¢ ç”°å—é‡æ–°åˆ†é…<br>â€¢ æ‰¹æ¬¡ä¼˜åŒ– |

---

## 10. ç¡¬ä»¶è®¾å¤‡ç®¡ç†

### 10.1 æŸ¥è¯¢æ‰€æœ‰ç”°å—è®¾å¤‡çŠ¶æ€

**æ¥å£**: `GET /api/hardware/fields-device-status`

**åŠŸèƒ½**: æ ¹æ®å†œåœºIDæŸ¥è¯¢æ‰€æœ‰ç”°å—å¯¹åº”çš„è®¾å¤‡ä¿¡æ¯å’Œå®æ—¶çŠ¶æ€

**å®Œæ•´æµç¨‹**:
1. æ ¹æ®å†œåœºIDè·å–å†œåœºåç§°ï¼ˆä»farm_id_mapping.jsonï¼‰
2. æ ¹æ®å†œåœºåç§°æŸ¥æ‰¾CSVæ–‡ä»¶ï¼Œæå–ç”°å—IDåˆ—è¡¨
3. å¯¹æ¯ä¸ªç”°å—IDï¼Œè·å–å…¶è®¾å¤‡æ˜ å°„ï¼ˆç”°å—ID â†’ è®¾å¤‡ç¼–ç  â†’ è®¾å¤‡ä¿¡æ¯ â†’ uniqueNoï¼‰
4. ç­›é€‰ç‰¹å®šè®¾å¤‡ç±»å‹ï¼ˆ101588ã€101544ã€101134ï¼‰
5. æ ¹æ®è®¾å¤‡ç±»å‹æ ‡è®°ä¸º inout-G æˆ– branch-G
6. æŸ¥è¯¢æ¯ä¸ªè®¾å¤‡çš„å®æ—¶çŠ¶æ€ï¼ˆé—¸é—¨å¼€åº¦ç­‰ï¼‰

**è¯·æ±‚å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| farm_id | string | æ˜¯ | å†œåœºIDï¼ˆå¦‚ï¼š13944136728576 = æ¸¯ä¸­åªï¼‰ |
| app_id | string | å¦ | åº”ç”¨IDï¼ˆé»˜è®¤ä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰ |
| secret | string | å¦ | å¯†é’¥ï¼ˆé»˜è®¤ä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰ |
| timeout | integer | å¦ | è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤30 |
| verbose | boolean | å¦ | æ˜¯å¦æ‰“å°è¯¦ç»†æ—¥å¿—ï¼Œé»˜è®¤false |

**è®¾å¤‡ç±»å‹æ˜ å°„è§„åˆ™**

| deviceTypeCode | è®¾å¤‡ç±»å‹åç§° | æ˜ å°„ä¸ºé—¸é—¨ç±»å‹ | è¯´æ˜ |
|----------------|------------|---------------|------|
| 101588 | æ™ºèƒ½æŠ€æœ¯-è¿›æ°´é˜€ | inout-G | è¿›å‡ºæ°´é—¸ |
| 101544 | å…¶ä»–è¿›å‡ºæ°´é˜€ | inout-G | è¿›å‡ºæ°´é—¸ |
| 101134 | èŠ‚åˆ¶é—¸ | branch-G | æ”¯æ¸ èŠ‚åˆ¶é—¸ |

**å“åº”æ•°æ®ç»“æ„**

```json
{
  "success": true,
  "message": "æˆåŠŸè·å– æ¸¯ä¸­åª å†œåœºæ‰€æœ‰ç”°å—è®¾å¤‡çŠ¶æ€",
  "data": {
    "farm_id": "13944136728576",
    "farm_name": "æ¸¯ä¸­åª",
    "total_fields": 42,
    "fields": [
      {
        "field_id": "1891820536309653504",
        "field_name": "31",
        "section_code": "S6-G39-F26",
        "gates_code": "S6-G39",
        "device_count": 2,
        "devices": [
          {
            "device_code": "157B025010011",
            "unique_no": "471743004049787907",
            "gate_type": "inout-G",
            "device_info": {
              "deviceCode": "157B025010011",
              "deviceName": "300*300é—¸é—¨",
              "deviceTypeCode": "101588",
              "deviceTypeName": "æ™ºèƒ½æŠ€æœ¯-è¿›æ°´é˜€",
              "sectionId": "1891820536309653504",
              "sectionName": "31",
              "farmId": "13944136728576",
              "farmName": "é¼åŸåŒºæ¸¯ä¸­åªæ™ºæ…§å†œåœº",
              "onlineStatus": "0",
              "gateValveType": "0",
              ...
            },
            "status": {
              "gate_degree": 0.0,
              "online_status": "0",
              "success": true
            }
          }
        ]
      }
    ]
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**

| å­—æ®µè·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| success | boolean | æ˜¯å¦æˆåŠŸ |
| message | string | è¿”å›æ¶ˆæ¯ |
| data.farm_id | string | å†œåœºID |
| data.farm_name | string | å†œåœºåç§° |
| data.total_fields | integer | ç”°å—æ€»æ•° |
| data.fields | array | ç”°å—åˆ—è¡¨ |
| data.fields[].field_id | string | ç”°å—IDï¼ˆé•¿IDï¼‰ |
| data.fields[].field_name | string | ç”°å—åç§°ï¼ˆç®€çŸ­ç¼–å·ï¼‰ |
| data.fields[].section_code | string | ç”°å—ç¼–ç ï¼ˆS-G-Fæ ¼å¼ï¼Œå¦‚S6-G39-F26ï¼‰ |
| data.fields[].gates_code | string | é—¸é—¨ç¼–ç ï¼ˆS-Gæ ¼å¼ï¼Œå¦‚S6-G39ï¼Œä»section_codeæå–ï¼‰ |
| data.fields[].device_count | integer | è¯¥ç”°å—çš„è®¾å¤‡æ•°é‡ï¼ˆä»…åŒ…å«ç­›é€‰çš„ç±»å‹ï¼‰ |
| data.fields[].devices | array | è®¾å¤‡åˆ—è¡¨ |
| data.fields[].devices[].device_code | string | è®¾å¤‡ç¼–ç  |
| data.fields[].devices[].unique_no | string | è®¾å¤‡å”¯ä¸€ç¼–å·ï¼ˆç”¨äºæ§åˆ¶ï¼‰ |
| data.fields[].devices[].gate_type | string | é—¸é—¨ç±»å‹æ ‡è®°ï¼ˆinout-G æˆ– branch-Gï¼‰ |
| data.fields[].devices[].device_info | object | å®Œæ•´è®¾å¤‡ä¿¡æ¯ï¼ˆåŒ…å«æ‰€æœ‰å­—æ®µï¼‰ |
| data.fields[].devices[].status | object | è®¾å¤‡å®æ—¶çŠ¶æ€ |
| data.fields[].devices[].status.gate_degree | number | é—¸é—¨å¼€åº¦ï¼ˆ0-100ï¼‰ |
| data.fields[].devices[].status.online_status | string | åœ¨çº¿çŠ¶æ€ï¼ˆ0=ç¦»çº¿, 1=åœ¨çº¿ï¼‰ |
| data.fields[].devices[].status.success | boolean | çŠ¶æ€æŸ¥è¯¢æ˜¯å¦æˆåŠŸ |
| data.fields[].devices[].status.error | string | é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰ |

**ä½¿ç”¨åœºæ™¯**

| åœºæ™¯ | è¯´æ˜ | å…¸å‹ç”¨æ³• |
|------|------|----------|
| **ç›‘æ§çœ‹æ¿** | å±•ç¤ºæ‰€æœ‰ç”°å—è®¾å¤‡çš„å®æ—¶çŠ¶æ€ | å®šæ—¶è½®è¯¢è·å–æœ€æ–°çŠ¶æ€ |
| **è®¾å¤‡ç­›é€‰** | åªæ˜¾ç¤ºè¿›å‡ºæ°´é—¸æˆ–èŠ‚åˆ¶é—¸ | æ ¹æ®gate_typeå­—æ®µè¿‡æ»¤ |
| **å¼‚å¸¸å‘Šè­¦** | æ£€æµ‹ç¦»çº¿æˆ–æ•…éšœè®¾å¤‡ | æ£€æŸ¥onlineStatuså’Œsuccesså­—æ®µ |
| **æ§åˆ¶å‡†å¤‡** | è·å–è®¾å¤‡çš„uniqueNoç”¨äºåç»­æ§åˆ¶ | æå–unique_noåè°ƒç”¨æ§åˆ¶æ¥å£ |

**å…¸å‹è°ƒç”¨ç¤ºä¾‹**

```javascript
// ç¤ºä¾‹1ï¼šè·å–æ¸¯ä¸­åªå†œåœºæ‰€æœ‰è®¾å¤‡çŠ¶æ€
const response = await fetch(
  'http://120.55.127.125/api/hardware/fields-device-status?farm_id=13944136728576',
  {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  }
);
const data = await response.json();

// å¤„ç†ç»“æœ
if (data.success) {
  console.log(`å†œåœº: ${data.data.farm_name}`);
  console.log(`ç”°å—æ•°: ${data.data.total_fields}`);
  
  // éå†ç”°å—
  data.data.fields.forEach(field => {
    console.log(`ç”°å— ${field.field_name} (ID: ${field.field_id}, Code: ${field.section_code || 'N/A'}, Gate: ${field.gates_code || 'N/A'})`);
    console.log(`  è®¾å¤‡æ•°: ${field.device_count}`);
    
    // éå†è®¾å¤‡
    field.devices.forEach(device => {
      console.log(`  - ${device.device_info.deviceTypeName}`);
      console.log(`    ç±»å‹: ${device.gate_type}`);
      console.log(`    å¼€åº¦: ${device.status.gate_degree}%`);
      console.log(`    åœ¨çº¿: ${device.status.online_status === '1' ? 'æ˜¯' : 'å¦'}`);
    });
  });
}

// ç¤ºä¾‹2ï¼šç­›é€‰æ‰€æœ‰è¿›å‡ºæ°´é—¸(inout-G)
const inoutGates = data.data.fields
  .flatMap(field => field.devices)
  .filter(device => device.gate_type === 'inout-G');

console.log(`å…±æœ‰ ${inoutGates.length} ä¸ªè¿›å‡ºæ°´é—¸`);

// ç¤ºä¾‹3ï¼šæŸ¥æ‰¾éœ€è¦å‘Šè­¦çš„è®¾å¤‡ï¼ˆç¦»çº¿æˆ–å¼€åº¦å¼‚å¸¸ï¼‰
const alertDevices = data.data.fields
  .flatMap(field => field.devices.map(d => ({...d, field_name: field.field_name})))
  .filter(device => 
    device.status.online_status === '0' ||  // ç¦»çº¿
    !device.status.success ||               // çŠ¶æ€æŸ¥è¯¢å¤±è´¥
    device.status.gate_degree > 100         // å¼€åº¦å¼‚å¸¸
  );

if (alertDevices.length > 0) {
  console.log('âš ï¸ å‘ç°å¼‚å¸¸è®¾å¤‡:');
  alertDevices.forEach(device => {
    console.log(`  ç”°å—${device.field_name}: ${device.device_info.deviceName}`);
    console.log(`    é—®é¢˜: ${device.status.error || 'è®¾å¤‡ç¦»çº¿'}`);
  });
}
```

**æ³¨æ„äº‹é¡¹**

1. âš ï¸ **è®¾å¤‡ç­›é€‰**: æ¥å£åªè¿”å›ç‰¹å®šç±»å‹çš„è®¾å¤‡ï¼ˆ101588ã€101544ã€101134ï¼‰ï¼Œå…¶ä»–ç±»å‹è®¾å¤‡ä¼šè¢«è‡ªåŠ¨è¿‡æ»¤
2. âš ï¸ **çŠ¶æ€æŸ¥è¯¢å¯èƒ½å¤±è´¥**: éƒ¨åˆ†è®¾å¤‡çš„status.successå¯èƒ½ä¸ºfalseï¼Œéœ€è¦æ£€æŸ¥errorå­—æ®µ
3. âš ï¸ **æ€§èƒ½è€ƒè™‘**: æŸ¥è¯¢æ‰€æœ‰ç”°å—è®¾å¤‡å¯èƒ½è¾ƒæ…¢ï¼Œå»ºè®®ï¼š
   - è®¾ç½®åˆç†çš„timeoutå€¼ï¼ˆå»ºè®®30-60ç§’ï¼‰
   - å‰ç«¯æ˜¾ç¤ºåŠ è½½çŠ¶æ€
   - è€ƒè™‘åˆ†é¡µæˆ–å¢é‡æ›´æ–°
4. âœ… **è®¾å¤‡åˆ†ç±»**: ä½¿ç”¨gate_typeå­—æ®µå¯ä»¥å¿«é€ŸåŒºåˆ†è¿›å‡ºæ°´é—¸å’ŒèŠ‚åˆ¶é—¸
5. âœ… **å®æ—¶æ€§**: é—¸é—¨å¼€åº¦ä¸ºå®æ—¶æŸ¥è¯¢å€¼ï¼Œåæ˜ å½“å‰å®é™…çŠ¶æ€
6. ğŸ’¡ **unique_noçš„ç”¨é€”**: è¯¥å­—æ®µæ˜¯è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºåç»­çš„è®¾å¤‡æ§åˆ¶æ“ä½œ
7. ğŸ’¡ **æ‰¹é‡å¤„ç†**: å¯ä»¥ä½¿ç”¨æ•°ç»„æ–¹æ³•(map, filter, reduce)å¯¹æ•°æ®è¿›è¡Œæ‰¹é‡å¤„ç†å’Œç»Ÿè®¡

**æ•°æ®æµç¨‹å›¾**

```
å†œåœºID (13944136728576)
  â†“
å†œåœºåç§° (æ¸¯ä¸­åª) â† ä» farm_id_mapping.json è¯»å–
  â†“
ç”°å—åˆ—è¡¨ â† ä» æ¸¯ä¸­åªåœ°å—id.csv è¯»å–
  â†“
å¯¹æ¯ä¸ªç”°å—:
  â”œâ”€> ç”°å—ID â†’ API: equipment.listCodeBySection
  â”œâ”€> è®¾å¤‡ç¼–ç åˆ—è¡¨ â†’ ç­›é€‰(101588/101544/101134)
  â”œâ”€> å¯¹æ¯ä¸ªè®¾å¤‡ç¼–ç :
  â”‚     â”œâ”€> API: equipment.getByDeviceCode
  â”‚     â”œâ”€> è·å– uniqueNo + deviceTypeCode
  â”‚     â”œâ”€> æ˜ å°„ä¸º gate_type (inout-G/branch-G)
  â”‚     â””â”€> API: device.properties.newest (æŸ¥è¯¢å¼€åº¦)
  â””â”€> è¿”å›: ç”°å—è®¾å¤‡åˆ—è¡¨ + çŠ¶æ€
```

---

### 10.2 æ ¹æ®è®¡åˆ’è·å–è®¾å¤‡åˆ—è¡¨

**æ¥å£**: `GET /api/hardware/devices-from-plan`

**åŠŸèƒ½**: æ ¹æ®çŒæº‰è®¡åˆ’IDè·å–éœ€è¦è‡ªæ£€çš„è®¾å¤‡åˆ—è¡¨ï¼Œç®€åŒ–å‰ç«¯å¤„ç†é€»è¾‘

**ä½¿ç”¨åœºæ™¯**: 
- ç”ŸæˆçŒæº‰è®¡åˆ’åï¼Œå¿«é€Ÿè·å–éœ€è¦è‡ªæ£€çš„è®¾å¤‡åˆ—è¡¨
- å‰ç«¯æ— éœ€æ‰‹åŠ¨ç­›é€‰ç”°å—å’Œè®¾å¤‡ï¼Œç›´æ¥è·å–unique_noåˆ—è¡¨

**å®Œæ•´æµç¨‹**:
1. è¯»å–çŒæº‰è®¡åˆ’æ–‡ä»¶
2. æå–éœ€è¦çŒæº‰çš„ç”°å—IDåˆ—è¡¨
3. æŸ¥è¯¢è¿™äº›ç”°å—å¯¹åº”çš„è®¾å¤‡
4. è¿”å›è®¾å¤‡çš„unique_noåˆ—è¡¨

**è¯·æ±‚å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| farm_id | string | âœ… æ˜¯ | - | å†œåœºIDï¼ˆå¦‚ï¼š13944136728576ï¼‰ |
| plan_id | string | âŒ å¦ | æœ€æ–°è®¡åˆ’ | çŒæº‰è®¡åˆ’IDæˆ–æ–‡ä»¶åï¼ˆç•™ç©ºä½¿ç”¨æœ€æ–°è®¡åˆ’ï¼‰ |
| scenario_name | string | âŒ å¦ | ç¬¬ä¸€ä¸ª | æ–¹æ¡ˆåç§°ï¼ˆå¦‚ï¼š"P2å•ç‹¬ä½¿ç”¨"ï¼‰ |
| app_id | string | âŒ å¦ | ç¯å¢ƒå˜é‡ | iLandå¹³å°åº”ç”¨ID |
| secret | string | âŒ å¦ | ç¯å¢ƒå˜é‡ | iLandå¹³å°å¯†é’¥ |
| timeout | integer | âŒ å¦ | 30 | è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |

**å“åº”æ•°æ®ç»“æ„**

```json
{
  "success": true,
  "message": "æˆåŠŸè·å– 36 ä¸ªç”°å—å¯¹åº”çš„ 58 ä¸ªè®¾å¤‡",
  "data": {
    "unique_no_list": [
      "477379421064159253",
      "471743004049787907",
      "471743004051885071",
      "992503151729510001"
    ],
    "field_count": 36,
    "device_count": 58,
    "plan_file": "/app/output/irrigation_plan_20250121_123456.json",
    "scenario_name": "P2å•ç‹¬ä½¿ç”¨",
    "field_device_mapping": {
      "S3-G2-F1": [
        {
          "unique_no": "477379421064159253",
          "device_name": "300*300é—¸é—¨",
          "gate_type": "inout-G"
        }
      ],
      "S3-G3-F2": [
        {
          "unique_no": "471743004049787907",
          "device_name": "300*300é—¸é—¨",
          "gate_type": "inout-G"
        }
      ]
    }
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**

| å­—æ®µè·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| success | boolean | æ˜¯å¦æˆåŠŸ |
| message | string | è¿”å›æ¶ˆæ¯ |
| data.unique_no_list | array | **æ ¸å¿ƒå­—æ®µ**ï¼šè®¾å¤‡å”¯ä¸€æ ‡è¯†åˆ—è¡¨ï¼Œå¯ç›´æ¥ç”¨äºè‡ªæ£€æ¥å£ |
| data.field_count | integer | éœ€è¦çŒæº‰çš„ç”°å—æ•°é‡ |
| data.device_count | integer | è®¾å¤‡æ€»æ•°é‡ |
| data.plan_file | string | ä½¿ç”¨çš„è®¡åˆ’æ–‡ä»¶è·¯å¾„ |
| data.scenario_name | string | ä½¿ç”¨çš„æ–¹æ¡ˆåç§° |
| data.field_device_mapping | object | ç”°å—ä¸è®¾å¤‡çš„è¯¦ç»†æ˜ å°„å…³ç³»ï¼ˆå¯é€‰ï¼‰ |

**å…¸å‹è°ƒç”¨ç¤ºä¾‹**

```javascript
// ç¤ºä¾‹1ï¼šä½¿ç”¨æœ€æ–°è®¡åˆ’
const response = await fetch(
  'http://120.55.127.125/api/hardware/devices-from-plan?farm_id=13944136728576',
  {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  }
);
const data = await response.json();

if (data.success) {
  console.log(`âœ… è·å–åˆ° ${data.data.device_count} ä¸ªè®¾å¤‡`);
  console.log('è®¾å¤‡åˆ—è¡¨:', data.data.unique_no_list);
  
  // ç›´æ¥ç”¨äºè‡ªæ£€æ¥å£
  const checkResponse = await fetch('/api/hardware/device-self-check', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      unique_no_list: data.data.unique_no_list
    })
  });
}

// ç¤ºä¾‹2ï¼šæŒ‡å®šè®¡åˆ’æ–‡ä»¶å’Œæ–¹æ¡ˆ
const response2 = await fetch(
  'http://120.55.127.125/api/hardware/devices-from-plan?' +
  'farm_id=13944136728576&' +
  'plan_id=irrigation_plan_20250121_123456.json&' +
  'scenario_name=P2å•ç‹¬ä½¿ç”¨',
  {
    method: 'GET',
    headers: { 'Content-Type': 'application/json' }
  }
);

// ç¤ºä¾‹3ï¼šå®Œæ•´ä¸šåŠ¡æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
async function irrigationWorkflow() {
  // 1. ç”ŸæˆçŒæº‰è®¡åˆ’
  const plan = await fetch('/api/irrigation/plan-generation', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ farm_id: "13944136728576" })
  }).then(r => r.json());
  
  console.log(`âœ… è®¡åˆ’ç”ŸæˆæˆåŠŸ: ${plan.plan_id}`);
  
  // 2. è·å–è®¾å¤‡åˆ—è¡¨ï¼ˆä½¿ç”¨æ–°æ¥å£ï¼‰
  const devices = await fetch(
    `/api/hardware/devices-from-plan?farm_id=13944136728576`
  ).then(r => r.json());
  
  console.log(`âœ… è·å–åˆ° ${devices.data.device_count} ä¸ªè®¾å¤‡`);
  
  // 3. è®¾å¤‡è‡ªæ£€
  const check = await fetch('/api/hardware/device-self-check', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      unique_no_list: devices.data.unique_no_list
    })
  }).then(r => r.json());
  
  console.log(`âœ… è‡ªæ£€å®Œæˆ: ${check.data.success_count}/${check.data.total_devices} è®¾å¤‡æ­£å¸¸`);
}
```

**ä¸åŸæœ‰æ–¹æ¡ˆçš„å¯¹æ¯”**

| ç‰¹æ€§ | åŸæœ‰æ–¹æ¡ˆï¼ˆå‰ç«¯ç­›é€‰ï¼‰ | æ–°æ¥å£æ–¹æ¡ˆ |
|------|---------------------|-----------|
| **æ¥å£è°ƒç”¨æ¬¡æ•°** | 3æ¬¡ï¼ˆç”Ÿæˆè®¡åˆ’ + æŸ¥è¯¢æ‰€æœ‰è®¾å¤‡ + è‡ªæ£€ï¼‰ | 3æ¬¡ï¼ˆç”Ÿæˆè®¡åˆ’ + **è·å–è®¾å¤‡åˆ—è¡¨** + è‡ªæ£€ï¼‰ |
| **å‰ç«¯ä»£ç å¤æ‚åº¦** | é«˜ï¼ˆéœ€è¦ç­›é€‰é€»è¾‘ï¼‰ | ä½ï¼ˆç›´æ¥ä½¿ç”¨è¿”å›çš„åˆ—è¡¨ï¼‰ |
| **æ•°æ®ä¼ è¾“é‡** | å¤§ï¼ˆè¿”å›æ‰€æœ‰è®¾å¤‡ï¼‰ | å°ï¼ˆåªè¿”å›éœ€è¦çš„è®¾å¤‡ï¼‰ |
| **æ˜“ç”¨æ€§** | ä¸­ç­‰ | â­â­â­â­â­ é«˜ |
| **ç»´æŠ¤æ€§** | å‰ç«¯éœ€ç»´æŠ¤ç­›é€‰é€»è¾‘ | åç«¯ç»Ÿä¸€å¤„ç† |

**ä¼˜åŠ¿è¯´æ˜**

1. âœ… **ç®€åŒ–å‰ç«¯é€»è¾‘**ï¼šå‰ç«¯æ— éœ€ç†è§£ç”°å—ç­›é€‰é€»è¾‘
2. âœ… **å‡å°‘æ•°æ®ä¼ è¾“**ï¼šåªè¿”å›éœ€è¦çš„è®¾å¤‡ï¼Œä¸æ˜¯å…¨éƒ¨è®¾å¤‡
3. âœ… **æé«˜å¯ç»´æŠ¤æ€§**ï¼šç­›é€‰é€»è¾‘åœ¨åç«¯ç»Ÿä¸€ç®¡ç†
4. âœ… **æ›´å¥½çš„å°è£…**ï¼šå‰ç«¯åªéœ€å…³å¿ƒä¸šåŠ¡æµç¨‹ï¼Œä¸éœ€å…³å¿ƒå®ç°ç»†èŠ‚
5. âœ… **æ˜“äºè°ƒè¯•**ï¼šå¯ä»¥ç‹¬ç«‹æµ‹è¯•è®¾å¤‡åˆ—è¡¨è·å–åŠŸèƒ½

**æ³¨æ„äº‹é¡¹**

1. âš ï¸ **plan_idæ ¼å¼**ï¼š
   - æ”¯æŒå®Œæ•´è·¯å¾„ï¼š`/app/output/irrigation_plan_*.json`
   - æ”¯æŒæ–‡ä»¶åï¼š`irrigation_plan_*.json`
   - ç•™ç©ºä½¿ç”¨æœ€æ–°è®¡åˆ’
   
2. âš ï¸ **scenario_name**ï¼š
   - ä¸åŒæ–¹æ¡ˆçš„æ‰¹æ¬¡æ•°é‡å¯èƒ½ä¸åŒ
   - å»ºè®®æ˜ç¡®æŒ‡å®šï¼Œé¿å…è¯¯ç”¨
   
3. âœ… **ç¼“å­˜æœºåˆ¶**ï¼šæ¥å£å†…éƒ¨ä¼šç¼“å­˜è®¾å¤‡æŸ¥è¯¢ç»“æœï¼Œæé«˜æ€§èƒ½

4. ğŸ’¡ **è°ƒè¯•å»ºè®®**ï¼š
   - å¯ä»¥æŸ¥çœ‹ `field_device_mapping` äº†è§£è¯¦ç»†æ˜ å°„å…³ç³»
   - æ—¥å¿—ä¼šè¾“å‡ºè¯¦ç»†çš„æ‰§è¡Œæ­¥éª¤

---

### 10.3 è®¾å¤‡è‡ªæ£€å®Œæ•´å·¥ä½œæµ

**æ¥å£**: `POST /api/hardware/device-self-check`

**åŠŸèƒ½**: è§¦å‘æŒ‡å®šè®¾å¤‡çš„è‡ªæ£€ä»»åŠ¡ï¼Œå¹¶è½®è¯¢æŸ¥è¯¢è‡ªæ£€çŠ¶æ€ç›´è‡³å®Œæˆ

**æ³¨æ„**: æ­¤æ¥å£éœ€è¦æ‰‹åŠ¨ä¼ å…¥ `unique_no_list`ã€‚å¦‚æœæ˜¯åŸºäºçŒæº‰è®¡åˆ’çš„è‡ªæ£€ï¼Œå»ºè®®ä½¿ç”¨ `10.2 æ ¹æ®è®¡åˆ’è·å–è®¾å¤‡åˆ—è¡¨` æ¥å£å…ˆè·å–è®¾å¤‡åˆ—è¡¨ã€‚

**å®Œæ•´æµç¨‹**:
1. æ¥æ”¶è®¾å¤‡å”¯ä¸€æ ‡è¯†åˆ—è¡¨ï¼ˆunique_no_listï¼‰
2. è°ƒç”¨ç¡¬ä»¶ç½‘å…³è§¦å‘è‡ªæ£€ä»»åŠ¡ï¼ˆ`/device_self_check`ï¼‰
3. è½®è¯¢æŸ¥è¯¢è‡ªæ£€çŠ¶æ€ï¼ˆ`/devices_status`ï¼‰
4. è¿”å›æœ€ç»ˆè‡ªæ£€ç»“æœ

**è¯·æ±‚å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| unique_no_list | array | æ˜¯ | è®¾å¤‡å”¯ä¸€æ ‡è¯†åˆ—è¡¨ï¼ˆå¦‚ï¼š["477379421064159253", "477379421064159255"]ï¼‰ |
| timeout | integer | å¦ | è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤300ç§’ |
| poll_interval | integer | å¦ | è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤5ç§’ |

**è®¾å¤‡è‡ªæ£€çŠ¶æ€è¯´æ˜**

| çŠ¶æ€å€¼ | å«ä¹‰ | è¯´æ˜ |
|--------|------|------|
| `initialized` | å·²åˆå§‹åŒ– | è®¾å¤‡å·²åˆå§‹åŒ–ï¼Œç­‰å¾…è‡ªæ£€ä»»åŠ¡ |
| `scheduled` | å·²è°ƒåº¦ | è‡ªæ£€ä»»åŠ¡å·²è¢«è°ƒåº¦ï¼Œç­‰å¾…æ‰§è¡Œ |
| `checking` | è‡ªæ£€ä¸­ | è®¾å¤‡æ­£åœ¨æ‰§è¡Œè‡ªæ£€ |
| `check_success` | è‡ªæ£€æˆåŠŸ | è®¾å¤‡è‡ªæ£€é€šè¿‡ï¼ŒçŠ¶æ€æ­£å¸¸ |
| `check_failed` | è‡ªæ£€å¤±è´¥ | è®¾å¤‡è‡ªæ£€å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨æ•…éšœ |

**å“åº”æ•°æ®ç»“æ„**

```json
{
  "success": true,
  "message": "è®¾å¤‡è‡ªæ£€å®Œæˆï¼Œ2 ä¸ªæˆåŠŸï¼Œ0 ä¸ªå¤±è´¥",
  "data": {
    "total_devices": 2,
    "success_count": 2,
    "failed_count": 0,
    "timeout_count": 0,
    "devices": [
      {
        "unique_no": "477379421064159253",
        "status": "check_success",
        "check_duration_seconds": 12.5,
        "status_history": [
          {
            "status": "scheduled",
            "timestamp": "2025-01-10T10:30:00.123Z"
          },
          {
            "status": "checking",
            "timestamp": "2025-01-10T10:30:05.456Z"
          },
          {
            "status": "check_success",
            "timestamp": "2025-01-10T10:30:12.789Z"
          }
        ]
      },
      {
        "unique_no": "477379421064159255",
        "status": "check_success",
        "check_duration_seconds": 10.8,
        "status_history": [
          {
            "status": "scheduled",
            "timestamp": "2025-01-10T10:30:00.123Z"
          },
          {
            "status": "checking",
            "timestamp": "2025-01-10T10:30:04.321Z"
          },
          {
            "status": "check_success",
            "timestamp": "2025-01-10T10:30:11.098Z"
          }
        ]
      }
    ],
    "total_duration_seconds": 15.2,
    "hardware_api_url": "http://101.201.78.54:8100"
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**

| å­—æ®µè·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| success | boolean | æ˜¯å¦æˆåŠŸï¼ˆæ‰€æœ‰è®¾å¤‡éƒ½å®Œæˆè‡ªæ£€å³ä¸ºæˆåŠŸï¼‰ |
| message | string | è¿”å›æ¶ˆæ¯ |
| data.total_devices | integer | è®¾å¤‡æ€»æ•° |
| data.success_count | integer | è‡ªæ£€æˆåŠŸè®¾å¤‡æ•° |
| data.failed_count | integer | è‡ªæ£€å¤±è´¥è®¾å¤‡æ•° |
| data.timeout_count | integer | è‡ªæ£€è¶…æ—¶è®¾å¤‡æ•° |
| data.devices | array | è®¾å¤‡åˆ—è¡¨ |
| data.devices[].unique_no | string | è®¾å¤‡å”¯ä¸€æ ‡è¯† |
| data.devices[].status | string | æœ€ç»ˆçŠ¶æ€ï¼ˆcheck_success/check_failed/timeoutï¼‰ |
| data.devices[].check_duration_seconds | float | è‡ªæ£€è€—æ—¶ï¼ˆç§’ï¼‰ |
| data.devices[].status_history | array | çŠ¶æ€å˜åŒ–å†å² |
| data.devices[].status_history[].status | string | çŠ¶æ€å€¼ |
| data.devices[].status_history[].timestamp | string | çŠ¶æ€å˜æ›´æ—¶é—´ |
| data.total_duration_seconds | float | æ€»è€—æ—¶ï¼ˆç§’ï¼‰ |
| data.hardware_api_url | string | ç¡¬ä»¶ç½‘å…³åœ°å€ |

**ä½¿ç”¨åœºæ™¯**

| åœºæ™¯ | è¯´æ˜ | å…¸å‹ç”¨æ³• |
|------|------|----------|
| **çŒæº‰å‰æ£€æŸ¥** | æ‰§è¡ŒçŒæº‰è®¡åˆ’å‰æ£€æŸ¥è®¾å¤‡çŠ¶æ€ | è°ƒç”¨æ­¤æ¥å£ç¡®è®¤æ‰€æœ‰é—¸é—¨æ­£å¸¸ |
| **å®šæœŸå·¡æ£€** | å®šæ—¶æ£€æŸ¥è®¾å¤‡å¥åº·çŠ¶æ€ | æ¯æ—¥å®šæ—¶è§¦å‘è‡ªæ£€ |
| **æ•…éšœæ’æŸ¥** | è®¾å¤‡å¼‚å¸¸æ—¶è§¦å‘è‡ªæ£€ç¡®è®¤é—®é¢˜ | é—¸é—¨æ§åˆ¶å¤±è´¥åè§¦å‘è‡ªæ£€ |
| **ç³»ç»Ÿåˆå§‹åŒ–** | ç³»ç»Ÿå¯åŠ¨æ—¶æ£€æŸ¥è®¾å¤‡å°±ç»ªçŠ¶æ€ | å¯åŠ¨æ—¶å¯¹æ‰€æœ‰è®¾å¤‡æ‰§è¡Œè‡ªæ£€ |

**å…¸å‹è°ƒç”¨ç¤ºä¾‹**

```javascript
// ç¤ºä¾‹1ï¼šçŒæº‰å‰è®¾å¤‡è‡ªæ£€
const response = await fetch(
  'http://120.55.127.125/api/hardware/device-self-check',
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      unique_no_list: [
        "477379421064159253",
        "477379421064159255"
      ],
      timeout: 300,
      poll_interval: 5
    })
  }
);
const data = await response.json();

// å¤„ç†ç»“æœ
if (data.success) {
  console.log(`âœ… è‡ªæ£€å®Œæˆ: ${data.data.success_count}/${data.data.total_devices} è®¾å¤‡æ­£å¸¸`);
  
  // æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥è®¾å¤‡
  if (data.data.failed_count > 0) {
    const failedDevices = data.data.devices.filter(d => d.status === 'check_failed');
    console.log('âš ï¸ ä»¥ä¸‹è®¾å¤‡è‡ªæ£€å¤±è´¥:');
    failedDevices.forEach(device => {
      console.log(`  - ${device.unique_no}`);
    });
  }
} else {
  console.log('âŒ è‡ªæ£€å¤±è´¥:', data.message);
}

// ç¤ºä¾‹2ï¼šé…åˆç”°å—è®¾å¤‡çŠ¶æ€æŸ¥è¯¢ä½¿ç”¨
// æ­¥éª¤1: æŸ¥è¯¢å†œåœºæ‰€æœ‰ç”°å—è®¾å¤‡
const fieldsResponse = await fetch(
  'http://120.55.127.125/api/hardware/fields-device-status?farm_id=13944136728576'
);
const fieldsData = await fieldsResponse.json();

// æ­¥éª¤2: æå–æ‰€æœ‰è®¾å¤‡çš„ unique_no
const allUniqueNos = fieldsData.data.fields
  .flatMap(field => field.devices)
  .map(device => device.unique_no);

console.log(`å‡†å¤‡å¯¹ ${allUniqueNos.length} ä¸ªè®¾å¤‡æ‰§è¡Œè‡ªæ£€`);

// æ­¥éª¤3: æ‰¹é‡è‡ªæ£€
const checkResponse = await fetch(
  'http://120.55.127.125/api/hardware/device-self-check',
  {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      unique_no_list: allUniqueNos
    })
  }
);
const checkData = await checkResponse.json();

// æ­¥éª¤4: åˆ†æç»“æœ
console.log(`è‡ªæ£€å®Œæˆï¼Œè€—æ—¶ ${checkData.data.total_duration_seconds} ç§’`);
console.log(`æˆåŠŸ: ${checkData.data.success_count}, å¤±è´¥: ${checkData.data.failed_count}`);

// ç¤ºä¾‹3ï¼šé”™è¯¯å¤„ç†
try {
  const response = await fetch('/api/hardware/device-self-check', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      unique_no_list: ["477379421064159253"]
    })
  });
  
  if (!response.ok) {
    const error = await response.json();
    console.error('è‡ªæ£€è¯·æ±‚å¤±è´¥:', error.detail);
  }
  
  const data = await response.json();
  
  // æ£€æŸ¥æ˜¯å¦æœ‰è¶…æ—¶è®¾å¤‡
  if (data.data.timeout_count > 0) {
    console.log('âš ï¸ éƒ¨åˆ†è®¾å¤‡è‡ªæ£€è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è®¾å¤‡çŠ¶æ€');
  }
  
} catch (error) {
  console.error('ç½‘ç»œé”™è¯¯:', error);
}
```

**æ³¨æ„äº‹é¡¹**

1. âš ï¸ **æ‰¹é‡è‡ªæ£€é™åˆ¶**: å»ºè®®å•æ¬¡è‡ªæ£€è®¾å¤‡æ•°é‡ â‰¤ 50 ä¸ªï¼Œé¿å…è¶…æ—¶
2. âš ï¸ **è¶…æ—¶è®¾ç½®**: é»˜è®¤è¶…æ—¶ 300 ç§’ï¼Œå¯æ ¹æ®è®¾å¤‡æ•°é‡è°ƒæ•´
3. âš ï¸ **è½®è¯¢é—´éš”**: é»˜è®¤ 5 ç§’è½®è¯¢ä¸€æ¬¡ï¼Œä¸å»ºè®®è®¾ç½®è¿‡å°ï¼ˆ< 3 ç§’ï¼‰
4. âš ï¸ **ç½‘ç»œä¾èµ–**: ä¾èµ–ç¡¬ä»¶ç½‘å…³ï¼ˆ101.201.78.54:8100ï¼‰è¿é€šæ€§
5. âœ… **çŠ¶æ€è¿½è¸ª**: è¿”å›å®Œæ•´çŠ¶æ€å†å²ï¼Œå¯ç”¨äºåˆ†æè‡ªæ£€è¿‡ç¨‹
6. âœ… **å¼‚æ­¥æ‰§è¡Œ**: æ¥å£å†…éƒ¨å¤„ç†è½®è¯¢ï¼Œå‰ç«¯åªéœ€ç­‰å¾…æœ€ç»ˆç»“æœ
7. ğŸ’¡ **è‡ªæ£€è€—æ—¶**: å•ä¸ªè®¾å¤‡è‡ªæ£€é€šå¸¸ 5-15 ç§’ï¼Œæ‰¹é‡è‡ªæ£€ä¼šå¹¶è¡Œæ‰§è¡Œ
8. ğŸ’¡ **å¤±è´¥é‡è¯•**: å¦‚æœéƒ¨åˆ†è®¾å¤‡å¤±è´¥ï¼Œå¯ä»¥åªå¯¹å¤±è´¥è®¾å¤‡é‡æ–°è‡ªæ£€

**å·¥ä½œæµç¨‹å›¾**

```
å‰ç«¯è¯·æ±‚
  â†“
API æ¥å£: /api/hardware/device-self-check
  â†“
è°ƒç”¨ç¡¬ä»¶ç½‘å…³: POST /device_self_check
  â†“
è§¦å‘è‡ªæ£€ä»»åŠ¡ï¼ˆè¿”å› acceptedï¼‰
  â†“
è½®è¯¢æŸ¥è¯¢çŠ¶æ€: GET /devices_status
  â”œâ”€> scheduledï¼ˆå·²è°ƒåº¦ï¼‰
  â”œâ”€> checkingï¼ˆè‡ªæ£€ä¸­ï¼‰
  â””â”€> check_success / check_failedï¼ˆå®Œæˆï¼‰
  â†“
è¿”å›æœ€ç»ˆç»“æœç»™å‰ç«¯
```

**ä¸ç”°å—è®¾å¤‡çŠ¶æ€æŸ¥è¯¢çš„é…åˆä½¿ç”¨**

```javascript
// å®Œæ•´å·¥ä½œæµï¼šæŸ¥è¯¢è®¾å¤‡ â†’ è‡ªæ£€ â†’ éªŒè¯
const fullWorkflow = async (farmId) => {
  // 1. æŸ¥è¯¢å†œåœºæ‰€æœ‰è®¾å¤‡
  const fieldsResp = await fetch(
    `/api/hardware/fields-device-status?farm_id=${farmId}`
  );
  const fields = await fieldsResp.json();
  
  console.log(`ğŸ“Š å†œåœºå…±æœ‰ ${fields.data.total_fields} ä¸ªç”°å—`);
  
  // 2. ç­›é€‰éœ€è¦è‡ªæ£€çš„è®¾å¤‡ï¼ˆå¦‚ï¼šåªæ£€æŸ¥è¿›å‡ºæ°´é—¸ï¼‰
  const inoutGates = fields.data.fields
    .flatMap(f => f.devices)
    .filter(d => d.gate_type === 'inout-G');
  
  const uniqueNos = inoutGates.map(d => d.unique_no);
  
  console.log(`ğŸ” å‡†å¤‡å¯¹ ${uniqueNos.length} ä¸ªè¿›å‡ºæ°´é—¸è¿›è¡Œè‡ªæ£€`);
  
  // 3. æ‰§è¡Œè‡ªæ£€
  const checkResp = await fetch('/api/hardware/device-self-check', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ unique_no_list: uniqueNos })
  });
  const checkResult = await checkResp.json();
  
  // 4. åˆ†æç»“æœ
  console.log(`âœ… è‡ªæ£€å®Œæˆ`);
  console.log(`  æ­£å¸¸: ${checkResult.data.success_count} ä¸ª`);
  console.log(`  å¼‚å¸¸: ${checkResult.data.failed_count} ä¸ª`);
  console.log(`  è¶…æ—¶: ${checkResult.data.timeout_count} ä¸ª`);
  
  // 5. å¤„ç†å¼‚å¸¸è®¾å¤‡
  if (checkResult.data.failed_count > 0) {
    const failedDevices = checkResult.data.devices
      .filter(d => d.status === 'check_failed');
    
    console.log('âš ï¸ éœ€è¦ç»´æŠ¤çš„è®¾å¤‡:');
    failedDevices.forEach(device => {
      // æŸ¥æ‰¾è®¾å¤‡æ‰€å±ç”°å—
      const field = fields.data.fields.find(f => 
        f.devices.some(d => d.unique_no === device.unique_no)
      );
      
      console.log(`  - ç”°å— ${field.field_name} (${field.section_code})`);
      console.log(`    è®¾å¤‡: ${device.unique_no}`);
    });
  }
  
  return checkResult;
};

// ä½¿ç”¨ç¤ºä¾‹
fullWorkflow("13944136728576");
```

---

### 10.4 è·å–æ‰¹æ¬¡è®¾å¤‡æŒ‡ä»¤

**æ¥å£**: `GET /api/execution/batch-commands`

**åŠŸèƒ½**: è·å–æ‰¹æ¬¡è®¾å¤‡æ§åˆ¶æŒ‡ä»¤ï¼Œä¾›ç¡¬ä»¶å›¢é˜Ÿè½®è¯¢è°ƒç”¨

**ä½¿ç”¨åœºæ™¯**: 
- ç¡¬ä»¶å›¢é˜Ÿå®šæœŸè½®è¯¢è·å–å¾…æ‰§è¡Œçš„è®¾å¤‡æ§åˆ¶æŒ‡ä»¤
- è·å–æ‰¹æ¬¡å¯åŠ¨ã€æ‰§è¡Œä¸­ã€åœæ­¢é˜¶æ®µçš„æ‰€æœ‰è®¾å¤‡æŒ‡ä»¤
- æ”¯æŒæŒ‰é˜¶æ®µå’ŒçŠ¶æ€ç­›é€‰æŒ‡ä»¤

**å®Œæ•´æµç¨‹**:
1. åç«¯åœ¨æ‰¹æ¬¡æ‰§è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆè®¾å¤‡æ§åˆ¶æŒ‡ä»¤
2. ç¡¬ä»¶å›¢é˜Ÿå®šæœŸè½®è¯¢æ­¤æ¥å£è·å– pending çŠ¶æ€çš„æŒ‡ä»¤
3. æ¥å£è¿”å›æŒ‡ä»¤åˆ—è¡¨å¹¶è‡ªåŠ¨æ ‡è®°ä¸º sent
4. ç¡¬ä»¶å›¢é˜Ÿæ‰§è¡ŒæŒ‡ä»¤åè°ƒç”¨åé¦ˆæ¥å£

**è¯·æ±‚å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| execution_id | string | âœ… æ˜¯ | - | æ‰§è¡ŒIDï¼ˆç”±å¯åŠ¨æ‰§è¡Œæ¥å£è¿”å›ï¼‰ |
| batch_index | integer | âŒ å¦ | å½“å‰æ‰¹æ¬¡ | æ‰¹æ¬¡ç´¢å¼•ï¼ˆå¯é€‰ï¼‰ |
| phase | string | âŒ å¦ | null | é˜¶æ®µç­›é€‰ï¼šstart/running/stop |
| status | string | âŒ å¦ | pending | çŠ¶æ€ç­›é€‰ï¼špending/sent/executed/failed |

**é˜¶æ®µè¯´æ˜**

| é˜¶æ®µå€¼ | å«ä¹‰ | åŒ…å«çš„æŒ‡ä»¤ç±»å‹ |
|--------|------|----------------|
| `start` | æ‰¹æ¬¡å¯åŠ¨é˜¶æ®µ | æ³µç«™å¯åŠ¨ã€èŠ‚åˆ¶é—¸å¼€å¯ã€ç”°å—è¿›æ°´é˜€å¼€å¯ |
| `running` | æ‰¹æ¬¡æ‰§è¡Œä¸­ | æ°´ä½è¾¾æ ‡åçš„è®¾å¤‡å…³é—­æŒ‡ä»¤ |
| `stop` | æ‰¹æ¬¡åœæ­¢é˜¶æ®µ | æ‰¹æ¬¡ç»“æŸæ—¶çš„æ³µç«™åœæ­¢æŒ‡ä»¤ |

**çŠ¶æ€è¯´æ˜**

| çŠ¶æ€å€¼ | å«ä¹‰ | è¯´æ˜ |
|--------|------|------|
| `pending` | å¾…æ‰§è¡Œ | æ–°ç”Ÿæˆçš„æŒ‡ä»¤ï¼Œç­‰å¾…ç¡¬ä»¶å›¢é˜Ÿè·å– |
| `sent` | å·²å‘é€ | æŒ‡ä»¤å·²è¢«ç¡¬ä»¶å›¢é˜Ÿè·å–ï¼Œæ­£åœ¨æ‰§è¡Œä¸­ |
| `executed` | å·²æ‰§è¡Œ | ç¡¬ä»¶å›¢é˜Ÿåé¦ˆæ‰§è¡ŒæˆåŠŸ |
| `failed` | æ‰§è¡Œå¤±è´¥ | ç¡¬ä»¶å›¢é˜Ÿåé¦ˆæ‰§è¡Œå¤±è´¥ |

**å“åº”æ•°æ®ç»“æ„**

```json
{
  "success": true,
  "execution_id": "exec_20250121_123456",
  "batch_index": 1,
  "phase": "start",
  "timestamp": "2025-01-21T12:34:56.789Z",
  "commands": [
    {
      "command_id": "cmd_0001",
      "device_type": "pump",
      "device_id": "P1",
      "unique_no": null,
      "action": "start",
      "params": {},
      "priority": 1,
      "phase": "start",
      "description": "å¯åŠ¨P1æ³µç«™",
      "status": "pending",
      "reason": null,
      "created_at": "2025-01-21T12:34:56.789Z"
    },
    {
      "command_id": "cmd_0002",
      "device_type": "regulator",
      "device_id": "S3-G2",
      "unique_no": "477379421064159253",
      "action": "open",
      "params": {
        "open_pct": 100,
        "gate_degree": 100
      },
      "priority": 2,
      "phase": "start",
      "description": "å¼€å¯S3-G2èŠ‚åˆ¶é—¸(100%)",
      "status": "pending",
      "reason": null,
      "created_at": "2025-01-21T12:34:56.789Z"
    },
    {
      "command_id": "cmd_0003",
      "device_type": "field_inlet_gate",
      "device_id": "S3-G2-F1",
      "unique_no": "471743004049787907",
      "action": "open",
      "params": {
        "gate_degree": 100
      },
      "priority": 3,
      "phase": "start",
      "description": "å¼€å¯S3-G2-F1è¿›æ°´é˜€",
      "status": "pending",
      "reason": null,
      "created_at": "2025-01-21T12:34:56.789Z"
    }
  ],
  "total_commands": 36,
  "has_new_commands": true,
  "statistics": {
    "total_commands": 36,
    "pending": 30,
    "sent": 6,
    "executed": 0,
    "failed": 0
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**

| å­—æ®µè·¯å¾„ | ç±»å‹ | è¯´æ˜ |
|---------|------|------|
| success | boolean | æ˜¯å¦æˆåŠŸ |
| execution_id | string | æ‰§è¡ŒID |
| batch_index | integer | æ‰¹æ¬¡ç´¢å¼• |
| phase | string | é˜¶æ®µ |
| timestamp | string | æŸ¥è¯¢æ—¶é—´æˆ³ |
| commands | array | æŒ‡ä»¤åˆ—è¡¨ |
| commands[].command_id | string | æŒ‡ä»¤å”¯ä¸€ID |
| commands[].device_type | string | è®¾å¤‡ç±»å‹ï¼špump/regulator/field_inlet_gate/field_outlet_gate |
| commands[].device_id | string | è®¾å¤‡ID |
| commands[].unique_no | string/null | è®¾å¤‡å”¯ä¸€ç¼–å·ï¼ˆç”¨äºå®é™…æ§åˆ¶ï¼‰ |
| commands[].action | string | åŠ¨ä½œï¼šstart/stop/open/close/set |
| commands[].params | object | åŠ¨ä½œå‚æ•° |
| commands[].priority | integer | ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ |
| commands[].description | string | æŒ‡ä»¤æè¿° |
| commands[].reason | string/null | ç”ŸæˆåŸå› ï¼ˆå¦‚"æ°´ä½è¾¾æ ‡"ï¼‰ |
| total_commands | integer | æŒ‡ä»¤æ€»æ•° |
| has_new_commands | boolean | æ˜¯å¦æœ‰æ–°æŒ‡ä»¤ |
| statistics | object | ç»Ÿè®¡ä¿¡æ¯ |

**è®¾å¤‡ç±»å‹è¯´æ˜**

| device_type | è¯´æ˜ | action å¯é€‰å€¼ | æ§åˆ¶æ–¹å¼ |
|-------------|------|----------------|----------|
| `pump` | æ³µç«™ | start, stop | å¯åŠ¨/åœæ­¢ |
| `regulator` | èŠ‚åˆ¶é—¸ | open, close | å¼€å¯(100%)/å…³é—­(0%) |
| `field_inlet_gate` | ç”°å—è¿›æ°´é˜€ | open, close | å¼€å¯(100%)/å…³é—­(0%) |
| `field_outlet_gate` | ç”°å—å‡ºæ°´é˜€ | open, close, set | å¼€å¯/å…³é—­/è®¾ç½®å¼€åº¦ |

**å…¸å‹è°ƒç”¨ç¤ºä¾‹**

```javascript
// ç¤ºä¾‹1ï¼šè·å–å¾…æ‰§è¡Œçš„å¯åŠ¨æŒ‡ä»¤ï¼ˆç¡¬ä»¶å›¢é˜Ÿé¦–æ¬¡è°ƒç”¨ï¼‰
const response = await fetch(
  'http://120.55.127.125/api/execution/batch-commands?' +
  'execution_id=exec_20250121_123456&' +
  'phase=start&' +
  'status=pending',
  {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  }
);
const data = await response.json();

if (data.success && data.has_new_commands) {
  console.log(`âœ… è·å–åˆ° ${data.total_commands} æ¡å¾…æ‰§è¡ŒæŒ‡ä»¤`);
  
  // æŒ‰ä¼˜å…ˆçº§æ‰§è¡ŒæŒ‡ä»¤
  data.commands.forEach(cmd => {
    console.log(`[${cmd.priority}] ${cmd.description}`);
    console.log(`  è®¾å¤‡: ${cmd.device_id}, unique_no: ${cmd.unique_no}`);
    console.log(`  åŠ¨ä½œ: ${cmd.action}, å‚æ•°:`, cmd.params);
    
    // æ‰§è¡Œç¡¬ä»¶æ§åˆ¶
    executeHardwareCommand(cmd);
  });
}

// ç¤ºä¾‹2ï¼šè½®è¯¢è·å–æ‰§è¡Œä¸­çš„å…³é—­æŒ‡ä»¤
const pollCommands = async (executionId) => {
  const response = await fetch(
    `http://120.55.127.125/api/execution/batch-commands?` +
    `execution_id=${executionId}&` +
    `phase=running&` +
    `status=pending`,
    { method: 'GET' }
  );
  const data = await response.json();
  
  if (data.has_new_commands) {
    console.log(`ğŸ”„ æ£€æµ‹åˆ° ${data.total_commands} æ¡æ–°æŒ‡ä»¤`);
    data.commands.forEach(cmd => {
      if (cmd.reason) {
        console.log(`  åŸå› : ${cmd.reason}`);
      }
      executeHardwareCommand(cmd);
    });
  }
};

// æ¯30ç§’è½®è¯¢ä¸€æ¬¡
setInterval(() => pollCommands('exec_20250121_123456'), 30000);

// ç¤ºä¾‹3ï¼šæŸ¥çœ‹æ‰€æœ‰æŒ‡ä»¤ç»Ÿè®¡
const response3 = await fetch(
  'http://120.55.127.125/api/execution/batch-commands?' +
  'execution_id=exec_20250121_123456',
  { method: 'GET' }
);
const data3 = await response3.json();

console.log('ğŸ“Š æŒ‡ä»¤ç»Ÿè®¡:');
console.log(`  æ€»è®¡: ${data3.statistics.total_commands}`);
console.log(`  å¾…æ‰§è¡Œ: ${data3.statistics.pending}`);
console.log(`  å·²å‘é€: ${data3.statistics.sent}`);
console.log(`  å·²æ‰§è¡Œ: ${data3.statistics.executed}`);
console.log(`  å¤±è´¥: ${data3.statistics.failed}`);
```

**æ³¨æ„äº‹é¡¹**

1. âš ï¸ **è‡ªåŠ¨çŠ¶æ€è½¬æ¢**: è°ƒç”¨æ­¤æ¥å£è·å– `pending` çŠ¶æ€çš„æŒ‡ä»¤åï¼Œè¿™äº›æŒ‡ä»¤ä¼šè‡ªåŠ¨æ ‡è®°ä¸º `sent`
2. âš ï¸ **è½®è¯¢é¢‘ç‡**: å»ºè®®æ¯30ç§’è½®è¯¢ä¸€æ¬¡ï¼Œä¸è¦è®¾ç½®è¿‡å°ï¼ˆ< 10ç§’ï¼‰
3. âš ï¸ **ä¼˜å…ˆçº§æ‰§è¡Œ**: æŒ‡ä»¤æŒ‰ `priority` å­—æ®µæ’åºï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå»ºè®®æŒ‰é¡ºåºæ‰§è¡Œ
4. âš ï¸ **unique_no å­—æ®µ**: 
   - æ³µç«™æŒ‡ä»¤çš„ `unique_no` å¯èƒ½ä¸º `null`ï¼ˆéœ€è¦ç¡¬ä»¶å›¢é˜Ÿæ ¹æ® `device_id` æ˜ å°„ï¼‰
   - èŠ‚åˆ¶é—¸å’Œç”°å—é—¸é—¨çš„ `unique_no` é€šå¸¸éƒ½æœ‰å€¼
5. âœ… **å¹‚ç­‰æ€§**: åŒä¸€ä¸ª `command_id` å¤šæ¬¡è·å–ä¸ä¼šé‡å¤æ‰§è¡Œ
6. âœ… **å®Œæ•´æ€§**: åŒ…å«æ‰¹æ¬¡å¯åŠ¨ã€æ‰§è¡Œä¸­ã€åœæ­¢çš„æ‰€æœ‰è®¾å¤‡æ§åˆ¶æŒ‡ä»¤
7. ğŸ’¡ **é˜¶æ®µç­›é€‰**: 
   - `start`: æ‰¹æ¬¡å¼€å§‹æ—¶è·å–ï¼Œæ‰§è¡Œæ³µç«™å¯åŠ¨ã€é—¸é—¨å¼€å¯
   - `running`: æŒç»­è½®è¯¢ï¼Œè·å–æ°´ä½è¾¾æ ‡åçš„å…³é—­æŒ‡ä»¤
   - `stop`: æ‰¹æ¬¡ç»“æŸæ—¶è·å–ï¼Œæ‰§è¡Œæ³µç«™åœæ­¢

**å·¥ä½œæµç¨‹å›¾**

```
æ‰¹æ¬¡å¯åŠ¨
  â†“
åç«¯ç”Ÿæˆå¯åŠ¨æŒ‡ä»¤ (phase: start)
  â†“
ç¡¬ä»¶å›¢é˜Ÿè·å–æŒ‡ä»¤ (GET /batch-commands?phase=start&status=pending)
  â†“
æŒ‡ä»¤è‡ªåŠ¨æ ‡è®°ä¸º sent
  â†“
ç¡¬ä»¶å›¢é˜Ÿæ‰§è¡ŒæŒ‡ä»¤ï¼ˆå¯åŠ¨æ³µç«™ã€å¼€å¯é—¸é—¨ï¼‰
  â†“
ç¡¬ä»¶å›¢é˜Ÿæäº¤åé¦ˆ (POST /command-feedback)
  â†“
æ‰¹æ¬¡æ‰§è¡Œä¸­
  â†“
åç«¯ç›‘æ§æ°´ä½ï¼Œç”Ÿæˆå…³é—­æŒ‡ä»¤ (phase: running)
  â†“
ç¡¬ä»¶å›¢é˜Ÿè½®è¯¢è·å– (æ¯30ç§’)
  â†“
æ£€æµ‹åˆ°æ–°æŒ‡ä»¤ â†’ æ‰§è¡Œ â†’ åé¦ˆ
  â†“
æ‰€æœ‰ç”°å—å®Œæˆ
  â†“
åç«¯ç”Ÿæˆåœæ³µæŒ‡ä»¤ (phase: stop)
  â†“
ç¡¬ä»¶å›¢é˜Ÿè·å–å¹¶æ‰§è¡Œ
  â†“
æ‰¹æ¬¡å®Œæˆ
```

---

### 10.5 æäº¤æŒ‡ä»¤åé¦ˆ

**æ¥å£**: `POST /api/execution/command-feedback`

**åŠŸèƒ½**: ç¡¬ä»¶å›¢é˜Ÿåé¦ˆæŒ‡ä»¤æ‰§è¡Œç»“æœ

**ä½¿ç”¨åœºæ™¯**: 
- ç¡¬ä»¶å›¢é˜Ÿæ‰§è¡Œå®Œè®¾å¤‡æ§åˆ¶æŒ‡ä»¤åï¼Œåé¦ˆæ‰§è¡ŒçŠ¶æ€
- è®°å½•æŒ‡ä»¤æ‰§è¡Œç»“æœï¼Œç”¨äºç³»ç»Ÿç›‘æ§å’Œé—®é¢˜è¿½è¸ª
- æ›´æ–°æŒ‡ä»¤çŠ¶æ€ï¼Œä¾¿äºåç»­ç»Ÿè®¡å’Œåˆ†æ

**è¯·æ±‚å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| command_id | string | âœ… æ˜¯ | æŒ‡ä»¤IDï¼ˆä»è·å–æŒ‡ä»¤æ¥å£è·å¾—ï¼‰ |
| status | string | âœ… æ˜¯ | æ‰§è¡ŒçŠ¶æ€ï¼šexecutedï¼ˆæˆåŠŸï¼‰/ failedï¼ˆå¤±è´¥ï¼‰ |
| message | string | âŒ å¦ | åé¦ˆæ¶ˆæ¯ï¼ˆå»ºè®®æä¾›è¯¦ç»†ä¿¡æ¯ï¼‰ |
| execution_time | float | âŒ å¦ | æ‰§è¡Œè€—æ—¶ï¼ˆç§’ï¼‰ |

**è¯·æ±‚ç¤ºä¾‹**

```bash
# æ–¹å¼1: FormDataï¼ˆæ¨èï¼‰
curl -X POST "http://120.55.127.125/api/execution/command-feedback" \
  -F "command_id=cmd_0001" \
  -F "status=executed" \
  -F "message=P1æ³µç«™å·²æˆåŠŸå¯åŠ¨ï¼Œå½“å‰è½¬é€Ÿ2800rpm" \
  -F "execution_time=2.5"

# æ–¹å¼2: JSONï¼ˆä¹Ÿæ”¯æŒï¼‰
curl -X POST "http://120.55.127.125/api/execution/command-feedback" \
  -H "Content-Type: application/json" \
  -d '{
    "command_id": "cmd_0001",
    "status": "executed",
    "message": "P1æ³µç«™å·²æˆåŠŸå¯åŠ¨",
    "execution_time": 2.5
  }'
```

**å“åº”ç¤ºä¾‹**

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "message": "åé¦ˆå·²è®°å½•",
  "command_id": "cmd_0001"
}
```

**å¤±è´¥å“åº”**:
```json
{
  "success": false,
  "error": "æŒ‡ä»¤ä¸å­˜åœ¨",
  "command_id": "cmd_9999"
}
```

**å…¸å‹è°ƒç”¨ç¤ºä¾‹**

```javascript
// ç¤ºä¾‹1ï¼šæ‰§è¡ŒæˆåŠŸçš„åé¦ˆ
const submitSuccess = async (commandId) => {
  const formData = new FormData();
  formData.append('command_id', commandId);
  formData.append('status', 'executed');
  formData.append('message', 'P1æ³µç«™å·²æˆåŠŸå¯åŠ¨ï¼Œå½“å‰è½¬é€Ÿ2800rpm');
  formData.append('execution_time', '2.5');
  
  const response = await fetch(
    'http://120.55.127.125/api/execution/command-feedback',
    {
      method: 'POST',
      body: formData
    }
  );
  
  const data = await response.json();
  if (data.success) {
    console.log(`âœ… æŒ‡ä»¤ ${commandId} åé¦ˆæˆåŠŸ`);
  }
};

// ç¤ºä¾‹2ï¼šæ‰§è¡Œå¤±è´¥çš„åé¦ˆ
const submitFailure = async (commandId, errorMsg) => {
  const formData = new FormData();
  formData.append('command_id', commandId);
  formData.append('status', 'failed');
  formData.append('message', errorMsg);
  
  const response = await fetch(
    'http://120.55.127.125/api/execution/command-feedback',
    {
      method: 'POST',
      body: formData
    }
  );
  
  const data = await response.json();
  if (data.success) {
    console.log(`âš ï¸ æŒ‡ä»¤ ${commandId} æ‰§è¡Œå¤±è´¥: ${errorMsg}`);
  }
};

// ç¤ºä¾‹3ï¼šæ‰¹é‡åé¦ˆ
const batchFeedback = async (commands) => {
  const results = await Promise.all(
    commands.map(cmd => 
      fetch('http://120.55.127.125/api/execution/command-feedback', {
        method: 'POST',
        body: new URLSearchParams({
          command_id: cmd.command_id,
          status: cmd.success ? 'executed' : 'failed',
          message: cmd.message,
          execution_time: cmd.executionTime
        })
      }).then(r => r.json())
    )
  );
  
  const successCount = results.filter(r => r.success).length;
  console.log(`ğŸ“Š æ‰¹é‡åé¦ˆå®Œæˆ: ${successCount}/${results.length}`);
};

// ç¤ºä¾‹4ï¼šå®Œæ•´çš„æŒ‡ä»¤æ‰§è¡Œæµç¨‹
const executeCommand = async (command) => {
  console.log(`ğŸ”§ æ‰§è¡ŒæŒ‡ä»¤: ${command.description}`);
  
  try {
    // 1. æ‰§è¡Œç¡¬ä»¶æ§åˆ¶
    const startTime = Date.now();
    
    if (command.device_type === 'pump') {
      await controlPump(command.device_id, command.action);
    } else if (command.device_type === 'regulator') {
      await controlRegulator(command.unique_no, command.params.gate_degree);
    } else if (command.device_type === 'field_inlet_gate') {
      await controlGate(command.unique_no, command.params.gate_degree);
    }
    
    const executionTime = (Date.now() - startTime) / 1000;
    
    // 2. åé¦ˆæ‰§è¡ŒæˆåŠŸ
    const formData = new FormData();
    formData.append('command_id', command.command_id);
    formData.append('status', 'executed');
    formData.append('message', `${command.description} æ‰§è¡ŒæˆåŠŸ`);
    formData.append('execution_time', executionTime.toString());
    
    await fetch('http://120.55.127.125/api/execution/command-feedback', {
      method: 'POST',
      body: formData
    });
    
    console.log(`âœ… ${command.description} å®Œæˆ (${executionTime}s)`);
    
  } catch (error) {
    // 3. åé¦ˆæ‰§è¡Œå¤±è´¥
    const formData = new FormData();
    formData.append('command_id', command.command_id);
    formData.append('status', 'failed');
    formData.append('message', `æ‰§è¡Œå¤±è´¥: ${error.message}`);
    
    await fetch('http://120.55.127.125/api/execution/command-feedback', {
      method: 'POST',
      body: formData
    });
    
    console.error(`âŒ ${command.description} å¤±è´¥: ${error.message}`);
  }
};
```

**åé¦ˆæ¶ˆæ¯å»ºè®®**

**æˆåŠŸç¤ºä¾‹**:
```
- "P1æ³µç«™å·²æˆåŠŸå¯åŠ¨ï¼Œå½“å‰è½¬é€Ÿ2800rpm"
- "S3-G2èŠ‚åˆ¶é—¸å·²å¼€å¯è‡³100%ï¼Œå½“å‰å¼€åº¦100%"
- "S3-G2-F1è¿›æ°´é˜€å·²å¼€å¯ï¼Œæµé‡æ­£å¸¸"
- "P1æ³µç«™å·²åœæ­¢ï¼Œè¿è¡Œæ—¶é•¿2.5å°æ—¶"
```

**å¤±è´¥ç¤ºä¾‹**:
```
- "P1æ³µç«™å¯åŠ¨å¤±è´¥ï¼šç”µæœºè¿‡çƒ­ä¿æŠ¤"
- "S3-G2èŠ‚åˆ¶é—¸æ— å“åº”ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥"
- "S3-G2-F1è¿›æ°´é˜€å¼€å¯å¤±è´¥ï¼šé˜€é—¨å¡æ­»"
- "è®¾å¤‡ç¦»çº¿ï¼Œæ— æ³•æ§åˆ¶"
```

**æ³¨æ„äº‹é¡¹**

1. âš ï¸ **åŠæ—¶åé¦ˆ**: æ‰§è¡Œå®ŒæŒ‡ä»¤ååº”ç«‹å³æäº¤åé¦ˆï¼Œä¸è¦å»¶è¿Ÿ
2. âš ï¸ **è¯¦ç»†æ¶ˆæ¯**: å»ºè®®æä¾›è¯¦ç»†çš„åé¦ˆæ¶ˆæ¯ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
3. âš ï¸ **å¤±è´¥åŸå› **: æ‰§è¡Œå¤±è´¥æ—¶å¿…é¡»æä¾›å…·ä½“çš„å¤±è´¥åŸå› 
4. âš ï¸ **æ‰§è¡Œæ—¶é—´**: å»ºè®®è®°å½•æ‰§è¡Œè€—æ—¶ï¼Œç”¨äºæ€§èƒ½åˆ†æ
5. âœ… **å¹‚ç­‰æ€§**: åŒä¸€ä¸ª command_id å¯ä»¥å¤šæ¬¡æäº¤åé¦ˆï¼ˆä¼šæ›´æ–°æœ€åä¸€æ¬¡ï¼‰
6. âœ… **å¼‚æ­¥å¤„ç†**: åé¦ˆæ¥å£æ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¼šé˜»å¡ç¡¬ä»¶å›¢é˜Ÿçš„å…¶ä»–æ“ä½œ
7. ğŸ’¡ **æ—¥å¿—è®°å½•**: æ‰€æœ‰åé¦ˆéƒ½ä¼šè®°å½•åˆ°ç³»ç»Ÿæ—¥å¿—ä¸­
8. ğŸ’¡ **ç»Ÿè®¡åˆ†æ**: å¯ä»¥é€šè¿‡è·å–æŒ‡ä»¤æ¥å£çš„ statistics å­—æ®µæŸ¥çœ‹æ‰§è¡Œç»Ÿè®¡

**å®Œæ•´å·¥ä½œæµç¨‹**

```javascript
// ç¡¬ä»¶å›¢é˜Ÿçš„å®Œæ•´å·¥ä½œæµ
const hardwareWorker = async (executionId) => {
  while (true) {
    // 1. è·å–å¾…æ‰§è¡ŒæŒ‡ä»¤
    const response = await fetch(
      `http://120.55.127.125/api/execution/batch-commands?` +
      `execution_id=${executionId}&status=pending`
    );
    const data = await response.json();
    
    if (data.has_new_commands) {
      console.log(`ğŸ“¥ è·å–åˆ° ${data.total_commands} æ¡æ–°æŒ‡ä»¤`);
      
      // 2. æŒ‰ä¼˜å…ˆçº§æ‰§è¡ŒæŒ‡ä»¤
      for (const command of data.commands) {
        await executeCommand(command);
      }
    } else {
      console.log('â¸ï¸  æš‚æ— æ–°æŒ‡ä»¤');
    }
    
    // 3. ç­‰å¾…30ç§’åç»§ç»­è½®è¯¢
    await new Promise(resolve => setTimeout(resolve, 30000));
  }
};

// å¯åŠ¨ç¡¬ä»¶å·¥ä½œçº¿ç¨‹
hardwareWorker('exec_20250121_123456');
```

---

### 11. Rice æ™ºèƒ½å†³ç­–é›†æˆ

#### 11.1 æ£€æŸ¥ Rice æœåŠ¡çŠ¶æ€

**æ¥å£è¯´æ˜**: æ£€æŸ¥ rice_smart_irrigation æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ

**è¯·æ±‚**
```
GET /api/irrigation/rice-status?rice_api_url=http://localhost:5000/v1/rice_irrigation
```

**æŸ¥è¯¢å‚æ•°**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| rice_api_url | string | å¦ | http://localhost:5000/v1/rice_irrigation | Rice API åœ°å€ |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "status_code": 200,
  "message": "Rice æœåŠ¡æ­£å¸¸",
  "rice_api_url": "http://localhost:5000/v1/rice_irrigation",
  "timestamp": "2025-11-20T15:30:45.123456"
}
```

**çŠ¶æ€ç è¯´æ˜**
- `200`: Rice æœåŠ¡æ­£å¸¸
- `503`: æ— æ³•è¿æ¥åˆ° Rice æœåŠ¡

---

#### 11.2 åŸºäº Rice å†³ç­–ç”ŸæˆçŒæº‰è®¡åˆ’

**æ¥å£è¯´æ˜**: è°ƒç”¨ rice_smart_irrigation çš„æ™ºèƒ½å†³ç­–ï¼Œç”ŸæˆçŒæº‰è®¡åˆ’

**æ¶æ„è¯´æ˜**:
- rice_smart_irrigation: ç‹¬ç«‹æœåŠ¡ï¼Œæä¾›æ™ºèƒ½å†³ç­– APIï¼ˆç«¯å£ 5000ï¼‰
- farm_irrigation: ç‹¬ç«‹æœåŠ¡ï¼Œè´Ÿè´£è®¡åˆ’ç”Ÿæˆå’Œæ‰§è¡Œï¼ˆç«¯å£ 8000ï¼‰
- ä¸¤ä¸ªæœåŠ¡é€šè¿‡ HTTP API é€šä¿¡ï¼Œå®Œå…¨è§£è€¦

**è¯·æ±‚**
```
POST /api/irrigation/generate-from-rice
Content-Type: application/json
```

**è¯·æ±‚ä½“**
```json
{
  "farm_id": "13944136728576",
  "rice_api_url": "http://localhost:5000/v1/rice_irrigation",
  "pumps": "P1,P2",
  "time_constraints": false,
  "auto_execute": false
}
```

**å‚æ•°è¯´æ˜**
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| farm_id | string | æ˜¯ | - | å†œåœºID |
| rice_api_url | string | å¦ | http://localhost:5000/v1/rice_irrigation | Rice API åœ°å€ |
| pumps | string | å¦ | P1,P2 | å¯ç”¨çš„æ°´æ³µï¼ˆé€—å·åˆ†éš”ï¼‰ |
| time_constraints | boolean | å¦ | false | æ˜¯å¦å¯ç”¨æ—¶é—´çº¦æŸ |
| auto_execute | boolean | å¦ | false | æ˜¯å¦è‡ªåŠ¨æ‰§è¡Œç”Ÿæˆçš„è®¡åˆ’ |

**å“åº”ç¤ºä¾‹**
```json
{
  "success": true,
  "message": "æˆåŠŸï¼åŸºäº Rice æ™ºèƒ½å†³ç­–ç”ŸæˆçŒæº‰è®¡åˆ’ï¼ˆ8 ä¸ªç”°å—ï¼‰",
  "decision_count": 36,
  "irrigate_count": 8,
  "plan_file": "e:/irrigation_schedule/farm_irrigation/data/output/irrigation_plan_20251120_153045.json",
  "execution_id": null,
  "details": {
    "skipped_sections": [],
    "mapping_count": 36,
    "converted_count": 8
  }
}
```

**å“åº”å­—æ®µè¯´æ˜**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| success | boolean | æ˜¯å¦æˆåŠŸ |
| message | string | æ¶ˆæ¯ |
| decision_count | integer | Rice å†³ç­–æ€»æ•° |
| irrigate_count | integer | éœ€è¦çŒæº‰çš„ç”°å—æ•° |
| plan_file | string | ç”Ÿæˆçš„è®¡åˆ’æ–‡ä»¶è·¯å¾„ |
| execution_id | string/null | æ‰§è¡ŒIDï¼ˆå¦‚æœ auto_execute=trueï¼‰ |
| details.skipped_sections | array | æœªæ‰¾åˆ°æ˜ å°„çš„ç”°å—åˆ—è¡¨ |
| details.mapping_count | integer | ç”°å—æ˜ å°„æ€»æ•° |
| details.converted_count | integer | æˆåŠŸè½¬æ¢çš„ç”°å—æ•° |

**å·¥ä½œæµç¨‹**
1. è°ƒç”¨ Rice API è·å–æ™ºèƒ½å†³ç­– (HTTP)
2. æ˜ å°„ç”°å—ID (section_id â†’ field_id)
3. æ„é€ çŒæº‰å‚æ•°
4. è°ƒç”¨ç°æœ‰çš„è®¡åˆ’ç”Ÿæˆæ¥å£
5. (å¯é€‰) è‡ªåŠ¨å¯åŠ¨æ‰§è¡Œ

**Rice å†³ç­–ç¤ºä¾‹**
Rice API è¿”å›çš„å†³ç­–æ ¼å¼ï¼š
```json
{
  "1901477857038049280": {
    "action": "irrigate",
    "current_waterlevel": 45.2,
    "target": 90.0,
    "reason": "åˆ†è˜–æœŸæ°´ä½ä½äºé€‚å®œæ°´ä½",
    "irrigation_amount": 157.8,
    "irrigation_duration": 0.53
  },
  "1901478066941992960": {
    "action": "none",
    "current_waterlevel": 85.0,
    "target": 90.0,
    "reason": "æ°´ä½é€‚å®œ"
  }
}
```

**æ˜ å°„è½¬æ¢**
```
Rice section_id          Farm field_id
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1901477857038049280  â†’  S3-G2-F1
1901478066941992960  â†’  S3-G5-F3
```

**ä¸ä¼ ç»Ÿæ–¹æ³•çš„å¯¹æ¯”**
| ç‰¹æ€§ | ä¼ ç»Ÿæ–¹æ³• | Rice é›†æˆ |
|------|---------|-----------|
| å†³ç­–ä¾æ® | å›ºå®šé˜ˆå€¼ (wl_low/wl_opt) | ç”Ÿè‚²æœŸ + å¤©æ°” + å†œäº‹æ“ä½œ |
| çµæ´»æ€§ | ä½ | é«˜ |
| å‡†ç¡®æ€§ | ä¸­ç­‰ | é«˜ï¼ˆæ™ºèƒ½å†³ç­–ï¼‰ |
| ç»´æŠ¤æˆæœ¬ | ä½ | ä¸­ï¼ˆéœ€è¦ç»´æŠ¤ä¸¤ä¸ªæœåŠ¡ï¼‰ |

**ä½¿ç”¨ç¤ºä¾‹**

```javascript
// ç¤ºä¾‹1ï¼šæ£€æŸ¥ Rice æœåŠ¡
const statusResponse = await fetch(
  'http://localhost:8000/api/irrigation/rice-status'
);
const statusData = await statusResponse.json();

if (statusData.success) {
  console.log('âœ… Rice æœåŠ¡æ­£å¸¸');
  
  // ç¤ºä¾‹2ï¼šç”Ÿæˆè®¡åˆ’ï¼ˆä¸è‡ªåŠ¨æ‰§è¡Œï¼‰
  const planResponse = await fetch(
    'http://localhost:8000/api/irrigation/generate-from-rice',
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        farm_id: "13944136728576",
        pumps: "P1,P2",
        auto_execute: false
      })
    }
  );
  const planData = await planResponse.json();
  
  console.log(`âœ… è®¡åˆ’å·²ç”Ÿæˆ: ${planData.plan_file}`);
  console.log(`ğŸ“Š éœ€è¦çŒæº‰ ${planData.irrigate_count} ä¸ªç”°å—`);
  
  // ç¤ºä¾‹3ï¼šæ‰‹åŠ¨å¯åŠ¨æ‰§è¡Œ
  if (planData.success && planData.plan_file) {
    const execResponse = await fetch(
      'http://localhost:8000/api/execution/start',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          plan_file: planData.plan_file,
          farm_id: "13944136728576"
        })
      }
    );
  }
} else {
  console.log('âŒ Rice æœåŠ¡ä¸å¯ç”¨:', statusData.message);
}

// ç¤ºä¾‹4ï¼šç”Ÿæˆå¹¶è‡ªåŠ¨æ‰§è¡Œ
const autoExecResponse = await fetch(
  'http://localhost:8000/api/irrigation/generate-from-rice',
  {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      farm_id: "13944136728576",
      pumps: "P1,P2",
      auto_execute: true  // è‡ªåŠ¨æ‰§è¡Œ
    })
  }
);
const autoExecData = await autoExecResponse.json();

if (autoExecData.execution_id) {
  console.log('âœ… å·²è‡ªåŠ¨å¯åŠ¨æ‰§è¡Œ:', autoExecData.execution_id);
}
```

**æ•…éšœæ’æŸ¥**

**é—®é¢˜1: æ— æ³•è¿æ¥åˆ° Rice API**
```json
{
  "detail": "æ— æ³•è¿æ¥åˆ° Rice APIï¼Œè¯·ç¡®ä¿ rice_smart_irrigation æœåŠ¡æ­£åœ¨è¿è¡Œ"
}
```
**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ Rice æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼š`curl http://localhost:5000/v1/rice_irrigation?farm_id=13944136728576`
2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
3. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨

**é—®é¢˜2: æ²¡æœ‰éœ€è¦çŒæº‰çš„ç”°å—**
```json
{
  "success": true,
  "message": "Rice å†³ç­–è·å–æˆåŠŸï¼Œä½†æ²¡æœ‰éœ€è¦çŒæº‰çš„ç”°å—",
  "irrigate_count": 0
}
```
**åŸå› **: æ‰€æœ‰ç”°å—æ°´ä½éƒ½åœ¨é€‚å®œèŒƒå›´å†…ï¼Œæˆ– Rice åˆ¤æ–­å½“å‰ä¸éœ€è¦çŒæº‰

**é—®é¢˜3: ç”°å—æ˜ å°„å¤±è´¥**
```json
{
  "details": {
    "skipped_sections": ["1234567890123456789"],
    "mapping_count": 36,
    "converted_count": 0
  }
}
```
**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `config.json` ä¸­çš„ `sectionID` æ˜¯å¦ä¸ Rice è¿”å›çš„ä¸€è‡´
2. ç¡®è®¤å†œåœºIDæ˜¯å¦æ­£ç¡®

**æ³¨æ„äº‹é¡¹**

1. âš ï¸ **æœåŠ¡ä¾èµ–**: éœ€è¦ rice_smart_irrigation æœåŠ¡æ­£å¸¸è¿è¡Œ
2. âš ï¸ **æ˜ å°„é…ç½®**: ç¡®ä¿ config.json ä¸­çš„ sectionID ä¸ Rice ä½¿ç”¨çš„ä¸€è‡´
3. âœ… **è§£è€¦æ¶æ„**: ä¸¤ä¸ªæœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œé€šè¿‡ HTTP é€šä¿¡
4. âœ… **æ™ºèƒ½å†³ç­–**: åŸºäºç”Ÿè‚²æœŸã€å¤©æ°”ã€å†œäº‹æ“ä½œçš„ç»¼åˆå†³ç­–
5. ğŸ’¡ **è°ƒè¯•æ¨¡å¼**: å…ˆä½¿ç”¨ `auto_execute: false` æ£€æŸ¥è®¡åˆ’ï¼Œå†æ‰‹åŠ¨æ‰§è¡Œ
6. ğŸ’¡ **ç›‘æ§**: å®šæœŸè°ƒç”¨ `/api/irrigation/rice-status` ç›‘æ§æœåŠ¡çŠ¶æ€

---

## å…¸å‹ä¸šåŠ¡æµç¨‹

### æµç¨‹1ï¼šæ ‡å‡†çŒæº‰è®¡åˆ’ç”Ÿæˆä¸æ‰§è¡Œ 

**é€‚ç”¨åœºæ™¯**: æœ€å¸¸ç”¨çš„æ ‡å‡†æµç¨‹
```javascript
// æ­¥éª¤1: ç”ŸæˆçŒæº‰è®¡åˆ’
const planResponse = await fetch(`${BASE_URL}/api/irrigation/plan-generation`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    farm_id: "13944136728576",
    multi_pump_scenarios: true
  })
});
const planData = await planResponse.json();
const planId = planData.plan_id; // ä¿å­˜plan_id

// æ­¥éª¤2: å¯åŠ¨åŠ¨æ€æ‰§è¡Œ
const execResponse = await fetch(`${BASE_URL}/api/execution/start`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    plan_file_path: planId,  // ä½¿ç”¨æ­¥éª¤1çš„plan_id
    farm_id: "13944136728576",
    auto_start: true,
    enable_plan_regeneration: true
  })
});
const execData = await execResponse.json();
const executionId = execData.data.execution_id;

// æ­¥éª¤3: è½®è¯¢æŸ¥è¯¢æ‰§è¡ŒçŠ¶æ€
const checkStatus = async () => {
  const statusResponse = await fetch(
    `${BASE_URL}/api/execution/status?execution_id=${executionId}`
  );
  const statusData = await statusResponse.json();
  
  if (statusData.data.status === 'completed') {
    console.log('æ‰§è¡Œå®Œæˆï¼');
  } else if (statusData.data.status === 'running') {
    console.log(`æ‰§è¡Œä¸­: ${statusData.data.progress_percent}%`);
    setTimeout(checkStatus, 5000); // 5ç§’åå†æ¬¡æŸ¥è¯¢
  }
};
checkStatus();
```

**æµç¨‹å›¾**:
```
ç”Ÿæˆè®¡åˆ’ â†’ è·å–plan_id â†’ å¯åŠ¨æ‰§è¡Œ â†’ è·å–execution_id â†’ è½®è¯¢çŠ¶æ€ â†’ å®Œæˆ
```

---

### æµç¨‹2ï¼šå¤šæ–¹æ¡ˆå¯¹æ¯”å†³ç­–

**é€‚ç”¨åœºæ™¯**: éœ€è¦å¯¹æ¯”å¤šä¸ªæ–¹æ¡ˆé€‰æ‹©æœ€ä¼˜è§£

```javascript
// æ­¥éª¤1: ç”Ÿæˆè®¡åˆ’ï¼ˆåŒ…å«å¤šæ°´æ³µæ–¹æ¡ˆï¼‰
const planResponse = await fetch(`${BASE_URL}/api/irrigation/plan-generation`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    farm_id: "13944136728576",
    multi_pump_scenarios: true
  })
});
const planData = await planResponse.json();

// æ­¥éª¤2: æŸ¥çœ‹å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”
const scenarios = planData.multi_pump_scenarios.scenarios;
scenarios.forEach(scenario => {
  console.log(`æ–¹æ¡ˆ: ${scenario.scenario_name}`);
  console.log(`  ç”µè´¹: Â¥${scenario.total_electricity_cost}`);
  console.log(`  æ—¶é•¿: ${scenario.total_eta_h}å°æ—¶`);
  console.log(`  æ°´æ³µ: ${scenario.pumps_used.join(', ')}`);
});

// æ­¥éª¤3: ç”¨æˆ·é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆåå¯åŠ¨æ‰§è¡Œ
const selectedPlanId = planData.plan_id;
// ... å¯åŠ¨æ‰§è¡Œï¼ˆå‚è€ƒæµç¨‹1æ­¥éª¤2ï¼‰
```

---

### æµç¨‹3ï¼šæ™ºèƒ½ä¼˜åŒ–æ–¹æ¡ˆç”Ÿæˆ

**é€‚ç”¨åœºæ™¯**: éœ€è¦æ ¹æ®ä¸åŒä¼˜åŒ–ç›®æ ‡ç”Ÿæˆå¤šä¸ªæ–¹æ¡ˆ

```javascript
// æ­¥éª¤1: ç”ŸæˆåŸºç¡€è®¡åˆ’
const planResponse = await fetch(`${BASE_URL}/api/irrigation/plan-generation`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    farm_id: "13944136728576"
  })
});
const planData = await planResponse.json();
const planId = planData.plan_id;

// æ­¥éª¤2: ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆ
const optResponse = await fetch(`${BASE_URL}/api/irrigation/plan-optimization`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    original_plan_id: planId,
    optimization_goals: [
      "cost_minimization",
      "time_minimization",
      "balanced",
      "off_peak"
    ],
    constraints: {
      max_duration_hours: 24,
      electricity_price_schedule: {
        peak: { hours: [8,9,10,11,12,13,14,15,16,17,18,19,20,21], price: 1.0 },
        valley: { hours: [22,23,0,1,2,3,4,5,6,7], price: 0.4 }
      }
    }
  })
});
const optData = await optResponse.json();

// æ­¥éª¤3: å±•ç¤ºä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”
console.log(`æ¨èæ–¹æ¡ˆ: ${optData.comparison.recommended}`);
console.log(`æœ€å¤§èŠ‚çœ: ${optData.comparison.cost_range.savings_percent}%`);

optData.scenarios.forEach(scenario => {
  console.log(`\n${scenario.name}`);
  console.log(`è¯´æ˜: ${scenario.description}`);
  console.log(`ç”µè´¹: Â¥${scenario.total_electricity_cost}`);
  console.log(`æ—¶é•¿: ${scenario.total_eta_h}å°æ—¶`);
});

// æ­¥éª¤4: ç”¨æˆ·é€‰æ‹©æ–¹æ¡ˆåæ‰§è¡Œï¼ˆä½¿ç”¨é€‰ä¸­æ–¹æ¡ˆçš„planæ•°æ®ï¼‰
```

---

### æµç¨‹4ï¼šå®æ—¶æ°´ä½æ›´æ–°ä¸è®¡åˆ’è°ƒæ•´

**é€‚ç”¨åœºæ™¯**: æ‰§è¡Œè¿‡ç¨‹ä¸­æ ¹æ®å®æ—¶æ°´ä½è°ƒæ•´è®¡åˆ’

```javascript
// æ­¥éª¤1: å¯åŠ¨æ‰§è¡Œï¼ˆå‚è€ƒæµç¨‹1ï¼‰
// ...

// æ­¥éª¤2: æ¥æ”¶ä¼ æ„Ÿå™¨æ°´ä½æ•°æ®å¹¶æ›´æ–°
const updateWaterLevel = async (fieldId, waterLevel) => {
  await fetch(`${BASE_URL}/api/water-levels/update`, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify({
      farm_id: "13944136728576",
      field_id: fieldId,
      water_level_mm: waterLevel,
      source: "sensor",
      quality: "good"
    })
  });
};

// æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°
updateWaterLevel("S3-G2-F1", 28.5);
updateWaterLevel("S3-G3-F2", 32.1);

// æ­¥éª¤3: ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®æ–°æ°´ä½é‡æ–°ç”Ÿæˆè®¡åˆ’ï¼ˆå¦‚æœå¯ç”¨äº†enable_plan_regenerationï¼‰
// å‰ç«¯å¯ä»¥é€šè¿‡æŸ¥è¯¢æ‰§è¡ŒçŠ¶æ€ç›‘æ§é‡æ–°ç”Ÿæˆæ¬¡æ•°
const statusResponse = await fetch(
  `${BASE_URL}/api/execution/status?execution_id=${executionId}`
);
const statusData = await statusResponse.json();
console.log(`è®¡åˆ’å·²é‡æ–°ç”Ÿæˆ ${statusData.data.total_regenerations} æ¬¡`);
```

---

### æµç¨‹5ï¼šæ‰¹æ¬¡ç¼–è¾‘ä¸é‡æ–°ç”Ÿæˆ 

**é€‚ç”¨åœºæ™¯**: æ‰‹åŠ¨è°ƒæ•´æ‰¹æ¬¡å†…å®¹ï¼ˆæ·»åŠ /åˆ é™¤ç”°å—ã€è°ƒæ•´æ—¶é—´ç­‰ï¼‰

```javascript
// æ­¥éª¤1: ç”Ÿæˆåˆå§‹è®¡åˆ’
const planResponse = await fetch(`${BASE_URL}/api/irrigation/plan-generation`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    farm_id: "13944136728576"
  })
});
const planData = await planResponse.json();
const planId = planData.plan_id;

// æ­¥éª¤2: æŸ¥çœ‹æ‰¹æ¬¡è¯¦æƒ…
const batchResponse = await fetch(`${BASE_URL}/api/batches/1/details`);
const batchData = await batchResponse.json();
console.log('å½“å‰æ‰¹æ¬¡ç”°å—:', batchData.fields.map(f => f.id));

// æ­¥éª¤3: ä¿®æ”¹æ‰¹æ¬¡ï¼ˆæ·»åŠ ç”°å—ã€è°ƒæ•´æ—¶é—´ï¼‰
const regenResponse = await fetch(`${BASE_URL}/api/regeneration/batch`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    original_plan_id: planId,
    field_modifications: [
      { field_id: "S3-G5-F1", action: "add", custom_water_level: 95.0 },
      { field_id: "S3-G5-F2", action: "remove" }
    ],
    time_modifications: [
      { batch_index: 1, start_time_h: 2.0, duration_h: 10.0 }
    ]
  })
});
const regenData = await regenResponse.json();

// æ­¥éª¤4: ä½¿ç”¨ä¿®æ”¹åçš„è®¡åˆ’æ‰§è¡Œ
// ä½¿ç”¨ regenData.modified_plan æˆ–ä¿å­˜çš„æ–°è®¡åˆ’æ–‡ä»¶
```

---

### æµç¨‹6ï¼šæ‰¹æ¬¡é—´ç”°å—è°ƒæ•´ä¼˜åŒ–

**é€‚ç”¨åœºæ™¯**: å·²æœ‰è®¡åˆ’ï¼Œéœ€è¦ä¼˜åŒ–æ‰¹æ¬¡é—´çš„ç”°å—åˆ†é…

```javascript
// æ­¥éª¤1: ç”Ÿæˆåˆå§‹è®¡åˆ’
const planResponse = await fetch(`${BASE_URL}/api/irrigation/plan-generation`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    farm_id: "13944136728576",
    multi_pump_scenarios: true
  })
});
const planData = await planResponse.json();
const planId = planData.plan_id;

// æ­¥éª¤2: æŸ¥çœ‹å½“å‰æ‰¹æ¬¡åˆ†é…
const batchesResponse = await fetch(`${BASE_URL}/api/batches?farm_id=13944136728576`);
const batchesData = await batchesResponse.json();

// åˆ†ææ‰¹æ¬¡ï¼Œå‘ç°æ‰¹æ¬¡1æ—¶é—´è¿‡é•¿ï¼Œæ‰¹æ¬¡2æ—¶é—´è¾ƒçŸ­
console.log('æ‰¹æ¬¡1æ—¶é•¿:', batchesData.batches[0].duration_h); // ä¾‹å¦‚: 20.5h
console.log('æ‰¹æ¬¡2æ—¶é•¿:', batchesData.batches[1].duration_h); // ä¾‹å¦‚: 15.2h

// æ­¥éª¤3: è°ƒæ•´ç”°å—åˆ†é…ï¼ˆäº¤æ¢ä¸¤ä¸ªç”°å—å®ç°è´Ÿè½½å‡è¡¡ï¼‰
const adjustResponse = await fetch(`${BASE_URL}/api/batch/adjust`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    plan_id: planId,
    field_adjustments: [
      {
        field_id: "S3-G5-F3",      // ä»æ‰¹æ¬¡1ç§»åˆ°æ‰¹æ¬¡2
        from_batch: 1,
        to_batch: 2
      },
      {
        field_id: "S5-G27-F19",    // ä»æ‰¹æ¬¡2ç§»åˆ°æ‰¹æ¬¡1ï¼ˆäº¤æ¢ï¼‰
        from_batch: 2,
        to_batch: 1
      }
    ],
    options: {
      recalculate_sequence: true,
      recalculate_timing: true,
      maintain_pump_assignments: true,
      regenerate_commands: true
    }
  })
});
const adjustData = await adjustResponse.json();

// æ­¥éª¤4: æŸ¥çœ‹è°ƒæ•´ç»“æœ
console.log('è°ƒæ•´æˆåŠŸ:', adjustData.success);
console.log('ç§»åŠ¨ç”°å—æ•°:', adjustData.changes_summary.total_fields_moved);

// æŸ¥çœ‹æ—¶é—´å˜åŒ–
adjustData.changes_summary.batch_time_changes.forEach(change => {
  console.log(`æ‰¹æ¬¡${change.batch_index}: ${change.old_duration_h}h -> ${change.new_duration_h}h`);
  console.log(`  å˜åŒ–: ${change.time_diff_h > 0 ? '+' : ''}${change.time_diff_h}h`);
});

// æ­¥éª¤5: éªŒè¯è°ƒæ•´åçš„è®¡åˆ’
if (adjustData.validation.is_valid) {
  console.log('âœ… è°ƒæ•´åçš„è®¡åˆ’æœ‰æ•ˆï¼Œå¯ä»¥æ‰§è¡Œ');
  
  // æ­¥éª¤6: ä½¿ç”¨è°ƒæ•´åçš„è®¡åˆ’æ‰§è¡Œ
  const execResponse = await fetch(`${BASE_URL}/api/execution/start`, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify({
      plan_file_path: adjustData.output_file,  // ä½¿ç”¨è°ƒæ•´åçš„è®¡åˆ’æ–‡ä»¶
      farm_id: "13944136728576",
      auto_start: true,
      enable_plan_regeneration: true
    })
  });
} else {
  console.log('âŒ è°ƒæ•´åçš„è®¡åˆ’æ— æ•ˆ:', adjustData.validation.warnings);
}
```

**æµç¨‹å›¾**:
```
ç”Ÿæˆè®¡åˆ’ â†’ åˆ†ææ‰¹æ¬¡ â†’ è¯†åˆ«ä¼˜åŒ–ç‚¹ â†’ è°ƒæ•´ç”°å—åˆ†é… â†’ éªŒè¯è®¡åˆ’ â†’ æ‰§è¡Œ
```

---

### æµç¨‹7ï¼šè®¾å¤‡æŒ‡ä»¤ç®¡ç†ä¸ç¡¬ä»¶å¯¹æ¥

**é€‚ç”¨åœºæ™¯**: åç«¯ç”Ÿæˆè®¾å¤‡æ§åˆ¶æŒ‡ä»¤ï¼Œç¡¬ä»¶å›¢é˜Ÿæ‰§è¡Œå¹¶åé¦ˆ

**æ¶æ„è¯´æ˜**:
- **åç«¯èŒè´£**: ç”Ÿæˆè®¾å¤‡æ§åˆ¶æŒ‡ä»¤ï¼ˆåŒ…å« unique_noï¼‰ï¼Œæä¾›æŸ¥è¯¢æ¥å£
- **ç¡¬ä»¶å›¢é˜ŸèŒè´£**: è½®è¯¢è·å–æŒ‡ä»¤ï¼Œæ‰§è¡Œç¡¬ä»¶æ§åˆ¶ï¼Œæäº¤æ‰§è¡Œåé¦ˆ

**å®Œæ•´æµç¨‹**:

```javascript
// ========== åç«¯ä¾§ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰ ==========

// æ­¥éª¤1: å¯åŠ¨çŒæº‰æ‰§è¡Œï¼ˆé›†æˆè®¾å¤‡æŒ‡ä»¤ç”Ÿæˆï¼‰
const execResponse = await fetch(`${BASE_URL}/api/execution/start`, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify({
    plan_file_path: planId,
    farm_id: "13944136728576",
    auto_start: true,
    enable_plan_regeneration: true
  })
});
const execData = await execResponse.json();
const executionId = execData.data.execution_id;

console.log('âœ… æ‰§è¡Œå·²å¯åŠ¨ï¼Œåç«¯å¼€å§‹ç”Ÿæˆè®¾å¤‡æ§åˆ¶æŒ‡ä»¤');

// åç«¯ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
// - æ‰¹æ¬¡å¯åŠ¨æ—¶ï¼šç”Ÿæˆæ³µç«™å¯åŠ¨ã€èŠ‚åˆ¶é—¸å¼€å¯ã€ç”°å—è¿›æ°´é˜€å¼€å¯æŒ‡ä»¤
// - æ‰¹æ¬¡æ‰§è¡Œä¸­ï¼šç›‘æ§æ°´ä½ï¼Œç”Ÿæˆç”°å—ã€èŠ‚åˆ¶é—¸ã€æ³µç«™å…³é—­æŒ‡ä»¤
// - æ‰¹æ¬¡ç»“æŸæ—¶ï¼šç”Ÿæˆæ³µç«™åœæ­¢æŒ‡ä»¤

// ========== ç¡¬ä»¶å›¢é˜Ÿä¾§ï¼ˆè½®è¯¢æ‰§è¡Œï¼‰ ==========

// æ­¥éª¤2: ç¡¬ä»¶å›¢é˜Ÿè·å–æ‰¹æ¬¡å¯åŠ¨æŒ‡ä»¤
const getStartCommands = async () => {
  const response = await fetch(
    `${BASE_URL}/api/execution/batch-commands?` +
    `execution_id=${executionId}&` +
    `phase=start&` +
    `status=pending`,
    { method: 'GET' }
  );
  const data = await response.json();
  
  if (data.has_new_commands) {
    console.log(`ğŸ“¥ è·å–åˆ° ${data.total_commands} æ¡å¯åŠ¨æŒ‡ä»¤`);
    
    // æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œ
    for (const cmd of data.commands) {
      console.log(`[ä¼˜å…ˆçº§${cmd.priority}] ${cmd.description}`);
      console.log(`  è®¾å¤‡ç±»å‹: ${cmd.device_type}`);
      console.log(`  è®¾å¤‡ID: ${cmd.device_id}`);
      console.log(`  unique_no: ${cmd.unique_no}`);
      console.log(`  åŠ¨ä½œ: ${cmd.action}, å‚æ•°:`, cmd.params);
      
      // æ‰§è¡Œç¡¬ä»¶æ§åˆ¶
      await executeHardwareCommand(cmd);
    }
  }
};

// æ­¥éª¤3: æ‰§è¡Œç¡¬ä»¶æ§åˆ¶å¹¶åé¦ˆ
const executeHardwareCommand = async (command) => {
  const startTime = Date.now();
  
  try {
    // æ ¹æ®è®¾å¤‡ç±»å‹æ‰§è¡Œæ§åˆ¶
    if (command.device_type === 'pump') {
      // æ³µç«™æ§åˆ¶
      await controlPump(command.device_id, command.action);
    } else if (command.device_type === 'regulator') {
      // èŠ‚åˆ¶é—¸æ§åˆ¶ï¼ˆ0% æˆ– 100%ï¼‰
      await controlGate(command.unique_no, command.params.gate_degree);
    } else if (command.device_type === 'field_inlet_gate') {
      // ç”°å—è¿›æ°´é˜€æ§åˆ¶
      await controlGate(command.unique_no, command.params.gate_degree);
    } else if (command.device_type === 'field_outlet_gate') {
      // ç”°å—å‡ºæ°´é˜€æ§åˆ¶
      await controlGate(command.unique_no, command.params.gate_degree);
    }
    
    const executionTime = (Date.now() - startTime) / 1000;
    
    // åé¦ˆæˆåŠŸ
    const formData = new FormData();
    formData.append('command_id', command.command_id);
    formData.append('status', 'executed');
    formData.append('message', `${command.description} æ‰§è¡ŒæˆåŠŸ`);
    formData.append('execution_time', executionTime.toString());
    
    await fetch(`${BASE_URL}/api/execution/command-feedback`, {
      method: 'POST',
      body: formData
    });
    
    console.log(`âœ… ${command.description} å®Œæˆ (${executionTime}s)`);
    
  } catch (error) {
    // åé¦ˆå¤±è´¥
    const formData = new FormData();
    formData.append('command_id', command.command_id);
    formData.append('status', 'failed');
    formData.append('message', `æ‰§è¡Œå¤±è´¥: ${error.message}`);
    
    await fetch(`${BASE_URL}/api/execution/command-feedback`, {
      method: 'POST',
      body: formData
    });
    
    console.error(`âŒ ${command.description} å¤±è´¥: ${error.message}`);
  }
};

// æ­¥éª¤4: æŒç»­è½®è¯¢è·å–æ‰§è¡Œä¸­çš„æŒ‡ä»¤
const pollRunningCommands = async () => {
  while (true) {
    const response = await fetch(
      `${BASE_URL}/api/execution/batch-commands?` +
      `execution_id=${executionId}&` +
      `phase=running&` +
      `status=pending`,
      { method: 'GET' }
    );
    const data = await response.json();
    
    if (data.has_new_commands) {
      console.log(`ğŸ”„ æ£€æµ‹åˆ° ${data.total_commands} æ¡æ–°æŒ‡ä»¤`);
      
      for (const cmd of data.commands) {
        if (cmd.reason) {
          console.log(`  åŸå› : ${cmd.reason}`);
        }
        await executeHardwareCommand(cmd);
      }
    } else {
      console.log('â¸ï¸  æš‚æ— æ–°æŒ‡ä»¤');
    }
    
    // æŸ¥çœ‹ç»Ÿè®¡
    console.log('ğŸ“Š æŒ‡ä»¤ç»Ÿè®¡:');
    console.log(`  å¾…æ‰§è¡Œ: ${data.statistics.pending}`);
    console.log(`  å·²å‘é€: ${data.statistics.sent}`);
    console.log(`  å·²æ‰§è¡Œ: ${data.statistics.executed}`);
    console.log(`  å¤±è´¥: ${data.statistics.failed}`);
    
    // ç­‰å¾…30ç§’
    await new Promise(resolve => setTimeout(resolve, 30000));
  }
};

// æ­¥éª¤5: å¯åŠ¨ç¡¬ä»¶å·¥ä½œçº¿ç¨‹
getStartCommands();  // ç«‹å³è·å–å¯åŠ¨æŒ‡ä»¤
pollRunningCommands();  // æŒç»­è½®è¯¢æ‰§è¡Œä¸­çš„æŒ‡ä»¤

// ========== äººå·¥è°ƒæ•´æ°´ä½è§¦å‘è®¾å¤‡å…³é—­ ==========

// æ­¥éª¤6: äººå·¥è°ƒæ•´æ°´ä½åè‡ªåŠ¨è§¦å‘è®¾å¤‡æ£€æŸ¥
const manualAdjustWaterLevel = async () => {
  const response = await fetch(`${BASE_URL}/api/regeneration/manual`, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify({
      batch_index: 1,
      custom_water_levels: {
        "S3-G2-F1": 95.0,  // äººå·¥è°ƒæ•´ä¸º95mmï¼ˆè¾¾æ ‡ï¼‰
        "S3-G3-F2": 92.0   // äººå·¥è°ƒæ•´ä¸º92mmï¼ˆè¾¾æ ‡ï¼‰
      }
    })
  });
  const data = await response.json();
  
  console.log('âœ… æ°´ä½å·²è°ƒæ•´ï¼Œåç«¯è‡ªåŠ¨è§¦å‘è®¾å¤‡æ£€æŸ¥');
  
  // åç«¯ä¼šè‡ªåŠ¨ï¼š
  // 1. æ›´æ–°ç›‘æ§å™¨ä¸­çš„æ°´ä½
  // 2. æ£€æŸ¥æ˜¯å¦è¾¾æ ‡
  // 3. ç”Ÿæˆå…³é—­æŒ‡ä»¤ï¼ˆå¦‚æœè¾¾æ ‡ï¼‰
  
  // ç¡¬ä»¶å›¢é˜Ÿï¼š
  // è½®è¯¢æ—¶ä¼šè‡ªåŠ¨è·å–åˆ°æ–°ç”Ÿæˆçš„å…³é—­æŒ‡ä»¤
};
```

**æµç¨‹å›¾**:
```
å¯åŠ¨æ‰§è¡Œ
  â†“
åç«¯ç”Ÿæˆå¯åŠ¨æŒ‡ä»¤ (æ³µç«™ã€èŠ‚åˆ¶é—¸ã€è¿›æ°´é˜€)
  â†“
ç¡¬ä»¶å›¢é˜Ÿè·å–æŒ‡ä»¤ (GET /batch-commands?phase=start)
  â†“
æ‰§è¡Œç¡¬ä»¶æ§åˆ¶
  â†“
åé¦ˆæ‰§è¡Œç»“æœ (POST /command-feedback)
  â†“
æ‰¹æ¬¡æ‰§è¡Œä¸­ (æ¯30ç§’è½®è¯¢)
  â†“
åç«¯ç›‘æ§æ°´ä½ â†’ è¾¾æ ‡ â†’ ç”Ÿæˆå…³é—­æŒ‡ä»¤
  â†“
ç¡¬ä»¶å›¢é˜Ÿè·å–æŒ‡ä»¤ (GET /batch-commands?phase=running)
  â†“
æ‰§è¡Œå…³é—­æ“ä½œ â†’ åé¦ˆ
  â†“
äººå·¥è°ƒæ•´æ°´ä½ï¼ˆå¯é€‰ï¼‰
  â†“
åç«¯ç«‹å³è§¦å‘æ£€æŸ¥ â†’ ç”ŸæˆæŒ‡ä»¤
  â†“
ç¡¬ä»¶å›¢é˜Ÿè½®è¯¢è·å– â†’ æ‰§è¡Œ â†’ åé¦ˆ
  â†“
æ‰€æœ‰ç”°å—å®Œæˆ
  â†“
åç«¯ç”Ÿæˆåœæ³µæŒ‡ä»¤ (phase=stop)
  â†“
ç¡¬ä»¶å›¢é˜Ÿè·å–å¹¶æ‰§è¡Œ
  â†“
æ‰¹æ¬¡å®Œæˆ
```

**å…³é”®ç‚¹è¯´æ˜**:

1. **åç«¯èŒè´£**:
   - âœ… ç”Ÿæˆæ‰€æœ‰è®¾å¤‡æ§åˆ¶æŒ‡ä»¤ï¼ˆåŒ…å« unique_noï¼‰
   - âœ… æä¾›æŒ‡ä»¤æŸ¥è¯¢æ¥å£
   - âœ… å®æ—¶ç›‘æ§æ°´ä½ï¼ŒåŠ¨æ€ç”Ÿæˆå…³é—­æŒ‡ä»¤
   - âœ… äººå·¥è°ƒæ•´æ°´ä½åè‡ªåŠ¨è§¦å‘è®¾å¤‡æ£€æŸ¥
   - âŒ ä¸ç›´æ¥æ‰§è¡Œç¡¬ä»¶æ§åˆ¶

2. **ç¡¬ä»¶å›¢é˜ŸèŒè´£**:
   - âœ… å®šæœŸè½®è¯¢è·å–å¾…æ‰§è¡ŒæŒ‡ä»¤ï¼ˆå»ºè®®30ç§’ï¼‰
   - âœ… æ ¹æ® device_type å’Œ unique_no æ‰§è¡Œç¡¬ä»¶æ§åˆ¶
   - âœ… åŠæ—¶åé¦ˆæ‰§è¡Œç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
   - âŒ ä¸éœ€è¦ç†è§£çŒæº‰é€»è¾‘

3. **æŒ‡ä»¤ä¼˜å…ˆçº§**:
   - ä¼˜å…ˆçº§1: æ³µç«™æ§åˆ¶ï¼ˆæœ€é«˜ï¼‰
   - ä¼˜å…ˆçº§2: èŠ‚åˆ¶é—¸æ§åˆ¶
   - ä¼˜å…ˆçº§3: ç”°å—é—¸é—¨æ§åˆ¶

4. **è®¾å¤‡ç±»å‹å¯¹åº”**:
   - `pump`: æ³µç«™ â†’ æ ¹æ® device_id æ˜ å°„ï¼ˆå¦‚ P1, P2ï¼‰
   - `regulator`: èŠ‚åˆ¶é—¸ â†’ ä½¿ç”¨ unique_no æ§åˆ¶ï¼ˆåªæœ‰0%æˆ–100%ï¼‰
   - `field_inlet_gate`: ç”°å—è¿›æ°´é˜€ â†’ ä½¿ç”¨ unique_no æ§åˆ¶
   - `field_outlet_gate`: ç”°å—å‡ºæ°´é˜€ â†’ ä½¿ç”¨ unique_no æ§åˆ¶

5. **é”™è¯¯å¤„ç†**:
   - æ‰§è¡Œå¤±è´¥æ—¶ï¼Œå¿…é¡»åé¦ˆè¯¦ç»†é”™è¯¯ä¿¡æ¯
   - åç«¯ä¼šè®°å½•æ‰€æœ‰åé¦ˆåˆ°æ—¥å¿—
   - å¯é€šè¿‡ statistics å­—æ®µæŸ¥çœ‹æ‰§è¡Œç»Ÿè®¡

---

## é”™è¯¯ç è¯´æ˜
### HTTP çŠ¶æ€ç 

| çŠ¶æ€ç  | è¯´æ˜ | å¤„ç†å»ºè®® |
|--------|------|----------|
| 200 | æˆåŠŸ | æ­£å¸¸å¤„ç†å“åº”æ•°æ® |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ | æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼å’Œå¿…å¡«é¡¹ |
| 404 | èµ„æºä¸å­˜åœ¨ | æ£€æŸ¥plan_idã€execution_idç­‰æ˜¯å¦æ­£ç¡® |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æŸ¥çœ‹detailå­—æ®µè·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ |

### ä¸šåŠ¡é”™è¯¯ç 

é”™è¯¯å“åº”æ ¼å¼ï¼š
```json
{
  "detail": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ³•**:

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ³• |
|---------|------|----------|
| "æœªæ‰¾åˆ°è®¡åˆ’: {plan_id}" | plan_idä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯ | ç¡®ä¿ä½¿ç”¨ç”Ÿæˆæ¥å£è¿”å›çš„å®Œæ•´plan_id |
| "çŒæº‰è®¡åˆ’æ–‡ä»¶ä¸å­˜åœ¨" | è®¡åˆ’æ–‡ä»¶å·²è¢«åˆ é™¤ | é‡æ–°ç”Ÿæˆè®¡åˆ’ |
| "å¯åŠ¨åŠ¨æ€æ‰§è¡Œå¤±è´¥: æ— æ³•åŠ è½½çŒæº‰è®¡åˆ’" | plan_file_pathæ ¼å¼é”™è¯¯ | ä½¿ç”¨æ­£ç¡®çš„å®Œæ•´è·¯å¾„ |
| "æ‰¹æ¬¡ {index} ä¸å­˜åœ¨" | æ‰¹æ¬¡ç´¢å¼•è¶…å‡ºèŒƒå›´ | æ£€æŸ¥æ‰¹æ¬¡ç´¢å¼•èŒƒå›´ï¼ˆä»1å¼€å§‹ï¼‰ |
| "è°ƒåº¦å™¨æœªåˆå§‹åŒ–" | ç³»ç»Ÿç»„ä»¶æœªå°±ç»ª | ç­‰å¾…æˆ–è°ƒç”¨å¥åº·æ£€æŸ¥ç¡®è®¤ç³»ç»ŸçŠ¶æ€ |

---

## å¸¸è§é—®é¢˜

### Q1: plan_idå’Œexecution_idçš„åŒºåˆ«
**A**: 
- `plan_id`: çŒæº‰è®¡åˆ’æ–‡ä»¶çš„è·¯å¾„ï¼Œç”±**ç”Ÿæˆè®¡åˆ’æ¥å£**è¿”å›ï¼Œæ ¼å¼å¦‚ `/app/output/irrigation_plan_20250109_123456.json`
- `execution_id`: æ‰§è¡Œä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œç”±**å¯åŠ¨æ‰§è¡Œæ¥å£**è¿”å›ï¼Œæ ¼å¼å¦‚ `exec_20250109_123456`

**ä½¿ç”¨åœºæ™¯**:
- `plan_id` â†’ ç”¨äºå¯åŠ¨æ‰§è¡Œã€ä¼˜åŒ–ã€é‡æ–°ç”Ÿæˆç­‰éœ€è¦è®¡åˆ’æ–‡ä»¶çš„æ¥å£
- `execution_id` â†’ ç”¨äºæŸ¥è¯¢æ‰§è¡ŒçŠ¶æ€ã€åœæ­¢æ‰§è¡Œç­‰ç®¡ç†æ‰§è¡Œä»»åŠ¡çš„æ¥å£

---

### Q2: è·å– plan_idçš„æ–¹æ³•
**A**: æœ‰ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼1: ä»ç”Ÿæˆæ¥å£è·å–**ï¼ˆæ¨èï¼‰
```javascript
const response = await fetch('/api/irrigation/plan-generation', {...});
const data = await response.json();
const planId = data.plan_id; // è¿™å°±æ˜¯plan_id
```
**æ–¹å¼2: ä»æ–‡ä»¶ç³»ç»Ÿè·å–**ï¼ˆä¸æ¨èï¼‰
```
æœ€æ–°è®¡åˆ’æ–‡ä»¶é€šå¸¸åœ¨: /app/output/irrigation_plan_YYYYMMDD_HHMMSS.json
```

---

### Q3: å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯”å’Œè®¡åˆ’ä¼˜åŒ–çš„åŒºåˆ«
**A**: 

| ç‰¹æ€§ | å¤šæ°´æ³µæ–¹æ¡ˆå¯¹æ¯” | è®¡åˆ’ä¼˜åŒ– |
|------|---------------|----------|
| **å¯¹æ¯”ç»´åº¦** | ä¸åŒæ°´æ³µç»„åˆ | ä¸åŒä¼˜åŒ–ç›®æ ‡ |
| **æ–¹æ¡ˆç±»å‹** | P1å•ç‹¬ã€P2å•ç‹¬ã€P1+P2ç»„åˆç­‰ | æˆæœ¬æœ€å°ã€æ—¶é—´æœ€å°ã€å‡è¡¡ã€é¿å³°ç­‰ |
| **ä½¿ç”¨æ—¶æœº** | è®¡åˆ’ç”Ÿæˆæ—¶æˆ–ç‹¬ç«‹è°ƒç”¨ | å·²æœ‰åŸºç¡€è®¡åˆ’åä¼˜åŒ– |
| **æ¥å£** | `/api/irrigation/multi-pump-scenarios` | `/api/irrigation/plan-optimization` |

**æ¨èç”¨æ³•**:
1. å…ˆç”ŸæˆåŸºç¡€è®¡åˆ’ï¼ˆå¯é€‰multi_pump_scenariosï¼‰
2. å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œè°ƒç”¨ä¼˜åŒ–æ¥å£
3. å¯¹æ¯”æ‰€æœ‰æ–¹æ¡ˆï¼Œé€‰æ‹©æœ€ä¼˜

---

### Q4: å®ç°å®æ—¶æ°´ä½æ›´æ–°
**A**: æœ‰ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼1: è‡ªåŠ¨æ›´æ–°**ï¼ˆæ¨èï¼‰
```javascript
// å¯åŠ¨æ‰§è¡Œæ—¶å¯ç”¨è‡ªåŠ¨æ°´ä½æ›´æ–°
{
  enable_plan_regeneration: true,
  water_level_update_interval_minutes: 30
}
// ç³»ç»Ÿä¼šè‡ªåŠ¨å®šæœŸè·å–æœ€æ–°æ°´ä½å¹¶é‡æ–°ç”Ÿæˆè®¡åˆ’
```

**æ–¹å¼2: æ‰‹åŠ¨æ›´æ–°**
```javascript
// 1. ä¸»åŠ¨æ¨é€æ°´ä½æ•°æ®
await fetch('/api/water-levels/update', {
  body: JSON.stringify({
    field_id: "S3-G2-F1",
    water_level_mm: 28.5
  })
});

// 2. æ‰‹åŠ¨è§¦å‘é‡æ–°ç”Ÿæˆ
await fetch('/api/regeneration/manual', {
  body: JSON.stringify({
    batch_index: 1,
    force_regeneration: true
  })
});
```

---

### Q5: å¤„ç†æ‰§è¡Œå¤±è´¥

**A**: æ ‡å‡†é”™è¯¯å¤„ç†æµç¨‹ï¼š

```javascript
try {
  const response = await fetch('/api/execution/start', {...});
  
  if (!response.ok) {
    const error = await response.json();
    console.error('æ‰§è¡Œå¤±è´¥:', error.detail);
    
    // æ ¹æ®é”™è¯¯ç±»å‹å¤„ç†
    if (response.status === 404) {
      // è®¡åˆ’æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‡æ–°ç”Ÿæˆè®¡åˆ’
      await generateNewPlan();
    } else if (response.status === 500) {
      // æœåŠ¡å™¨é”™è¯¯ï¼Œè®°å½•å¹¶é€šçŸ¥ç”¨æˆ·
      logError(error.detail);
      notifyUser('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
    }
  }
  
  const data = await response.json();
  // æ­£å¸¸å¤„ç†
  
} catch (error) {
  console.error('ç½‘ç»œé”™è¯¯:', error);
  notifyUser('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
}
```

---

### Q6: æ‰¹æ¬¡ç´¢å¼•ä»0å¼€å§‹è¿˜æ˜¯ä»1å¼€å§‹
**A**: **ä»1å¼€å§‹**

```javascript
// æ­£ç¡® âœ…
GET /api/batches/1/details  // è·å–ç¬¬1ä¸ªæ‰¹æ¬¡

// é”™è¯¯ âŒ
GET /api/batches/0/details  // ä¼šè¿”å›404
```

**æ³¨æ„**: 
- APIæ¥å£ä¸­çš„batch_indexï¼š**ä»1å¼€å§‹**
- å†…éƒ¨æ•°ç»„ç´¢å¼•ï¼šä»0å¼€å§‹ï¼ˆå¼€å‘è€…æ— éœ€å…³å¿ƒï¼‰

---

### Q7: æ‰¹æ¬¡ç›¸å…³æ¥å£çš„åŒºåˆ«ï¼ˆé‡æ–°ç”Ÿæˆ vs ç”°å—è°ƒæ•´ vs é¡ºåºè°ƒæ•´ï¼‰

**A**: ç³»ç»Ÿæä¾›ä¸‰ä¸ªæ‰¹æ¬¡ä¿®æ”¹æ¥å£ï¼Œåº”ç”¨åœºæ™¯å’Œæ•ˆæœå®Œå…¨ä¸åŒï¼š

| ç‰¹æ€§ | æ‰¹æ¬¡é‡æ–°ç”Ÿæˆ<br>`/api/regeneration/batch` | æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´<br>`/api/batch/adjust` | æ‰¹æ¬¡é¡ºåºè°ƒæ•´<br>`/api/batch/reorder` |
|------|------------------------------------------|-------------------------------------|-------------------------------------|
| **ä¸»è¦åŠŸèƒ½** | ä¿®æ”¹ç”°å—æ•°é‡ï¼Œé‡æ–°ç”Ÿæˆæ‰¹æ¬¡ç»“æ„ | åœ¨ç°æœ‰æ‰¹æ¬¡é—´ç§»åŠ¨ç”°å— | è°ƒæ•´æ‰¹æ¬¡æ‰§è¡Œé¡ºåº |
| **æ‰¹æ¬¡æ•°é‡** | âœ… å¯èƒ½æ”¹å˜ | âŒ ä¿æŒä¸å˜ | âŒ ä¿æŒä¸å˜ |
| **æ‰¹æ¬¡ç´¢å¼•** | å¯èƒ½æ”¹å˜ | ä¿æŒä¸å˜ | ä¿æŒä¸å˜ |
| **æ‰¹æ¬¡å†…å®¹** | âœ… å¯èƒ½æ”¹å˜ | âœ… ä¼šæ”¹å˜ï¼ˆç”°å—é‡æ–°åˆ†é…ï¼‰ | âŒ ä¿æŒä¸å˜ |
| **ç”°å—æ€»æ•°** | âœ… å¯èƒ½æ”¹å˜ï¼ˆå¢åŠ /åˆ é™¤ç”°å—ï¼‰ | âŒ ä¿æŒä¸å˜ | âŒ ä¿æŒä¸å˜ |
| **æ‰§è¡Œé¡ºåº** | ä¿æŒä¸å˜ | ä¿æŒä¸å˜ | âœ… ä¼šæ”¹å˜ |
| **æ°´æ³µåˆ†é…** | âœ… å¯ä»¥ä¿®æ”¹ | ğŸ”’ é€šå¸¸ä¿æŒä¸å˜ | ä¿æŒä¸å˜ |
| **æ—¶é—´å®‰æ’** | âœ… é‡æ–°è®¡ç®— | âœ… é‡æ–°è®¡ç®— | âœ… é‡æ–°è®¡ç®— |
| **scenarioæ”¯æŒ** | âœ… æ”¯æŒæŒ‡å®š | âœ… æ‰€æœ‰åŒæ­¥ | âœ… æ”¯æŒæŒ‡å®šï¼ˆæ¨èï¼‰ |
| **é€‚ç”¨åœºæ™¯** | â€¢ å¢åŠ æ–°ç”°å—åˆ°è®¡åˆ’<br>â€¢ ç§»é™¤æŸäº›ç”°å—<br>â€¢ ä¿®æ”¹æ°´æ³µåˆ†é…<br>â€¢ å¤§å¹…è°ƒæ•´çŒæº‰èŒƒå›´ | â€¢ ä¼˜åŒ–æ‰¹æ¬¡è´Ÿè½½å‡è¡¡<br>â€¢ è°ƒæ•´çŒæº‰ä¼˜å…ˆçº§<br>â€¢ æ‰¹æ¬¡é—´ç”°å—äº¤æ¢ | â€¢ è°ƒæ•´æ‰§è¡Œä¼˜å…ˆçº§<br>â€¢ é¿å³°ç”¨ç”µ<br>â€¢ åº”æ€¥è°ƒåº¦ |
| **è®¡ç®—å¼ºåº¦** | ğŸ”´ é«˜ï¼ˆé‡æ–°è®¡ç®—æ‰¹æ¬¡åˆ’åˆ†ï¼‰ | ğŸŸ¢ ä½ï¼ˆä»…é‡æ–°è®¡ç®—é¡ºåºå’Œæ—¶é—´ï¼‰ | ğŸŸ¢ ä½ï¼ˆä»…è°ƒæ•´æ—¶é—´ï¼‰ |
| **ä½¿ç”¨æ—¶æœº** | è®¡åˆ’å†…å®¹éœ€è¦æ”¹å˜æ—¶ | è®¡åˆ’å†…å®¹ä¸å˜ï¼Œä»…ä¼˜åŒ–åˆ†é…æ—¶ | åªéœ€æ”¹å˜æ‰§è¡Œé¡ºåºæ—¶ |

**æ¨èä½¿ç”¨åœºæ™¯**:

**ä½¿ç”¨æ‰¹æ¬¡é‡æ–°ç”Ÿæˆ** (`/api/regeneration/batch`)ï¼š
```javascript
// åœºæ™¯1: å¢åŠ æ–°ç”°å—
{
  field_modifications: [
    { field_id: "S3-G10-F30", action: "add", custom_water_level: 95.0 }
  ]
}

// åœºæ™¯2: ç§»é™¤æ•…éšœç”°å—
{
  field_modifications: [
    { field_id: "S3-G5-F3", action: "remove" }
  ]
}

// åœºæ™¯3: ä¿®æ”¹æ°´æ³µåˆ†é…
{
  pump_assignments: [
    { batch_index: 1, pump_ids: ["P1", "P2"] }
  ]
}
```

**ä½¿ç”¨æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´** (`/api/batch/adjust`)ï¼š
```javascript
// åœºæ™¯1: è´Ÿè½½å‡è¡¡ï¼ˆæ‰¹æ¬¡1å¤ªé•¿ï¼Œæ‰¹æ¬¡2å¤ªçŸ­ï¼‰
{
  field_adjustments: [
    { field_id: "S3-G5-F3", from_batch: 1, to_batch: 2 }
  ]
}

// åœºæ™¯2: æé«˜ä¼˜å…ˆçº§ï¼ˆå°†ç”°å—ç§»åˆ°ç¬¬ä¸€æ‰¹æ¬¡ï¼‰
{
  field_adjustments: [
    { field_id: "S5-G27-F19", from_batch: 3, to_batch: 1 }
  ]
}

// åœºæ™¯3: ç”°å—äº¤æ¢
{
  field_adjustments: [
    { field_id: "S3-G5-F3", from_batch: 1, to_batch: 2 },
    { field_id: "S5-G27-F19", from_batch: 2, to_batch: 1 }
  ]
}
```

**ä½¿ç”¨æ‰¹æ¬¡é¡ºåºè°ƒæ•´** (`/api/batch/reorder`)ï¼š
```javascript
// åœºæ™¯1: æ‰¹æ¬¡2ä¼˜å…ˆæ‰§è¡Œï¼ˆæ¨èæŒ‡å®šscenarioï¼‰
{
  plan_id: "irrigation_plan_20250109_123456.json",
  scenario_name: "P2å•ç‹¬ä½¿ç”¨",
  new_order: [2, 1, 3]  // æ‰¹æ¬¡2å…ˆæ‰§è¡Œ
}

// åœºæ™¯2: é¿å³°ç”¨ç”µè°ƒæ•´
{
  plan_id: "irrigation_plan_20250109_123456.json",
  scenario_name: "å…¨éƒ¨æ°´æ³µ(P1+P2)ç»„åˆä½¿ç”¨",
  new_order: [2, 1]  // ç»„åˆæ–¹æ¡ˆå¯èƒ½åªæœ‰2ä¸ªæ‰¹æ¬¡
}

// åœºæ™¯3: åº”æ€¥è°ƒåº¦
{
  plan_id: "irrigation_plan_20250109_123456.json",
  scenario_name: "çœç”µæ–¹æ¡ˆ",
  new_order: [3, 1, 2, 4]  // æ‰¹æ¬¡3æœ€ç´§æ€¥ï¼Œè°ƒåˆ°ç¬¬ä¸€ä½
}
```

**âš ï¸ é‡è¦æç¤º**ï¼š
- æ‰¹æ¬¡é¡ºåºè°ƒæ•´ï¼šä¸åŒscenarioæ‰¹æ¬¡æ•°é‡å¯èƒ½ä¸åŒï¼Œå»ºè®®æ˜ç¡®æŒ‡å®š`scenario_name`
- æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´ï¼šæ‰€æœ‰scenarioåŒæ­¥è°ƒæ•´ï¼Œç¡®ä¿ä¸€è‡´æ€§
- æ‰¹æ¬¡é‡æ–°ç”Ÿæˆï¼šå¯æŒ‡å®šscenarioï¼Œçµæ´»æ€§æœ€é«˜

---

### Q8: è½®è¯¢æ‰§è¡ŒçŠ¶æ€

**A**: æ¨èä½¿ç”¨ä»¥ä¸‹è½®è¯¢ç­–ç•¥ï¼š

```javascript
const pollExecutionStatus = (executionId, onUpdate, onComplete) => {
  let pollInterval;
  
  const checkStatus = async () => {
    try {
      const response = await fetch(
        `/api/execution/status?execution_id=${executionId}`
      );
      const data = await response.json();
      
      // å›è°ƒæ›´æ–°UI
      onUpdate(data.data);
      
      // æ£€æŸ¥æ˜¯å¦å®Œæˆ
      if (data.data.status === 'completed' || 
          data.data.status === 'failed' ||
          data.data.status === 'stopped') {
        clearInterval(pollInterval);
        onComplete(data.data);
      }
    } catch (error) {
      console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error);
    }
  };
  
  // åˆå§‹æŸ¥è¯¢
  checkStatus();
  
  // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
  pollInterval = setInterval(checkStatus, 5000);
  
  // è¿”å›åœæ­¢è½®è¯¢çš„å‡½æ•°
  return () => clearInterval(pollInterval);
};

// ä½¿ç”¨ç¤ºä¾‹
const stopPolling = pollExecutionStatus(
  executionId,
  (status) => {
    // æ›´æ–°è¿›åº¦æ¡
    updateProgressBar(status.progress_percent);
    updateCurrentBatch(status.current_batch);
  },
  (finalStatus) => {
    console.log('æ‰§è¡Œå®Œæˆ!', finalStatus);
  }
);
```


## é™„å½•

### A. å®Œæ•´çš„è¯·æ±‚ç¤ºä¾‹ï¼ˆAxiosï¼‰

```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://120.55.127.125/api',
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  }
});

// è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆå¯æ·»åŠ è®¤è¯ï¼‰
api.interceptors.request.use(config => {
  // æœªæ¥ç‰ˆæœ¬å¯æ·»åŠ  token
  // config.headers.Authorization = `Bearer ${token}`;
  return config;
});

// å“åº”æ‹¦æˆªå™¨ï¼ˆç»Ÿä¸€é”™è¯¯å¤„ç†ï¼‰
api.interceptors.response.use(
  response => response.data,
  error => {
    console.error('API Error:', error.response?.data || error.message);
    return Promise.reject(error.response?.data || error);
  }
);

// ä½¿ç”¨ç¤ºä¾‹
const generatePlan = async () => {
  try {
    const data = await api.post('/irrigation/plan-generation', {
      farm_id: '13944136728576',
      multi_pump_scenarios: true
    });
    return data;
  } catch (error) {
    throw error;
  }
};
```

---

### B. TypeScript ç±»å‹å®šä¹‰

```typescript
// åŸºç¡€å“åº”ç±»å‹
interface ApiResponse<T = any> {
  success: boolean;
  message?: string;
  data?: T;
}

// çŒæº‰è®¡åˆ’å“åº”
interface PlanGenerationResponse {
  success: boolean;
  message: string;
  plan_id: string;
  data: IrrigationPlan;
  multi_pump_scenarios?: MultiPumpScenarios;
}

// çŒæº‰è®¡åˆ’æ•°æ®
interface IrrigationPlan {
  calc: {
    A_cover_mu: number;
    q_avail_m3ph: number;
    t_win_h: number;
    d_target_mm: number;
  };
  batches: Batch[];
  steps: Step[];
}

// æ‰¹æ¬¡æ•°æ®
interface Batch {
  index: number;
  area_mu: number;
  fields: Field[];
  stats: {
    deficit_vol_m3: number;
    cap_vol_m3: number;
    eta_hours: number;
  };
}

// ç”°å—æ•°æ®
interface Field {
  id: string;
  area_mu: number;
  segment_id: string;
  distance_rank: number;
  wl_mm: number;
  inlet_G_id: string;
}

// æ‰§è¡ŒçŠ¶æ€
interface ExecutionStatus {
  execution_id: string;
  status: 'running' | 'paused' | 'completed' | 'failed' | 'stopped';
  start_time: string;
  current_batch: number;
  total_batches: number;
  progress_percent: number;
  total_regenerations: number;
}
```

---

### C. å¿«é€Ÿå‚è€ƒè¡¨

**æ ¸å¿ƒæ¥å£é€ŸæŸ¥**

| åŠŸèƒ½ | æ–¹æ³• | è·¯å¾„ | å…³é”®å‚æ•° | å‚æ•°å«ä¹‰ |
|------|------|------|----------|----------|
| ç”Ÿæˆè®¡åˆ’ | POST | `/api/irrigation/plan-generation` | `farm_id`, `multi_pump_scenarios` | å†œåœºIDï¼Œæ˜¯å¦ç”Ÿæˆå¤šæ–¹æ¡ˆå¯¹æ¯” |
| å¯åŠ¨æ‰§è¡Œ | POST | `/api/execution/start` | `plan_file_path`, `farm_id`, `execution_mode` | è®¡åˆ’æ–‡ä»¶è·¯å¾„ï¼Œå†œåœºIDï¼Œæ‰§è¡Œæ¨¡å¼(æ¨¡æ‹Ÿ/ç”Ÿäº§) |
| æŸ¥è¯¢çŠ¶æ€ | GET | `/api/execution/status` | `execution_id` | æ‰§è¡Œä»»åŠ¡ID |
| å¤šæ³µå¯¹æ¯” | POST | `/api/irrigation/multi-pump-scenarios` | `config_file`, `active_pumps` | é…ç½®æ–‡ä»¶ï¼Œå¯ç”¨æ°´æ³µåˆ—è¡¨ |
| è®¡åˆ’ä¼˜åŒ– | POST | `/api/irrigation/plan-optimization` | `original_plan_id`, `optimization_goals` | åŸå§‹è®¡åˆ’IDï¼Œä¼˜åŒ–ç›®æ ‡åˆ—è¡¨ |
| æ‰¹æ¬¡è¯¦æƒ… | GET | `/api/batches/{index}/details` | `batch_index` | æ‰¹æ¬¡ç´¢å¼•ï¼ˆä»1å¼€å§‹ï¼‰ |
| æ›´æ–°æ°´ä½ | POST | `/api/water-levels/update` | `field_id`, `water_level_mm` | ç”°å—IDï¼Œæ°´ä½å€¼(mm) |
| æ‰¹æ¬¡é—´ç”°å—è°ƒæ•´ | POST | `/api/batch/adjust` | `plan_id`, `field_adjustments`, `options` | è®¡åˆ’IDï¼Œç”°å—è°ƒæ•´åˆ—è¡¨ï¼Œè°ƒæ•´é€‰é¡¹ |
| æ‰¹æ¬¡é¡ºåºè°ƒæ•´ | POST | `/api/batch/reorder` | `plan_id`, `scenario_name`, `new_order` | è®¡åˆ’IDï¼Œscenarioåç§°ï¼Œæ–°é¡ºåºåˆ—è¡¨ |
| æŸ¥è¯¢æ‰€æœ‰ç”°å—è®¾å¤‡çŠ¶æ€ | GET | `/api/hardware/fields-device-status` | `farm_id`, `timeout`, `verbose` | å†œåœºIDï¼Œè¶…æ—¶æ—¶é—´ï¼Œè¯¦ç»†æ—¥å¿— |
| æ£€æŸ¥ Rice æœåŠ¡ | GET | `/api/irrigation/rice-status` | `rice_api_url` | Rice API åœ°å€ |
| **æ›´æ–°é…ç½®ï¼ˆRice å†³ç­–ï¼‰** | POST | `/api/irrigation/update-config-from-rice` | `farm_id`, `rice_api_url` | ã€ç‹¬ç«‹ã€‘åªæ›´æ–°é…ç½®ï¼Œä¸ç”Ÿæˆè®¡åˆ’ |
| Rice æ™ºèƒ½å†³ç­–ç”Ÿæˆè®¡åˆ’ï¼ˆä¸€ä½“åŒ–ï¼‰ | POST | `/api/irrigation/generate-from-rice` | `farm_id`, `pumps`, `auto_execute` | æ›´æ–°é…ç½®+ç”Ÿæˆè®¡åˆ’ï¼ˆä¸€é”®å¼ï¼‰ |
| åˆ—å‡ºé…ç½®å¤‡ä»½ | GET | `/api/irrigation/list-backups` | æ—  | åˆ—å‡ºæ‰€æœ‰ config.json å¤‡ä»½æ–‡ä»¶ |
| æ¢å¤é…ç½® | POST | `/api/irrigation/restore-config` | `backup_file` | å¤‡ä»½æ–‡ä»¶å |

**é‡è¦IDç±»å‹å¯¹ç…§**

| IDç±»å‹ | æ ¼å¼ | ç¤ºä¾‹ | è·å–æ¥æº | ç”¨é€” |
|--------|------|------|----------|------|
| farm_id | æ•°å­—å­—ç¬¦ä¸² | `"13944136728576"` | ç³»ç»Ÿé…ç½® | æ ‡è¯†å†œåœºï¼Œæ‰€æœ‰æ¥å£éƒ½éœ€è¦ |
| plan_id | æ–‡ä»¶è·¯å¾„ | ç”Ÿäº§: `"/app/output/irrigation_plan_*.json"`<br>æœ¬åœ°: `"e:/irrigation_schedule/farm_irrigation/output/irrigation_plan_*.json"` | ç”Ÿæˆè®¡åˆ’æ¥å£è¿”å› | å¯åŠ¨æ‰§è¡Œã€ä¼˜åŒ–ã€é‡æ–°ç”Ÿæˆ |
| execution_id | exec_å‰ç¼€ | `"exec_20250109_123456"` | å¯åŠ¨æ‰§è¡Œæ¥å£è¿”å› | æŸ¥è¯¢çŠ¶æ€ã€åœæ­¢æ‰§è¡Œ |
| field_id | S-G-Fæ ¼å¼ | `"S3-G2-F1"` | é…ç½®æ–‡ä»¶ | æ°´ä½æ›´æ–°ã€ç”°å—æ“ä½œ |
| batch_index | æ•´æ•°(â‰¥1) | `1`, `2`, `3` | è®¡åˆ’æ–‡ä»¶ä¸­ | æ‰¹æ¬¡æŸ¥è¯¢ã€æ‰¹æ¬¡ä¿®æ”¹ |

**å¸¸ç”¨å‚æ•°å€¼å¯¹ç…§**

| å‚æ•°å | å¯é€‰å€¼ | è¯´æ˜ | æ¨èå€¼ |
|--------|--------|------|--------|
| execution_mode | `simulation`, `production` | æ¨¡æ‹Ÿæ¨¡å¼ / ç”Ÿäº§æ¨¡å¼ | æµ‹è¯•:`simulation`ï¼Œæ­£å¼:`production` |
| source | `sensor`, `manual`, `estimated` | ä¼ æ„Ÿå™¨ / æ‰‹åŠ¨ / ä¼°ç®— | ä¼˜å…ˆä½¿ç”¨:`sensor` |
| quality | `good`, `fair`, `poor` | è‰¯å¥½ / ä¸€èˆ¬ / è¾ƒå·® | ä¼ æ„Ÿå™¨:`good`ï¼Œäººå·¥:`fair` |
| optimization_goals | `cost_minimization`, `time_minimization`, `balanced`, `off_peak`, `water_saving` | æˆæœ¬ä¼˜å…ˆ / æ—¶é—´ä¼˜å…ˆ / å‡è¡¡ / é¿å³° / èŠ‚æ°´ | æ—¥å¸¸ä½¿ç”¨:`balanced` |

---

## D. Rice æ™ºèƒ½å†³ç­–é›†æˆ - é…ç½®ç®¡ç†

### ğŸ“Œ æ ¸å¿ƒå˜æ›´

ä» **v1.1.0** å¼€å§‹ï¼ŒRice é›†æˆæ”¹ä¸º**ç›´æ¥ä¿®æ”¹ `config.json`**ï¼Œè€Œéä½¿ç”¨ä¸´æ—¶é…ç½®æ–‡ä»¶ã€‚

**ä¸»è¦å˜åŒ–**ï¼š
- âœ… è°ƒç”¨ Rice API åï¼Œç›´æ¥æ›´æ–° `config.json` ä¸­çš„ `wl_low` å’Œ `wl_opt`
- âœ… æ‰€æœ‰æ¥å£ï¼ˆåŒ…æ‹¬ `/api/water-levels/targets`ï¼‰éƒ½èƒ½çœ‹åˆ° Rice çš„å†³ç­–å‚æ•°
- âœ… è‡ªåŠ¨åˆ›å»ºé…ç½®å¤‡ä»½ï¼Œæ”¯æŒä¸€é”®æ¢å¤
- âœ… æ”¯æŒé…ç½®ç‰ˆæœ¬ç®¡ç†

ä» **v1.2.0** å¼€å§‹ï¼Œæ–°å¢**ç‹¬ç«‹çš„é…ç½®æ›´æ–°æ¥å£**ï¼Œæä¾›æ›´çµæ´»çš„å·¥ä½œæµï¼š
- âœ… **ç‹¬ç«‹æ¥å£** (`/update-config-from-rice`): åªæ›´æ–°é…ç½®ï¼Œä¸ç”Ÿæˆè®¡åˆ’
- âœ… **ä¸€ä½“åŒ–æ¥å£** (`/generate-from-rice`): æ›´æ–°é…ç½® + ç”Ÿæˆè®¡åˆ’ï¼ˆä¸€é”®å¼ï¼‰
- âœ… ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„å·¥ä½œæµ

---

### 1. æ›´æ–°é…ç½®ï¼ˆåŸºäº Rice å†³ç­–ï¼‰ã€æ–°å¢ã€‘

**æ¥å£**: `POST /api/irrigation/update-config-from-rice`

**åŠŸèƒ½**: ç‹¬ç«‹çš„é…ç½®æ›´æ–°æ¥å£ï¼Œä» Rice è·å–å†³ç­–å¹¶æ›´æ–° `config.json`

**è®¾è®¡ç†å¿µ**:
- âœ… **èŒè´£å•ä¸€**: åªè´Ÿè´£é…ç½®æ›´æ–°ï¼Œä¸ç”Ÿæˆè®¡åˆ’
- âœ… **çµæ´»å¤ç”¨**: æ›´æ–°åå¯è°ƒç”¨ä»»æ„æ¥å£
- âœ… **RESTful è®¾è®¡**: ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

**è¯·æ±‚å‚æ•°**:
```json
{
  "farm_id": "13944136728576",
  "rice_api_url": "http://localhost:5000/v1/rice_irrigation"  // å¯é€‰ï¼Œé»˜è®¤ localhost:5000
}
```

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8000/api/irrigation/update-config-from-rice" \
  -H "Content-Type: application/json" \
  -d '{
    "farm_id": "13944136728576"
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æˆåŠŸï¼config.json å·²åŸºäº Rice å†³ç­–æ›´æ–°ï¼ˆ33 ä¸ªç”°å—ï¼‰",
  "decision_count": 40,
  "irrigate_count": 33,
  "config_backup": "data/config_backup/config_backup_20251120_153022.json",
  "details": {
    "skipped_sections": ["1901478357028446208"],
    "mapping_count": 36,
    "converted_count": 33,
    "rice_modifications": {
      "timestamp": "20251120_153022",
      "source": "rice_smart_irrigation",
      "farm_id": "13944136728576",
      "modified_fields": {
        "S3-G2-F1": {
          "original": {
            "wl_low": 30.0,
            "wl_opt": 80.0,
            "wl_mm": 3.0
          },
          "rice_decision": {
            "wl_low": 4.0,
            "wl_opt": 50.0,
            "wl_mm": 3.0
          }
        }
      }
    },
    "next_steps": [
      "å¯ä»¥è°ƒç”¨ /api/irrigation/plan-generation ç”Ÿæˆè®¡åˆ’",
      "å¯ä»¥è°ƒç”¨ /api/regeneration/batch é‡æ–°ç”Ÿæˆæ‰¹æ¬¡",
      "å¯ä»¥è°ƒç”¨ /api/water-levels/targets æŸ¥çœ‹æ›´æ–°åçš„æ°´ä½",
      "å¯ä»¥è°ƒç”¨ /api/irrigation/restore-config æ¢å¤åŸé…ç½®"
    ]
  }
}
```

**å­—æ®µè¯´æ˜**:
- `decision_count`: Rice API è¿”å›çš„æ€»å†³ç­–æ•°é‡
- `irrigate_count`: éœ€è¦çŒæº‰çš„ç”°å—æ•°é‡
- `config_backup`: åŸå§‹é…ç½®çš„å¤‡ä»½æ–‡ä»¶è·¯å¾„
- `rice_modifications`: Rice é…ç½®ä¿®æ”¹è¯¦æƒ…
  - `modified_fields`: æ¯ä¸ªç”°å—çš„åŸå§‹å€¼å’Œ Rice å†³ç­–å€¼

**åç»­ä½¿ç”¨åœºæ™¯**:

**åœºæ™¯ 1: æ ‡å‡†å·¥ä½œæµ**
```bash
# 1. å…ˆæ›´æ–°é…ç½®
POST /api/irrigation/update-config-from-rice
{
  "farm_id": "13944136728576"
}

# 2. å†ç”Ÿæˆè®¡åˆ’ï¼ˆä½¿ç”¨ Rice é…ç½®ï¼‰
POST /api/irrigation/plan-generation
{
  "farm_id": "13944136728576"
}
```

**åœºæ™¯ 2: é…ç½®æ›´æ–° + æ‰¹æ¬¡é‡æ–°ç”Ÿæˆ**
```bash
# 1. æ›´æ–°é…ç½®
POST /api/irrigation/update-config-from-rice
{
  "farm_id": "13944136728576"
}

# 2. æ‰¹æ¬¡é‡æ–°ç”Ÿæˆï¼ˆä¼šä½¿ç”¨ Rice é…ç½®ï¼‰
POST /api/regeneration/batch
{
  "original_plan_id": "xxx",
  "field_modifications": [...]
}
```

**åœºæ™¯ 3: åªæ›´æ–°é…ç½®ï¼ŒæŸ¥çœ‹æ°´ä½**
```bash
# 1. æ›´æ–°é…ç½®
POST /api/irrigation/update-config-from-rice
{
  "farm_id": "13944136728576"
}

# 2. æŸ¥çœ‹æ°´ä½ç›®æ ‡ï¼ˆä¼šæ˜¾ç¤º Rice é…ç½®ï¼‰
GET /api/water-levels/targets?farm_id=13944136728576
```

**ä¸ä¸€ä½“åŒ–æ¥å£çš„åŒºåˆ«**:
| ç‰¹æ€§ | ç‹¬ç«‹æ¥å£ (`/update-config-from-rice`) | ä¸€ä½“åŒ–æ¥å£ (`/generate-from-rice`) |
|------|---------------------------------------|-------------------------------------|
| èŒè´£ | åªæ›´æ–°é…ç½® | æ›´æ–°é…ç½® + ç”Ÿæˆè®¡åˆ’ |
| çµæ´»æ€§ | é«˜ï¼ˆå¯è°ƒç”¨ä»»æ„åç»­æ¥å£ï¼‰ | ä½ï¼ˆå›ºå®šç”Ÿæˆè®¡åˆ’ï¼‰ |
| é€‚ç”¨åœºæ™¯ | éœ€è¦ç»†ç²’åº¦æ§åˆ¶ | ä¸€é”®å¼å¿«é€Ÿæ“ä½œ |
| è¿”å›å†…å®¹ | é…ç½®æ›´æ–°è¯¦æƒ… | è®¡åˆ’æ–‡ä»¶è·¯å¾„ + æ‰§è¡ŒID |

---

### 2. åˆ—å‡ºé…ç½®å¤‡ä»½

**æ¥å£**: `GET /api/irrigation/list-backups`

**åŠŸèƒ½**: åˆ—å‡ºæ‰€æœ‰é…ç½®å¤‡ä»½æ–‡ä»¶ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl "http://localhost:8000/api/irrigation/list-backups"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "total_backups": 3,
  "backups": [
    {
      "filename": "config_backup_20251120_153022.json",
      "path": "/app/config_backup_20251120_153022.json",
      "size_bytes": 24567,
      "created_time": "2025-11-20T15:30:22"
    },
    {
      "filename": "config_backup_20251120_142015.json",
      "path": "/app/config_backup_20251120_142015.json",
      "size_bytes": 24567,
      "created_time": "2025-11-20T14:20:15"
    }
  ],
  "timestamp": "2025-11-20T15:35:10.123456"
}
```

**å­—æ®µè¯´æ˜**:
- `total_backups`: å¤‡ä»½æ–‡ä»¶æ€»æ•°
- `backups`: å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ï¼ˆæœ€æ–°çš„åœ¨æœ€å‰é¢ï¼‰
  - `filename`: æ–‡ä»¶åï¼ˆå¯ç”¨äºæ¢å¤æ¥å£ï¼‰
  - `path`: å®Œæ•´è·¯å¾„
  - `size_bytes`: æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  - `created_time`: åˆ›å»ºæ—¶é—´

---

### 2. æ¢å¤é…ç½®

**æ¥å£**: `POST /api/irrigation/restore-config`

**åŠŸèƒ½**: ä»å¤‡ä»½æ–‡ä»¶æ¢å¤ `config.json`

**å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `backup_file` | string | æ˜¯ | å¤‡ä»½æ–‡ä»¶åï¼ˆå¦‚ `config_backup_20251120_153022.json`ï¼‰ |

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8000/api/irrigation/restore-config?backup_file=config_backup_20251120_153022.json"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "é…ç½®å·²æˆåŠŸæ¢å¤",
  "restored_from": "config_backup_20251120_153022.json",
  "current_config_backup": "config_before_restore_20251120_160045.json",
  "timestamp": "2025-11-20T16:00:45.123456"
}
```

**å­—æ®µè¯´æ˜**:
- `restored_from`: æ¢å¤æ¥æºçš„å¤‡ä»½æ–‡ä»¶
- `current_config_backup`: æ¢å¤å‰çš„å½“å‰é…ç½®å¤‡ä»½ï¼ˆå®‰å…¨æœºåˆ¶ï¼‰

**âš ï¸ æ³¨æ„äº‹é¡¹**:
1. æ¢å¤æ“ä½œä¼šè‡ªåŠ¨å¤‡ä»½å½“å‰é…ç½®
2. æ¢å¤åéœ€è¦é‡æ–°ç”ŸæˆçŒæº‰è®¡åˆ’
3. æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¸å—å½±å“ï¼ˆä½¿ç”¨å·²ç”Ÿæˆçš„è®¡åˆ’ï¼‰

---

### 3. Rice æ™ºèƒ½å†³ç­–ç”ŸæˆçŒæº‰è®¡åˆ’ï¼ˆä¸€ä½“åŒ–æ¥å£ï¼‰

**æ¥å£**: `POST /api/irrigation/generate-from-rice`

**ç±»å‹**: ä¸€ä½“åŒ–æ¥å£ï¼ˆæ›´æ–°é…ç½® + ç”Ÿæˆè®¡åˆ’ï¼‰

**åŠŸèƒ½**: 
- âœ… è°ƒç”¨ Rice API è·å–æ™ºèƒ½å†³ç­–
- âœ… ç›´æ¥ä¿®æ”¹ `config.json`
- âœ… è‡ªåŠ¨ç”ŸæˆçŒæº‰è®¡åˆ’
- âœ… è‡ªåŠ¨åˆ›å»ºé…ç½®å¤‡ä»½
- âœ… å¯é€‰è‡ªåŠ¨å¯åŠ¨æ‰§è¡Œ

**ä¸ç‹¬ç«‹æ¥å£çš„å¯¹æ¯”**:
| ç‰¹æ€§ | ä¸€ä½“åŒ–æ¥å£ï¼ˆæœ¬æ¥å£ï¼‰ | ç‹¬ç«‹æ¥å£ (`/update-config-from-rice`) |
|------|---------------------|----------------------------------------|
| æ“ä½œèŒƒå›´ | æ›´æ–°é…ç½® + ç”Ÿæˆè®¡åˆ’ | åªæ›´æ–°é…ç½® |
| é€‚ç”¨åœºæ™¯ | ä¸€é”®å¼å¿«é€Ÿæ“ä½œ | éœ€è¦ç»†ç²’åº¦æ§åˆ¶ |
| è¿”å›å†…å®¹ | è®¡åˆ’æ–‡ä»¶è·¯å¾„ + æ‰§è¡ŒID | é…ç½®æ›´æ–°è¯¦æƒ… |
| åç»­æ“ä½œ | å¯ç›´æ¥æ‰§è¡Œè®¡åˆ’ | å¯è°ƒç”¨ä»»æ„æ¥å£ |

**è¯·æ±‚å‚æ•°**:
```json
{
  "farm_id": "13944136728576",
  "rice_api_url": "http://localhost:5000/v1/rice_irrigation",  // å¯é€‰
  "pumps": "P1,P2",                                             // å¯é€‰
  "time_constraints": false,                                    // å¯é€‰
  "auto_execute": false                                         // å¯é€‰
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æˆåŠŸï¼åŸºäº Rice æ™ºèƒ½å†³ç­–ç”ŸæˆçŒæº‰è®¡åˆ’ï¼ˆ28 ä¸ªç”°å—ï¼‰ï¼Œconfig.json å·²æ›´æ–°",
  "decision_count": 36,
  "irrigate_count": 28,
  "plan_file": "/app/output/irrigation_plan_20251120_123456.json",
  "execution_id": null,
  "details": {
    "skipped_sections": [],
    "mapping_count": 36,
    "converted_count": 28,
    "config_backup": "config_backup_20251120_123456.json",
    "rice_modifications": {
      "timestamp": "20251120_123456",
      "source": "rice_smart_irrigation",
      "farm_id": "13944136728576",
      "modified_fields": {
        "S3-G2-F1": {
          "original": {
            "wl_low": 30.0,
            "wl_opt": 80.0,
            "wl_mm": 3.0
          },
          "rice_decision": {
            "wl_low": 4.0,
            "wl_opt": 90.0,
            "wl_mm": 3.0
          }
        }
        // ... æ›´å¤šç”°å—
      }
    },
    "note": "config.json å·²è¢« Rice å†³ç­–æ›´æ–°ï¼ŒåŸå§‹é…ç½®å·²å¤‡ä»½"
  }
}
```

---

### 4. é…ç½®ç®¡ç†å®Œæ•´å·¥ä½œæµ

**åœºæ™¯1: ä¸€é”®å¼ç”Ÿæˆï¼ˆä½¿ç”¨ä¸€ä½“åŒ–æ¥å£ï¼‰**

```javascript
// é€‚ç”¨åœºæ™¯ï¼šå¿«é€Ÿç”Ÿæˆè®¡åˆ’ï¼Œä¸€æ­¥åˆ°ä½
const response = await fetch('/api/irrigation/generate-from-rice', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    farm_id: "13944136728576",
    pumps: "P1,P2",
    auto_execute: true  // å¯è‡ªåŠ¨å¯åŠ¨æ‰§è¡Œ
  })
});
const data = await response.json();

console.log('âœ… è®¡åˆ’å·²ç”Ÿæˆ:', data.plan_file);
console.log('âœ… æ‰§è¡Œå·²å¯åŠ¨:', data.execution_id);
```

**åœºæ™¯2: çµæ´»æ§åˆ¶ï¼ˆä½¿ç”¨ç‹¬ç«‹æ¥å£ï¼‰**

```javascript
// æ­¥éª¤1: å…ˆæ›´æ–°é…ç½®
const updateResponse = await fetch('/api/irrigation/update-config-from-rice', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    farm_id: "13944136728576"
  })
});
const updateData = await updateResponse.json();

console.log('âœ… é…ç½®å·²æ›´æ–°:', updateData.irrigate_count, 'ä¸ªç”°å—');
console.log('ğŸ“¦ å¤‡ä»½æ–‡ä»¶:', updateData.config_backup);

// æ­¥éª¤2: æŸ¥çœ‹æ›´æ–°åçš„é…ç½®
const targetsResponse = await fetch('/api/water-levels/targets?farm_id=13944136728576');
const targets = await targetsResponse.json();

console.log('Rice å†³ç­–æ°´ä½:');
console.log('  wl_low:', targets.fields["S3-G2-F1"].wl_low);  // 4.0
console.log('  wl_opt:', targets.fields["S3-G2-F1"].wl_opt);  // 50.0

// æ­¥éª¤3: æ ¹æ®éœ€è¦è°ƒç”¨å…¶ä»–æ¥å£
// 3a. ç”Ÿæˆè®¡åˆ’
const planResponse = await fetch('/api/irrigation/plan-generation', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ farm_id: "13944136728576" })
});

// æˆ– 3b. æ‰¹æ¬¡é‡æ–°ç”Ÿæˆ
const batchResponse = await fetch('/api/regeneration/batch', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    original_plan_id: "xxx",
    field_modifications: [...]
  })
});
```

**åœºæ™¯3: é…ç½®æŸ¥çœ‹å’ŒéªŒè¯**

```javascript
// ä½¿ç”¨ç‹¬ç«‹æ¥å£æ›´æ–°é…ç½®åï¼Œå¯ä»¥æŸ¥çœ‹å’ŒéªŒè¯
const updateResponse = await fetch('/api/irrigation/update-config-from-rice', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ farm_id: "13944136728576" })
});
const data = await updateResponse.json();

// æŸ¥çœ‹ä¿®æ”¹è¯¦æƒ…
console.log('ä¿®æ”¹çš„ç”°å—æ•°:', Object.keys(data.details.rice_modifications.modified_fields).length);

// æŸ¥çœ‹å…·ä½“ç”°å—çš„ä¿®æ”¹
const field = data.details.rice_modifications.modified_fields["S3-G2-F1"];
console.log('ç”°å— S3-G2-F1:');
console.log('  åŸå§‹é…ç½®:', field.original);
console.log('  Rice å†³ç­–:', field.rice_decision);

// éªŒè¯é…ç½®
const targetsResponse = await fetch('/api/water-levels/targets?farm_id=13944136728576');
const targets = await targetsResponse.json();
console.log('âœ… é…ç½®éªŒè¯:', targets.fields["S3-G2-F1"]);
```

**åœºæ™¯4: æ¢å¤åˆ°åŸå§‹é…ç½®**

```javascript
// æ­¥éª¤1: åˆ—å‡ºå¤‡ä»½
const backupsResponse = await fetch('/api/irrigation/list-backups');
const backups = await backupsResponse.json();

console.log('ğŸ“¦ å¯ç”¨å¤‡ä»½:', backups.total_backups, 'ä¸ª');
backups.backups.forEach(b => {
  console.log(`  - ${b.filename} (${b.age})`);
});

// æ­¥éª¤2: é€‰æ‹©æœ€æ–°å¤‡ä»½æ¢å¤
const latestBackup = backups.backups[0].filename;

const restoreResponse = await fetch('/api/irrigation/restore-config', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    backup_file: latestBackup
  })
});
const restore = await restoreResponse.json();

console.log('âœ… é…ç½®å·²æ¢å¤:', restore.restored_from);
console.log('ğŸ“¦ å½“å‰é…ç½®å·²å¤‡ä»½:', restore.current_config_backed_up_to);

// æ­¥éª¤3: éªŒè¯é…ç½®å·²æ¢å¤
const targetsResponse = await fetch('/api/water-levels/targets?farm_id=13944136728576');
const targets = await targetsResponse.json();

console.log('éªŒè¯åŸå§‹é…ç½®:');
console.log('  wl_low:', targets.fields["S3-G2-F1"].wl_low);  // 30.0 (åŸå§‹é»˜è®¤å€¼)
console.log('  wl_opt:', targets.fields["S3-G2-F1"].wl_opt);  // 80.0 (åŸå§‹é»˜è®¤å€¼)
```

**åœºæ™¯5: æ¥å£é€‰æ‹©å»ºè®®**

```javascript
// âœ… æ¨èï¼šå¿«é€Ÿä¸€é”®æ“ä½œ
// åœºæ™¯ï¼šéœ€è¦ç«‹å³ç”Ÿæˆè®¡åˆ’å¹¶æ‰§è¡Œ
const quickGenerate = async () => {
  return await fetch('/api/irrigation/generate-from-rice', {
    method: 'POST',
    body: JSON.stringify({
      farm_id: "13944136728576",
      auto_execute: true
    })
  });
};

// âœ… æ¨èï¼šéœ€è¦æŸ¥çœ‹é…ç½®å†å†³å®š
// åœºæ™¯ï¼šå…ˆæ›´æ–°é…ç½®ï¼ŒæŸ¥çœ‹ Rice å†³ç­–ï¼Œç„¶åå†³å®šä¸‹ä¸€æ­¥
const flexibleControl = async () => {
  // 1. æ›´æ–°é…ç½®
  const update = await fetch('/api/irrigation/update-config-from-rice', {
    method: 'POST',
    body: JSON.stringify({ farm_id: "13944136728576" })
  });
  
  // 2. æŸ¥çœ‹é…ç½®
  const config = await fetch('/api/water-levels/targets?farm_id=13944136728576');
  
  // 3. æ ¹æ®é…ç½®å†³å®šåç»­æ“ä½œ
  // - å¦‚æœæ»¡æ„ï¼šè°ƒç”¨ /plan-generation
  // - å¦‚æœä¸æ»¡æ„ï¼šè°ƒç”¨ /restore-config æ¢å¤
};

// âœ… æ¨èï¼šéœ€è¦å¤šæ¬¡ä½¿ç”¨ Rice é…ç½®
// åœºæ™¯ï¼šåŸºäº Rice é…ç½®ï¼Œéœ€è¦è°ƒç”¨å¤šä¸ªä¸åŒæ¥å£
const reuseConfig = async () => {
  // 1. å…ˆæ›´æ–°é…ç½®
  await fetch('/api/irrigation/update-config-from-rice', {
    method: 'POST',
    body: JSON.stringify({ farm_id: "13944136728576" })
  });
  
  // 2. å¤šæ¬¡ä½¿ç”¨ Rice é…ç½®
  await fetch('/api/irrigation/plan-generation', ...);
  await fetch('/api/regeneration/batch', ...);
  await fetch('/api/irrigation/plan-optimization', ...);
};
```

**åœºæ™¯6: é…ç½®ç‰ˆæœ¬ç®¡ç†**

```javascript
// å®šæœŸæŸ¥çœ‹é…ç½®å†å²
const viewHistory = async () => {
  const backups = await fetch('/api/irrigation/list-backups').then(r => r.json());
  
  backups.backups.forEach((backup, index) => {
    console.log(`ç‰ˆæœ¬ ${index + 1}: ${backup.created_time}`);
  });
};

// å›æ»šåˆ°ç‰¹å®šç‰ˆæœ¬
const rollbackTo = async (backupFilename) => {
  await fetch(
    `/api/irrigation/restore-config?backup_file=${backupFilename}`,
    { method: 'POST' }
  );
};
```

---

### 5. é…ç½®æ–‡ä»¶å…ƒæ•°æ®

ä½¿ç”¨ Rice å†³ç­–åï¼Œ`config.json` ä¼šåŒ…å«å…ƒæ•°æ®ï¼š

```json
{
  "farm_id": "13944136728576",
  "fields": [
    {
      "id": "S3-G2-F1",
      "wl_mm": 3.0,
      "wl_low": 4.0,      // Rice ä¿®æ”¹åçš„å€¼
      "wl_opt": 90.0,     // Rice ä¿®æ”¹åçš„å€¼
      "wl_high": 140.0
      // ... å…¶ä»–å­—æ®µ
    }
  ],
  "_rice_integration": {
    "timestamp": "20251120_123456",
    "source": "rice_smart_irrigation",
    "farm_id": "13944136728576",
    "modified_fields": {
      // è¯¦ç»†çš„ä¿®æ”¹è®°å½•
    }
  }
}
```

**å…ƒæ•°æ®å­—æ®µè¯´æ˜**:
- `_rice_integration`: Rice é›†æˆå…ƒæ•°æ®ï¼ˆä¸‹åˆ’çº¿å¼€å¤´è¡¨ç¤ºå†…éƒ¨ä½¿ç”¨ï¼‰
  - `timestamp`: ä¿®æ”¹æ—¶é—´æˆ³
  - `source`: æ•°æ®æ¥æºï¼ˆ`rice_smart_irrigation`ï¼‰
  - `modified_fields`: è¯¦ç»†çš„ä¿®æ”¹è®°å½•ï¼ˆåŸå€¼ vs æ–°å€¼ï¼‰

---

### 6. å¸¸è§é—®é¢˜

**Q: ä½¿ç”¨ Rice å†³ç­–åï¼Œå…¶ä»–æ¥å£èƒ½çœ‹åˆ°ä¿®æ”¹å—ï¼Ÿ**  
A: æ˜¯çš„ï¼æ‰€æœ‰åŸºäº `config.json` çš„æ¥å£éƒ½ä¼šçœ‹åˆ°ä¿®æ”¹ï¼š
- `/api/water-levels/targets` - æ˜¾ç¤º Rice çš„å†³ç­–å‚æ•°
- `/api/irrigation/plan-generation` - ä½¿ç”¨ Rice çš„é˜ˆå€¼ç”Ÿæˆè®¡åˆ’
- æ‰€æœ‰æ‰¹æ¬¡å’Œç”°å—ç›¸å…³æ¥å£

**Q: å¦‚ä½•çŸ¥é“é…ç½®æ˜¯å¦è¢« Rice ä¿®æ”¹è¿‡ï¼Ÿ**  
A: æ£€æŸ¥ `config.json` ä¸­çš„ `_rice_integration` å­—æ®µï¼š
```javascript
const hasRiceModifications = config._rice_integration !== undefined;
```

**Q: è¯¯æ“ä½œæ€ä¹ˆåŠï¼Ÿ**  
A: æ¯æ¬¡ä½¿ç”¨ Rice å†³ç­–éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œä½¿ç”¨ `/api/irrigation/restore-config` æ¢å¤å³å¯ã€‚

**Q: å¤‡ä»½æ–‡ä»¶å ç”¨ç©ºé—´æ€ä¹ˆåŠï¼Ÿ**  
A: 
- å¤‡ä»½æ–‡ä»¶é€šå¸¸ < 30KBï¼Œå ç”¨ç©ºé—´å¾ˆå°
- å¯ä»¥æ‰‹åŠ¨åˆ é™¤æ—§å¤‡ä»½æ–‡ä»¶ï¼ˆæ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ï¼‰
- å»ºè®®ä¿ç•™æœ€è¿‘ 10 ä¸ªå¤‡ä»½

**Q: æ¢å¤é…ç½®ä¼šå½±å“æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å—ï¼Ÿ**  
A: ä¸ä¼šã€‚æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä½¿ç”¨å·²ç”Ÿæˆçš„è®¡åˆ’æ–‡ä»¶ï¼Œä¸ä¾èµ– `config.json`ã€‚

---




