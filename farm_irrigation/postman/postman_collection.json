{
  "info": {
    "name": "灌溉系统API测试集合",
    "description": "农场灌溉管理系统完整API测试集合",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. 系统管理",
      "item": [
        {
          "name": "系统初始化",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"farm_id\": \"{{farm_id}}\",\n  \"config_file_path\": \"/path/to/config.json\",\n  \"force_reinit\": false\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/system/init",
              "host": ["{{base_url}}"],
              "path": ["api", "system", "init"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"状态码为200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"响应包含成功标识\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "健康检查",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/system/health-check",
              "host": ["{{base_url}}"],
              "path": ["api", "system", "health-check"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"服务健康状态正常\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.eql(\"healthy\");",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "2. 动态执行",
      "item": [
        {
          "name": "启动动态执行",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"plan_file_path\": \"{{plan_id}}\",\n  \"farm_id\": \"{{farm_id}}\",\n  \"config_file_path\": \"\",\n  \"auto_start\": true,\n  \"water_level_update_interval_minutes\": 30,\n  \"enable_plan_regeneration\": true,\n  \"execution_mode\": \"simulation\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/execution/start",
              "host": ["{{base_url}}"],
              "path": ["api", "execution", "start"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"执行启动成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    ",
                  "    // 保存execution_id供后续使用",
                  "    if (jsonData.data && jsonData.data.execution_id) {",
                  "        pm.environment.set(\"execution_id\", jsonData.data.execution_id);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "查询执行状态",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/execution/status?execution_id={{execution_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "execution", "status"],
              "query": [
                {
                  "key": "execution_id",
                  "value": "{{execution_id}}"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"状态查询成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.data).to.have.property(\"status\");",
                  "});",
                  "",
                  "pm.test(\"响应包含scenario信息\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    if (jsonData.data && jsonData.data.selected_scenario) {",
                  "        pm.expect(jsonData.data.selected_scenario).to.have.property(\"scenario_name\");",
                  "        pm.expect(jsonData.data.selected_scenario).to.have.property(\"pumps_used\");",
                  "        pm.expect(jsonData.data.selected_scenario).to.have.property(\"total_batches\");",
                  "        console.log(\"当前执行的scenario:\", jsonData.data.selected_scenario.scenario_name);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "停止执行",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"execution_id\": \"{{execution_id}}\",\n  \"reason\": \"手动停止测试\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/execution/stop",
              "host": ["{{base_url}}"],
              "path": ["api", "execution", "stop"]
            }
          }
        }
      ]
    },
    {
      "name": "3. 水位管理",
      "item": [
        {
          "name": "更新水位数据",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"farm_id\": \"{{farm_id}}\",\n  \"field_id\": \"{{field_id}}\",\n  \"water_level_mm\": {{water_level}},\n  \"timestamp\": \"2025-01-01T12:00:00Z\",\n  \"source\": \"manual\",\n  \"quality\": \"good\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/water-levels/update",
              "host": ["{{base_url}}"],
              "path": ["api", "water-levels", "update"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"水位更新成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "获取水位历史",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/water-levels/history?farm_id={{farm_id}}&field_id={{field_id}}&hours=24",
              "host": ["{{base_url}}"],
              "path": ["api", "water-levels", "history"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                },
                {
                  "key": "field_id",
                  "value": "{{field_id}}"
                },
                {
                  "key": "hours",
                  "value": "24"
                }
              ]
            }
          }
        },
        {
          "name": "获取水位汇总",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/water-levels/summary?farm_id={{farm_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "water-levels", "summary"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "4. 计划重新生成",
      "item": [
        {
          "name": "手动重新生成（水位）",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"batch_index\": 1,\n  \"custom_water_levels\": {\n    \"S3-G5-F3\": {{custom_water_level}}\n  },\n  \"custom_water_level_standards\": {\n    \"S3-G5-F3\": {\n      \"wl_low\": {{custom_wl_low}},\n      \"wl_opt\": {{custom_wl_opt}},\n      \"wl_high\": {{custom_wl_high}}\n    }\n  },\n  \"force_regeneration\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/regeneration/manual",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "manual"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"重新生成请求成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"响应包含水位标准参数\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('wl_low');",
                  "    pm.expect(jsonData).to.have.property('wl_opt');",
                  "    pm.expect(jsonData).to.have.property('wl_high');",
                  "    pm.expect(jsonData).to.have.property('d_target_mm');",
                  "    ",
                  "    console.log('\\n=== 全局水位标准参数 ===');",
                  "    console.log('低水位阈值 (wl_low): ' + jsonData.wl_low + ' mm - 触发灌溉的判断标准');",
                  "    console.log('最优水位 (wl_opt): ' + jsonData.wl_opt + ' mm - 理想的田间持水量');",
                  "    console.log('高水位阈值 (wl_high): ' + jsonData.wl_high + ' mm - 超过则不需要灌溉');",
                  "    console.log('目标灌溉水深 (d_target_mm): ' + jsonData.d_target_mm + ' mm - 每次灌溉增加的水深');",
                  "    ",
                  "    // 检查田块级水位标准（如果有自定义）",
                  "    if (jsonData.field_water_level_standards) {",
                  "        console.log('\\n=== 田块级水位标准（自定义） ===');",
                  "        Object.keys(jsonData.field_water_level_standards).forEach(function(fieldId) {",
                  "            var standards = jsonData.field_water_level_standards[fieldId];",
                  "            console.log('田块 ' + fieldId + ':');",
                  "            console.log('  - wl_low: ' + standards.wl_low + ' mm');",
                  "            console.log('  - wl_opt: ' + standards.wl_opt + ' mm');",
                  "            console.log('  - wl_high: ' + standards.wl_high + ' mm');",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "获取执行状态",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/execution/status",
              "host": ["{{base_url}}"],
              "path": ["api", "execution", "status"]
            }
          }
        },
        {
          "name": "批次重新生成（田块、时间）-ALL",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"original_plan_id\": \"{{plan_id}}\",\n  \"scenario_name\": null,\n  \"field_modifications\": [\n    {\n      \"field_id\": \"{{test_field_add}}\",\n      \"action\": \"add\",\n      \"custom_water_level\": {{custom_water_level}}\n    },\n    {\n      \"field_id\": \"{{test_field_remove}}\",\n      \"action\": \"remove\"\n    }\n  ],\n  \"time_modifications\": [\n    {\n      \"batch_index\": {{batch_index}},\n      \"start_time_h\": {{start_time_h}},\n      \"duration_h\": {{duration_h}}\n    }\n  ],\n  \"regeneration_params\": {\n    \"force_regeneration\": true,\n    \"optimize_schedule\": true\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/regeneration/batch",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "batch"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"批次重新生成成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.original_plan).to.exist;",
                  "    pm.expect(jsonData.modified_plan).to.exist;",
                  "    pm.expect(jsonData.modifications_summary).to.exist;",
                  "});",
                  "",
                  "pm.test(\"修改摘要包含预期字段\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var summary = jsonData.modifications_summary;",
                  "    pm.expect(summary.field_modifications).to.be.an('array');",
                  "    pm.expect(summary.time_modifications).to.be.an('array');",
                  "    pm.expect(summary.total_changes).to.be.a('number');",
                  "    console.log('\\n=== 接口1-ALL: 只修改田块和时间，不涉及水泵 ===');",
                  "});",
                  "",
                  "pm.test(\"修改摘要包含scenario统计信息\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var summary = jsonData.modifications_summary;",
                  "    ",
                  "    console.log('\\n=== Scenario修改统计 ===');",
                  "    if (summary.scenarios_modified) {",
                  "        console.log('已修改的scenarios:', summary.scenarios_modified.join(', '));",
                  "    }",
                  "    if (summary.scenarios_unchanged) {",
                  "        console.log('未修改的scenarios:', summary.scenarios_unchanged.join(', '));",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "批次重新生成-scenario",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"original_plan_id\": \"{{plan_id}}\",\n  \"scenario_name\": \"{{scenario_name}}\",\n  \"pump_assignments\": [\n    {\n      \"batch_index\": {{batch_index}},\n      \"pump_ids\": [\"{{pump_id_1}}\"]\n    }\n  ],\n  \"time_modifications\": [\n    {\n      \"batch_index\": {{batch_index}},\n      \"start_time_h\": {{start_time_h}},\n      \"duration_h\": {{duration_h}}\n    }\n  ]\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/regeneration/batch",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "batch"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"批次重新生成成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "});",
                  "",
                  "pm.test(\"只修改了指定的scenario\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var summary = jsonData.modifications_summary;",
                  "    ",
                  "    console.log('\\n=== 接口2-scenario: 水泵+时间修改（只影响指定scenario） ===');",
                  "    console.log('指定修改:', pm.environment.get('scenario_name'));",
                  "    ",
                  "    if (summary.scenarios_modified) {",
                  "        console.log('实际修改的scenarios:', summary.scenarios_modified);",
                  "        pm.expect(summary.scenarios_modified).to.include(pm.environment.get('scenario_name'));",
                  "    }",
                  "    ",
                  "    if (summary.scenarios_unchanged) {",
                  "        console.log('未修改的scenarios:', summary.scenarios_unchanged);",
                  "    }",
                  "    ",
                  "    // 验证水泵分配中包含scenarios_affected字段",
                  "    if (summary.pump_assignments && summary.pump_assignments.length > 0) {",
                  "        pm.expect(summary.pump_assignments[0]).to.have.property('scenarios_affected');",
                  "        console.log('\\n受影响的scenarios:', summary.pump_assignments[0].scenarios_affected);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "查询可用Scenarios",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/regeneration/scenarios",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "scenarios"],
              "query": [
                {
                  "key": "plan_id",
                  "value": "{{plan_id}}",
                  "description": "可选：指定计划ID或文件路径。不提供则自动使用最新的计划文件",
                  "disabled": true
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"查询scenarios成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.data).to.exist;",
                  "    pm.expect(jsonData.data.available_scenarios).to.be.an('array');",
                  "});",
                  "",
                  "pm.test(\"显示所有可用scenarios\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var scenarios = jsonData.data.available_scenarios;",
                  "    ",
                  "    console.log('\\n=== 可用的Scenarios ===');",
                  "    console.log('总数:', jsonData.data.total_scenarios);",
                  "    console.log('');",
                  "    ",
                  "    scenarios.forEach(function(scenario, index) {",
                  "        console.log(`${index + 1}. ${scenario.scenario_name}`);",
                  "        console.log(`   水泵: ${scenario.pumps_used.join(', ')}`);",
                  "        console.log(`   批次数: ${scenario.total_batches}`);",
                  "        console.log(`   总时长: ${scenario.total_eta_h.toFixed(1)}h`);",
                  "        console.log(`   总电费: ¥${scenario.total_electricity_cost.toFixed(2)}`);",
                  "        if (scenario.optimization_goal) {",
                  "            console.log(`   优化目标: ${scenario.optimization_goal}`);",
                  "        }",
                  "        console.log('');",
                  "    });",
                  "    ",
                  "    // 自动保存第一个scenario名称到环境变量",
                  "    if (scenarios.length > 0) {",
                  "        pm.environment.set('scenario_name', scenarios[0].scenario_name);",
                  "        console.log('✅ 已自动设置scenario_name为:', scenarios[0].scenario_name);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "清除缓存",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/regeneration/clear-cache",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "clear-cache"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"清除缓存成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    console.log('✅', jsonData.message);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "获取重新生成摘要",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/regeneration/summary/{{farm_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "summary", "{{farm_id}}"]
            }
          }
        },
        {
          "name": "批次间田块调整",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"plan_id\": \"{{plan_id}}\",\n  \"field_adjustments\": [\n    {\n      \"field_id\": \"{{field_id_move_1}}\",\n      \"from_batch\": {{from_batch_1}},\n      \"to_batch\": {{to_batch_1}}\n    },\n    {\n      \"field_id\": \"{{field_id_move_2}}\",\n      \"from_batch\": {{from_batch_2}},\n      \"to_batch\": {{to_batch_2}}\n    }\n  ],\n  \"options\": {\n    \"recalculate_sequence\": true,\n    \"recalculate_timing\": true,\n    \"maintain_pump_assignments\": true,\n    \"regenerate_commands\": true\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/batch/adjust",
              "host": ["{{base_url}}"],
              "path": ["api", "batch", "adjust"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"批次间田块调整成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.original_plan).to.exist;",
                  "    pm.expect(jsonData.adjusted_plan).to.exist;",
                  "    pm.expect(jsonData.changes_summary).to.exist;",
                  "});",
                  "",
                  "pm.test(\"变更摘要包含预期字段\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var summary = jsonData.changes_summary;",
                  "    pm.expect(summary.total_fields_moved).to.be.a('number');",
                  "    pm.expect(summary.affected_batches).to.be.an('array');",
                  "    pm.expect(summary.field_movements).to.be.an('array');",
                  "    pm.expect(summary.batch_time_changes).to.be.an('array');",
                  "    ",
                  "    console.log('\\n=== 批次调整结果 ===');",
                  "    console.log('移动田块数: ' + summary.total_fields_moved);",
                  "    console.log('受影响批次: ' + summary.affected_batches.join(', '));",
                  "    ",
                  "    if (summary.batch_time_changes && summary.batch_time_changes.length > 0) {",
                  "        console.log('\\n批次时间变化:');",
                  "        summary.batch_time_changes.forEach(function(change) {",
                  "            console.log('  批次' + change.batch_index + ': ' + change.old_duration_h + 'h -> ' + change.new_duration_h + 'h (变化: ' + change.time_diff_h + 'h)');",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test(\"验证通过\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.validation).to.exist;",
                  "    pm.expect(jsonData.validation.is_valid).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "5. 批次管理",
      "item": [
        {
          "name": "获取批次列表",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/batches?farm_id={{farm_id}}&status=active",
              "host": ["{{base_url}}"],
              "path": ["api", "batches"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                },
                {
                  "key": "status",
                  "value": "active"
                }
              ]
            }
          }
        },
        {
          "name": "获取批次详情",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/batches/{{batch_index}}/details",
              "host": ["{{base_url}}"],
              "path": ["api", "batches", "{{batch_index}}", "details"]
            }
          }
        }
      ]
    },
    {
      "name": "6. 灌溉计划生成",
      "item": [
        {
          "name": "生成灌溉计划",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"farm_id\": \"{{farm_id}}\",\n  \"config_path\": \"{{config_file_path}}\",\n  \"output_dir\": \"{{output_dir}}\",\n  \"scenario_name\": \"test_scenario\",\n  \"multi_pump_scenarios\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/irrigation/plan-generation",
              "host": ["{{base_url}}"],
              "path": ["api", "irrigation", "plan-generation"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"计划生成成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    ",
                  "    // 保存plan_id供后续使用（plan_id在响应根级别）",
                  "    if (jsonData.plan_id) {",
                  "        pm.environment.set(\"plan_id\", jsonData.plan_id);",
                  "        console.log(\"✅ plan_id已自动设置: \" + jsonData.plan_id);",
                  "    } else {",
                  "        console.log(\"⚠️ 响应中没有找到plan_id\");",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "上传并生成计划",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "config_file",
                  "type": "file",
                  "src": []
                },
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}",
                  "type": "text"
                },
                {
                  "key": "scenario_name",
                  "value": "upload_test",
                  "type": "text"
                },
                {
                  "key": "multi_pump_scenarios",
                  "value": "true",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/api/irrigation/plan-with-upload",
              "host": ["{{base_url}}"],
              "path": ["api", "irrigation", "plan-with-upload"]
            }
          }
        },
        {
          "name": "多水泵方案对比",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"config_file\": \"config.json\",\n  \"active_pumps\": null,\n  \"zone_ids\": null,\n  \"use_realtime_wl\": true,\n  \"min_fields_trigger\": {{min_fields_trigger}}\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/irrigation/multi-pump-scenarios",
              "host": ["{{base_url}}"],
              "path": ["api", "irrigation", "multi-pump-scenarios"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"多水泵方案生成成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.scenarios).to.be.an('array');",
                  "    pm.expect(jsonData.analysis).to.be.an('object');",
                  "    pm.expect(jsonData.total_scenarios).to.be.a('number');",
                  "});",
                  "",
                  "pm.test(\"响应包含触发条件信息\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    if (jsonData.analysis) {",
                  "        pm.expect(jsonData.analysis).to.have.property('min_fields_trigger');",
                  "        console.log('触发阈值:', jsonData.analysis.min_fields_trigger);",
                  "        console.log('低于阈值的田块数:', jsonData.analysis.total_fields_below_threshold);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "灌溉计划优化",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"original_plan_id\": \"{{plan_id}}\",\n  \"optimization_goals\": [\n    \"cost_minimization\",\n    \"time_minimization\",\n    \"balanced\",\n    \"off_peak\"\n  ],\n  \"constraints\": {\n    \"max_duration_hours\": 24,\n    \"electricity_price_schedule\": {\n      \"peak\": {\n        \"hours\": [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21],\n        \"price\": 1.0\n      },\n      \"valley\": {\n        \"hours\": [22, 23, 0, 1, 2, 3, 4, 5, 6, 7],\n        \"price\": 0.4\n      }\n    },\n    \"available_pumps\": [\"P1\", \"P2\"]\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/irrigation/plan-optimization",
              "host": ["{{base_url}}"],
              "path": ["api", "irrigation", "plan-optimization"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"优化方案生成成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.total_scenarios).to.be.above(0);",
                  "});",
                  "",
                  "pm.test(\"响应包含优化方案\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.scenarios).to.be.an('array');",
                  "    pm.expect(jsonData.comparison).to.be.an('object');",
                  "    pm.expect(jsonData.base_plan_summary).to.be.an('object');",
                  "    ",
                  "    console.log('\\n=== 优化方案对比 ===');",
                  "    jsonData.scenarios.forEach(function(scenario) {",
                  "        console.log(scenario.name + ':');",
                  "        console.log('  - 总时长: ' + scenario.total_eta_h.toFixed(1) + '小时');",
                  "        console.log('  - 总电费: ¥' + scenario.total_electricity_cost.toFixed(2));",
                  "        console.log('  - 说明: ' + scenario.description);",
                  "    });",
                  "    ",
                  "    console.log('\\n推荐方案: ' + jsonData.comparison.recommended);",
                  "    console.log('电费范围: ¥' + jsonData.comparison.cost_range.min.toFixed(2) + ' - ¥' + jsonData.comparison.cost_range.max.toFixed(2));",
                  "    console.log('时长范围: ' + jsonData.comparison.time_range.min.toFixed(1) + 'h - ' + jsonData.comparison.time_range.max.toFixed(1) + 'h');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "7. Web可视化",
      "item": [
        {
          "name": "获取GeoJSON数据",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/geojson/fields?farm_id={{farm_id}}",
              "host": ["{{base_url}}"],
              "path": ["geojson", "fields"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                }
              ]
            }
          }
        },
        {
          "name": "获取监控面板数据",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/monitoring/dashboard?farm_id={{farm_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "monitoring", "dashboard"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                }
              ]
            }
          }
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全局预请求脚本",
          "console.log('发送请求到:', pm.request.url);"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全局测试脚本",
          "pm.test('响应时间小于5秒', function () {",
          "    pm.expect(pm.response.responseTime).to.be.below(5000);",
          "});"
        ]
      }
    }
  ]
}