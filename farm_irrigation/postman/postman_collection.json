{
  "info": {
    "name": "灌溉系统API测试集合",
    "description": "农场灌溉管理系统完整API测试集合",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. 系统管理",
      "item": [
        {
          "name": "系统初始化",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"farm_id\": \"{{farm_id}}\",\n  \"config_file_path\": \"/path/to/config.json\",\n  \"force_reinit\": false\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/system/init",
              "host": ["{{base_url}}"],
              "path": ["api", "system", "init"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"状态码为200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"响应包含成功标识\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "健康检查",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/system/health-check",
              "host": ["{{base_url}}"],
              "path": ["api", "system", "health-check"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"服务健康状态正常\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.eql(\"healthy\");",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "2. 动态执行",
      "item": [
        {
          "name": "启动动态执行",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"plan_file_path\": \"{{plan_file_path}}\",\n  \"farm_id\": \"{{farm_id}}\",\n  \"config_file_path\": \"{{config_file_path}}\",\n  \"auto_start\": true,\n  \"water_level_update_interval_minutes\": 30,\n  \"enable_plan_regeneration\": true,\n  \"execution_mode\": \"simulation\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/execution/start",
              "host": ["{{base_url}}"],
              "path": ["api", "execution", "start"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"执行启动成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    ",
                  "    // 保存execution_id供后续使用",
                  "    if (jsonData.data && jsonData.data.execution_id) {",
                  "        pm.environment.set(\"execution_id\", jsonData.data.execution_id);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "查询执行状态",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/execution/status?execution_id={{execution_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "execution", "status"],
              "query": [
                {
                  "key": "execution_id",
                  "value": "{{execution_id}}"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"状态查询成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.data).to.have.property(\"status\");",
                  "});",
                  "",
                  "pm.test(\"响应包含scenario信息\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    if (jsonData.data && jsonData.data.selected_scenario) {",
                  "        pm.expect(jsonData.data.selected_scenario).to.have.property(\"scenario_name\");",
                  "        pm.expect(jsonData.data.selected_scenario).to.have.property(\"pumps_used\");",
                  "        pm.expect(jsonData.data.selected_scenario).to.have.property(\"total_batches\");",
                  "        console.log(\"当前执行的scenario:\", jsonData.data.selected_scenario.scenario_name);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "停止执行",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"execution_id\": \"{{execution_id}}\",\n  \"reason\": \"手动停止测试\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/execution/stop",
              "host": ["{{base_url}}"],
              "path": ["api", "execution", "stop"]
            }
          }
        }
      ]
    },
    {
      "name": "3. 水位管理",
      "item": [
        {
          "name": "更新水位数据",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"farm_id\": \"{{farm_id}}\",\n  \"field_id\": \"{{field_id}}\",\n  \"water_level_mm\": {{water_level}},\n  \"timestamp\": \"2025-01-01T12:00:00Z\",\n  \"source\": \"manual\",\n  \"quality\": \"good\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/water-levels/update",
              "host": ["{{base_url}}"],
              "path": ["api", "water-levels", "update"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"水位更新成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "获取水位历史",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/water-levels/history?farm_id={{farm_id}}&field_id={{field_id}}&hours=24",
              "host": ["{{base_url}}"],
              "path": ["api", "water-levels", "history"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                },
                {
                  "key": "field_id",
                  "value": "{{field_id}}"
                },
                {
                  "key": "hours",
                  "value": "24"
                }
              ]
            }
          }
        },
        {
          "name": "获取水位汇总",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/water-levels/summary?farm_id={{farm_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "water-levels", "summary"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "4. 计划重新生成",
      "item": [
        {
          "name": "手动重新生成",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"batch_index\": 1,\n  \"custom_water_levels\": {\n    \"S3-G5-F3\": 95.0\n  },\n  \"force_regeneration\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/regeneration/manual",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "manual"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"重新生成请求成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "获取执行状态",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/execution/status",
              "host": ["{{base_url}}"],
              "path": ["api", "execution", "status"]
            }
          }
        },
        {
          "name": "批次重新生成",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"original_plan_id\": \"{{plan_id}}\",\n  \"field_modifications\": [\n    {\n      \"field_id\": \"{{test_field_add}}\",\n      \"action\": \"add\",\n      \"custom_water_level\": {{custom_water_level}}\n    },\n    {\n      \"field_id\": \"{{test_field_remove}}\",\n      \"action\": \"remove\"\n    }\n  ],\n  \"pump_assignments\": [\n    {\n      \"batch_index\": {{batch_index}},\n      \"pump_ids\": [\"{{pump_id_1}}\", \"{{pump_id_2}}\"]\n    }\n  ],\n  \"time_modifications\": [\n    {\n      \"batch_index\": {{batch_index}},\n      \"start_time_h\": {{start_time_h}},\n      \"duration_h\": {{duration_h}}\n    }\n  ],\n  \"regeneration_params\": {\n    \"force_regeneration\": true,\n    \"optimize_schedule\": true\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/regeneration/batch",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "batch"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"批次重新生成成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    pm.expect(jsonData.original_plan).to.exist;",
                  "    pm.expect(jsonData.modified_plan).to.exist;",
                  "    pm.expect(jsonData.modifications_summary).to.exist;",
                  "});",
                  "",
                  "pm.test(\"修改摘要包含预期字段\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    var summary = jsonData.modifications_summary;",
                  "    pm.expect(summary.field_modifications).to.be.an('array');",
                  "    pm.expect(summary.pump_assignments).to.be.an('array');",
                  "    pm.expect(summary.time_modifications).to.be.an('array');",
                  "    pm.expect(summary.total_changes).to.be.a('number');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "获取重新生成摘要",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/regeneration/summary/{{farm_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "regeneration", "summary", "{{farm_id}}"]
            }
          }
        }
      ]
    },
    {
      "name": "5. 批次管理",
      "item": [
        {
          "name": "获取批次列表",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/batches?farm_id={{farm_id}}&status=active",
              "host": ["{{base_url}}"],
              "path": ["api", "batches"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                },
                {
                  "key": "status",
                  "value": "active"
                }
              ]
            }
          }
        },
        {
          "name": "获取批次详情",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/batches/{{batch_index}}/details",
              "host": ["{{base_url}}"],
              "path": ["api", "batches", "{{batch_index}}", "details"]
            }
          }
        }
      ]
    },
    {
      "name": "6. 灌溉计划生成",
      "item": [
        {
          "name": "生成灌溉计划",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"farm_id\": \"{{farm_id}}\",\n  \"config_path\": \"{{config_file_path}}\",\n  \"output_dir\": \"{{output_dir}}\",\n  \"scenario_name\": \"test_scenario\",\n  \"multi_pump_scenarios\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/irrigation/plan-generation",
              "host": ["{{base_url}}"],
              "path": ["api", "irrigation", "plan-generation"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"计划生成成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.success).to.be.true;",
                  "    ",
                  "    // 保存plan_id供后续使用",
                  "    if (jsonData.data && jsonData.data.plan_id) {",
                  "        pm.environment.set(\"plan_id\", jsonData.data.plan_id);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "上传并生成计划",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "config_file",
                  "type": "file",
                  "src": []
                },
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}",
                  "type": "text"
                },
                {
                  "key": "scenario_name",
                  "value": "upload_test",
                  "type": "text"
                },
                {
                  "key": "multi_pump_scenarios",
                  "value": "true",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{base_url}}/api/irrigation/plan-with-upload",
              "host": ["{{base_url}}"],
              "path": ["api", "irrigation", "plan-with-upload"]
            }
          }
        },
        {
          "name": "多水泵方案对比",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"config_file\": \"config.json\",\n  \"active_pumps\": null,\n  \"zone_ids\": null,\n  \"use_realtime_wl\": true,\n  \"min_fields_trigger\": {{min_fields_trigger}}\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/irrigation/multi-pump-scenarios",
              "host": ["{{base_url}}"],
              "path": ["api", "irrigation", "multi-pump-scenarios"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"多水泵方案生成成功\", function () {",
                  "    pm.response.to.have.status(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.scenarios).to.be.an('array');",
                  "    pm.expect(jsonData.analysis).to.be.an('object');",
                  "    pm.expect(jsonData.total_scenarios).to.be.a('number');",
                  "});",
                  "",
                  "pm.test(\"响应包含触发条件信息\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    if (jsonData.analysis) {",
                  "        pm.expect(jsonData.analysis).to.have.property('min_fields_trigger');",
                  "        console.log('触发阈值:', jsonData.analysis.min_fields_trigger);",
                  "        console.log('低于阈值的田块数:', jsonData.analysis.total_fields_below_threshold);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "7. Web可视化",
      "item": [
        {
          "name": "获取GeoJSON数据",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/geojson/fields?farm_id={{farm_id}}",
              "host": ["{{base_url}}"],
              "path": ["geojson", "fields"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                }
              ]
            }
          }
        },
        {
          "name": "获取监控面板数据",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/monitoring/dashboard?farm_id={{farm_id}}",
              "host": ["{{base_url}}"],
              "path": ["api", "monitoring", "dashboard"],
              "query": [
                {
                  "key": "farm_id",
                  "value": "{{farm_id}}"
                }
              ]
            }
          }
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全局预请求脚本",
          "console.log('发送请求到:', pm.request.url);"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// 全局测试脚本",
          "pm.test('响应时间小于5秒', function () {",
          "    pm.expect(pm.response.responseTime).to.be.below(5000);",
          "});"
        ]
      }
    }
  ]
}