# Rice æ™ºèƒ½å†³ç­–é›†æˆ - å¿«é€ŸæŒ‡å—

## ğŸ“‹ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  rice_smart_irrigation (ç«¯å£ 5000)  â”‚  â† æ™ºèƒ½å†³ç­–æœåŠ¡
â”‚  - ç”Ÿè‚²æœŸåˆ†æ                        â”‚
â”‚  - å¤©æ°”é¢„æµ‹                          â”‚
â”‚  - å†œäº‹å†³ç­–                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP API
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  farm_irrigation (ç«¯å£ 8000)        â”‚  â† è®¡åˆ’ç”Ÿæˆä¸æ‰§è¡Œ
â”‚  - æ‰¹æ¬¡è®¡ç®—                          â”‚
â”‚  - ç¡¬ä»¶æ§åˆ¶                          â”‚
â”‚  - æ‰§è¡Œç›‘æ§                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¯åŠ¨æµç¨‹

### 1. å¯åŠ¨ Rice æœåŠ¡ï¼ˆç»ˆç«¯ 1ï¼‰

```bash
cd e:/rice_smart_irrigation/rice_smart_irrigation/backend
$env:USE_EXTERNAL_DB="1"
python app.py
```

**éªŒè¯**: è®¿é—® `http://localhost:5000/v1/rice_irrigation?farm_id=13944136728576`

---

### 2. å¯åŠ¨ Farm æœåŠ¡ï¼ˆç»ˆç«¯ 2ï¼‰

```bash
cd e:/irrigation_schedule/farm_irrigation
python main_dynamic_execution_api.py
```

**éªŒè¯**: è®¿é—® `http://localhost:8000/api/info`

---

## ğŸ”„ æ ¸å¿ƒå·¥ä½œæµ

### æ–¹æ¡ˆ Aï¼šä¸€é”®å¼ï¼ˆæ¨èå¿«é€Ÿæ“ä½œï¼‰

```bash
# ä¸€æ­¥å®Œæˆï¼šæ›´æ–°é…ç½® + ç”Ÿæˆè®¡åˆ’
POST http://localhost:8000/api/irrigation/generate-from-rice
{
  "farm_id": "13944136728576",
  "pumps": "P1,P2",
  "auto_execute": false
}

# è¿”å›ï¼šè®¡åˆ’æ–‡ä»¶è·¯å¾„ + é…ç½®å¤‡ä»½è·¯å¾„
```

**é€‚ç”¨åœºæ™¯**: å¿«é€Ÿç”Ÿæˆè®¡åˆ’ï¼Œä¸€æ­¥åˆ°ä½

---

### æ–¹æ¡ˆ Bï¼šåˆ†æ­¥å¼ï¼ˆæ¨èç»†ç²’åº¦æ§åˆ¶ï¼‰

```bash
# æ­¥éª¤1: æ›´æ–°é…ç½®ï¼ˆä¸ç”Ÿæˆè®¡åˆ’ï¼‰
POST http://localhost:8000/api/irrigation/update-config-from-rice
{
  "farm_id": "13944136728576"
}

# æ­¥éª¤2: æŸ¥çœ‹é…ç½®ï¼ˆå¯é€‰ï¼‰
GET http://localhost:8000/api/water-levels/targets?farm_id=13944136728576

# æ­¥éª¤3: ç”Ÿæˆè®¡åˆ’ï¼ˆä½¿ç”¨ Rice é…ç½®ï¼‰
POST http://localhost:8000/api/irrigation/plan-generation
{
  "farm_id": "13944136728576"
}

# æ­¥éª¤4: å¯åŠ¨æ‰§è¡Œï¼ˆå¯é€‰ï¼‰
POST http://localhost:8000/api/execution/start
{
  "plan_file_path": "è¿”å›çš„è®¡åˆ’è·¯å¾„",
  "farm_id": "13944136728576"
}
```

**é€‚ç”¨åœºæ™¯**: 
- éœ€è¦æŸ¥çœ‹ Rice å†³ç­–å†å†³å®šä¸‹ä¸€æ­¥
- éœ€è¦åŸºäº Rice é…ç½®è°ƒç”¨å¤šä¸ªæ¥å£
- éœ€è¦å¯¹æµç¨‹æœ‰æ›´å¤šæ§åˆ¶

---

## ğŸ“Š æ¥å£å¯¹æ¯”

| æ¥å£ | åŠŸèƒ½ | è¿”å› | ä½¿ç”¨åœºæ™¯ |
|------|------|------|----------|
| `/update-config-from-rice` | åªæ›´æ–°é…ç½® | é…ç½®è¯¦æƒ… + å¤‡ä»½è·¯å¾„ | éœ€è¦çµæ´»æ§åˆ¶æµç¨‹ |
| `/generate-from-rice` | æ›´æ–°é…ç½® + ç”Ÿæˆè®¡åˆ’ | è®¡åˆ’æ–‡ä»¶ + æ‰§è¡ŒID | ä¸€é”®å¿«é€Ÿæ“ä½œ |
| `/plan-generation` | ç”Ÿæˆè®¡åˆ’ï¼ˆä½¿ç”¨ç°æœ‰é…ç½®ï¼‰ | è®¡åˆ’æ–‡ä»¶ | åŸºäº Rice é…ç½®ç”Ÿæˆè®¡åˆ’ |
| `/list-backups` | åˆ—å‡ºé…ç½®å¤‡ä»½ | å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ | æŸ¥çœ‹å†å²é…ç½® |
| `/restore-config` | æ¢å¤é…ç½® | æ¢å¤ç»“æœ | å›é€€åˆ°åŸå§‹é…ç½® |

---

## ğŸ¯ å¸¸è§åœºæ™¯

### åœºæ™¯ 1: æ¯æ—¥çŒæº‰å†³ç­–

```bash
# 1. è·å– Rice å†³ç­–å¹¶ç”Ÿæˆè®¡åˆ’
POST /api/irrigation/generate-from-rice
{"farm_id": "13944136728576", "auto_execute": true}

# å®Œæˆï¼ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œ
```

---

### åœºæ™¯ 2: æŸ¥çœ‹ Rice å†³ç­–åå†å†³å®š

```bash
# 1. å…ˆæ›´æ–°é…ç½®
POST /api/irrigation/update-config-from-rice
{"farm_id": "13944136728576"}

# 2. æŸ¥çœ‹ Rice çš„æ°´ä½ç›®æ ‡
GET /api/water-levels/targets?farm_id=13944136728576

# 3. å¦‚æœæ»¡æ„ï¼Œç”Ÿæˆè®¡åˆ’
POST /api/irrigation/plan-generation
{"farm_id": "13944136728576"}

# 4. å¦‚æœä¸æ»¡æ„ï¼Œæ¢å¤åŸé…ç½®
POST /api/irrigation/restore-config
{"backup_file": "config_backup_20251120_123456.json"}
```

---

### åœºæ™¯ 3: æ‰¹æ¬¡è°ƒæ•´ï¼ˆä½¿ç”¨ Rice é…ç½®ï¼‰

```bash
# 1. æ›´æ–°é…ç½®
POST /api/irrigation/update-config-from-rice
{"farm_id": "13944136728576"}

# 2. ç”Ÿæˆåˆå§‹è®¡åˆ’
POST /api/irrigation/plan-generation
{"farm_id": "13944136728576"}

# 3. è°ƒæ•´æ‰¹æ¬¡ï¼ˆä»ä½¿ç”¨ Rice é…ç½®ï¼‰
POST /api/regeneration/batch
{
  "original_plan_id": "è®¡åˆ’ID",
  "field_modifications": [{"field_id": "S3-G2-F1", "action": "remove"}]
}
```

---

### åœºæ™¯ 4: é…ç½®ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰å¤‡ä»½
GET /api/irrigation/list-backups

# æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ¬
POST /api/irrigation/restore-config
{"backup_file": "config_backup_20251120_123456.json"}
```

---

## âš™ï¸ å…³é”®æœºåˆ¶

### Rice é…ç½®åŸç†

```
Rice API è¿”å›:
â”œâ”€ action: "irrigate"
â”œâ”€ current_waterlevel: 3.0mm
â””â”€ target: 50.0mm

Farm é…ç½®æ›´æ–°:
â”œâ”€ wl_mm: 3.0           (å½“å‰æ°´ä½)
â”œâ”€ wl_low: 4.0          (current + 1ï¼Œå¼ºåˆ¶è§¦å‘)
â””â”€ wl_opt: 50.0         (Rice ç›®æ ‡)

æ‰¹æ¬¡è®¡ç®—:
if (wl_mm < wl_low):     # 3.0 < 4.0 â†’ éœ€è¦çŒæº‰
    deficit = wl_opt - wl_mm   # 50 - 3 = 47mm
    â†’ åŠ å…¥æ‰¹æ¬¡è®¡åˆ’
```

---

### é…ç½®ä¿æŠ¤æœºåˆ¶

```
1. è°ƒç”¨ Rice æ¥å£
   â†“
2. å¤‡ä»½ config.json â†’ data/config_backup/config_backup_{timestamp}.json
   â†“
3. ä¿®æ”¹ config.json (wl_low, wl_opt, wl_mm)
   â†“
4. ç”Ÿæˆè®¡åˆ’ (Pipeline è·³è¿‡é…ç½®ç”Ÿæˆæ­¥éª¤)
   â†“
5. å†æ¬¡å†™å…¥ config.json (ç¡®ä¿ä¸è¢«è¦†ç›–)
```

**å…³é”®**: Pipeline é€šè¿‡ `config_file` å‚æ•°è·³è¿‡é…ç½®é‡æ–°ç”Ÿæˆï¼Œä¿ç•™ Rice é…ç½®ã€‚

---

## ğŸ”§ Postman æµ‹è¯•

### å¯¼å…¥ Postman é›†åˆ

```
æ–‡ä»¶: tests/postman/postman_collection.json
ç¯å¢ƒ: tests/postman/postman_environment.json
```

### æ ¸å¿ƒè¯·æ±‚

```
11. Rice æ™ºèƒ½å†³ç­–é›†æˆ
  â”œâ”€ 11.1 æ£€æŸ¥ Rice æœåŠ¡çŠ¶æ€
  â”œâ”€ 11.2 æ›´æ–°é…ç½®ï¼ˆåŸºäº Rice å†³ç­–ï¼‰    â† ç‹¬ç«‹æ¥å£
  â”œâ”€ 11.3 æ™ºèƒ½å†³ç­–ç”ŸæˆçŒæº‰è®¡åˆ’ï¼ˆä¸€ä½“åŒ–ï¼‰ â† ä¸€ä½“åŒ–æ¥å£
  â”œâ”€ 11.4 åˆ—å‡ºé…ç½®å¤‡ä»½
  â””â”€ 11.5 æ¢å¤é…ç½®
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸¤ä¸ªæ¥å£è¯¥ç”¨å“ªä¸ªï¼Ÿ

**A**: 
- **å¿«é€Ÿæ“ä½œ** â†’ `/generate-from-rice`ï¼ˆä¸€é”®å®Œæˆï¼‰
- **ç»†ç²’åº¦æ§åˆ¶** â†’ `/update-config-from-rice`ï¼ˆåˆ†æ­¥æ“ä½œï¼‰

---

### Q2: é…ç½®æ›´æ–°åä¼šå½±å“å·²æœ‰è®¡åˆ’å—ï¼Ÿ

**A**: ä¸ä¼šã€‚å·²ç”Ÿæˆçš„è®¡åˆ’æ–‡ä»¶ç‹¬ç«‹å­˜åœ¨ï¼Œä¸å—é…ç½®æ›´æ–°å½±å“ã€‚

---

### Q3: å¦‚ä½•éªŒè¯ Rice é…ç½®å·²ç”Ÿæ•ˆï¼Ÿ

**A**: 
```bash
GET /api/water-levels/targets?farm_id=13944136728576

# æŸ¥çœ‹è¿”å›çš„ wl_low å’Œ wl_opt æ˜¯å¦ä¸º Rice å†³ç­–å€¼
```

---

### Q4: å¦‚ä½•å›é€€åˆ°åŸå§‹é…ç½®ï¼Ÿ

**A**: 
```bash
# 1. åˆ—å‡ºå¤‡ä»½
GET /api/irrigation/list-backups

# 2. æ¢å¤
POST /api/irrigation/restore-config
{"backup_file": "config_backup_xxx.json"}
```

---

### Q5: Rice æœåŠ¡æœªå¯åŠ¨ä¼šæ€æ ·ï¼Ÿ

**A**: API è¿”å›é”™è¯¯ï¼š
```json
{
  "success": false,
  "detail": "æ— æ³•è¿æ¥åˆ° Rice æœåŠ¡ï¼Œè¯·ç¡®ä¿ Rice API å·²å¯åŠ¨ (python app.py)"
}
```

**è§£å†³**: åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ `python app.py`

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### ID æ˜ å°„

```python
# Rice API ä½¿ç”¨ sectionID (æ•°å­—ä¸²)
"1901478554692747264" â†’ 

# Farm ç³»ç»Ÿä½¿ç”¨ field_id (SGF æ ¼å¼)
"S3-G2-F1"

# æ˜ å°„è§„åˆ™: config.json ä¸­çš„ sectionID å­—æ®µ
{
  "id": "S3-G2-F1",
  "sectionID": "1901478554692747264",
  ...
}
```

---

### å…³é”®ç«¯å£

- Rice API: `http://localhost:5000`
- Farm API: `http://localhost:8000`

---

## ğŸ‰ å¿«é€Ÿä¸Šæ‰‹

```bash
# 1. å¯åŠ¨æœåŠ¡
ç»ˆç«¯1: cd rice_smart_irrigation/backend && python app.py
ç»ˆç«¯2: cd farm_irrigation && python main_dynamic_execution_api.py

# 2. æ‰“å¼€ Postmanï¼Œå¯¼å…¥é›†åˆ

# 3. è¿è¡Œæµ‹è¯•è¯·æ±‚ï¼ˆæŒ‰é¡ºåºï¼‰
11.1 æ£€æŸ¥ Rice æœåŠ¡çŠ¶æ€   âœ“
11.2 æ›´æ–°é…ç½®ï¼ˆRice å†³ç­–ï¼‰ âœ“
11.3 æŸ¥çœ‹æ°´ä½ç›®æ ‡          âœ“
2.1 ç”ŸæˆçŒæº‰è®¡åˆ’           âœ“
3.1 å¯åŠ¨æ‰§è¡Œ               âœ“

# å®Œæˆï¼ğŸŠ
```

---

**ç‰ˆæœ¬**: v1.2.0  
**æ›´æ–°**: 2025-11-20  
**ç»´æŠ¤**: æ·»åŠ ç‹¬ç«‹é…ç½®æ›´æ–°æ¥å£ï¼Œæ”¯æŒæ›´çµæ´»çš„å·¥ä½œæµ

