# åŸºäºä¸åŒéœ€æ±‚çš„çŒæº‰æ–¹æ¡ˆæ¨èç®—æ³•æ–‡æ¡£ v1.0

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: 1.0
- **æ—¥æœŸ**: 2025å¹´1æœˆ
- **é€‚ç”¨ç³»ç»Ÿ**: æ™ºèƒ½çŒæº‰è°ƒåº¦ç³»ç»Ÿ
- **æ ¸å¿ƒæ¨¡å—**: `intelligent_batch_optimizer.py`
- **ä½œè€…**: ç³»ç»Ÿæ¶æ„ç»„

---

## 1. ç®—æ³•æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

çŒæº‰æ–¹æ¡ˆæ¨èç®—æ³•æ˜¯ä¸€å¥—åŸºäºå¤šç›®æ ‡ä¼˜åŒ–çš„æ™ºèƒ½å†³ç­–ç³»ç»Ÿï¼Œèƒ½å¤Ÿæ ¹æ®ä¸åŒä¸šåŠ¡éœ€æ±‚è‡ªåŠ¨ç”Ÿæˆæœ€ä¼˜çŒæº‰æ–¹æ¡ˆï¼Œå¸®åŠ©ç”¨æˆ·åœ¨**æˆæœ¬ã€æ—¶é—´ã€æ°´èµ„æº**ç­‰å¤šç»´åº¦ä¹‹é—´åšå‡ºæƒè¡¡ã€‚

**æ ¸å¿ƒèƒ½åŠ›**ï¼š
- ğŸ¯ **å¤šç›®æ ‡ä¼˜åŒ–**ï¼šæ”¯æŒ5ç§ä¼˜åŒ–ç›®æ ‡ï¼ˆçœç”µã€çœæ—¶ã€å‡è¡¡ã€é¿å³°ã€èŠ‚æ°´ï¼‰
- ğŸ”„ **æ–¹æ¡ˆå¯¹æ¯”**ï¼šè‡ªåŠ¨ç”Ÿæˆå¤šä¸ªæ–¹æ¡ˆå¹¶æä¾›é‡åŒ–å¯¹æ¯”
- ğŸ’¡ **æ™ºèƒ½æ¨è**ï¼šåŸºäºçº¦æŸæ¡ä»¶æ¨èæœ€é€‚åˆçš„æ–¹æ¡ˆ
- ğŸ“Š **å¯è§†åŒ–åˆ†æ**ï¼šæä¾›è¯¦ç»†çš„æˆæœ¬-æ—¶é—´-èµ„æºåˆ†æ

### 1.2 æ”¯æŒçš„ä¼˜åŒ–ç›®æ ‡

| ä¼˜åŒ–ç›®æ ‡ | è‹±æ–‡æ ‡è¯† | åº”ç”¨åœºæ™¯ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| **çœç”µæ–¹æ¡ˆ** | cost_minimization | ç”µè´¹é¢„ç®—ç´§å¼ ï¼Œå¯æ¥å—è¾ƒé•¿æ—¶é—´ | æˆæœ¬ä¼˜å…ˆ |
| **çœæ—¶æ–¹æ¡ˆ** | time_minimization | éœ€è¦å¿«é€Ÿå®ŒæˆçŒæº‰ï¼Œæˆæœ¬å¯æ¥å— | æ—¶é—´ä¼˜å…ˆ |
| **å‡è¡¡æ–¹æ¡ˆ** | balanced | æˆæœ¬å’Œæ—¶é—´å…¼é¡¾ï¼Œå¯»æ±‚æœ€ä½³å¹³è¡¡ | å‡è¡¡è€ƒè™‘ |
| **é¿å³°æ–¹æ¡ˆ** | off_peak | é¿å¼€ç”¨ç”µé«˜å³°ï¼Œé™ä½ç”µè´¹ | ç”µä»·ä¼˜åŒ– |
| **èŠ‚æ°´æ–¹æ¡ˆ** | water_saving | æ°´èµ„æºç´§ç¼ºï¼Œéœ€è¦èŠ‚çº¦ç”¨æ°´ | èµ„æºä¼˜å…ˆ |

---

## 2. ç®—æ³•åŸç†

### 2.1 ç®—æ³•æ¡†æ¶

```
è¾“å…¥ï¼šåŸºç¡€çŒæº‰è®¡åˆ’ + ä¼˜åŒ–ç›®æ ‡ + çº¦æŸæ¡ä»¶
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ–¹æ¡ˆç”Ÿæˆå¼•æ“                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æå–åŸºç¡€è®¡åˆ’ä¿¡æ¯                  â”‚
â”‚  2. æ ¹æ®ä¼˜åŒ–ç›®æ ‡è°ƒæ•´å‚æ•°              â”‚
â”‚     - æ—¶é—´è°ƒæ•´ï¼ˆå»¶é•¿/ç¼©çŸ­ï¼‰            â”‚
â”‚     - æ°´æ³µé€‰æ‹©ï¼ˆå•æ³µ/å¤šæ³µï¼‰            â”‚
â”‚     - æ—¶æ®µå®‰æ’ï¼ˆé«˜å³°/ä½è°·ï¼‰            â”‚
â”‚  3. é‡æ–°è®¡ç®—æˆæœ¬å’Œæ—¶é•¿                â”‚
â”‚  4. ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
å¤šä¸ªä¼˜åŒ–æ–¹æ¡ˆ
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ–¹æ¡ˆå¯¹æ¯”åˆ†æå¼•æ“                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æˆæœ¬å¯¹æ¯”                          â”‚
â”‚  2. æ—¶é•¿å¯¹æ¯”                          â”‚
â”‚  3. æ°´æ³µè¿è¡Œæ—¶é•¿å¯¹æ¯”                  â”‚
â”‚  4. ç»¼åˆè¯„åˆ†                          â”‚
â”‚  5. æ¨èæœ€ä¼˜æ–¹æ¡ˆ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
è¾“å‡ºï¼šæ¨èæ–¹æ¡ˆ + å¯¹æ¯”æŠ¥å‘Š
```

### 2.2 æ ¸å¿ƒæ•°æ®ç»“æ„

```python
# ä¼˜åŒ–è¯·æ±‚
{
    "base_plan": {
        "scenarios": [...],
        "batches": [...],
        "steps": [...]
    },
    "optimization_goals": [
        "cost_minimization",
        "time_minimization",
        "balanced"
    ],
    "constraints": {
        "max_total_hours": 24,          # æœ€å¤§æ€»æ—¶é•¿
        "available_pumps": ["P1", "P2"], # å¯ç”¨æ°´æ³µ
        "electricity_price_schedule": {  # ç”µä»·æ—¶åˆ»è¡¨
            "peak": {"hours": [8-22], "price": 1.0},
            "valley": {"hours": [22-8], "price": 0.4}
        }
    }
}

# ä¼˜åŒ–æ–¹æ¡ˆ
{
    "optimization_goal": "cost_minimization",
    "name": "çœç”µæ–¹æ¡ˆ",
    "description": "é€šè¿‡å»¶é•¿ä½œä¸šæ—¶é—´å¹¶å®‰æ’åœ¨ç”µä»·ä½è°·æœŸï¼Œé™ä½æ€»ç”µè´¹",
    "total_eta_h": 28.5,                # æ€»æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
    "total_electricity_cost": 342.0,    # æ€»ç”µè´¹ï¼ˆå…ƒï¼‰
    "total_pump_runtime_hours": {       # å„æ°´æ³µè¿è¡Œæ—¶é•¿
        "P1": 15.0,
        "P2": 13.5
    },
    "pumps_used": ["P1"],               # ä½¿ç”¨çš„æ°´æ³µ
    "plan": { ... }                     # è¯¦ç»†æ‰§è¡Œè®¡åˆ’
}

# æ–¹æ¡ˆå¯¹æ¯”
{
    "best_cost_scenario": "çœç”µæ–¹æ¡ˆ",
    "best_time_scenario": "çœæ—¶æ–¹æ¡ˆ",
    "recommended_scenario": "å‡è¡¡æ–¹æ¡ˆ",
    "comparison_table": [
        {
            "scenario": "çœç”µæ–¹æ¡ˆ",
            "cost": 342.0,
            "time_h": 28.5,
            "cost_saving_percent": 25.3,
            "time_overhead_percent": 18.8
        },
        ...
    ]
}
```

---

## 3. ä¼˜åŒ–ç®—æ³•è¯¦è§£

### 3.1 çœç”µæ–¹æ¡ˆ (Cost Minimization)

#### 3.1.1 ä¼˜åŒ–ç­–ç•¥

**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡å»¶é•¿æ‰§è¡Œæ—¶é—´å’Œé€‰æ‹©ä½ç”µä»·æ—¶æ®µï¼Œæœ€å¤§åŒ–é™ä½ç”µè´¹æˆæœ¬ã€‚

**ä¼˜åŒ–æ‰‹æ®µ**ï¼š
1. â° **æ—¶é—´å»¶é•¿**ï¼šå°†æ‰¹æ¬¡æ—¶é—´å»¶é•¿20%ï¼ˆå¯é…ç½®ï¼‰
2. ğŸŒ™ **ä½è°·æ—¶æ®µ**ï¼šå®‰æ’åœ¨ç”µä»·ä½è°·æœŸæ‰§è¡Œï¼ˆå¦‚22:00-8:00ï¼‰
3. ğŸ’¡ **ä½åŠŸç‡æ³µ**ï¼šä¼˜å…ˆä½¿ç”¨ä½åŠŸç‡æ°´æ³µ
4. ğŸ”‹ **å¹³æ»‘è´Ÿè½½**ï¼šé¿å…å¤šæ³µåŒæ—¶è¿è¡Œ

#### 3.1.2 ç®—æ³•å®ç°

```python
def optimize_for_cost(base_scenario, constraints):
    """
    æˆæœ¬æœ€å°åŒ–ä¼˜åŒ–
    
    æ­¥éª¤ï¼š
    1. å»¶é•¿æ‰¹æ¬¡æ—¶é—´ï¼ˆé™ä½åŠŸç‡éœ€æ±‚ï¼‰
    2. è°ƒæ•´åˆ°ç”µä»·ä½è°·æœŸ
    3. é€‰æ‹©ä½åŠŸç‡æ°´æ³µ
    4. é‡æ–°è®¡ç®—æˆæœ¬
    """
    scenario = copy.deepcopy(base_scenario)
    
    # è·å–ç”µä»·é…ç½®
    electricity_prices = constraints.get("electricity_price_schedule", {
        "peak": {"hours": [8-22], "price": 1.0},
        "valley": {"hours": [22-8], "price": 0.4}
    })
    
    valley_start = 22.0  # ä½è°·æœŸå¼€å§‹æ—¶é—´
    valley_price = electricity_prices["valley"]["price"]
    
    # å»¶é•¿æ‰¹æ¬¡æ—¶é—´
    TIME_EXTENSION_FACTOR = 1.2  # å»¶é•¿20%
    
    steps = scenario["plan"]["steps"]
    current_time = valley_start  # ä»ä½è°·æœŸå¼€å§‹
    
    for step in steps:
        original_duration = step["t_end_h"] - step["t_start_h"]
        extended_duration = original_duration * TIME_EXTENSION_FACTOR
        
        # è°ƒæ•´æ—¶é—´åˆ°ä½è°·æœŸ
        step["t_start_h"] = current_time
        step["t_end_h"] = current_time + extended_duration
        
        # æ›´æ–°æ‰€æœ‰å‘½ä»¤çš„æ—¶é—´
        for cmd in step.get("commands", []):
            cmd["t_start_h"] = current_time
            cmd["t_end_h"] = current_time + extended_duration
        
        current_time += extended_duration
    
    # é€‰æ‹©ä½åŠŸç‡æ°´æ³µï¼ˆå¦‚æœæœ‰é€‰æ‹©ï¼‰
    available_pumps = constraints.get("available_pumps", [])
    if available_pumps:
        scenario["pumps_used"] = [available_pumps[0]]  # å‡è®¾å·²æŒ‰åŠŸç‡æ’åº
    
    # é‡æ–°è®¡ç®—æˆæœ¬
    total_duration = sum(
        step["t_end_h"] - step["t_start_h"] 
        for step in steps
    )
    
    pump_info = scenario["plan"].get("calc", {}).get("pump", {})
    power_kw = pump_info.get("power_kw", 60.0)
    
    total_cost = total_duration * power_kw * valley_price
    
    scenario["total_eta_h"] = total_duration
    scenario["total_electricity_cost"] = total_cost
    scenario["description"] = (
        f"é€šè¿‡å»¶é•¿ä½œä¸šæ—¶é—´å¹¶å®‰æ’åœ¨ç”µä»·ä½è°·æœŸï¼ˆ{valley_start}:00åï¼‰ï¼Œ"
        f"é™ä½æ€»ç”µè´¹è‡³ Â¥{total_cost:.2f}"
    )
    
    return scenario
```

#### 3.1.3 æ•ˆæœç¤ºä¾‹

```
åŸºç¡€æ–¹æ¡ˆï¼š
- æ€»æ—¶é•¿ï¼š24å°æ—¶
- æ‰§è¡Œæ—¶æ®µï¼š8:00-32:00ï¼ˆè·¨å¤©ï¼‰
- ç”µä»·ï¼šå³°æ®µ1.0å…ƒ/åº¦ï¼Œè°·æ®µ0.4å…ƒ/åº¦
- æ°´æ³µåŠŸç‡ï¼š60kW
- æ€»ç”µè´¹ï¼š24 Ã— 60 Ã— 0.8 = Â¥1,152

çœç”µæ–¹æ¡ˆï¼š
- æ€»æ—¶é•¿ï¼š28.8å°æ—¶ï¼ˆå»¶é•¿20%ï¼‰
- æ‰§è¡Œæ—¶æ®µï¼š22:00-50:48ï¼ˆå…¨éƒ¨åœ¨è°·æ®µï¼‰
- ç”µä»·ï¼šå…¨éƒ¨ä½¿ç”¨è°·æ®µ0.4å…ƒ/åº¦
- æ°´æ³µåŠŸç‡ï¼š60kW
- æ€»ç”µè´¹ï¼š28.8 Ã— 60 Ã— 0.4 = Â¥691.2

èŠ‚çœï¼šÂ¥1,152 - Â¥691.2 = Â¥460.8ï¼ˆ40%ï¼‰
ä»£ä»·ï¼šæ—¶é—´å¢åŠ  4.8å°æ—¶ï¼ˆ20%ï¼‰
```

---

### 3.2 çœæ—¶æ–¹æ¡ˆ (Time Minimization)

#### 3.2.1 ä¼˜åŒ–ç­–ç•¥

**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡å¢åŠ èµ„æºæŠ•å…¥ï¼Œæœ€å¿«å®ŒæˆçŒæº‰ä»»åŠ¡ã€‚

**ä¼˜åŒ–æ‰‹æ®µ**ï¼š
1. âš¡ **æ—¶é—´ç¼©çŸ­**ï¼šå°†æ‰¹æ¬¡æ—¶é—´ç¼©çŸ­30%ï¼ˆå¯é…ç½®ï¼‰
2. ğŸš€ **å¤šæ³µå¹¶è¡Œ**ï¼šåŒæ—¶ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ°´æ³µ
3. ğŸ“ˆ **é«˜æµé‡**ï¼šæå‡æ°´æ³µåŠŸç‡å’Œæµé‡
4. ğŸ”„ **æ‰¹æ¬¡ä¼˜åŒ–**ï¼šå‡å°‘æ‰¹æ¬¡åˆ‡æ¢æ—¶é—´

#### 3.2.2 ç®—æ³•å®ç°

```python
def optimize_for_time(base_scenario, constraints):
    """
    æ—¶é—´æœ€å°åŒ–ä¼˜åŒ–
    
    æ­¥éª¤ï¼š
    1. ç¼©çŸ­æ‰¹æ¬¡æ—¶é—´ï¼ˆæé«˜åŠŸç‡ï¼‰
    2. ä½¿ç”¨å…¨éƒ¨æ°´æ³µå¹¶è¡Œ
    3. ç«‹å³å¼€å§‹æ‰§è¡Œ
    4. é‡æ–°è®¡ç®—æˆæœ¬
    """
    scenario = copy.deepcopy(base_scenario)
    
    TIME_REDUCTION_FACTOR = 0.7  # ç¼©çŸ­30%
    
    steps = scenario["plan"]["steps"]
    current_time = 0.0  # ç«‹å³å¼€å§‹
    
    for step in steps:
        original_duration = step["t_end_h"] - step["t_start_h"]
        shortened_duration = original_duration * TIME_REDUCTION_FACTOR
        
        step["t_start_h"] = current_time
        step["t_end_h"] = current_time + shortened_duration
        
        # æ›´æ–°æ‰€æœ‰å‘½ä»¤çš„æ—¶é—´
        for cmd in step.get("commands", []):
            cmd["t_start_h"] = current_time
            cmd["t_end_h"] = current_time + shortened_duration
        
        current_time += shortened_duration
    
    # ä½¿ç”¨å…¨éƒ¨æ°´æ³µå¹¶è¡Œ
    available_pumps = constraints.get("available_pumps", [])
    if available_pumps:
        scenario["pumps_used"] = available_pumps  # å…¨éƒ¨ä½¿ç”¨
    
    # é‡æ–°è®¡ç®—æˆæœ¬ï¼ˆåŠŸç‡å¢åŠ ï¼‰
    total_duration = sum(
        step["t_end_h"] - step["t_start_h"] 
        for step in steps
    )
    
    pump_info = scenario["plan"].get("calc", {}).get("pump", {})
    power_kw = pump_info.get("power_kw", 60.0)
    num_pumps = len(scenario["pumps_used"])
    
    # å¤šæ³µå¹¶è¡Œï¼Œæ€»åŠŸç‡ = å•æ³µåŠŸç‡ Ã— æ³µæ•°é‡
    total_cost = total_duration * power_kw * num_pumps * 0.8  # å‡è®¾å¹³å‡ç”µä»·
    
    scenario["total_eta_h"] = total_duration
    scenario["total_electricity_cost"] = total_cost
    scenario["description"] = (
        f"é€šè¿‡ç¼©çŸ­ä½œä¸šæ—¶é—´å¹¶ä½¿ç”¨{num_pumps}å°æ°´æ³µå¹¶è¡Œï¼Œ"
        f"æ€»æ—¶é•¿ç¼©çŸ­è‡³ {total_duration:.1f}å°æ—¶"
    )
    
    return scenario
```

#### 3.2.3 æ•ˆæœç¤ºä¾‹

```
åŸºç¡€æ–¹æ¡ˆï¼š
- æ€»æ—¶é•¿ï¼š24å°æ—¶
- ä½¿ç”¨æ°´æ³µï¼šP1ï¼ˆå•æ³µï¼‰
- æ°´æ³µåŠŸç‡ï¼š60kW
- æ€»ç”µè´¹ï¼šÂ¥1,152

çœæ—¶æ–¹æ¡ˆï¼š
- æ€»æ—¶é•¿ï¼š16.8å°æ—¶ï¼ˆç¼©çŸ­30%ï¼‰
- ä½¿ç”¨æ°´æ³µï¼šP1 + P2ï¼ˆåŒæ³µå¹¶è¡Œï¼‰
- æ€»åŠŸç‡ï¼š120kW
- æ€»ç”µè´¹ï¼š16.8 Ã— 120 Ã— 0.8 = Â¥1,612.8

èŠ‚çœæ—¶é—´ï¼š24 - 16.8 = 7.2å°æ—¶ï¼ˆ30%ï¼‰
ä»£ä»·ï¼šç”µè´¹å¢åŠ  Â¥460.8ï¼ˆ40%ï¼‰
```

---

### 3.3 å‡è¡¡æ–¹æ¡ˆ (Balanced)

#### 3.3.1 ä¼˜åŒ–ç­–ç•¥

**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨æˆæœ¬å’Œæ—¶é—´ä¹‹é—´å¯»æ‰¾æœ€ä½³å¹³è¡¡ç‚¹ã€‚

**ä¼˜åŒ–æ‰‹æ®µ**ï¼š
1. âš–ï¸ **é€‚åº¦è°ƒæ•´**ï¼šæ—¶é—´å»¶é•¿10%ï¼ˆä»‹äºçœç”µå’Œçœæ—¶ä¹‹é—´ï¼‰
2. ğŸ¯ **æ™ºèƒ½åˆ†æ®µ**ï¼šéƒ¨åˆ†æ—¶æ®µå•æ³µï¼Œéƒ¨åˆ†æ—¶æ®µåŒæ³µ
3. â° **æ—¶æ®µä¼˜åŒ–**ï¼šé¿å¼€å³°æ®µé«˜å³°ï¼Œåˆ©ç”¨å¹³æ®µ
4. ğŸ“Š **ç»¼åˆè¯„åˆ†**ï¼šæœ€å¤§åŒ–æ€§ä»·æ¯”

#### 3.3.2 ç®—æ³•å®ç°

```python
def optimize_balanced(base_scenario, constraints):
    """
    å‡è¡¡ä¼˜åŒ–
    
    æ­¥éª¤ï¼š
    1. é€‚åº¦å»¶é•¿æ—¶é—´ï¼ˆ10%ï¼‰
    2. éƒ¨åˆ†å®‰æ’åœ¨ä½è°·æœŸ
    3. æ··åˆä½¿ç”¨å•æ³µå’ŒåŒæ³µ
    4. è¿½æ±‚æˆæœ¬-æ—¶é—´ç»¼åˆæœ€ä¼˜
    """
    scenario = copy.deepcopy(base_scenario)
    
    BALANCED_TIME_FACTOR = 1.1  # é€‚åº¦å»¶é•¿10%
    
    steps = scenario["plan"]["steps"]
    
    # è®¡ç®—ä½è°·æœŸå’Œå¹³æ®µçš„åˆ†é…æ¯”ä¾‹
    valley_ratio = 0.6  # 60%å®‰æ’åœ¨ä½è°·æœŸ
    peak_ratio = 0.4    # 40%å®‰æ’åœ¨å¹³æ®µ
    
    valley_start = 22.0
    peak_start = 6.0
    
    current_time_valley = valley_start
    current_time_peak = peak_start
    
    total_steps = len(steps)
    valley_steps = int(total_steps * valley_ratio)
    
    for i, step in enumerate(steps):
        original_duration = step["t_end_h"] - step["t_start_h"]
        adjusted_duration = original_duration * BALANCED_TIME_FACTOR
        
        # å‰60%æ‰¹æ¬¡å®‰æ’åœ¨ä½è°·æœŸ
        if i < valley_steps:
            step["t_start_h"] = current_time_valley
            step["t_end_h"] = current_time_valley + adjusted_duration
            current_time_valley += adjusted_duration
        else:
            step["t_start_h"] = current_time_peak
            step["t_end_h"] = current_time_peak + adjusted_duration
            current_time_peak += adjusted_duration
        
        # æ›´æ–°å‘½ä»¤æ—¶é—´
        for cmd in step.get("commands", []):
            cmd["t_start_h"] = step["t_start_h"]
            cmd["t_end_h"] = step["t_end_h"]
    
    # æ··åˆä½¿ç”¨æ°´æ³µ
    available_pumps = constraints.get("available_pumps", [])
    if available_pumps and len(available_pumps) > 1:
        # äº¤æ›¿ä½¿ç”¨å•æ³µå’ŒåŒæ³µ
        scenario["pumps_used"] = available_pumps[:2]
    
    # é‡æ–°è®¡ç®—æˆæœ¬ï¼ˆåŠ æƒå¹³å‡ç”µä»·ï¼‰
    total_duration = sum(
        step["t_end_h"] - step["t_start_h"] 
        for step in steps
    )
    
    pump_info = scenario["plan"].get("calc", {}).get("pump", {})
    power_kw = pump_info.get("power_kw", 60.0)
    
    # åŠ æƒç”µä»·
    weighted_price = valley_ratio * 0.4 + peak_ratio * 0.8
    total_cost = total_duration * power_kw * weighted_price
    
    scenario["total_eta_h"] = total_duration
    scenario["total_electricity_cost"] = total_cost
    scenario["description"] = (
        f"å‡è¡¡æˆæœ¬å’Œæ—¶é—´ï¼Œæ€»æ—¶é•¿ {total_duration:.1f}å°æ—¶ï¼Œ"
        f"æ€»ç”µè´¹ Â¥{total_cost:.2f}"
    )
    
    return scenario
```

#### 3.3.3 æ•ˆæœç¤ºä¾‹

```
åŸºç¡€æ–¹æ¡ˆï¼š
- æ€»æ—¶é•¿ï¼š24å°æ—¶
- æ€»ç”µè´¹ï¼šÂ¥1,152

å‡è¡¡æ–¹æ¡ˆï¼š
- æ€»æ—¶é•¿ï¼š26.4å°æ—¶ï¼ˆå»¶é•¿10%ï¼‰
- ä½è°·æœŸå æ¯”ï¼š60%
- å¹³æ®µå æ¯”ï¼š40%
- åŠ æƒç”µä»·ï¼š0.4 Ã— 0.6 + 0.8 Ã— 0.4 = 0.56å…ƒ/åº¦
- æ€»ç”µè´¹ï¼š26.4 Ã— 60 Ã— 0.56 = Â¥887.04

ä¸çœç”µæ–¹æ¡ˆå¯¹æ¯”ï¼š
  æ—¶é—´ï¼š26.4h vs 28.8hï¼ˆå¿«2.4å°æ—¶ï¼‰
  æˆæœ¬ï¼šÂ¥887 vs Â¥691ï¼ˆå¤šÂ¥196ï¼‰

ä¸çœæ—¶æ–¹æ¡ˆå¯¹æ¯”ï¼š
  æ—¶é—´ï¼š26.4h vs 16.8hï¼ˆæ…¢9.6å°æ—¶ï¼‰
  æˆæœ¬ï¼šÂ¥887 vs Â¥1,613ï¼ˆçœÂ¥726ï¼‰

ç»“è®ºï¼šç»¼åˆæ€§ä»·æ¯”æœ€é«˜
```

---

### 3.4 é¿å³°æ–¹æ¡ˆ (Off-Peak)

#### 3.4.1 ä¼˜åŒ–ç­–ç•¥

**æ ¸å¿ƒæ€æƒ³**ï¼šå®Œå…¨é¿å¼€ç”¨ç”µé«˜å³°æœŸï¼Œåˆ©ç”¨ä½è°·æ—¶æ®µæ‰§è¡Œã€‚

**ä¼˜åŒ–æ‰‹æ®µ**ï¼š
1. ğŸŒ™ **ä¸¥æ ¼é¿å³°**ï¼šæ‰€æœ‰æ‰¹æ¬¡å®‰æ’åœ¨ä½è°·æœŸï¼ˆ22:00-8:00ï¼‰
2. â±ï¸ **æ—¶æ®µæ‹†åˆ†**ï¼šå¦‚æœä¸€ä¸ªä½è°·æœŸä¸å¤Ÿï¼Œåˆ†å¤šä¸ªä½è°·æœŸ
3. ğŸ’¤ **å…è®¸ç­‰å¾…**ï¼šæ‰¹æ¬¡ä¹‹é—´å¯èƒ½æœ‰ç©ºæ¡£æ—¶é—´
4. ğŸ“‰ **æœ€ä½ç”µä»·**ï¼šå…¨ç¨‹ä½¿ç”¨æœ€ä½ç”µä»·

#### 3.4.2 ç®—æ³•å®ç°

```python
def optimize_off_peak(base_scenario, constraints):
    """
    é¿å³°ä¼˜åŒ–
    
    æ­¥éª¤ï¼š
    1. è¯†åˆ«ä½è°·æ—¶æ®µ
    2. å°†æ‰€æœ‰æ‰¹æ¬¡å®‰æ’åœ¨ä½è°·æœŸ
    3. å¦‚æœä¸€ä¸ªä½è°·æœŸä¸å¤Ÿï¼Œåˆ†é…åˆ°å¤šä¸ªä½è°·æœŸ
    4. å…è®¸æ‰¹æ¬¡é—´æœ‰ç­‰å¾…æ—¶é—´
    """
    scenario = copy.deepcopy(base_scenario)
    
    # å®šä¹‰ä½è°·æ—¶æ®µï¼ˆå¯ä»¥è·¨å¤©ï¼‰
    valley_periods = [
        (22.0, 24.0),  # æ™šä¸Š22:00-24:00
        (0.0, 8.0)     # å‡Œæ™¨0:00-8:00
    ]
    
    steps = scenario["plan"]["steps"]
    
    # è®¡ç®—æ¯ä¸ªä½è°·æœŸçš„å¯ç”¨æ—¶é•¿
    valley_capacities = [
        (end - start) for start, end in valley_periods
    ]
    
    current_valley_idx = 0
    current_time = valley_periods[0][0]  # ä»ç¬¬ä¸€ä¸ªä½è°·æœŸå¼€å§‹
    
    for step in steps:
        original_duration = step["t_end_h"] - step["t_start_h"]
        
        # æ£€æŸ¥å½“å‰ä½è°·æœŸæ˜¯å¦è¿˜æœ‰ç©ºé—´
        valley_start, valley_end = valley_periods[current_valley_idx]
        remaining_capacity = valley_end - current_time
        
        if remaining_capacity < original_duration:
            # å½“å‰ä½è°·æœŸä¸å¤Ÿï¼Œè·³åˆ°ä¸‹ä¸€ä¸ªä½è°·æœŸ
            current_valley_idx = (current_valley_idx + 1) % len(valley_periods)
            valley_start, valley_end = valley_periods[current_valley_idx]
            current_time = valley_start
        
        step["t_start_h"] = current_time
        step["t_end_h"] = current_time + original_duration
        
        # æ›´æ–°å‘½ä»¤æ—¶é—´
        for cmd in step.get("commands", []):
            cmd["t_start_h"] = current_time
            cmd["t_end_h"] = current_time + original_duration
        
        current_time += original_duration
    
    # ä½¿ç”¨ä½è°·ç”µä»·è®¡ç®—æˆæœ¬
    valley_price = constraints.get("electricity_price_schedule", {}).get(
        "valley", {}
    ).get("price", 0.4)
    
    total_duration = sum(
        step["t_end_h"] - step["t_start_h"] 
        for step in steps
    )
    
    pump_info = scenario["plan"].get("calc", {}).get("pump", {})
    power_kw = pump_info.get("power_kw", 60.0)
    
    total_cost = total_duration * power_kw * valley_price
    
    scenario["total_eta_h"] = total_duration
    scenario["total_electricity_cost"] = total_cost
    scenario["description"] = (
        f"å®Œå…¨é¿å¼€ç”¨ç”µé«˜å³°ï¼Œå…¨éƒ¨å®‰æ’åœ¨ä½è°·æœŸæ‰§è¡Œï¼Œ"
        f"æ€»ç”µè´¹ Â¥{total_cost:.2f}ï¼ˆä½è°·ç”µä»· {valley_price}å…ƒ/åº¦ï¼‰"
    )
    
    return scenario
```

#### 3.4.3 æ•ˆæœç¤ºä¾‹

```
ç”µä»·æ—¶åˆ»è¡¨ï¼š
- å³°æ®µï¼ˆ8:00-22:00ï¼‰ï¼š1.0å…ƒ/åº¦
- è°·æ®µï¼ˆ22:00-8:00ï¼‰ï¼š0.4å…ƒ/åº¦

åŸºç¡€æ–¹æ¡ˆï¼ˆæ··åˆæ—¶æ®µï¼‰ï¼š
- å³°æ®µæ‰§è¡Œï¼š12å°æ—¶ Ã— 60kW Ã— 1.0 = Â¥720
- è°·æ®µæ‰§è¡Œï¼š12å°æ—¶ Ã— 60kW Ã— 0.4 = Â¥288
- æ€»ç”µè´¹ï¼šÂ¥1,008

é¿å³°æ–¹æ¡ˆï¼ˆå…¨éƒ¨è°·æ®µï¼‰ï¼š
- ç¬¬1å¤©è°·æ®µï¼š22:00-8:00ï¼Œ10å°æ—¶
- ç¬¬2å¤©è°·æ®µï¼š22:00-8:00ï¼Œ10å°æ—¶
- ç¬¬3å¤©è°·æ®µï¼š22:00-26:00ï¼Œ4å°æ—¶
- æ€»æ—¶é•¿ï¼š24å°æ—¶ï¼ˆåˆ†3å¤©æ‰§è¡Œï¼‰
- æ€»ç”µè´¹ï¼š24 Ã— 60 Ã— 0.4 = Â¥576

èŠ‚çœï¼šÂ¥1,008 - Â¥576 = Â¥432ï¼ˆ43%ï¼‰
ä»£ä»·ï¼šéœ€è¦è·¨å¤šå¤©æ‰§è¡Œï¼Œæœ‰ç­‰å¾…æ—¶é—´
```

---

### 3.5 èŠ‚æ°´æ–¹æ¡ˆ (Water Saving)

#### 3.5.1 ä¼˜åŒ–ç­–ç•¥

**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡ç²¾ç»†åŒ–æ§åˆ¶å’Œåˆ†æ®µçŒæº‰ï¼Œæœ€å¤§é™åº¦èŠ‚çº¦æ°´èµ„æºã€‚

**ä¼˜åŒ–æ‰‹æ®µ**ï¼š
1. ğŸ’§ **ç²¾å‡†çŒæº‰**ï¼šä¸¥æ ¼æŒ‰ç…§ç¼ºæ°´é‡è®¡ç®—ï¼Œä¸è¿‡é‡
2. ğŸ¯ **åˆ†æ®µçŒæº‰**ï¼šå°æ‰¹æ¬¡å¤šé¢‘æ¬¡ï¼Œå‡å°‘æ·±å±‚æ¸—æ¼
3. â° **å¤œé—´çŒæº‰**ï¼šå‡å°‘è’¸å‘æŸå¤±
4. ğŸ“‰ **ä½æµé‡**ï¼šä½¿ç”¨ä½æµé‡ç¼“æ…¢çŒæº‰ï¼Œæé«˜å¸æ”¶ç‡

#### 3.5.2 ç®—æ³•å®ç°

```python
def optimize_water_saving(base_scenario, constraints):
    """
    èŠ‚æ°´ä¼˜åŒ–
    
    æ­¥éª¤ï¼š
    1. å»¶é•¿æ‰¹æ¬¡æ—¶é—´ï¼Œé™ä½æµé‡ï¼ˆå‡å°‘å¾„æµï¼‰
    2. å¢åŠ æ‰¹æ¬¡æ•°é‡ï¼ˆå°æ‰¹æ¬¡å¤šé¢‘æ¬¡ï¼‰
    3. å®‰æ’åœ¨å¤œé—´æ‰§è¡Œï¼ˆå‡å°‘è’¸å‘ï¼‰
    4. ç²¾ç¡®è®¡ç®—æ°´é‡ï¼Œé¿å…è¿‡é‡
    """
    scenario = copy.deepcopy(base_scenario)
    
    WATER_SAVING_TIME_FACTOR = 1.2  # å»¶é•¿20%ï¼Œé™ä½æµé‡
    
    steps = scenario["plan"]["steps"]
    
    # å°†æ‰¹æ¬¡æ‹†åˆ†ä¸ºæ›´å°çš„å•å…ƒ
    new_steps = []
    for step in steps:
        original_duration = step["t_end_h"] - step["t_start_h"]
        extended_duration = original_duration * WATER_SAVING_TIME_FACTOR
        
        # æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‹†åˆ†
        fields = step.get("sequence", {}).get("fields", [])
        if len(fields) > 5:
            # æ‹†åˆ†ä¸ºä¸¤ä¸ªå°æ‰¹æ¬¡
            mid_point = len(fields) // 2
            
            # ç¬¬ä¸€ä¸ªå­æ‰¹æ¬¡
            step1 = copy.deepcopy(step)
            step1["sequence"]["fields"] = fields[:mid_point]
            step1["label"] = step["label"] + "-A"
            new_steps.append(step1)
            
            # ç¬¬äºŒä¸ªå­æ‰¹æ¬¡
            step2 = copy.deepcopy(step)
            step2["sequence"]["fields"] = fields[mid_point:]
            step2["label"] = step["label"] + "-B"
            new_steps.append(step2)
        else:
            new_steps.append(step)
    
    # é‡æ–°å®‰æ’æ—¶é—´ï¼ˆå¤œé—´ä¼˜å…ˆï¼‰
    night_start = 20.0  # æ™šä¸Š8ç‚¹å¼€å§‹
    current_time = night_start
    
    for step in new_steps:
        original_duration = step.get("t_end_h", 0) - step.get("t_start_h", 0)
        extended_duration = original_duration * WATER_SAVING_TIME_FACTOR
        
        step["t_start_h"] = current_time
        step["t_end_h"] = current_time + extended_duration
        
        for cmd in step.get("commands", []):
            cmd["t_start_h"] = current_time
            cmd["t_end_h"] = current_time + extended_duration
        
        current_time += extended_duration
    
    scenario["plan"]["steps"] = new_steps
    
    # é‡æ–°è®¡ç®—
    total_duration = sum(
        step["t_end_h"] - step["t_start_h"] 
        for step in new_steps
    )
    
    pump_info = scenario["plan"].get("calc", {}).get("pump", {})
    power_kw = pump_info.get("power_kw", 60.0)
    
    # å¤œé—´ç”µä»·
    night_price = 0.6
    total_cost = total_duration * power_kw * night_price
    
    scenario["total_eta_h"] = total_duration
    scenario["total_electricity_cost"] = total_cost
    scenario["description"] = (
        f"é€šè¿‡å»¶é•¿æ—¶é—´ã€é™ä½æµé‡å’Œå¢åŠ æ‰¹æ¬¡æ•°é‡ï¼Œ"
        f"å‡å°‘æ°´èµ„æºæµªè´¹ï¼Œæ‰¹æ¬¡æ•°ä» {len(steps)} å¢åŠ åˆ° {len(new_steps)}"
    )
    
    return scenario
```

#### 3.5.3 æ•ˆæœç¤ºä¾‹

```
åŸºç¡€æ–¹æ¡ˆï¼š
- æ‰¹æ¬¡æ•°ï¼š4ä¸ª
- æµé‡ï¼š300 mÂ³/hï¼ˆé«˜æµé‡ï¼‰
- æ€»ç”¨æ°´ï¼š10,000 mÂ³
- æœ‰æ•ˆåˆ©ç”¨ç‡ï¼š85%ï¼ˆ15%å¾„æµ/æ·±å±‚æ¸—æ¼ï¼‰

èŠ‚æ°´æ–¹æ¡ˆï¼š
- æ‰¹æ¬¡æ•°ï¼š8ä¸ªï¼ˆæ‹†åˆ†ï¼‰
- æµé‡ï¼š250 mÂ³/hï¼ˆä½æµé‡ï¼‰
- æ‰§è¡Œæ—¶é—´ï¼šå¤œé—´ï¼ˆå‡å°‘è’¸å‘ï¼‰
- æ€»ç”¨æ°´ï¼š10,000 mÂ³
- æœ‰æ•ˆåˆ©ç”¨ç‡ï¼š92%ï¼ˆ8%æŸå¤±ï¼‰

èŠ‚æ°´æ•ˆæœï¼š
- æŸå¤±å‡å°‘ï¼š15% - 8% = 7%
- èŠ‚çº¦æ°´é‡ï¼š10,000 Ã— 7% = 700 mÂ³
- ä»£ä»·ï¼šæ—¶é—´å¢åŠ 20%
```

---

## 4. æ–¹æ¡ˆå¯¹æ¯”ä¸æ¨è

### 4.1 å¯¹æ¯”ç»´åº¦

```python
def generate_comparison(scenarios: List[Dict]) -> Dict:
    """
    ç”Ÿæˆæ–¹æ¡ˆå¯¹æ¯”åˆ†æ
    
    å¯¹æ¯”ç»´åº¦ï¼š
    1. æ€»ç”µè´¹ï¼ˆå…ƒï¼‰
    2. æ€»æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
    3. æ°´æ³µè¿è¡Œæ—¶é•¿ï¼ˆå°æ—¶ï¼‰
    4. æˆæœ¬èŠ‚çœç™¾åˆ†æ¯”
    5. æ—¶é—´ç¼©çŸ­ç™¾åˆ†æ¯”
    6. ç»¼åˆè¯„åˆ†
    """
    
    if not scenarios:
        return {}
    
    # æå–åŸºå‡†å€¼ï¼ˆåŸºç¡€æ–¹æ¡ˆæˆ–å¹³å‡å€¼ï¼‰
    base_cost = scenarios[0]["total_electricity_cost"]
    base_time = scenarios[0]["total_eta_h"]
    
    comparison_table = []
    
    for scenario in scenarios:
        cost = scenario["total_electricity_cost"]
        time_h = scenario["total_eta_h"]
        
        # è®¡ç®—èŠ‚çœç™¾åˆ†æ¯”
        cost_saving = ((base_cost - cost) / base_cost) * 100
        time_saving = ((base_time - time_h) / base_time) * 100
        
        # ç»¼åˆè¯„åˆ†ï¼ˆå¯è‡ªå®šä¹‰æƒé‡ï¼‰
        cost_weight = 0.6
        time_weight = 0.4
        score = (cost_saving * cost_weight + time_saving * time_weight)
        
        comparison_table.append({
            "scenario": scenario["name"],
            "cost": cost,
            "time_h": time_h,
            "cost_saving_percent": cost_saving,
            "time_saving_percent": time_saving,
            "ç»¼åˆè¯„åˆ†": score
        })
    
    # æ‰¾å‡ºæœ€ä½³æ–¹æ¡ˆ
    best_cost = min(comparison_table, key=lambda x: x["cost"])
    best_time = min(comparison_table, key=lambda x: x["time_h"])
    best_overall = max(comparison_table, key=lambda x: x["ç»¼åˆè¯„åˆ†"])
    
    return {
        "comparison_table": comparison_table,
        "best_cost_scenario": best_cost["scenario"],
        "best_time_scenario": best_time["scenario"],
        "recommended_scenario": best_overall["scenario"],
        "recommendation_reason": (
            f"{best_overall['scenario']} ç»¼åˆè¯„åˆ†æœ€é«˜ï¼ˆ{best_overall['ç»¼åˆè¯„åˆ†']:.1f}åˆ†ï¼‰ï¼Œ"
            f"åœ¨æˆæœ¬å’Œæ—¶é—´ä¹‹é—´å–å¾—æœ€ä½³å¹³è¡¡"
        )
    }
```

### 4.2 æ¨èé€»è¾‘

```python
def recommend_best_scenario(scenarios: List[Dict], 
                           user_preferences: Dict) -> Dict:
    """
    åŸºäºç”¨æˆ·åå¥½æ¨èæœ€ä½³æ–¹æ¡ˆ
    
    ç”¨æˆ·åå¥½å‚æ•°ï¼š
    - cost_priority: æˆæœ¬ä¼˜å…ˆçº§ (0-1)
    - time_priority: æ—¶é—´ä¼˜å…ˆçº§ (0-1)
    - water_priority: èŠ‚æ°´ä¼˜å…ˆçº§ (0-1)
    - max_acceptable_cost: æœ€å¤§å¯æ¥å—æˆæœ¬
    - max_acceptable_time: æœ€å¤§å¯æ¥å—æ—¶é—´
    """
    
    cost_priority = user_preferences.get("cost_priority", 0.5)
    time_priority = user_preferences.get("time_priority", 0.5)
    water_priority = user_preferences.get("water_priority", 0.0)
    
    max_cost = user_preferences.get("max_acceptable_cost", float('inf'))
    max_time = user_preferences.get("max_acceptable_time", float('inf'))
    
    # è¿‡æ»¤ä¸æ»¡è¶³ç¡¬çº¦æŸçš„æ–¹æ¡ˆ
    eligible_scenarios = [
        s for s in scenarios
        if s["total_electricity_cost"] <= max_cost and
           s["total_eta_h"] <= max_time
    ]
    
    if not eligible_scenarios:
        return {"error": "æ²¡æœ‰æ–¹æ¡ˆæ»¡è¶³çº¦æŸæ¡ä»¶"}
    
    # å½’ä¸€åŒ–è¯„åˆ†
    costs = [s["total_electricity_cost"] for s in eligible_scenarios]
    times = [s["total_eta_h"] for s in eligible_scenarios]
    
    min_cost, max_cost = min(costs), max(costs)
    min_time, max_time = min(times), max(times)
    
    # è®¡ç®—ç»¼åˆå¾—åˆ†
    for scenario in eligible_scenarios:
        cost = scenario["total_electricity_cost"]
        time_h = scenario["total_eta_h"]
        
        # å½’ä¸€åŒ–ï¼ˆè¶Šå°è¶Šå¥½ï¼‰
        cost_score = 1 - (cost - min_cost) / (max_cost - min_cost + 0.001)
        time_score = 1 - (time_h - min_time) / (max_time - min_time + 0.001)
        
        # åŠ æƒè¯„åˆ†
        total_weight = cost_priority + time_priority + water_priority
        scenario["weighted_score"] = (
            (cost_score * cost_priority +
             time_score * time_priority) / total_weight
        )
    
    # é€‰æ‹©å¾—åˆ†æœ€é«˜çš„æ–¹æ¡ˆ
    best_scenario = max(eligible_scenarios, key=lambda s: s["weighted_score"])
    
    return {
        "recommended": best_scenario["name"],
        "score": best_scenario["weighted_score"],
        "reason": f"åŸºäºæ‚¨çš„åå¥½ï¼ˆæˆæœ¬æƒé‡{cost_priority}ï¼Œæ—¶é—´æƒé‡{time_priority}ï¼‰ï¼Œè¯¥æ–¹æ¡ˆç»¼åˆè¯„åˆ†æœ€é«˜"
    }
```

### 4.3 å¯¹æ¯”æŠ¥å‘Šç¤ºä¾‹

```json
{
  "comparison": {
    "comparison_table": [
      {
        "scenario": "çœç”µæ–¹æ¡ˆ",
        "cost": 691.2,
        "time_h": 28.8,
        "cost_saving_percent": 40.0,
        "time_saving_percent": -20.0,
        "ç»¼åˆè¯„åˆ†": 16.0
      },
      {
        "scenario": "çœæ—¶æ–¹æ¡ˆ",
        "cost": 1612.8,
        "time_h": 16.8,
        "cost_saving_percent": -40.0,
        "time_saving_percent": 30.0,
        "ç»¼åˆè¯„åˆ†": -12.0
      },
      {
        "scenario": "å‡è¡¡æ–¹æ¡ˆ",
        "cost": 887.0,
        "time_h": 26.4,
        "cost_saving_percent": 23.0,
        "time_saving_percent": -10.0,
        "ç»¼åˆè¯„åˆ†": 9.8
      },
      {
        "scenario": "é¿å³°æ–¹æ¡ˆ",
        "cost": 576.0,
        "time_h": 24.0,
        "cost_saving_percent": 50.0,
        "time_saving_percent": 0.0,
        "ç»¼åˆè¯„åˆ†": 30.0
      },
      {
        "scenario": "èŠ‚æ°´æ–¹æ¡ˆ",
        "cost": 864.0,
        "time_h": 28.8,
        "cost_saving_percent": 25.0,
        "time_saving_percent": -20.0,
        "ç»¼åˆè¯„åˆ†": 7.0
      }
    ],
    "best_cost_scenario": "é¿å³°æ–¹æ¡ˆ",
    "best_time_scenario": "çœæ—¶æ–¹æ¡ˆ",
    "recommended_scenario": "é¿å³°æ–¹æ¡ˆ",
    "recommendation_reason": "é¿å³°æ–¹æ¡ˆ ç»¼åˆè¯„åˆ†æœ€é«˜ï¼ˆ30.0åˆ†ï¼‰ï¼Œç”µè´¹èŠ‚çœ50%ä¸”æ—¶é—´ä¸å˜"
  }
}
```

---

## 5. ä½¿ç”¨æŒ‡å—

### 5.1 APIè°ƒç”¨ç¤ºä¾‹

```python
from intelligent_batch_optimizer import IntelligentBatchOptimizer

# åˆå§‹åŒ–ä¼˜åŒ–å™¨
optimizer = IntelligentBatchOptimizer()

# åŠ è½½åŸºç¡€è®¡åˆ’
base_plan = load_json("irrigation_plan_20250109.json")

# å®šä¹‰ä¼˜åŒ–ç›®æ ‡
optimization_goals = [
    "cost_minimization",
    "time_minimization",
    "balanced",
    "off_peak",
    "water_saving"
]

# å®šä¹‰çº¦æŸæ¡ä»¶
constraints = {
    "max_total_hours": 48,  # æœ€å¤š48å°æ—¶å®Œæˆ
    "available_pumps": ["P1", "P2"],
    "electricity_price_schedule": {
        "peak": {"hours": list(range(8, 22)), "price": 1.0},
        "valley": {"hours": list(range(22, 24)) + list(range(0, 8)), "price": 0.4}
    }
}

# ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆ
result = optimizer.generate_optimized_scenarios(
    base_plan=base_plan,
    optimization_goals=optimization_goals,
    constraints=constraints
)

# æŸ¥çœ‹ç»“æœ
print(f"å…±ç”Ÿæˆ {result['total_scenarios']} ä¸ªæ–¹æ¡ˆ")
print(f"æ¨èæ–¹æ¡ˆï¼š{result['comparison']['recommended_scenario']}")

# ä¿å­˜æ–¹æ¡ˆ
for scenario in result['scenarios']:
    filename = f"optimized_{scenario['name']}.json"
    save_json(filename, scenario)
```

### 5.2 æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©æ–¹æ¡ˆ

| ä¸šåŠ¡åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|---------|---------|------|
| **ç”µè´¹é¢„ç®—ç´§å¼ ** | çœç”µæ–¹æ¡ˆ / é¿å³°æ–¹æ¡ˆ | æœ€å¤§åŒ–é™ä½ç”µè´¹æˆæœ¬ |
| **ç´§æ€¥çŒæº‰ï¼ˆå¹²æ—±ï¼‰** | çœæ—¶æ–¹æ¡ˆ | æœ€å¿«å®ŒæˆçŒæº‰ï¼ŒæŒ½æ•‘ä½œç‰© |
| **æ­£å¸¸ä½œä¸š** | å‡è¡¡æ–¹æ¡ˆ | æ€§ä»·æ¯”æœ€é«˜ |
| **ç”¨ç”µå®¹é‡ä¸è¶³** | é¿å³°æ–¹æ¡ˆ | é¿å¼€ç”¨ç”µé«˜å³°ï¼Œé˜²æ­¢è·³é—¸ |
| **æ°´èµ„æºç´§ç¼º** | èŠ‚æ°´æ–¹æ¡ˆ | ç²¾ç»†åŒ–çŒæº‰ï¼Œå‡å°‘æµªè´¹ |

### 5.3 å‚æ•°è°ƒä¼˜å»ºè®®

```python
# è°ƒæ•´ä¼˜åŒ–å¼ºåº¦
OptimizationConfig.COST_TIME_EXTENSION_FACTOR = 1.3  # çœç”µæ–¹æ¡ˆå»¶é•¿30%ï¼ˆæ›´çœç”µï¼‰
OptimizationConfig.TIME_REDUCTION_FACTOR = 0.6       # çœæ—¶æ–¹æ¡ˆç¼©çŸ­40%ï¼ˆæ›´å¿«ï¼‰
OptimizationConfig.WATER_SAVING_EXTENSION_FACTOR = 1.5  # èŠ‚æ°´æ–¹æ¡ˆå»¶é•¿50%ï¼ˆæ›´èŠ‚æ°´ï¼‰

# è°ƒæ•´ç”µä»·é…ç½®
OptimizationConfig.DEFAULT_PEAK_PRICE = 1.2      # æé«˜å³°æ®µç”µä»·
OptimizationConfig.DEFAULT_VALLEY_PRICE = 0.3    # é™ä½è°·æ®µç”µä»·
OptimizationConfig.DEFAULT_VALLEY_START = 22.0   # è°ƒæ•´ä½è°·æœŸå¼€å§‹æ—¶é—´
```

---

## 6. ç®—æ³•è¯„ä¼°

### 6.1 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | è®¡ç®—æ–¹å¼ | ç›®æ ‡ |
|-----|---------|------|
| **æˆæœ¬ä¼˜åŒ–ç‡** | (åŸºå‡†æˆæœ¬ - ä¼˜åŒ–æˆæœ¬) / åŸºå‡†æˆæœ¬ | >20% |
| **æ—¶é—´ä¼˜åŒ–ç‡** | (åŸºå‡†æ—¶é—´ - ä¼˜åŒ–æ—¶é—´) / åŸºå‡†æ—¶é—´ | >15% |
| **æ–¹æ¡ˆç”Ÿæˆæ—¶é—´** | è®¡ç®—è€—æ—¶ | <5ç§’ |
| **ç¼“å­˜å‘½ä¸­ç‡** | ç¼“å­˜å‘½ä¸­æ¬¡æ•° / æ€»è¯·æ±‚æ¬¡æ•° | >70% |

### 6.2 å®é™…æ•ˆæœ

```
æµ‹è¯•åœºæ™¯ï¼š300äº©å†œåœºï¼Œ4ä¸ªæ‰¹æ¬¡

åŸºç¡€æ–¹æ¡ˆï¼š
- æ€»æ—¶é•¿ï¼š24å°æ—¶
- æ€»ç”µè´¹ï¼šÂ¥1,152
- ç”¨æ°´é‡ï¼š12,000 mÂ³

ä¼˜åŒ–æ•ˆæœç»Ÿè®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆ       â”‚ æ—¶é•¿(h)  â”‚ ç”µè´¹(å…ƒ) â”‚ èŠ‚æ°´(mÂ³) â”‚ ç»¼åˆè¯„åˆ† â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çœç”µæ–¹æ¡ˆ   â”‚ 28.8     â”‚ 691      â”‚ 0        â”‚ 16.0     â”‚
â”‚ çœæ—¶æ–¹æ¡ˆ   â”‚ 16.8     â”‚ 1,613    â”‚ 0        â”‚ -12.0    â”‚
â”‚ å‡è¡¡æ–¹æ¡ˆ   â”‚ 26.4     â”‚ 887      â”‚ 0        â”‚ 9.8      â”‚
â”‚ é¿å³°æ–¹æ¡ˆ   â”‚ 24.0     â”‚ 576      â”‚ 0        â”‚ 30.0     â”‚
â”‚ èŠ‚æ°´æ–¹æ¡ˆ   â”‚ 28.8     â”‚ 864      â”‚ 840      â”‚ 7.0      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¨èï¼šé¿å³°æ–¹æ¡ˆï¼ˆç”µè´¹èŠ‚çœ50%ï¼Œæ—¶é—´ä¸å˜ï¼‰
```

---

## 7. æ‰©å±•ä¸æœªæ¥ä¼˜åŒ–

### 7.1 æœºå™¨å­¦ä¹ å¢å¼º

```python
# æœªæ¥å¯é›†æˆæœºå™¨å­¦ä¹ æ¨¡å‹
class MLEnhancedOptimizer:
    """åŸºäºæœºå™¨å­¦ä¹ çš„ä¼˜åŒ–å™¨"""
    
    def predict_optimal_parameters(self, 
                                   historical_data: List[Dict],
                                   weather_forecast: Dict) -> Dict:
        """
        åŸºäºå†å²æ•°æ®å’Œå¤©æ°”é¢„æŠ¥ï¼Œé¢„æµ‹æœ€ä¼˜å‚æ•°
        
        è¾“å…¥ï¼š
        - å†å²çŒæº‰æ•°æ®
        - å¤©æ°”é¢„æŠ¥ï¼ˆæ¸©åº¦ã€é™é›¨æ¦‚ç‡ï¼‰
        
        è¾“å‡ºï¼š
        - æ¨èçš„æ—¶é—´è°ƒæ•´å› å­
        - æ¨èçš„æ°´æ³µç»„åˆ
        - é¢„æµ‹çš„ç”¨æ°´é‡
        """
        # TODO: è®­ç»ƒæ¨¡å‹
        pass
```

### 7.2 å¤šç›®æ ‡å¸•ç´¯æ‰˜ä¼˜åŒ–

```python
def pareto_optimization(scenarios: List[Dict]) -> List[Dict]:
    """
    å¸•ç´¯æ‰˜æœ€ä¼˜ç­›é€‰
    
    æ‰¾å‡ºæ‰€æœ‰å¸•ç´¯æ‰˜æœ€ä¼˜è§£ï¼ˆæ— æ³•åœ¨ä¸ç‰ºç‰²æŸä¸ªç›®æ ‡çš„æƒ…å†µä¸‹æ”¹å–„å…¶ä»–ç›®æ ‡ï¼‰
    """
    pareto_front = []
    
    for scenario in scenarios:
        is_dominated = False
        
        for other in scenarios:
            if other == scenario:
                continue
            
            # æ£€æŸ¥æ˜¯å¦è¢«æ”¯é…
            if (other["total_electricity_cost"] <= scenario["total_electricity_cost"] and
                other["total_eta_h"] <= scenario["total_eta_h"] and
                (other["total_electricity_cost"] < scenario["total_electricity_cost"] or
                 other["total_eta_h"] < scenario["total_eta_h"])):
                is_dominated = True
                break
        
        if not is_dominated:
            pareto_front.append(scenario)
    
    return pareto_front
```

---

## 8. å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–ç›®æ ‡ï¼Ÿ

**A**: æ ¹æ®ä¸šåŠ¡ä¼˜å…ˆçº§ï¼š
- æˆæœ¬æ•æ„Ÿ â†’ cost_minimization / off_peak
- æ—¶é—´ç´§æ€¥ â†’ time_minimization
- ä¸ç¡®å®š â†’ balancedï¼ˆæ¨èï¼‰
- æ°´èµ„æºç´§ç¼º â†’ water_saving

### Q2: ä¼˜åŒ–æ–¹æ¡ˆçš„å¯è¡Œæ€§å¦‚ä½•ä¿è¯ï¼Ÿ

**A**: ç®—æ³•ä¼šéªŒè¯ï¼š
1. æ°´æ³µæµé‡æ˜¯å¦è¶³å¤Ÿ
2. æ˜¯å¦æ»¡è¶³æ—¶é—´çª—å£çº¦æŸ
3. æ˜¯å¦è¶…å‡ºæœ€å¤§æ‰§è¡Œæ—¶é•¿
4. èŠ‚åˆ¶é—¸æ§åˆ¶æ˜¯å¦å†²çª

### Q3: å¯ä»¥åŒæ—¶ä¼˜åŒ–å¤šä¸ªç›®æ ‡å—ï¼Ÿ

**A**: å¯ä»¥ï¼è°ƒç”¨æ—¶ä¼ å…¥å¤šä¸ªç›®æ ‡ï¼š
```python
optimization_goals = ["cost_minimization", "time_minimization", "balanced"]
```
ç³»ç»Ÿä¼šä¸ºæ¯ä¸ªç›®æ ‡ç”Ÿæˆä¸€ä¸ªæ–¹æ¡ˆï¼Œç„¶åæä¾›å¯¹æ¯”ã€‚

### Q4: ä¼˜åŒ–åçš„æ–¹æ¡ˆå¯ä»¥å†è°ƒæ•´å—ï¼Ÿ

**A**: å¯ä»¥ï¼ä¼˜åŒ–æ–¹æ¡ˆå¯ä»¥ä½œä¸ºæ–°çš„åŸºç¡€æ–¹æ¡ˆï¼Œå†æ¬¡ä¼˜åŒ–æˆ–æ‰‹åŠ¨è°ƒæ•´ã€‚

---

## 9. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|-----|------|------|
| 1.0 | 2025-01 | åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒ5ç§ä¼˜åŒ–ç›®æ ‡ |

---

## 10. å‚è€ƒèµ„æ–™

- ä»£ç æ¨¡å—ï¼š`intelligent_batch_optimizer.py`
- ä¼˜åŒ–é…ç½®ï¼š`OptimizationConfig` ç±»
- APIæ–‡æ¡£ï¼š`å†œåœºçº§è°ƒåº¦ç®—æ³•APIæ¥å£æ–‡æ¡£ï¼ˆ11.7ï¼‰.md`
- ç›¸å…³ç®—æ³•ï¼š`åŒºåŸŸçŒæº‰é€»è¾‘ç®—æ³•æ–‡æ¡£.md`

---

**æ–‡æ¡£ç»“æŸ**

