# åŒºåŸŸçŒæº‰é€»è¾‘ç®—æ³•æŠ€æœ¯æ–‡æ¡£ v1.0

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: 1.0
- **æ—¥æœŸ**: 2025å¹´1æœˆ
- **é€‚ç”¨ç³»ç»Ÿ**: æ™ºèƒ½çŒæº‰è°ƒåº¦ç³»ç»Ÿ
- **æ ¸å¿ƒæ¨¡å—**: `farm_irr_full_device_modified.py`
- **ä½œè€…**: ç³»ç»Ÿæ¶æ„ç»„

---

## 1. ç®—æ³•æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡

åŒºåŸŸçŒæº‰é€»è¾‘ç®—æ³•æ˜¯ä¸€å¥—åŸºäºåœ°ç†æ‹“æ‰‘ç»“æ„ã€æ°´åŠ›çº¦æŸå’Œè®¾å¤‡èƒ½åŠ›çš„æ™ºèƒ½çŒæº‰æ‰¹æ¬¡ç”Ÿæˆç®—æ³•ï¼Œæ—¨åœ¨ï¼š

âœ… **è‡ªåŠ¨ç”Ÿæˆæœ€ä¼˜çŒæº‰æ‰¹æ¬¡åºåˆ—**
- æ ¹æ®ç”°å—æ°´ä½ã€ä½ç½®ã€é¢ç§¯è‡ªåŠ¨åˆ†æ‰¹
- æ»¡è¶³æ°´æ³µæµé‡å’Œæ—¶é—´çª—å£çº¦æŸ
- ä¼˜åŒ–çŒæº‰é¡ºåºï¼Œå‡å°‘æ°´èµ„æºæµªè´¹

âœ… **åŠ¨æ€è®¡ç®—ç”°å—ç¼ºæ°´é‡å’ŒçŒæº‰æ—¶é•¿**
- å®æ—¶è¯»å–ç”°å—å½“å‰æ°´ä½
- æ ¹æ®ä½œç‰©éœ€æ±‚åŠ¨æ€è®¡ç®—ç¼ºæ°´é‡
- ç²¾ç¡®è®¡ç®—æ¯ä¸ªæ‰¹æ¬¡æ‰€éœ€æ—¶é—´

âœ… **æ™ºèƒ½æ§åˆ¶èŠ‚åˆ¶é—¸å’Œæ°´æ³µè®¾å¤‡**
- è‡ªåŠ¨ç”ŸæˆèŠ‚åˆ¶é—¸å¼€é—­æŒ‡ä»¤
- ä¼˜åŒ–æ°´æ³µå¯åœæ—¶åº
- ç¡®ä¿æ°´è·¯ç•…é€šï¼Œé¿å…å†²çª

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

#### 1.2.1 æ•°æ®ç»“æ„å®šä¹‰

```python
# ç”°å— (FieldPlot)
{
    "id": "S3-G5-F1",              # ç”°å—æ ‡è¯†ï¼šç‰‡åŒº-é—¸é—¨-ç”°å—
    "area_mu": 10.5,               # é¢ç§¯ï¼ˆäº©ï¼‰
    "segment_id": "S3",            # æ‰€å±ç‰‡åŒº
    "distance_rank": 5,            # è·ç¦»ä¼˜å…ˆçº§ï¼ˆ1=æœ€è¿‘ï¼‰
    "wl_mm": 75.0,                 # å½“å‰æ°´ä½ï¼ˆæ¯«ç±³ï¼‰
    "wl_low": 80.0,                # ä½æ°´ä½é˜ˆå€¼ï¼ˆè§¦å‘çŒæº‰ï¼‰
    "wl_opt": 100.0,               # æœ€ä¼˜æ°´ä½ï¼ˆçŒæº‰ç›®æ ‡ï¼‰
    "wl_high": 140.0,              # é«˜æ°´ä½é˜ˆå€¼ï¼ˆä¸éœ€çŒæº‰ï¼‰
    "inlet_gid": "S3-G5"           # è¿›æ°´é—¸é—¨ID
}

# ç‰‡åŒº (Segment)
{
    "id": "S3",                    # ç‰‡åŒºæ ‡è¯†
    "canal_id": "C_A",             # æ‰€å±æ¸ é“
    "distance_rank": 3,            # è·ç¦»ä¼˜å…ˆçº§
    "regulator_gate_ids": ["S3-G1", "S3-G15"],  # èŠ‚åˆ¶é—¸åˆ—è¡¨
    "feed_by": ["P1", "P2"]        # ä¾›æ°´æ°´æ³µ
}

# é—¸é—¨ (Gate)
{
    "id": "S3-G1",                 # é—¸é—¨æ ‡è¯†
    "type": "main-g",              # ç±»å‹ï¼šmain-g/branch-g/regulator
    "q_max_m3ph": 300.0            # æœ€å¤§æµé‡ï¼ˆç«‹æ–¹ç±³/å°æ—¶ï¼‰
}

# æ°´æ³µ (Pump)
{
    "name": "P1",                  # æ°´æ³µåç§°
    "q_rated_m3ph": 300.0,         # é¢å®šæµé‡ï¼ˆç«‹æ–¹ç±³/å°æ—¶ï¼‰
    "power_kw": 60.0,              # åŠŸç‡ï¼ˆåƒç“¦ï¼‰
    "efficiency": 0.8,             # æ•ˆç‡
    "electricity_price": 0.6       # ç”µä»·ï¼ˆå…ƒ/åº¦ï¼‰
}
```

---

## 2. æ ¸å¿ƒç®—æ³•åŸç†

### 2.1 çŒæº‰åˆ¤æ–­é€»è¾‘

#### 2.1.1 åˆ¤æ–­æ ‡å‡†

```python
def needs_irrigation(field: FieldPlot) -> bool:
    """
    åˆ¤æ–­ç”°å—æ˜¯å¦éœ€è¦çŒæº‰
    
    è§„åˆ™ï¼š
    - å½“å‰æ°´ä½ < ä½æ°´ä½é˜ˆå€¼ â†’ éœ€è¦çŒæº‰
    - å½“å‰æ°´ä½ >= ä½æ°´ä½é˜ˆå€¼ â†’ ä¸éœ€è¦çŒæº‰
    """
    if field.wl_mm is None:
        return False  # æ°´ä½æ•°æ®ç¼ºå¤±ï¼Œè·³è¿‡
    
    return field.wl_mm < field.wl_low
```

**ç¤ºä¾‹**ï¼š
```
ç”°å—Aï¼šwl_mm = 75mm, wl_low = 80mm
åˆ¤æ–­ï¼š75 < 80 â†’ éœ€è¦çŒæº‰ âœ…

ç”°å—Bï¼šwl_mm = 85mm, wl_low = 80mm
åˆ¤æ–­ï¼š85 >= 80 â†’ ä¸éœ€è¦çŒæº‰ âŒ
```

#### 2.1.2 ç¼ºæ°´é‡è®¡ç®—

```python
def calculate_deficit(field: FieldPlot) -> float:
    """
    è®¡ç®—ç”°å—ç¼ºæ°´é‡ï¼ˆç«‹æ–¹ç±³ï¼‰
    
    å…¬å¼ï¼š
    ç¼ºæ°´æ·±åº¦(mm) = wl_opt - wl_mm
    ç¼ºæ°´é‡(mÂ³) = é¢ç§¯(äº©) Ã— ç¼ºæ°´æ·±åº¦(mm) Ã— 0.666667
    
    è¯´æ˜ï¼š
    - çŒæº‰ç›®æ ‡ï¼šä»å½“å‰æ°´ä½çŒæº‰åˆ°æœ€ä¼˜æ°´ä½
    - è½¬æ¢ç³»æ•°ï¼š1äº©Â·mm â‰ˆ 0.666667 mÂ³
    """
    if field.wl_mm >= field.wl_low:
        return 0.0  # ä¸éœ€è¦çŒæº‰
    
    deficit_mm = field.wl_opt - field.wl_mm  # ç¼ºæ°´æ·±åº¦
    deficit_m3 = field.area_mu * deficit_mm * 0.666667
    
    return deficit_m3
```

**è®¡ç®—ç¤ºä¾‹**ï¼š
```
ç”°å—ä¿¡æ¯ï¼š
- é¢ç§¯ = 10 äº©
- wl_mm = 75mmï¼ˆå½“å‰æ°´ä½ï¼‰
- wl_low = 80mmï¼ˆä½æ°´ä½é˜ˆå€¼ï¼‰
- wl_opt = 100mmï¼ˆæœ€ä¼˜æ°´ä½ï¼‰

æ­¥éª¤ï¼š
1. åˆ¤æ–­æ˜¯å¦éœ€è¦çŒæº‰ï¼š75 < 80 â†’ æ˜¯ âœ…
2. è®¡ç®—ç¼ºæ°´æ·±åº¦ï¼š100 - 75 = 25mm
3. è®¡ç®—ç¼ºæ°´é‡ï¼š10 Ã— 25 Ã— 0.666667 = 166.67 mÂ³

ç»“è®ºï¼šéœ€è¦çŒæº‰ 166.67 ç«‹æ–¹ç±³æ°´
```

---

### 2.2 æ‰¹æ¬¡ç”Ÿæˆç®—æ³•

#### 2.2.1 ç®—æ³•æµç¨‹å›¾

```
å¼€å§‹
  â†“
1. ç”°å—ç­›é€‰
  - è¿‡æ»¤ wl_mm = null çš„ç”°å—
  - ç­›é€‰éœ€è¦çŒæº‰çš„ç”°å—ï¼ˆwl_mm < wl_lowï¼‰
  - æŒ‰ç‰‡åŒº(segment_id)åˆ†ç»„
  â†“
2. ç”°å—æ’åº
  - ä¼˜å…ˆçº§1ï¼šç‰‡åŒºè·ç¦»ä¼˜å…ˆçº§ï¼ˆdistance_rankï¼‰
  - ä¼˜å…ˆçº§2ï¼šç”°å—è·ç¦»ä¼˜å…ˆçº§
  - åŸåˆ™ï¼šè¿‘æ°´æºä¼˜å…ˆ
  â†“
3. æ‰¹æ¬¡åˆ†é…ï¼ˆä¸¤ç§æ¨¡å¼ï¼‰
  â”œâ”€ æ¨¡å¼Aï¼šæ—¶é—´çº¦æŸæ¨¡å¼
  â”‚   - æ ¹æ®æ°´æ³µæ—¶é—´çª—å£åˆ’åˆ†æ—¶æ®µ
  â”‚   - æ¯ä¸ªæ—¶æ®µå†…æ ¹æ®æµé‡å’Œæ—¶é•¿åˆ†æ‰¹
  â”‚   - ç¡®ä¿åœ¨æ—¶æ®µå†…å®Œæˆ
  â”‚
  â””â”€ æ¨¡å¼Bï¼šå¹¶å‘åˆ†æ‰¹æ¨¡å¼
      - æ ¹æ®æœ€å¤§å¹¶å‘é¢ç§¯åˆ†æ‰¹
      - æŒ‰ç‰‡åŒºé¡ºåºä¾æ¬¡åˆ†é…
      - ç¡®ä¿æ°´æ³µæµé‡å……è¶³
  â†“
4. æ—¶é—´è®¡ç®—
  - æ‰¹æ¬¡ç¼ºæ°´é‡ = Î£ ç”°å—ç¼ºæ°´é‡
  - æ‰¹æ¬¡æ—¶é•¿ = ç¼ºæ°´é‡ Ã· å¯ç”¨æµé‡
  - ç´¯åŠ è®¡ç®—å„æ‰¹æ¬¡å¼€å§‹/ç»“æŸæ—¶é—´
  â†“
5. èŠ‚åˆ¶é—¸æ§åˆ¶
  - æ ¹æ®æ‰¹æ¬¡ç”°å—ä½ç½®è®¡ç®—å¼€åº¦
  - ä¸»æ¸ èŠ‚åˆ¶é—¸ï¼šæ ¹æ®æ”¯æ¸ éœ€æ±‚
  - æ”¯æ¸ èŠ‚åˆ¶é—¸ï¼šæ ¹æ®æœ¬æ”¯æ¸ ç”°å—
  â†“
6. ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
  - æ‰¹æ¬¡åºåˆ—ï¼ˆbatchesï¼‰
  - æ‰§è¡Œæ­¥éª¤ï¼ˆstepsï¼‰
  - è®¾å¤‡æŒ‡ä»¤ï¼ˆcommandsï¼‰
  â†“
ç»“æŸ
```

#### 2.2.2 æ—¶é—´çº¦æŸæ¨¡å¼ç®—æ³•

**é€‚ç”¨åœºæ™¯**ï¼šæ°´æ³µæœ‰æ—¶é—´çª—å£é™åˆ¶ï¼ˆå¦‚P1åªåœ¨0-8ç‚¹è¿è¡Œï¼ŒP2åªåœ¨8-16ç‚¹è¿è¡Œï¼‰

```python
def build_time_constrained_plan(config: FarmConfig) -> Plan:
    """
    åŸºäºæ°´æ³µæ—¶é—´çº¦æŸçš„æ‰¹æ¬¡ç”Ÿæˆ
    
    æ­¥éª¤ï¼š
    1. è§£ææ°´æ³µæ—¶é—´çª—å£ï¼Œç”Ÿæˆæ—¶é—´æ®µ
    2. ç­›é€‰å¯è¾¾ç‰‡åŒºï¼ˆæ ¹æ®feed_byï¼‰
    3. ç­›é€‰éœ€è¦çŒæº‰çš„ç”°å—
    4. æŒ‰è·ç¦»ä¼˜å…ˆçº§æ’åº
    5. åœ¨æ¯ä¸ªæ—¶é—´æ®µå†…åˆ†æ‰¹
    """
    
    # æ­¥éª¤1ï¼šç”Ÿæˆæ—¶é—´æ®µ
    time_slots = []
    for constraint in config.pump_time_constraints:
        time_slots.append(TimeSlot(
            start_hour=constraint.start_hour,
            end_hour=constraint.end_hour,
            active_pumps=[constraint.pump_name],
            total_flow_rate=constraint.flow_rate
        ))
    
    # æ­¥éª¤2ï¼šç­›é€‰å¯è¾¾ç”°å—
    eligible_fields = []
    for field in config.fields.values():
        if field.wl_mm is None:
            continue  # è·³è¿‡æ— æ°´ä½æ•°æ®çš„ç”°å—
        
        if field.wl_mm >= field.wl_low:
            continue  # è·³è¿‡ä¸éœ€è¦çŒæº‰çš„ç”°å—
        
        # æ£€æŸ¥ç‰‡åŒºæ˜¯å¦å¯è¾¾
        segment = config.segments[field.segment_id]
        if has_common_pump(segment.feed_by, all_active_pumps):
            eligible_fields.append(field)
    
    # æ­¥éª¤3ï¼šæ’åºï¼ˆè·ç¦»ä¼˜å…ˆï¼‰
    eligible_fields.sort(key=lambda f: (
        config.segments[f.segment_id].distance_rank,
        f.distance_rank
    ))
    
    # æ­¥éª¤4ï¼šåœ¨æ¯ä¸ªæ—¶é—´æ®µå†…åˆ†æ‰¹
    batches = []
    for slot in time_slots:
        # è®¡ç®—æ—¶é—´æ®µå®¹é‡
        slot_duration_h = slot.end_hour - slot.start_hour
        slot_volume_m3 = slot.total_flow_rate * slot_duration_h
        
        # è´ªå¿ƒåˆ†é…ç”°å—
        batch_fields = []
        accumulated_volume = 0.0
        
        for field in remaining_fields:
            field_deficit = calculate_deficit(field)
            
            if accumulated_volume + field_deficit <= slot_volume_m3:
                batch_fields.append(field)
                accumulated_volume += field_deficit
        
        if batch_fields:
            batches.append(Batch(
                index=len(batches) + 1,
                fields=batch_fields,
                start_time_h=slot.start_hour,
                duration_h=slot_duration_h
            ))
    
    return Plan(batches=batches, ...)
```

**ç¤ºä¾‹**ï¼š
```
æ°´æ³µæ—¶é—´çº¦æŸï¼š
- P1: 0:00-8:00, æµé‡ 300 mÂ³/h
- P2: 8:00-16:00, æµé‡ 300 mÂ³/h

æ—¶é—´æ®µåˆ’åˆ†ï¼š
â”œâ”€ æ—¶æ®µ1: 0-8h, P1, å®¹é‡ = 300 Ã— 8 = 2400 mÂ³
â””â”€ æ—¶æ®µ2: 8-16h, P2, å®¹é‡ = 300 Ã— 8 = 2400 mÂ³

ç”°å—åˆ†é…ï¼š
æ—¶æ®µ1åˆ†é…ï¼š
  æ‰¹æ¬¡1: ç”°å—[S1-G1-F1, S1-G2-F1, ...], æ€»éœ€æ°´é‡ 2300 mÂ³
  
æ—¶æ®µ2åˆ†é…ï¼š
  æ‰¹æ¬¡2: ç”°å—[S2-G5-F1, S2-G6-F1, ...], æ€»éœ€æ°´é‡ 2100 mÂ³
```

#### 2.2.3 å¹¶å‘åˆ†æ‰¹æ¨¡å¼ç®—æ³•

**é€‚ç”¨åœºæ™¯**ï¼šæ°´æ³µå¯å…¨å¤©è¿è¡Œï¼Œæ ¹æ®å¹¶å‘èƒ½åŠ›åˆ†æ‰¹

```python
def build_concurrent_plan(config: FarmConfig) -> Plan:
    """
    åŸºäºå¹¶å‘èƒ½åŠ›çš„æ‰¹æ¬¡ç”Ÿæˆ
    
    æ ¸å¿ƒæ€æƒ³ï¼š
    - æ ¹æ®æ°´æ³µæµé‡è®¡ç®—æœ€å¤§å¹¶å‘é¢ç§¯
    - æŒ‰ç‰‡åŒºé¡ºåºä¾æ¬¡åˆ†æ‰¹
    - ç¡®ä¿æ¯æ‰¹æ¬¡åœ¨åˆç†æ—¶é—´å†…å®Œæˆ
    """
    
    # è®¡ç®—å‚æ•°
    q_avail = config.pump.q_rated_m3ph  # å¯ç”¨æµé‡
    t_win = config.t_win_h              # æ—¶é—´çª—å£
    per_mu_m3 = config.d_target_mm * 0.666667  # æ¯äº©ç”¨æ°´é‡
    
    # æœ€å¤§å¹¶å‘é¢ç§¯ï¼ˆäº©ï¼‰
    max_concurrent_area = (q_avail * t_win) / per_mu_m3
    
    # ç­›é€‰éœ€è¦çŒæº‰çš„ç”°å—
    eligible_fields = [
        f for f in config.fields.values()
        if f.wl_mm is not None and f.wl_mm < f.wl_low
    ]
    
    # æŒ‰è·ç¦»æ’åº
    eligible_fields.sort(key=lambda f: (
        config.segments[f.segment_id].distance_rank,
        f.distance_rank
    ))
    
    # è´ªå¿ƒåˆ†æ‰¹
    batches = []
    remaining_fields = eligible_fields.copy()
    
    while remaining_fields:
        batch_fields = []
        accumulated_area = 0.0
        
        # è´ªå¿ƒé€‰æ‹©ç”°å—
        for field in remaining_fields[:]:
            if accumulated_area + field.area_mu <= max_concurrent_area:
                batch_fields.append(field)
                accumulated_area += field.area_mu
                remaining_fields.remove(field)
        
        if batch_fields:
            # è®¡ç®—æ‰¹æ¬¡ç»Ÿè®¡
            deficit_m3 = sum(calculate_deficit(f) for f in batch_fields)
            eta_hours = deficit_m3 / q_avail
            
            batches.append(Batch(
                index=len(batches) + 1,
                fields=batch_fields,
                deficit_vol_m3=deficit_m3,
                eta_hours=eta_hours
            ))
    
    return Plan(batches=batches, ...)
```

**è®¡ç®—ç¤ºä¾‹**ï¼š
```
ç³»ç»Ÿå‚æ•°ï¼š
- æ°´æ³µæµé‡ï¼š300 mÂ³/h
- æ—¶é—´çª—å£ï¼š20 å°æ—¶
- ç›®æ ‡çŒæ·±ï¼š90mm

è®¡ç®—ï¼š
1. æ¯äº©ç”¨æ°´é‡ = 90 Ã— 0.666667 = 60 mÂ³/äº©
2. æœ€å¤§å¹¶å‘é¢ç§¯ = (300 Ã— 20) / 60 = 100 äº©

åˆ†æ‰¹ç»“æœï¼š
æ‰¹æ¬¡1ï¼šç”°å—æ€»é¢ç§¯ 95 äº©ï¼Œç¼ºæ°´é‡ 2500 mÂ³ï¼Œé¢„è®¡ 8.3 å°æ—¶
æ‰¹æ¬¡2ï¼šç”°å—æ€»é¢ç§¯ 88 äº©ï¼Œç¼ºæ°´é‡ 2200 mÂ³ï¼Œé¢„è®¡ 7.3 å°æ—¶
æ‰¹æ¬¡3ï¼šç”°å—æ€»é¢ç§¯ 92 äº©ï¼Œç¼ºæ°´é‡ 2400 mÂ³ï¼Œé¢„è®¡ 8.0 å°æ—¶
```

---

### 2.3 èŠ‚åˆ¶é—¸æ§åˆ¶é€»è¾‘

#### 2.3.1 èŠ‚åˆ¶é—¸åˆ†ç±»

1. **ä¸»æ¸ èŠ‚åˆ¶é—¸ (main-g)**
   - ä½ç½®ï¼šä¸»æ¸ é“ä¸Š
   - ä½œç”¨ï¼šæ§åˆ¶æ°´æµè¿›å…¥æ”¯æ¸ 
   - åˆ¤æ–­ä¾æ®ï¼šå…¶å®ƒæ”¯æ¸ çš„éœ€æ±‚

2. **æ”¯æ¸ èŠ‚åˆ¶é—¸ (branch-g / regulator)**
   - ä½ç½®ï¼šæ”¯æ¸ é“ä¸Š
   - ä½œç”¨ï¼šæ§åˆ¶æ°´æµåœ¨æ”¯æ¸ å†…åˆ†é…
   - åˆ¤æ–­ä¾æ®ï¼šæœ¬æ”¯æ¸ çš„éœ€æ±‚

#### 2.3.2 å¼€åº¦è®¡ç®—è§„åˆ™

```python
def calculate_gate_opening(gate_id: str, gate_type: str, 
                          batch_fields: List[FieldPlot]) -> int:
    """
    è®¡ç®—èŠ‚åˆ¶é—¸å¼€åº¦
    
    è¿”å›å€¼ï¼š0ï¼ˆå…³é—­ï¼‰æˆ– 100ï¼ˆå…¨å¼€ï¼‰
    
    è§„åˆ™ï¼š
    1. æå–é—¸é—¨åºå· kï¼ˆå¦‚ S3-G15 â†’ k=15ï¼‰
    2. æå–æ‰¹æ¬¡ä¸­æ‰€æœ‰ç”°å—çš„é—¸é—¨åºå·åˆ—è¡¨ [Gy1, Gy2, ...]
    3. æ ¹æ®é—¸é—¨ç±»å‹åˆ¤æ–­ï¼š
       
       ä¸»æ¸ èŠ‚åˆ¶é—¸ (main-g)ï¼š
       - æ¯”è¾ƒé›†åˆï¼šå…¶å®ƒæ”¯æ¸ çš„æ‰€æœ‰ç”°å—
       - è§„åˆ™ï¼šå¦‚æœæ‰€æœ‰ç”°å—é—¸å· > k â†’ å…³é—­(0)
              å¦åˆ™ â†’ å…¨å¼€(100)
       - å«ä¹‰ï¼šä¸‹æ¸¸æ”¯æ¸ ä¸éœ€è¦æ°´ï¼Œå…³é—­èŠ‚åˆ¶é—¸
       
       æ”¯æ¸ èŠ‚åˆ¶é—¸ (branch-g/regulator)ï¼š
       - æ¯”è¾ƒé›†åˆï¼šæœ¬æ”¯æ¸ çš„æ‰€æœ‰ç”°å—
       - è§„åˆ™ï¼šå¦‚æœæ‰€æœ‰ç”°å—é—¸å· < k â†’ å…³é—­(0)
              å¦åˆ™ â†’ å…¨å¼€(100)
       - å«ä¹‰ï¼šæœ¬æ”¯æ¸ å†…ä¸Šæ¸¸ç”°å—éƒ½çŒæº‰å®Œäº†ï¼Œå…³é—­èŠ‚åˆ¶é—¸
    """
    
    # æå–é—¸é—¨åºå·
    k = extract_gate_number(gate_id)  # S3-G15 â†’ 15
    
    # æå–ç”°å—é—¸é—¨åºå·åˆ—è¡¨
    field_gate_numbers = []
    for field in batch_fields:
        gy = extract_gate_number(field.inlet_gid)
        field_gate_numbers.append(gy)
    
    # æ ¹æ®ç±»å‹åˆ¤æ–­
    if gate_type == "main-g":
        # ä¸»æ¸ èŠ‚åˆ¶é—¸ï¼šçœ‹å…¶å®ƒæ”¯æ¸ 
        other_branch_fields = [
            f for f in batch_fields 
            if get_segment(f) != get_segment(gate_id)
        ]
        other_gate_numbers = [
            extract_gate_number(f.inlet_gid) 
            for f in other_branch_fields
        ]
        
        if all(gy > k for gy in other_gate_numbers):
            return 0  # å…¨éƒ¨åœ¨ä¸‹æ¸¸ï¼Œå…³é—­
        else:
            return 100  # æœ‰ä¸Šæ¸¸ç”°å—ï¼Œæ‰“å¼€
    
    else:  # branch-g / regulator
        # æ”¯æ¸ èŠ‚åˆ¶é—¸ï¼šçœ‹æœ¬æ”¯æ¸ 
        same_branch_fields = [
            f for f in batch_fields 
            if get_segment(f) == get_segment(gate_id)
        ]
        same_gate_numbers = [
            extract_gate_number(f.inlet_gid) 
            for f in same_branch_fields
        ]
        
        if all(gy < k for gy in same_gate_numbers):
            return 0  # å…¨éƒ¨åœ¨ä¸Šæ¸¸ï¼Œå…³é—­
        else:
            return 100  # æœ‰ä¸‹æ¸¸ç”°å—ï¼Œæ‰“å¼€
```

#### 2.3.3 æ§åˆ¶ç¤ºä¾‹

**åœºæ™¯ï¼šä¸»æ¸ èŠ‚åˆ¶é—¸**
```
ä¸»æ¸ ï¼š--- S1 --- [èŠ‚åˆ¶é—¸ S1-G10] --- S2 --- S3 ---

æ‰¹æ¬¡1çŒæº‰ç”°å—ï¼š
- S1-G5-F1  (é—¸å· 5)
- S1-G8-F2  (é—¸å· 8)
- S2-G15-F1 (é—¸å· 15ï¼Œå…¶å®ƒæ”¯æ¸ )

åˆ¤æ–­ S1-G10 å¼€åº¦ï¼š
- k = 10
- å…¶å®ƒæ”¯æ¸ ç”°å—é—¸å·ï¼š[15]
- åˆ¤æ–­ï¼š15 > 10 â†’ å…¨éƒ¨åœ¨ä¸‹æ¸¸
- ç»“æœï¼šå…³é—­(0%) â†’ æ°´ä¸éœ€è¦æµå‘ S2

ç»“è®ºï¼šèŠ‚çœæ°´èµ„æºï¼Œé¿å…æ— æ•ˆè¾“æ°´
```

**åœºæ™¯ï¼šæ”¯æ¸ èŠ‚åˆ¶é—¸**
```
æ”¯æ¸ S3ï¼š--- G1 --- G5 --- [èŠ‚åˆ¶é—¸ G10] --- G15 --- G20 ---

æ‰¹æ¬¡2çŒæº‰ç”°å—ï¼ˆæœ¬æ”¯æ¸ ï¼‰ï¼š
- S3-G5-F1  (é—¸å· 5)
- S3-G8-F2  (é—¸å· 8)

åˆ¤æ–­ S3-G10 å¼€åº¦ï¼š
- k = 10
- æœ¬æ”¯æ¸ ç”°å—é—¸å·ï¼š[5, 8]
- åˆ¤æ–­ï¼š5 < 10 ä¸” 8 < 10 â†’ å…¨éƒ¨åœ¨ä¸Šæ¸¸
- ç»“æœï¼šå…³é—­(0%) â†’ æ°´ä¸éœ€è¦æµå‘ä¸‹æ¸¸

ç»“è®ºï¼šé¿å…æ°´æµç»§ç»­å‘ä¸‹æ¸¸ï¼Œå‡å°‘æµªè´¹
```

---

## 3. æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ

### 3.1 æ•°æ®ç»“æ„

```python
Plan = {
    "plan_id": "irrigation_plan_20250109_123456.json",
    "calc": {
        "time_constrained": True/False,
        "d_target_mm": 90.0,
        "total_pumps": 2,
        "pump": { "name": "P1", "q_rated_m3ph": 300.0, ... }
    },
    "batches": [
        {
            "index": 1,
            "fields": [
                {"id": "S3-G5-F1", "area_mu": 10.5, "wl_mm": 75, ...},
                {"id": "S3-G6-F2", "area_mu": 8.2, "wl_mm": 72, ...}
            ]
        },
        ...
    ],
    "batch_stats": [
        {
            "deficit_vol_m3": 2500.0,     # æ€»ç¼ºæ°´é‡
            "cap_vol_m3": 3000.0,          # å®¹é‡
            "eta_hours": 8.3               # é¢„è®¡æ—¶é•¿
        },
        ...
    ],
    "steps": [
        {
            "t_start_h": 0.0,
            "t_end_h": 8.3,
            "label": "æ‰¹æ¬¡ 1",
            "commands": [
                {"action": "start", "target": "P1", "t_start_h": 0.0},
                {"action": "set", "target": "S3-G1", "value": 100, "t_start_h": 0.0},
                {"action": "open", "target": "S3-G5-F1", "t_start_h": 0.0},
                {"action": "close", "target": "S3-G5-F1", "t_end_h": 8.3},
                {"action": "stop", "target": "P1", "t_end_h": 8.3}
            ],
            "sequence": {
                "gates_set": [
                    {"id": "S3-G1", "open_pct": 100, "type": "main-g"},
                    {"id": "S3-G10", "open_pct": 0, "type": "regulator"}
                ],
                "fields": ["S3-G5-F1", "S3-G6-F2"]
            }
        },
        ...
    ]
}
```

### 3.2 æŒ‡ä»¤ç”Ÿæˆ

#### 3.2.1 æŒ‡ä»¤ç±»å‹

| æŒ‡ä»¤ç±»å‹ | target | è¯´æ˜ | ç¤ºä¾‹ |
|---------|--------|------|------|
| `start` | æ°´æ³µåç§° | å¯åŠ¨æ°´æ³µ | `{"action": "start", "target": "P1"}` |
| `stop` | æ°´æ³µåç§° | åœæ­¢æ°´æ³µ | `{"action": "stop", "target": "P1"}` |
| `set` | èŠ‚åˆ¶é—¸ID | è®¾ç½®èŠ‚åˆ¶é—¸å¼€åº¦ | `{"action": "set", "target": "S3-G1", "value": 100}` |
| `open` | ç”°å—ID | æ‰“å¼€ç”°å—é—¸é—¨ | `{"action": "open", "target": "S3-G5-F1"}` |
| `close` | ç”°å—ID | å…³é—­ç”°å—é—¸é—¨ | `{"action": "close", "target": "S3-G5-F1"}` |

#### 3.2.2 æŒ‡ä»¤é¡ºåº

```
æ‰¹æ¬¡å¼€å§‹ï¼š
  1. å¯åŠ¨æ°´æ³µ (start pump)
  2. è®¾ç½®èŠ‚åˆ¶é—¸ (set regulators)
  3. æ‰“å¼€ç”°å—é—¸é—¨ (open field gates)
     â†“
  [çŒæº‰è¿›è¡Œä¸­...]
     â†“
æ‰¹æ¬¡ç»“æŸï¼š
  4. å…³é—­ç”°å—é—¸é—¨ (close field gates)
  5. åœæ­¢æ°´æ³µ (stop pump)
```

---

## 4. åŠ¨æ€æ°´ä½è°ƒæ•´

### 4.1 å®æ—¶æ°´ä½è·å–

```python
def fetch_latest_water_levels(farm_id: str) -> Dict[str, float]:
    """
    ä»ä¼ æ„Ÿå™¨æˆ–APIè·å–æœ€æ–°æ°´ä½æ•°æ®
    
    è¿”å›æ ¼å¼ï¼š
    {
        "S3-G5-F1": 78.5,  # ç”°å—ID â†’ å½“å‰æ°´ä½(mm)
        "S3-G6-F2": 82.3,
        ...
    }
    """
    # è°ƒç”¨æ°´ä½API
    water_levels = api.get_water_levels(farm_id)
    return water_levels
```

### 4.2 è®¡åˆ’é‡æ–°ç”Ÿæˆ

å½“æ°´ä½å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç³»ç»Ÿä¼šé‡æ–°è®¡ç®—ï¼š

```python
def regenerate_plan_with_new_waterlevels(
    original_plan: Plan,
    new_water_levels: Dict[str, float]
) -> Plan:
    """
    åŸºäºæ–°æ°´ä½é‡æ–°ç”Ÿæˆè®¡åˆ’
    
    æ­¥éª¤ï¼š
    1. æ›´æ–°ç”°å—æ°´ä½
    2. é‡æ–°åˆ¤æ–­æ˜¯å¦éœ€è¦çŒæº‰
    3. é‡æ–°è®¡ç®—ç¼ºæ°´é‡
    4. é‡æ–°åˆ†æ‰¹
    5. é‡æ–°è®¡ç®—æ—¶é—´
    """
    
    # 1. æ›´æ–°æ°´ä½
    for field in original_plan.fields:
        if field.id in new_water_levels:
            field.wl_mm = new_water_levels[field.id]
    
    # 2. é‡æ–°ç­›é€‰éœ€è¦çŒæº‰çš„ç”°å—
    eligible_fields = [
        f for f in original_plan.fields
        if f.wl_mm < f.wl_low
    ]
    
    # 3. é‡æ–°ç”Ÿæˆè®¡åˆ’
    new_plan = build_concurrent_plan(config)
    
    return new_plan
```

**é‡æ–°ç”Ÿæˆè§¦å‘æ¡ä»¶**ï¼š
- æ‰¹æ¬¡æ‰§è¡Œå‰ï¼ˆè·å–æœ€æ–°æ°´ä½ï¼‰
- æ‰‹åŠ¨è§¦å‘
- æ°´ä½å˜åŒ–è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ Â±10mmï¼‰

---

## 5. ä¼˜åŒ–ç­–ç•¥

### 5.1 è·ç¦»ä¼˜å…ˆåŸåˆ™

**åŸç†**ï¼šä¼˜å…ˆçŒæº‰ç¦»æ°´æºè¿‘çš„ç”°å—ï¼Œå‡å°‘æ°´å¤´æŸå¤±å’Œè¾“æ°´æ—¶é—´

```python
# æ’åºè§„åˆ™
fields.sort(key=lambda f: (
    segments[f.segment_id].distance_rank,  # ç‰‡åŒºè·ç¦»
    f.distance_rank                        # ç”°å—è·ç¦»
))
```

### 5.2 æ‰¹æ¬¡å¹³è¡¡ç­–ç•¥

**ç›®æ ‡**ï¼šä½¿å„æ‰¹æ¬¡é¢ç§¯å’Œæ—¶é•¿ç›¸å¯¹å‡è¡¡ï¼Œé¿å…æŸæ‰¹æ¬¡è¿‡é•¿

```python
# è´ªå¿ƒç®—æ³•ï¼šæ¯æ‰¹æ¬¡å°½é‡å¡«æ»¡ï¼Œä½†ä¸è¶…è¿‡å®¹é‡
while remaining_fields:
    batch_fields = []
    accumulated_area = 0.0
    
    for field in remaining_fields:
        if accumulated_area + field.area_mu <= max_area:
            batch_fields.append(field)
            accumulated_area += field.area_mu
    
    batches.append(batch_fields)
```

### 5.3 èŠ‚æ°´ä¼˜åŒ–

**ç­–ç•¥**ï¼š
1. ç²¾ç¡®è®¡ç®—ç¼ºæ°´é‡ï¼ˆwl_opt - wl_mmï¼‰ï¼Œé¿å…è¿‡åº¦çŒæº‰
2. æ™ºèƒ½æ§åˆ¶èŠ‚åˆ¶é—¸ï¼Œå‡å°‘æ— æ•ˆè¾“æ°´
3. æŒ‰è·ç¦»æ’åºï¼Œå‡å°‘æ°´å¤´æŸå¤±

---

## 6. å…³é”®å‚æ•°è¯´æ˜

### 6.1 æ°´ä½å‚æ•°

| å‚æ•° | ç¬¦å· | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|--------|------|
| ä½æ°´ä½é˜ˆå€¼ | wl_low | 80mm | è§¦å‘çŒæº‰çš„åˆ¤æ–­æ ‡å‡† |
| æœ€ä¼˜æ°´ä½ | wl_opt | 100mm | çŒæº‰ç›®æ ‡æ°´ä½ |
| é«˜æ°´ä½é˜ˆå€¼ | wl_high | 140mm | è¶…è¿‡åˆ™ä¸éœ€çŒæº‰ |
| ç›®æ ‡çŒæ·± | d_target_mm | 90mm | å‚è€ƒå€¼ï¼ˆå®é™…ä½¿ç”¨åŠ¨æ€è®¡ç®—ï¼‰ |

### 6.2 è½¬æ¢ç³»æ•°

| è½¬æ¢ | ç³»æ•° | å…¬å¼ |
|-----|------|------|
| äº©Â·mm â†’ mÂ³ | 0.666667 | é¢ç§¯(äº©) Ã— æ·±åº¦(mm) Ã— 0.666667 |
| mÂ³ â†’ äº©Â·mm | 1.5 | ä½“ç§¯(mÂ³) Ã· é¢ç§¯(äº©) Ã— 1.5 |

### 6.3 ç³»ç»Ÿçº¦æŸ

| çº¦æŸ | å‚æ•° | è¯´æ˜ |
|-----|------|------|
| æ—¶é—´çª—å£ | t_win_h | å•æ‰¹æ¬¡æœ€å¤§æ‰§è¡Œæ—¶é—´ï¼ˆå¦‚20å°æ—¶ï¼‰ |
| æ°´æ³µæµé‡ | q_rated_m3ph | æ°´æ³µé¢å®šæµé‡ï¼ˆå¦‚300 mÂ³/hï¼‰ |
| æœ€å¤§å¹¶å‘é¢ç§¯ | max_area | (æµé‡ Ã— æ—¶é—´) / æ¯äº©ç”¨æ°´é‡ |

---

## 7. ç®—æ³•å¤æ‚åº¦åˆ†æ

### 7.1 æ—¶é—´å¤æ‚åº¦

| æ­¥éª¤ | å¤æ‚åº¦ | è¯´æ˜ |
|-----|--------|------|
| ç”°å—ç­›é€‰ | O(n) | n = ç”°å—æ€»æ•° |
| ç”°å—æ’åº | O(n log n) | å¿«é€Ÿæ’åº |
| æ‰¹æ¬¡åˆ†é… | O(n) | è´ªå¿ƒç®—æ³• |
| èŠ‚åˆ¶é—¸è®¡ç®— | O(m Ã— k) | m = èŠ‚åˆ¶é—¸æ•°é‡ï¼Œk = ç”°å—æ•°é‡ |
| æ€»ä½“ | O(n log n) | æ’åºä¸»å¯¼ |

### 7.2 ç©ºé—´å¤æ‚åº¦

- ç”°å—æ•°æ®ï¼šO(n)
- æ‰¹æ¬¡æ•°æ®ï¼šO(b Ã— k)ï¼Œb = æ‰¹æ¬¡æ•°ï¼Œk = å¹³å‡æ¯æ‰¹ç”°å—æ•°
- æ€»ä½“ï¼šO(n)

---

## 8. ä½¿ç”¨ç¤ºä¾‹

### 8.1 åŸºç¡€è°ƒç”¨

```python
from farm_irr_full_device_modified import (
    farmcfg_from_json_select,
    build_concurrent_plan,
    plan_to_json
)

# 1. åŠ è½½é…ç½®
config = farmcfg_from_json_select(
    config_data=load_json("config.json"),
    active_pumps=["P1", "P2"],
    zone_ids=None,
    use_realtime_wl=True  # ä½¿ç”¨å®æ—¶æ°´ä½
)

# 2. ç”Ÿæˆè®¡åˆ’
plan = build_concurrent_plan(config)

# 3. å¯¼å‡ºJSON
plan_json = plan_to_json(plan)
save_json("irrigation_plan.json", plan_json)
```

### 8.2 æ—¶é—´çº¦æŸæ¨¡å¼

```python
# é…ç½®æ°´æ³µæ—¶é—´çº¦æŸ
config_data["pump_time_constraints"] = [
    {
        "pump_name": "P1",
        "start_hour": 0,
        "end_hour": 8,
        "flow_rate": 300.0
    },
    {
        "pump_name": "P2",
        "start_hour": 8,
        "end_hour": 16,
        "flow_rate": 300.0
    }
]

# åŠ è½½é…ç½®
config = farmcfg_from_json_select(config_data, ...)

# ç”Ÿæˆè®¡åˆ’ï¼ˆè‡ªåŠ¨è¯†åˆ«æ—¶é—´çº¦æŸæ¨¡å¼ï¼‰
plan = build_concurrent_plan(config)
```

---

## 9. å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæŸäº›ç”°å—æ²¡æœ‰è¢«å®‰æ’çŒæº‰ï¼Ÿ

**A**: å¯èƒ½åŸå› ï¼š
1. ç”°å— `wl_mm >= wl_low`ï¼ˆä¸éœ€è¦çŒæº‰ï¼‰
2. ç”°å— `wl_mm = null`ï¼ˆæ°´ä½æ•°æ®ç¼ºå¤±ï¼‰
3. ç‰‡åŒºä¸å¯è¾¾ï¼ˆ`feed_by` ä¸å¯ç”¨æ°´æ³µä¸åŒ¹é…ï¼‰
4. è¶…å‡ºå…è®¸åŒºåŸŸï¼ˆ`supply_zone` ä¸åœ¨ `allowed_zones` ä¸­ï¼‰

### Q2: å¦‚ä½•è°ƒæ•´æ‰¹æ¬¡å¤§å°ï¼Ÿ

**A**: ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š
```python
config.t_win_h = 15  # å‡å°æ—¶é—´çª—å£ â†’ æ›´å¤šæ‰¹æ¬¡
config.pump.q_rated_m3ph = 400  # å¢å¤§æµé‡ â†’ æ›´å¤§æ‰¹æ¬¡
```

### Q3: èŠ‚åˆ¶é—¸å¼€åº¦åªæœ‰0å’Œ100å—ï¼Ÿ

**A**: æ˜¯çš„ã€‚å½“å‰ç®—æ³•é‡‡ç”¨äºŒå€¼æ§åˆ¶ï¼ˆå…¨å¼€/å…¨å…³ï¼‰ï¼Œç®€åŒ–æ§åˆ¶é€»è¾‘ã€‚æœªæ¥å¯æ‰©å±•ä¸ºæ¯”ä¾‹æ§åˆ¶ã€‚

### Q4: å¦‚ä½•å¤„ç†é™é›¨å¯¼è‡´çš„æ°´ä½ä¸Šå‡ï¼Ÿ

**A**: ç³»ç»Ÿæ”¯æŒåŠ¨æ€æ°´ä½æ›´æ–°ï¼š
1. è°ƒç”¨ `fetch_waterlevels(farm_id)` è·å–æœ€æ–°æ°´ä½
2. è°ƒç”¨ `regenerate_plan_with_new_waterlevels()` é‡æ–°ç”Ÿæˆè®¡åˆ’
3. ç³»ç»Ÿè‡ªåŠ¨æ’é™¤ä¸éœ€è¦çŒæº‰çš„ç”°å—

---

## 10. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|-----|------|------|
| 1.0 | 2025-01 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºäºfarm_irr_full_device_modified.py |

---

## 11. å‚è€ƒèµ„æ–™

- ä»£ç æ¨¡å—ï¼š`farm_irr_full_device_modified.py`
- é…ç½®ç¤ºä¾‹ï¼š`config.json`
- APIæ–‡æ¡£ï¼š`å†œåœºçº§è°ƒåº¦ç®—æ³•APIæ¥å£æ–‡æ¡£ï¼ˆ11.7ï¼‰.md`

---

**æ–‡æ¡£ç»“æŸ**

