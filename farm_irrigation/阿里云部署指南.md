# 农场级灌溉设计算法AI - 阿里云部署指南

本指南详细说明如何将农场级灌溉设计算法AI项目部署到阿里云ECS服务器。

## 1. 部署前准备

### 1.1 服务器要求
- **操作系统**: Ubuntu 20.04+ 或 CentOS 8+
- **配置**: 最低2核4GB，推荐4核8GB
- **存储**: 至少20GB可用空间
- **网络**: 公网IP，带宽建议5Mbps以上

### 1.2 域名准备（可选）
- 购买域名并完成备案
- 配置DNS解析指向服务器IP

### 1.3 安全组配置
在阿里云控制台配置安全组规则：
```
端口22   - SSH访问
端口80   - HTTP访问
端口443  - HTTPS访问
端口5000 - 应用直接访问（可选）
```

## 2. 快速部署

### 2.1 自动部署（推荐）

1. **上传项目文件**
```bash
# 上传整个farm_irrigation目录到服务器
scp -r /f:/农场级灌溉设计算法AI/farm_irrigation/ root@your-server-ip:/opt/
```

2. **运行自动部署脚本**
```bash
# 连接服务器
ssh root@your-server-ip

# 进入项目目录
cd /opt/farm_irrigation

# 给脚本执行权限
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh
```

3. **启动应用**
```bash
# 启动应用
./start.sh
```

### 2.2 手动部署

如果自动部署失败，可以按以下步骤手动部署：

1. **更新系统**
```bash
# Ubuntu
sudo apt update && sudo apt upgrade -y

# CentOS
sudo yum update -y
```

2. **安装依赖**
```bash
# Ubuntu
sudo apt install -y python3 python3-pip python3-venv nginx git
sudo apt install -y gdal-bin libgdal-dev python3-gdal

# CentOS
sudo yum install -y python3 python3-pip nginx git
sudo yum install -y gdal gdal-devel gdal-python3
```

3. **创建应用目录**
```bash
sudo mkdir -p /opt/farm_irrigation
sudo chown -R $USER:$USER /opt/farm_irrigation
```

4. **上传并解压项目文件**
```bash
# 上传farm_irrigation目录
scp -r /f:/农场级灌溉设计算法AI/farm_irrigation/ root@your-server-ip:/opt/
```

5. **创建Python虚拟环境**
```bash
cd /opt/farm_irrigation
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

6. **生成配置文件**
```bash
python auto_to_config.py
```

7. **设置权限**
```bash
chmod +x start.sh
chmod +x deploy.sh
```

## 3. 生产环境配置

### 3.1 配置Nginx反向代理

```bash
# 复制Nginx配置
sudo cp /opt/farm_irrigation/nginx.conf /etc/nginx/sites-available/farm_irrigation
sudo ln -s /etc/nginx/sites-available/farm_irrigation /etc/nginx/sites-enabled/

# 删除默认配置（可选）
sudo rm /etc/nginx/sites-enabled/default

# 测试Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 3.2 配置systemd服务

```bash
# 复制服务配置文件
sudo cp /opt/farm_irrigation/farm_irrigation.service /etc/systemd/system/

# 重新加载systemd配置
sudo systemctl daemon-reload

# 启用服务（开机自启）
sudo systemctl enable farm_irrigation

# 启动服务
sudo systemctl start farm_irrigation

# 查看服务状态
sudo systemctl status farm_irrigation
```

### 3.3 配置日志轮转

```bash
# 创建日志轮转配置
sudo tee /etc/logrotate.d/farm_irrigation << EOF
/var/log/farm_irrigation/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload farm_irrigation
    endscript
}
EOF
```

## 4. SSL证书配置（推荐）

### 4.1 使用Let's Encrypt免费证书

```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx  # Ubuntu
sudo yum install certbot python3-certbot-nginx  # CentOS

# 获取证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
0 12 * * * /usr/bin/certbot renew --quiet
```

## 5. 监控和维护

### 5.1 常用命令

```bash
# 查看应用状态
sudo systemctl status farm_irrigation

# 重启应用
sudo systemctl restart farm_irrigation

# 查看应用日志
sudo journalctl -u farm_irrigation -f

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 查看应用日志
tail -f /var/log/farm_irrigation/access.log
tail -f /var/log/farm_irrigation/error.log
```

### 5.2 性能监控

```bash
# 安装htop监控系统资源
sudo apt install htop  # Ubuntu
sudo yum install htop  # CentOS

# 监控系统资源
htop

# 监控磁盘使用
df -h

# 监控内存使用
free -h
```

## 6. 常见问题解决

### 6.1 端口被占用
```bash
# 查看端口占用
sudo netstat -tlnp | grep :5000

# 杀死占用进程
sudo kill -9 <PID>
```

### 6.2 权限问题
```bash
# 修复文件权限
sudo chown -R www-data:www-data /opt/farm_irrigation
sudo chmod -R 755 /opt/farm_irrigation
```

### 6.3 Python依赖问题
```bash
# 重新安装依赖
cd /opt/farm_irrigation
source venv/bin/activate
pip install --upgrade -r requirements.txt
```

### 6.4 GDAL库问题
```bash
# Ubuntu重新安装GDAL
sudo apt remove --purge libgdal-dev
sudo apt install libgdal-dev
pip install --upgrade GDAL==$(gdal-config --version)

# CentOS重新安装GDAL
sudo yum remove gdal-devel
sudo yum install gdal-devel
pip install --upgrade GDAL==$(gdal-config --version)
```

## 7. 访问应用

部署完成后，可以通过以下方式访问：

- **直接访问**: `http://your-server-ip:5000`
- **通过Nginx**: `http://your-domain.com` 或 `http://your-server-ip`
- **HTTPS访问**: `https://your-domain.com`（配置SSL后）

## 8. 备份策略

### 8.1 数据备份
```bash
# 创建备份脚本
sudo tee /opt/backup_farm_irrigation.sh << EOF
#!/bin/bash
BACKUP_DIR="/opt/backups/farm_irrigation"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份应用文件
tar -czf $BACKUP_DIR/app_$DATE.tar.gz /opt/farm_irrigation

# 备份配置文件
cp /opt/farm_irrigation/config.json $BACKUP_DIR/config_$DATE.json

# 删除30天前的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
find $BACKUP_DIR -name "*.json" -mtime +30 -delete

echo "备份完成: $DATE"
EOF

# 设置执行权限
sudo chmod +x /opt/backup_farm_irrigation.sh

# 设置定时备份（每天凌晨2点）
sudo crontab -e
# 添加以下行：
0 2 * * * /opt/backup_farm_irrigation.sh
```

---

**注意事项**：
1. 请确保服务器安全组已正确配置
2. 定期更新系统和依赖包
3. 监控服务器资源使用情况
4. 定期备份重要数据
5. 如遇问题，请查看相关日志文件

**技术支持**：
- 查看项目文档和代码注释
- 检查系统日志和应用日志
- 确保所有依赖正确安装